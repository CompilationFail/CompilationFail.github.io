<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"compilationfail.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.18.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"mac"},"fold":{"enable":true,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="orangejuice&#39;s blog">
<meta property="og:url" content="https://compilationfail.github.io/page/21/index.html">
<meta property="og:site_name" content="orangejuice&#39;s blog">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="orangejuice">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://compilationfail.github.io/page/21/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"page/21/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>orangejuice's blog</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">orangejuice's blog</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">挂了请务必叫我</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="orangejuice"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">orangejuice</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">257</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://twitter.com/ChenJerson" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;ChenJerson" rel="noopener me" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://weibo.com/3950662532/profile?rightmod=1&wvr=6&mod=personinfo" title="Weibo → https:&#x2F;&#x2F;weibo.com&#x2F;3950662532&#x2F;profile?rightmod&#x3D;1&amp;wvr&#x3D;6&amp;mod&#x3D;personinfo" rel="noopener me" target="_blank"><i class="fab fa-weibo fa-fw"></i>Weibo</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://github.com/CompilationFail" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;CompilationFail" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://steamcommunity.com/profiles/76561198969516062/" title="Steam → https:&#x2F;&#x2F;steamcommunity.com&#x2F;profiles&#x2F;76561198969516062&#x2F;" rel="noopener me" target="_blank"><i class="fab fa-steam fa-fw"></i>Steam</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.last.fm/user/chasedeath" title="Lastfm → https:&#x2F;&#x2F;www.last.fm&#x2F;user&#x2F;chasedeath" rel="noopener me" target="_blank"><i class="fab fa-lastfm-square fa-fw"></i>Lastfm</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://open.spotify.com/user/mgxnlznf9dli6bm4k3sp0iuwz" title="Spotify → https:&#x2F;&#x2F;open.spotify.com&#x2F;user&#x2F;mgxnlznf9dli6bm4k3sp0iuwz" rel="noopener me" target="_blank"><i class="fab fa-spotify fa-fw"></i>Spotify</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://compilationfail.github.io/oi-solutions/Atcoder/ARC117%20-%20Tricolor%20Pyramid/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="orangejuice">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="orangejuice's blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | orangejuice's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/oi-solutions/Atcoder/ARC117%20-%20Tricolor%20Pyramid/" class="post-title-link" itemprop="url">ARC117 - Tricolor Pyramid</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2023-08-12 11:05:24 / Modified: 12:37:29" itemprop="dateCreated datePublished" datetime="2023-08-12T11:05:24+08:00">2023-08-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/oi-solutions/" itemprop="url" rel="index"><span itemprop="name">oi-solutions</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="arc117---tricolor-pyramid">ARC117 - Tricolor Pyramid</h1>
<p>设三种颜色分别为01,2, 容易发现原题变换 <span
class="math inline">\(f(a,b)\)</span> 的等价表达为</p>
<p><span class="math inline">\(f(a,b)=(-a-b)\mod 3\)</span></p>
<p><span class="math inline">\(\mod 3\)</span>
可以最后处理，那么就是一个取负操作</p>
<p>看成一个递推 <span class="math inline">\(F_{n,i}=col_i\)</span></p>
<p><span class="math inline">\(F_{i,j}=-F_{i+1,j}-F_{i+1,j+1}\)</span>
，求出 <span class="math inline">\(F_{1,1} \mod 3\)</span></p>
<p>那么对于每个 <span class="math inline">\(col_i\)</span> ，处理其对于
<span class="math inline">\(F_{1,1}\)</span>
的贡献系数，容易发现贡献就是一个两边走的杨辉三角，即 <span
class="math inline">\(\displaystyle
\binom{n-1}{i-1}(-1)^{n-1}\)</span></p>
<p><del>然后我就真的暴力处理组合数</del></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> <span class="type">int</span> N=<span class="number">1e6</span>+<span class="number">10</span>,INF=<span class="number">1e9</span>+<span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> n;</span><br><span class="line"><span class="type">char</span> s[N];</span><br><span class="line"><span class="type">char</span> ch[]=<span class="string">&quot;BWR&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> F[N],cnt[N];</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">C</span><span class="params">(<span class="type">int</span> n,<span class="type">int</span> m)</span></span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(cnt[n]-cnt[m]-cnt[n-m]) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">return</span> F[n]*F[m]*F[n-m]%<span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="built_in">rep</span>(i,F[<span class="number">0</span>]=<span class="number">1</span>,N<span class="number">-1</span>) &#123;</span><br><span class="line">		cnt[i]=cnt[i<span class="number">-1</span>],F[i]=F[i<span class="number">-1</span>];</span><br><span class="line">		<span class="type">int</span> x=i;</span><br><span class="line">		<span class="keyword">while</span>(x%<span class="number">3</span>==<span class="number">0</span>) x/=<span class="number">3</span>,cnt[i]++;</span><br><span class="line">		F[i]=F[i]*x%<span class="number">3</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">scanf</span>(<span class="string">&quot;%d%s&quot;</span>,&amp;n,s+<span class="number">1</span>);</span><br><span class="line">	<span class="type">int</span> sum=<span class="number">0</span>;</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">1</span>,n) &#123;</span><br><span class="line">		<span class="type">int</span> t=<span class="number">0</span>;</span><br><span class="line">		<span class="keyword">if</span>(s[i]==<span class="string">&#x27;W&#x27;</span>) t=<span class="number">1</span>;</span><br><span class="line">		<span class="keyword">if</span>(s[i]==<span class="string">&#x27;R&#x27;</span>) t=<span class="number">2</span>;</span><br><span class="line">		<span class="keyword">if</span>(~n&amp;<span class="number">1</span>) t=<span class="number">3</span>-t;</span><br><span class="line">		sum=(sum+<span class="built_in">C</span>(n<span class="number">-1</span>,i<span class="number">-1</span>)*t)%<span class="number">3</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	sum%=<span class="number">3</span>,<span class="built_in">putchar</span>(ch[sum]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://compilationfail.github.io/oi-solutions/COCI/COCI2013-2014%20Contest#1%20F%20/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="orangejuice">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="orangejuice's blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | orangejuice's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/oi-solutions/COCI/COCI2013-2014%20Contest#1%20F%20/" class="post-title-link" itemprop="url">COCI2013-2014 Contest#1 F  SLASTIČAR</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2023-08-12 11:05:24 / Modified: 12:37:29" itemprop="dateCreated datePublished" datetime="2023-08-12T11:05:24+08:00">2023-08-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/oi-solutions/" itemprop="url" rel="index"><span itemprop="name">oi-solutions</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="coci2013-2014-contest1-f-slastičar">COCI2013-2014 Contest#1 F
SLASTIČAR</h1>
<p>其实挺妙的一个数据结构题</p>
<p>题意: 给定一个A串，对于查询的每个 <span
class="math inline">\(B\)</span> 串，从头开始匹配匹配 <span
class="math inline">\(A\)</span> 的每个后缀，每次匹配失败的代价是 <span
class="math inline">\(\text{LCP}+1\)</span> 可，匹配成功的代价是 <span
class="math inline">\(|B|\)</span> ，且立即停止，求代价总和</p>
<p>设 <span class="math inline">\(A\)</span> 串长为 <span
class="math inline">\(n\)</span> ，查询个数为 <span
class="math inline">\(q\)</span> ，查询总长为 <span
class="math inline">\(m\)</span></p>
<p>我们知道求两个串的 <span class="math inline">\(\text{LCP}\)</span>
可以把两个串中间放一个符号分开，跑后缀数组/后缀自动机</p>
<p>但是首先是 <span class="math inline">\(m=3\cdot 10^6\)</span>
，内存就开不下</p>
<p>而且发现，如果 <span class="math inline">\(|B|\)</span>
的某个前缀未出现在 <span class="math inline">\(A\)</span>
中，后面的部分都不造成贡献，所以可以在 <span
class="math inline">\(A\)</span> 串中定位 <span
class="math inline">\(B\)</span> 的每个前缀</p>
<p>这样就只需要求 <span class="math inline">\(A\)</span>
的后缀数组即可，然而，这个并不好实现</p>
<p>假设当前已经定位了一个长度为 <span class="math inline">\(i\)</span>
的前缀，其对应的合法后缀排名范围为 <span
class="math inline">\([L_i,R_i]\)</span></p>
<p>那么接下来就是在当前前缀上接上下一个字符 <span
class="math inline">\(c\)</span> ，这个如果再外加数据结构并不好实现</p>
<p>考虑后缀数组的性质， <span class="math inline">\([L_i,R_i]\)</span>
这些后缀前 <span class="math inline">\(d\)</span> 个字符相同， <span
class="math inline">\(d+1\)</span> 个字符呈单调非递减</p>
<p>所以字符 <span class="math inline">\(c\)</span>
出现的范围也一定是一段区间，可以直接两次二分得到</p>
<p>这样查询 <span class="math inline">\([L_i,R_i]\)</span> 的复杂度为
<span class="math inline">\(\log n\)</span> ，这样就用 <span
class="math inline">\(O(m\log n)\)</span> 的复杂度完成了串定位</p>
<p>如果不考虑每次完成匹配后停止，其实答案就是 <span
class="math inline">\(\sum R_i-L_i+1\)</span> ，即 <span
class="math inline">\(\sum_i LCP_i=\sum_i \sum_j [LCP_j\ge
i]\)</span></p>
<p>设最终的匹配位置为 <span class="math inline">\(p\)</span>
，这个位置可以用线段树在最后的一段 <span
class="math inline">\([L_{|B|},R_{|B|}]\)</span> 中求最小值得到</p>
<p>考虑减掉多余的部分，即减去实际位置 <span
class="math inline">\(&gt;p\)</span> 的且在后缀数组排名在 <span
class="math inline">\([L_i,R_i]\)</span> 中的部分</p>
<p>可以把所有的 <span class="math inline">\([L_i,R_i]\)</span>
拿出来作为，离线询问，用树状数组维护查询，复杂度为 <span
class="math inline">\(O((n+m)\log n)\)</span></p>
<p>因此总复杂度为 <span class="math inline">\(O((n+m)\log
n)\)</span></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">long</span> <span class="type">long</span> ll;</span><br><span class="line"><span class="keyword">typedef</span> pair &lt;<span class="type">int</span>,<span class="type">int</span>&gt; Pii;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> reg register</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> pb push_back</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> mp make_pair</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> rep(i,a,b) for(int i=a,i##end=b;i&lt;=i##end;++i)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> drep(i,a,b) for(int i=a,i##end=b;i&gt;=i##end;--i)</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt; <span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">cmin</span><span class="params">(T &amp;a,<span class="type">const</span> T &amp;b)</span></span>&#123; ((a&gt;b)&amp;&amp;(a=b)); &#125;</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt; <span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">cmax</span><span class="params">(T &amp;a,<span class="type">const</span> T &amp;b)</span></span>&#123; ((a&lt;b)&amp;&amp;(a=b)); &#125;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> N=<span class="number">1e5</span>+<span class="number">10</span>,M=<span class="number">3e6</span>+<span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> n,m;</span><br><span class="line"><span class="type">char</span> s[N],t[N];</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> rk[N&lt;&lt;<span class="number">1</span>],tmp[N],cnt[N],sa[N];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Build</span><span class="params">(<span class="type">int</span> n)</span></span>&#123;</span><br><span class="line">    <span class="built_in">rep</span>(i,<span class="number">1</span>,n) cnt[<span class="built_in">int</span>(s[i])]++;</span><br><span class="line">    <span class="built_in">rep</span>(i,<span class="number">1</span>,<span class="number">200</span>) cnt[i]+=cnt[i<span class="number">-1</span>];</span><br><span class="line">    <span class="built_in">rep</span>(i,<span class="number">1</span>,n) rk[i]=cnt[(<span class="type">int</span>)s[i]],sa[i]=i;</span><br><span class="line">    <span class="keyword">for</span>(reg <span class="type">int</span> k=<span class="number">1</span>;k&lt;n;k&lt;&lt;=<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span>(reg <span class="type">int</span> i=<span class="number">0</span>;i&lt;=n;++i) cnt[i]=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(reg <span class="type">int</span> i=<span class="number">1</span>;i&lt;=n;++i) cnt[rk[i+k]]++;</span><br><span class="line">        <span class="keyword">for</span>(reg <span class="type">int</span> i=<span class="number">1</span>;i&lt;=n;++i) cnt[i]+=cnt[i<span class="number">-1</span>];</span><br><span class="line">        <span class="keyword">for</span>(reg <span class="type">int</span> i=n;i&gt;=<span class="number">1</span>;--i) tmp[cnt[rk[i+k]]--]=i;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(reg <span class="type">int</span> i=<span class="number">0</span>;i&lt;=n;++i) cnt[i]=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(reg <span class="type">int</span> i=<span class="number">1</span>;i&lt;=n;++i) cnt[rk[i]]++;</span><br><span class="line">        <span class="keyword">for</span>(reg <span class="type">int</span> i=<span class="number">1</span>;i&lt;=n;++i) cnt[i]+=cnt[i<span class="number">-1</span>];</span><br><span class="line">        <span class="keyword">for</span>(reg <span class="type">int</span> i=n;i&gt;=<span class="number">1</span>;--i) sa[cnt[rk[tmp[i]]]--]=tmp[i];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(reg <span class="type">int</span> i=<span class="number">1</span>;i&lt;=n;++i) tmp[sa[i]]=tmp[sa[i<span class="number">-1</span>]]+(rk[sa[i]]!=rk[sa[i<span class="number">-1</span>]]||rk[sa[i]+k]!=rk[sa[i<span class="number">-1</span>]+k]);</span><br><span class="line">        <span class="keyword">for</span>(reg <span class="type">int</span> i=<span class="number">1</span>;i&lt;=n;++i) rk[i]=tmp[i];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">FindChar</span><span class="params">(<span class="type">int</span> &amp;l,<span class="type">int</span> &amp;r,<span class="type">int</span> len,<span class="type">int</span> c)</span></span>&#123;</span><br><span class="line">    <span class="type">int</span> tl=l,tr=r;</span><br><span class="line">    <span class="type">int</span> lres=<span class="number">-1</span>,rres=<span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">while</span>(l&lt;=r)&#123;</span><br><span class="line">        <span class="type">int</span> mid=(l+r)&gt;&gt;<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span>(s[sa[mid]+len]&lt;=c) l=mid+<span class="number">1</span>,lres=mid;</span><br><span class="line">        <span class="keyword">else</span> r=mid<span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(lres==<span class="number">-1</span> || s[sa[lres]+len]!=c) &#123; l=<span class="number">0</span>; <span class="keyword">return</span>; &#125;</span><br><span class="line">    l=tl,r=tr;</span><br><span class="line">    <span class="keyword">while</span>(l&lt;=r)&#123;</span><br><span class="line">        <span class="type">int</span> mid=(l+r)&gt;&gt;<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span>(s[sa[mid]+len]&gt;=c) r=mid<span class="number">-1</span>,rres=mid;</span><br><span class="line">        <span class="keyword">else</span> l=mid+<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    l=rres,r=lres;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ll ans[N];</span><br><span class="line"><span class="type">int</span> ql[M],qr[M],qid[M],qnxt[M];</span><br><span class="line"><span class="type">int</span> head[N],qc;</span><br><span class="line"><span class="type">int</span> L[N],R[N];</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">BIT</span>&#123;</span><br><span class="line">    <span class="type">int</span> s[N];</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Add</span><span class="params">(<span class="type">int</span> p)</span> </span>&#123; <span class="keyword">while</span>(p&lt;=n) s[p]++,p+=p&amp;-p; &#125;</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">Que</span><span class="params">(<span class="type">int</span> p)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> res=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>(p) res+=s[p],p-=p&amp;-p;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">Que</span><span class="params">(<span class="type">int</span> l,<span class="type">int</span> r)</span></span>&#123; <span class="keyword">return</span> <span class="built_in">Que</span>(r)-<span class="built_in">Que</span>(l<span class="number">-1</span>); &#125;</span><br><span class="line">&#125; T;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Tree</span>&#123;</span><br><span class="line">    <span class="type">int</span> s[N&lt;&lt;<span class="number">2</span>];</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Build</span><span class="params">(<span class="type">int</span> p,<span class="type">int</span> l,<span class="type">int</span> r)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(l==r) &#123; s[p]=sa[l]; <span class="keyword">return</span> ;&#125;</span><br><span class="line">        <span class="type">int</span> mid=(l+r)&gt;&gt;<span class="number">1</span>;</span><br><span class="line">        <span class="built_in">Build</span>(p&lt;&lt;<span class="number">1</span>,l,mid),<span class="built_in">Build</span>(p&lt;&lt;<span class="number">1</span>|<span class="number">1</span>,mid+<span class="number">1</span>,r);</span><br><span class="line">        s[p]=<span class="built_in">min</span>(s[p&lt;&lt;<span class="number">1</span>],s[p&lt;&lt;<span class="number">1</span>|<span class="number">1</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">Que</span><span class="params">(<span class="type">int</span> p,<span class="type">int</span> l,<span class="type">int</span> r,<span class="type">int</span> ql,<span class="type">int</span> qr)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(ql&lt;=l &amp;&amp; r&lt;=qr) <span class="keyword">return</span> s[p];</span><br><span class="line">        <span class="type">int</span> mid=(l+r)&gt;&gt;<span class="number">1</span>,res=<span class="number">1e9</span>;</span><br><span class="line">        <span class="keyword">if</span>(ql&lt;=mid) <span class="built_in">cmin</span>(res,<span class="built_in">Que</span>(p&lt;&lt;<span class="number">1</span>,l,mid,ql,qr));</span><br><span class="line">        <span class="keyword">if</span>(qr&gt;mid) <span class="built_in">cmin</span>(res,<span class="built_in">Que</span>(p&lt;&lt;<span class="number">1</span>|<span class="number">1</span>,mid+<span class="number">1</span>,r,ql,qr));</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;SGT;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d%s&quot;</span>,&amp;n,s+<span class="number">1</span>);</span><br><span class="line">    <span class="built_in">Build</span>(n),<span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>,&amp;m);</span><br><span class="line">    SGT.<span class="built_in">Build</span>(<span class="number">1</span>,<span class="number">1</span>,n);</span><br><span class="line">    <span class="built_in">rep</span>(i,<span class="number">1</span>,m) &#123;</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">&quot;%s&quot;</span>,t+<span class="number">1</span>);</span><br><span class="line">        L[<span class="number">0</span>]=<span class="number">1</span>,R[<span class="number">0</span>]=n;</span><br><span class="line">        <span class="type">int</span> len=<span class="number">0</span>,pos=<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> j=<span class="number">1</span>;t[j];++j) &#123;</span><br><span class="line">            L[len=j]=L[j<span class="number">-1</span>],R[j]=R[j<span class="number">-1</span>];</span><br><span class="line">            <span class="built_in">FindChar</span>(L[j],R[j],j<span class="number">-1</span>,t[j]);</span><br><span class="line">            <span class="keyword">if</span>(!L[j])&#123; pos=<span class="number">0</span>; <span class="keyword">break</span>; &#125;</span><br><span class="line">            ans[i]+=R[j]-L[j]+<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(pos &amp;&amp; (pos=SGT.<span class="built_in">Que</span>(<span class="number">1</span>,<span class="number">1</span>,n,L[len],R[len]))&lt;n) &#123;</span><br><span class="line">            ans[i]+=pos<span class="number">-1</span>,pos++;</span><br><span class="line">            <span class="built_in">rep</span>(j,<span class="number">1</span>,len)&#123;</span><br><span class="line">                qc++,ql[qc]=L[j],qr[qc]=R[j],qid[qc]=i,qnxt[qc]=head[pos];</span><br><span class="line">                head[pos]=qc;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> ans[i]+=n;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">drep</span>(i,n,<span class="number">1</span>)&#123;</span><br><span class="line">        T.<span class="built_in">Add</span>(rk[i]);</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> j=head[i];j;j=qnxt[j]) ans[qid[j]]-=T.<span class="built_in">Que</span>(ql[j],qr[j]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">rep</span>(i,<span class="number">1</span>,m) <span class="built_in">printf</span>(<span class="string">&quot;%lld\n&quot;</span>,ans[i]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://compilationfail.github.io/oi-solutions/COCI/COCI20162017%20Contest#7%20F%20/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="orangejuice">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="orangejuice's blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | orangejuice's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/oi-solutions/COCI/COCI20162017%20Contest#7%20F%20/" class="post-title-link" itemprop="url">COCI20162017 Contest#7 F</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2023-08-12 11:05:24 / Modified: 12:37:29" itemprop="dateCreated datePublished" datetime="2023-08-12T11:05:24+08:00">2023-08-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/oi-solutions/" itemprop="url" rel="index"><span itemprop="name">oi-solutions</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="coci20162017-contest7-f">COCI20162017 Contest#7 F</h1>
<h3 id="前置知识"><a
target="_blank" rel="noopener" href="https://www.cnblogs.com/chasedeath/p/13396877.html">前置知识</a></h3>
<p>沿用上面的定义，设字符串 <span class="math inline">\(S\)</span> 的
<span class="math inline">\(\text{border}\)</span> 集合为 <span
class="math inline">\(B(S)\)</span></p>
<p>考虑对于单串 <span class="math inline">\(S\)</span> 求答案，设答案为
<span class="math inline">\(Ans\)</span></p>
<p>将所有可能出现的字符串分为两个集合 <span
class="math inline">\(A,B\)</span></p>
<p>其中 <span class="math inline">\(A\)</span> 为所有恰好出现 <span
class="math inline">\(S\)</span> 的字符串集合， <span
class="math inline">\(B\)</span> 为所有还未出现匹配的字符串集合</p>
<p>我们知道每个字符串出现有一定的概率，即为 <span
class="math inline">\(\frac{1}{n^{|T|}}\)</span></p>
<p>设 <span class="math inline">\(A\)</span> 集合中所有长度为 <span
class="math inline">\(i\)</span> 的串出现的概率总和为 <span
class="math inline">\(A_i\)</span> ，同理得到 <span
class="math inline">\(B_i\)</span></p>
<p><span class="math inline">\(A\)</span>
中的概率是不重复的，因为每个匹配过程只有一次会恰好匹配，因此可以得到
<span class="math inline">\(\sum A_i=1\)</span></p>
<p>(而 <span class="math inline">\(B\)</span>
中每个不匹配的串概率会被算多次)</p>
<p>最后的答案期望可以表示为</p>
<p>1.每个匹配的串概率*匹配时串的长度之和，即 <span
class="math inline">\(Ans=\sum_i i\cdot A_i\)</span></p>
<p>2.将匹配成功的长度，转化为匹配失败的次数之和(包含空串)，可以表示为
<span class="math inline">\(Ans=\sum B_i\)</span></p>
<p>直接计算似乎比较麻烦</p>
<p><span class="math display">\[ \ \]</span></p>
<p>考虑如果在 <span class="math inline">\(B\)</span>
中所有字符串的后面接上一个原串 <span class="math inline">\(S\)</span>
（同时概率乘上 <span class="math inline">\(\frac{1}{n^{|S|}}\)</span>
），那么得到的新字符串一定完成匹配</p>
<p>但是实际上，这样的串并不一定完全合法，因为可能在更早的位置出现匹配</p>
<p>由上面的定义，假设原先在 <span class="math inline">\(B\)</span>
中的串为 <span class="math inline">\(T\)</span> ，原先已经在 <span
class="math inline">\(S\)</span> 中匹配了 <span
class="math inline">\(T&#39;\)</span> 作为前缀</p>
<p>那么直接强行加上 <span class="math inline">\(S\)</span> 后，如果
<span class="math inline">\(T&#39;\)</span>
会影响第一个出现匹配位置，设出现匹配时加入的字符串为 <span
class="math inline">\(R\)</span></p>
<p>则显然满足: <span class="math inline">\(R\)</span> 即是 <span
class="math inline">\(S\)</span> 的一段前缀，又是 <span
class="math inline">\(S\)</span> 的一段后缀，也就是 <span
class="math inline">\(R\in B(S)\)</span></p>
<p>而剩下部分( <span class="math inline">\(|S|-|R|\)</span>
)，实际上是无效的，因此概率会被算小了</p>
<p><span class="math display">\[ \ \]</span></p>
<p>不妨设 <span class="math inline">\(B\)</span> 集合接上一个 <span
class="math inline">\(S\)</span> 串得到的集合为 <span
class="math inline">\(C\)</span></p>
<p>可以把 <span class="math inline">\(C\)</span>
中的字符串，按照多余的部分 <span class="math inline">\(|S|-|R|\)</span>
为多个部分 <span class="math inline">\(D_{R}\)</span> 其中 <span
class="math inline">\(R\in B(S)\)</span></p>
<p>发现，实际上去掉多余的部分后，每个 <span
class="math inline">\(D_R\)</span> 集合就与 <span
class="math inline">\(A\)</span> 集合对应，但是多余部分的要乘回去</p>
<p>即 <span class="math inline">\(A_i=D_{|R|,i+|S|-|R|}\cdot
n^{|S|-|R|}\)</span> (偏移多出的部分)</p>
<p>由 <span class="math inline">\(B,C\)</span> 的关系，有 <span
class="math inline">\(\sum_R D_{R,i}=C_i=B_i\cdot
\frac{1}{n^{|S|}}\)</span></p>
<p>也就是 <span class="math inline">\(B_i\frac{1}{n^{|S|}}=\sum _R
D_{R,i+|S|-|R|}=\sum _R \frac{A_{i+|S|-|R|}}{n^{|S|-|R|}}\)</span></p>
<p>即 <span class="math inline">\(B_i=\sum _R
A_{i+|S|-|R|}n^{|R|}\)</span></p>
<p>将上式求和对于 <span class="math inline">\(i\)</span> 求和，得到
<span class="math inline">\(\sum B_i=\sum_i\sum_R
A_{i+|S|-|R|}n^{|R|}\)</span></p>
<p>由于 <span class="math inline">\(\sum A_i=1\)</span> ( <span
class="math inline">\(\sum A_i\)</span> 和 <span
class="math inline">\(\sum A_{i+|S|-|R|}\)</span> 等价)， 即</p>
<p><span class="math inline">\(Ans=\sum B_i=\sum_{R\in B(S)}
n^{|R|}\)</span></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://compilationfail.github.io/oi-solutions/COCI/[COCI2010-2011#7]%20UPIT/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="orangejuice">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="orangejuice's blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | orangejuice's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/oi-solutions/COCI/%5BCOCI2010-2011#7%5D%20UPIT/" class="post-title-link" itemprop="url">[COCI2010-2011#7] UPIT</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2023-08-12 11:05:24 / Modified: 12:37:29" itemprop="dateCreated datePublished" datetime="2023-08-12T11:05:24+08:00">2023-08-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/oi-solutions/" itemprop="url" rel="index"><span itemprop="name">oi-solutions</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="coci2010-20117-upit">[COCI2010-2011#7] UPIT</h1>
<p>约定:视 <span class="math inline">\(n,q\)</span> 同阶</p>
<p>看一下题目的操作</p>
<p>1.区间赋值</p>
<p>2.区间差分加</p>
<p>3.插入元素</p>
<p>4.区间查询</p>
<p>我们知道1,2操作都是可以用懒标记维护的，具体过程可能有一点细节</p>
<p>1.记录区间差分加的过程，要记录等差数列首项和公差，两个等差数列相加直接首项和公差都相加即可</p>
<p>2.区间赋值的优先级要高于加法，即打上赋值标记就要清空加法标记，标记下传时注意先下传赋值标记</p>
<p>然后具体问题落到如何实现插入元素这个操作上</p>
<h3 id="块状链表">块状链表</h3>
<p>对于静态的数组，可以直接静态分块来做</p>
<p>而要动态插入时，找到对应块，插入即可，但是涉及到编号问题</p>
<p>所以需要每个块维护一个 <span class="math inline">\(Size\)</span>
，块内每个元素维护一个标号 <span class="math inline">\(id_i\)</span></p>
<p>同时需要对于块的 <span class="math inline">\(Size\)</span> 累前缀和
<span class="math inline">\(SumSize\)</span> ，则块 <span
class="math inline">\(i\)</span> 内编号为 <span
class="math inline">\(j\)</span> 的元素在数组中的实际编号为 <span
class="math inline">\(SumSize_{i-1}+j\)</span></p>
<p>插入时把整个块内的元素取出重新标号即可</p>
<p>但是这样插入后，一个块的 <span class="math inline">\(Size\)</span>
会变大，再实现分块的操作时复杂度没有保证</p>
<p>因此需要加入一个操作:当 <span class="math inline">\(Size_i&gt;2\sqrt
n\)</span> 时, <span class="math inline">\(O(n)\)</span>
重构整个序列，这样每 <span class="math inline">\(\sqrt n\)</span>
次插入操作会导致一次重构，复杂度为均摊的 <span
class="math inline">\(O(n\sqrt n)\)</span></p>
<p>然后可以用类似分块的方法来直接维护</p>
<p><span class="math display">\[ \ \]</span></p>
<h3 id="线段树">线段树</h3>
<p>静态的操作线段树可以直接维护</p>
<p>在线段树上额外维护一个01，表示这个元素是否出现</p>
<p>将插入操作转化为在让对应位置的0变为1，但是由于不知道插入后的位置，所以不能直接操作</p>
<p>于是有两种解决办法</p>
<h4 id="暴力值域">暴力值域</h4>
<p>静态情况下我们对于 <span class="math inline">\([1,n]\)</span>
建树，但是动态可以对于 <span class="math inline">\([1,n\cdot q]\)</span>
建函数式线段树</p>
<h3 id="离线">离线</h3>
<p>离线维护，预处理出插入的位置</p>
<p><span class="math display">\[ \ \]</span></p>
<h3 id="平衡树">平衡树</h3>
<p><del>下面是安利时间</del></p>
<p>来学Treap吧</p>
<p>它可以</p>
<p>1.查询k大</p>
<p>2.插入元素</p>
<p>3.区间修改</p>
<p>4.区间翻转</p>
<p>5.可持久化!!</p>
<p><del>6.吊打Splay</del></p>
<p>Treap 即树堆，意思是在满足二叉查找树的性质同时满足二叉堆的性质</p>
<p>给定每个节点一个额外的随机权值，让二叉查找树对于这个权值满足堆的性质即可</p>
<p>这样构造的二叉查找树，树高是 <span class="math inline">\(O(\log
n)\)</span> 的</p>
<h4 id="带旋treap">带旋Treap</h4>
<p>像普通二叉查找树一样每次插入节点到叶子位置后，可能不满足二叉堆的性质，因此需要不断向上zig/zag来调整满足</p>
<p>区间操作可以尝试像写线段树一样写</p>
<p>但是它不可持久化</p>
<h4 id="非旋treap">非旋Treap</h4>
<p>维护两个基础操作</p>
<p>1.平衡树合并，操作需要满足两棵树的大小顺序确定，返回新的根</p>
<p>2.平衡树分裂为 <span class="math inline">\([1,d],[d+1,n]\)</span>
的两部分，返回两棵树的根</p>
<p>1.合并操作 <span class="math inline">\(x,y\)</span></p>
<p>按照节点的权值比较谁是平衡树的根，然后将根的左/右子树与另一棵树合并作为新的子树，递归实现</p>
<p>2.分裂 <span class="math inline">\(x,d\)</span></p>
<p>维护 <span class="math inline">\(Size\)</span>
判断是要分裂左子树还是右子树，将子树分裂得到的部分作为 <span
class="math inline">\(x\)</span> 新的子树，递归实现即可</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> pair &lt;<span class="type">int</span>,<span class="type">int</span>&gt; Pii;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> mp make_pair</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Union</span><span class="params">(<span class="type">int</span> x,<span class="type">int</span> y)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(!x || !y) <span class="keyword">return</span> x|y;</span><br><span class="line">	<span class="built_in">Down</span>(x),<span class="built_in">Down</span>(y);</span><br><span class="line">	<span class="keyword">if</span>(key[x]&lt;key[y]) <span class="keyword">return</span> rs[x]=<span class="built_in">Union</span>(rs[x],y),<span class="built_in">Up</span>(x),x;</span><br><span class="line">	<span class="keyword">return</span> ls[y]=<span class="built_in">Union</span>(x,ls[y]),<span class="built_in">Up</span>(y),y;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Pii <span class="title">Split</span><span class="params">(<span class="type">int</span> x,<span class="type">int</span> d)</span></span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(!x) <span class="keyword">return</span> <span class="built_in">mp</span>(x,x);</span><br><span class="line">	<span class="keyword">if</span>(sz[x]&lt;=d) <span class="keyword">return</span> <span class="built_in">mp</span>(x,<span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span>(d==<span class="number">0</span>) <span class="keyword">return</span> <span class="built_in">mp</span>(<span class="number">0</span>,x);</span><br><span class="line">	<span class="built_in">Down</span>(x);</span><br><span class="line">	<span class="keyword">if</span>(sz[ls[x]]+<span class="number">1</span>&lt;=d) &#123;</span><br><span class="line">		Pii y=<span class="built_in">Split</span>(rs[x],d-sz[ls[x]]<span class="number">-1</span>);</span><br><span class="line">		<span class="keyword">return</span> rs[x]=y.first,<span class="built_in">Up</span>(x),<span class="built_in">mp</span>(x,y.second);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		Pii y=<span class="built_in">Split</span>(ls[x],d);</span><br><span class="line">		<span class="keyword">return</span> ls[x]=y.second,<span class="built_in">Up</span>(x),<span class="built_in">mp</span>(y.first,x);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>插入操作可以分裂前 <span class="math inline">\(k\)</span>
个，将新节点和得到的两棵树按次合并</p>
<p>区间更新可以分裂两次，将对应区间的子树操作即可</p>
<h2 id="code">Code</h2>
<p>块状链表</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> GCC optimize(2)</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">double</span> db;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">long</span> <span class="type">double</span> ldb;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">long</span> <span class="type">long</span> ll;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> ull;</span><br><span class="line"><span class="keyword">typedef</span> pair &lt;<span class="type">int</span>,<span class="type">int</span>&gt; Pii;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> reg register</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> pb push_back</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> mp make_pair</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> Mod1(x) ((x&gt;=P)&amp;&amp;(x-=P))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> Mod2(x) ((x&lt;0)&amp;&amp;(x+=P))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> rep(i,a,b) for(int i=a,i##end=b;i&lt;=i##end;++i)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> drep(i,a,b) for(int i=a,i##end=b;i&gt;=i##end;--i)</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt; <span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">cmin</span><span class="params">(T &amp;a,T b)</span></span>&#123; ((a&gt;b)&amp;&amp;(a=b)); &#125;</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt; <span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">cmax</span><span class="params">(T &amp;a,T b)</span></span>&#123; ((a&lt;b)&amp;&amp;(a=b)); &#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="type">char</span> IO;</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">T</span>=<span class="type">int</span>&gt; T <span class="built_in">rd</span>()&#123;</span><br><span class="line">    T s=<span class="number">0</span>; <span class="type">int</span> f=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(!<span class="built_in">isdigit</span>(IO=<span class="built_in">getchar</span>())) <span class="keyword">if</span>(IO==<span class="string">&#x27;-&#x27;</span>) f=<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">do</span> s=(s&lt;&lt;<span class="number">1</span>)+(s&lt;&lt;<span class="number">3</span>)+(IO^<span class="string">&#x27;0&#x27;</span>);</span><br><span class="line">    <span class="keyword">while</span>(<span class="built_in">isdigit</span>(IO=<span class="built_in">getchar</span>()));</span><br><span class="line">    <span class="keyword">return</span> f?-s:s;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">const</span> <span class="type">int</span> N=<span class="number">2e5</span>+<span class="number">10</span>;</span><br><span class="line"> </span><br><span class="line"><span class="type">int</span> n,m,cnt;</span><br><span class="line"><span class="type">int</span> head[N],nxt[N],sz[N];</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Node</span>&#123; <span class="type">int</span> rk,id; &#125; E[N];</span><br><span class="line">ll s[N],st[N],t[N],d[N],a[N]; </span><br><span class="line"><span class="type">int</span> ssz[N];</span><br><span class="line"> </span><br><span class="line"><span class="function">ll <span class="title">Get</span><span class="params">(ll l,ll r)</span></span>&#123; <span class="keyword">return</span> (r-l+<span class="number">1</span>)*(l+r)/<span class="number">2</span>; &#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Down</span><span class="params">(<span class="type">int</span> p)</span> </span>&#123;</span><br><span class="line">    s[p]=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=head[p];i;i=nxt[i]) &#123;</span><br><span class="line">        <span class="keyword">if</span>(~st[p]) a[E[i].id]=st[p];</span><br><span class="line">        a[E[i].id]+=<span class="number">1ll</span>*(E[i].rk<span class="number">-1</span>)*d[p]+t[p];</span><br><span class="line">        s[p]+=a[E[i].id];</span><br><span class="line">    &#125;</span><br><span class="line">    st[p]=<span class="number">-1</span>,t[p]=d[p]=<span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Up</span><span class="params">(<span class="type">int</span> p)</span> </span>&#123;</span><br><span class="line">    s[p]=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=head[p];i;i=nxt[i]) s[p]+=a[E[i].id];</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Build</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">sort</span>(E+<span class="number">1</span>,E+n+<span class="number">1</span>,[&amp;](Node x,Node y)&#123; <span class="keyword">return</span> x.rk&lt;y.rk; &#125;);</span><br><span class="line">    <span class="built_in">rep</span>(i,<span class="number">0</span>,cnt) sz[i]=head[i]=<span class="number">0</span>,st[i]=<span class="number">-1</span>;</span><br><span class="line">    <span class="built_in">rep</span>(i,<span class="number">1</span>,n) &#123;</span><br><span class="line">        <span class="type">int</span> p=i/cnt+<span class="number">1</span>;</span><br><span class="line">        nxt[i]=head[p],E[i].rk=++sz[p];</span><br><span class="line">        head[p]=i;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">rep</span>(i,<span class="number">1</span>,cnt) ssz[i]=ssz[i<span class="number">-1</span>]+sz[i],<span class="built_in">Up</span>(i);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Break</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">rep</span>(i,<span class="number">1</span>,cnt) &#123;</span><br><span class="line">        sz[i]+=sz[i<span class="number">-1</span>],<span class="built_in">Down</span>(i);</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> j=head[i];j;j=nxt[j]) E[j].rk+=sz[i<span class="number">-1</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">Build</span>();</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Get</span><span class="params">(<span class="type">int</span> x)</span></span>&#123;</span><br><span class="line">    x--;</span><br><span class="line">    <span class="type">int</span> l=<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span>(sz[l]&lt;=x) x-=sz[l++];</span><br><span class="line">    <span class="keyword">return</span> l;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Insert</span><span class="params">(<span class="type">int</span> p,<span class="type">int</span> x)</span></span>&#123;</span><br><span class="line">    <span class="type">int</span> l=p&lt;=n?<span class="built_in">Get</span>(p):cnt;</span><br><span class="line">    <span class="built_in">Down</span>(l),p-=ssz[l<span class="number">-1</span>];</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=head[l];i;i=nxt[i]) <span class="keyword">if</span>(E[i].rk&gt;=p) E[i].rk++;</span><br><span class="line">    a[++n]=x,E[n]=(Node)&#123;p,n&#125;,nxt[n]=head[l],head[l]=n;</span><br><span class="line">    sz[l]++,s[l]+=x;</span><br><span class="line">    <span class="keyword">if</span>(sz[l]&gt;cnt*<span class="number">2.4</span>) <span class="built_in">Break</span>();</span><br><span class="line">    <span class="built_in">rep</span>(i,<span class="number">1</span>,cnt) ssz[i]=ssz[i<span class="number">-1</span>]+sz[i];</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Set</span><span class="params">(<span class="type">int</span> l,<span class="type">int</span> r,<span class="type">int</span> x)</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> p1=<span class="built_in">Get</span>(l),p2=<span class="built_in">Get</span>(r);</span><br><span class="line">    <span class="keyword">if</span>(p1==p2) &#123;</span><br><span class="line">        <span class="built_in">Down</span>(p1);</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=head[p1];i;i=nxt[i]) <span class="keyword">if</span>(ssz[p1<span class="number">-1</span>]+E[i].rk&gt;=l &amp;&amp; ssz[p1<span class="number">-1</span>]+E[i].rk&lt;=r) a[E[i].id]=x;</span><br><span class="line">        <span class="built_in">Up</span>(p1);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">Down</span>(p1),<span class="built_in">Down</span>(p2);</span><br><span class="line">    s[p1]=s[p2]=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=head[p1];i;i=nxt[i]) &#123;</span><br><span class="line">        <span class="keyword">if</span>(ssz[p1<span class="number">-1</span>]+E[i].rk&gt;=l) a[E[i].id]=x;</span><br><span class="line">        s[p1]+=a[E[i].id];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=head[p2];i;i=nxt[i]) &#123;</span><br><span class="line">        <span class="keyword">if</span>(ssz[p2<span class="number">-1</span>]+E[i].rk&lt;=r) a[E[i].id]=x;</span><br><span class="line">        s[p2]+=a[E[i].id];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">rep</span>(i,p1+<span class="number">1</span>,p2<span class="number">-1</span>) st[i]=x,d[i]=t[i]=<span class="number">0</span>,s[i]=<span class="number">1ll</span>*x*sz[i];</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Add</span><span class="params">(<span class="type">int</span> l,<span class="type">int</span> r,<span class="type">int</span> x)</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> p1=<span class="built_in">Get</span>(l),p2=<span class="built_in">Get</span>(r);</span><br><span class="line">    <span class="keyword">if</span>(p1==p2) &#123;</span><br><span class="line">        <span class="built_in">Down</span>(p1);</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=head[p1];i;i=nxt[i]) <span class="keyword">if</span>(ssz[p1<span class="number">-1</span>]+E[i].rk&gt;=l &amp;&amp; ssz[p1<span class="number">-1</span>]+E[i].rk&lt;=r) a[E[i].id]+=<span class="number">1ll</span>*(ssz[p1<span class="number">-1</span>]+E[i].rk-l+<span class="number">1</span>)*x;</span><br><span class="line">        <span class="built_in">Up</span>(p1);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">Down</span>(p1),<span class="built_in">Down</span>(p2);</span><br><span class="line">    s[p1]=s[p2]=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=head[p1];i;i=nxt[i]) &#123;</span><br><span class="line">        <span class="keyword">if</span>(ssz[p1<span class="number">-1</span>]+E[i].rk&gt;=l) a[E[i].id]+=<span class="number">1ll</span>*(ssz[p1<span class="number">-1</span>]+E[i].rk-l+<span class="number">1</span>)*x;</span><br><span class="line">        s[p1]+=a[E[i].id];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=head[p2];i;i=nxt[i]) &#123;</span><br><span class="line">        <span class="keyword">if</span>(ssz[p2<span class="number">-1</span>]+E[i].rk&lt;=r) a[E[i].id]+=<span class="number">1ll</span>*(ssz[p2<span class="number">-1</span>]+E[i].rk-l+<span class="number">1</span>)*x;</span><br><span class="line">        s[p2]+=a[E[i].id];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">rep</span>(i,p1+<span class="number">1</span>,p2<span class="number">-1</span>) &#123;</span><br><span class="line">        t[i]+=<span class="number">1ll</span>*(ssz[i<span class="number">-1</span>]-l+<span class="number">2</span>)*x,d[i]+=x;</span><br><span class="line">        s[i]+=<span class="built_in">Get</span>(ssz[i<span class="number">-1</span>]-l+<span class="number">2</span>,ssz[i]-l+<span class="number">1</span>)*x;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function">ll <span class="title">Que</span><span class="params">(<span class="type">int</span> l,<span class="type">int</span> r)</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> p1=<span class="built_in">Get</span>(l),p2=<span class="built_in">Get</span>(r);</span><br><span class="line">    ll ans=<span class="number">0</span>;</span><br><span class="line">    <span class="built_in">Down</span>(p1),<span class="built_in">Down</span>(p2);</span><br><span class="line">    <span class="keyword">if</span>(p1==p2) &#123;</span><br><span class="line">        <span class="built_in">Down</span>(p1);</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=head[p1];i;i=nxt[i]) <span class="keyword">if</span>(ssz[p1<span class="number">-1</span>]+E[i].rk&gt;=l &amp;&amp; ssz[p1<span class="number">-1</span>]+E[i].rk&lt;=r) ans+=a[E[i].id];</span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">Down</span>(p1),<span class="built_in">Down</span>(p2);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=head[p1];i;i=nxt[i]) <span class="keyword">if</span>(ssz[p1<span class="number">-1</span>]+E[i].rk&gt;=l) ans+=a[E[i].id];</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=head[p2];i;i=nxt[i]) <span class="keyword">if</span>(ssz[p2<span class="number">-1</span>]+E[i].rk&lt;=r) ans+=a[E[i].id];</span><br><span class="line">    <span class="built_in">rep</span>(i,p1+<span class="number">1</span>,p2<span class="number">-1</span>) ans+=s[i];</span><br><span class="line">    <span class="keyword">return</span> ans;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    n=<span class="built_in">rd</span>(),m=<span class="built_in">rd</span>();</span><br><span class="line">    cnt=<span class="built_in">ceil</span>(<span class="built_in">sqrt</span>(n+m));</span><br><span class="line">    <span class="built_in">rep</span>(i,<span class="number">1</span>,n) a[i]=<span class="built_in">rd</span>(),E[i]=(Node)&#123;i,i&#125;;</span><br><span class="line">    <span class="built_in">Build</span>();</span><br><span class="line">    <span class="built_in">rep</span>(i,<span class="number">1</span>,m) &#123;</span><br><span class="line">        <span class="type">int</span> opt=<span class="built_in">rd</span>();</span><br><span class="line">        <span class="keyword">if</span>(opt==<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="type">int</span> l=<span class="built_in">rd</span>(),r=<span class="built_in">rd</span>(),x=<span class="built_in">rd</span>();</span><br><span class="line">            <span class="built_in">Set</span>(l,r,x);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(opt==<span class="number">2</span>) &#123;</span><br><span class="line">            <span class="type">int</span> l=<span class="built_in">rd</span>(),r=<span class="built_in">rd</span>(),x=<span class="built_in">rd</span>();</span><br><span class="line">            <span class="built_in">Add</span>(l,r,x);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(opt==<span class="number">3</span>) &#123;</span><br><span class="line">            <span class="type">int</span> p=<span class="built_in">rd</span>(),x=<span class="built_in">rd</span>();</span><br><span class="line">            <span class="built_in">Insert</span>(p,x);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(opt==<span class="number">4</span>) &#123;</span><br><span class="line">            <span class="type">int</span> l=<span class="built_in">rd</span>(),r=<span class="built_in">rd</span>();</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%lld\n&quot;</span>,<span class="built_in">Que</span>(l,r));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br></pre></td></tr></table></figure>
<p>旋Treap:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="comment">//#pragma GCC optimize(2)</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">double</span> db;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">long</span> <span class="type">double</span> ldb;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">long</span> <span class="type">long</span> ll;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> ull;</span><br><span class="line"><span class="keyword">typedef</span> pair &lt;<span class="type">int</span>,<span class="type">int</span>&gt; Pii;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> reg register</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> pb push_back</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> mp make_pair</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> Mod1(x) ((x&gt;=P)&amp;&amp;(x-=P))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> Mod2(x) ((x&lt;0)&amp;&amp;(x+=P))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> rep(i,a,b) for(int i=a,i##end=b;i&lt;=i##end;++i)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> drep(i,a,b) for(int i=a,i##end=b;i&gt;=i##end;--i)</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt; <span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">cmin</span><span class="params">(T &amp;a,T b)</span></span>&#123; ((a&gt;b)&amp;&amp;(a=b)); &#125;</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt; <span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">cmax</span><span class="params">(T &amp;a,T b)</span></span>&#123; ((a&lt;b)&amp;&amp;(a=b)); &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">char</span> IO;</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">T</span>=<span class="type">int</span>&gt; T <span class="built_in">rd</span>()&#123;</span><br><span class="line">	T s=<span class="number">0</span>; <span class="type">int</span> f=<span class="number">0</span>;</span><br><span class="line">	<span class="keyword">while</span>(!<span class="built_in">isdigit</span>(IO=<span class="built_in">getchar</span>())) <span class="keyword">if</span>(IO==<span class="string">&#x27;-&#x27;</span>) f=<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">do</span> s=(s&lt;&lt;<span class="number">1</span>)+(s&lt;&lt;<span class="number">3</span>)+(IO^<span class="string">&#x27;0&#x27;</span>);</span><br><span class="line">	<span class="keyword">while</span>(<span class="built_in">isdigit</span>(IO=<span class="built_in">getchar</span>()));</span><br><span class="line">	<span class="keyword">return</span> f?-s:s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> N=<span class="number">2e5</span>+<span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> n;</span><br><span class="line"><span class="type">int</span> rt,son[N][<span class="number">2</span>],fa[N];</span><br><span class="line">ll s[N],t[N],d[N],st[N],val[N];</span><br><span class="line">ll sz[N],key[N];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Up</span><span class="params">(<span class="type">int</span> p)</span> </span>&#123;</span><br><span class="line">	s[p]=s[son[p][<span class="number">0</span>]]+s[son[p][<span class="number">1</span>]]+val[p];</span><br><span class="line">	sz[p]=sz[son[p][<span class="number">0</span>]]+sz[son[p][<span class="number">1</span>]]+<span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Set</span><span class="params">(<span class="type">int</span> p,ll x)</span></span>&#123;</span><br><span class="line">	t[p]=d[p]=<span class="number">0</span>,st[p]=val[p]=x,s[p]=sz[p]*x;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Add</span><span class="params">(<span class="type">int</span> p,ll x,ll d)</span> </span>&#123;</span><br><span class="line">	val[p]+=x+d*sz[son[p][<span class="number">0</span>]];</span><br><span class="line">	s[p]+=sz[p]*(sz[p]<span class="number">-1</span>)/<span class="number">2</span>*d+x*sz[p];</span><br><span class="line">	t[p]+=x,::d[p]+=d;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Down</span><span class="params">(<span class="type">int</span> p)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(~st[p]) <span class="built_in">Set</span>(son[p][<span class="number">0</span>],st[p]),<span class="built_in">Set</span>(son[p][<span class="number">1</span>],st[p]),st[p]=<span class="number">-1</span>;</span><br><span class="line">	<span class="keyword">if</span>(t[p] || d[p]) <span class="built_in">Add</span>(son[p][<span class="number">0</span>],t[p],d[p]),<span class="built_in">Add</span>(son[p][<span class="number">1</span>],t[p]+(sz[son[p][<span class="number">0</span>]]+<span class="number">1</span>)*d[p],d[p]),t[p]=d[p]=<span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">rotate</span><span class="params">(<span class="type">int</span> u)</span> </span>&#123;</span><br><span class="line">	<span class="type">int</span> f=fa[u],ff=fa[f],d=son[f][<span class="number">1</span>]==u;</span><br><span class="line">	fa[u]=ff; <span class="keyword">if</span>(ff) son[ff][son[ff][<span class="number">1</span>]==f]=u;</span><br><span class="line">	son[f][d]=son[u][!d]; <span class="keyword">if</span>(son[u][!d]) fa[son[u][!d]]=f;</span><br><span class="line">	son[u][!d]=f,fa[f]=u;</span><br><span class="line">	<span class="built_in">Up</span>(f),<span class="built_in">Up</span>(u);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Insert</span><span class="params">(<span class="type">int</span> p,<span class="type">int</span> x)</span></span>&#123;</span><br><span class="line">	<span class="type">int</span> v=++n;</span><br><span class="line">	val[v]=s[v]=x,sz[v]=<span class="number">1</span>,st[v]=<span class="number">-1</span>,key[v]=<span class="built_in">rand</span>();</span><br><span class="line">	<span class="keyword">if</span>(!rt)&#123; rt=v; <span class="keyword">return</span>; &#125;</span><br><span class="line">	<span class="type">int</span> u=rt;</span><br><span class="line">	<span class="keyword">while</span>(u) &#123;</span><br><span class="line">		<span class="built_in">Down</span>(u);</span><br><span class="line">		<span class="keyword">if</span>(sz[son[u][<span class="number">0</span>]]&gt;=p) &#123;</span><br><span class="line">			<span class="keyword">if</span>(!son[u][<span class="number">0</span>]) &#123; son[fa[v]=u][<span class="number">0</span>]=v; <span class="keyword">break</span>; &#125;</span><br><span class="line">			u=son[u][<span class="number">0</span>]; </span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			p-=sz[son[u][<span class="number">0</span>]]+<span class="number">1</span>;</span><br><span class="line">			<span class="keyword">if</span>(!son[u][<span class="number">1</span>]) &#123; son[fa[v]=u][<span class="number">1</span>]=v; <span class="keyword">break</span>; &#125;</span><br><span class="line">			u=son[u][<span class="number">1</span>];</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">while</span>(fa[v] &amp;&amp; key[v]&lt;key[fa[v]]) <span class="built_in">rotate</span>(v);</span><br><span class="line">	<span class="keyword">if</span>(!fa[v]) rt=v;</span><br><span class="line">	<span class="keyword">while</span>(fa[v]) <span class="built_in">Up</span>(v=fa[v]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Set</span><span class="params">(<span class="type">int</span> p,<span class="type">int</span> l,<span class="type">int</span> r,<span class="type">int</span> x)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(!p || r&lt;=<span class="number">0</span> || l&gt;sz[p]) <span class="keyword">return</span>;</span><br><span class="line">	<span class="keyword">if</span>(l&lt;=<span class="number">1</span> &amp;&amp; r&gt;=sz[p]) <span class="keyword">return</span> <span class="built_in">Set</span>(p,x);</span><br><span class="line">	<span class="type">int</span> t=sz[son[p][<span class="number">0</span>]]+<span class="number">1</span>;</span><br><span class="line">	<span class="built_in">Down</span>(p),<span class="built_in">Set</span>(son[p][<span class="number">0</span>],l,r,x),<span class="built_in">Set</span>(son[p][<span class="number">1</span>],l-t,r-t,x);</span><br><span class="line">	<span class="keyword">if</span>(t&gt;=l &amp;&amp; t&lt;=r) val[p]=x;</span><br><span class="line">	<span class="built_in">Up</span>(p);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Add</span><span class="params">(<span class="type">int</span> p,<span class="type">int</span> l,<span class="type">int</span> r,ll x,ll d)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(!p || r&lt;=<span class="number">0</span> || l&gt;sz[p]) <span class="keyword">return</span>;</span><br><span class="line">	<span class="keyword">if</span>(l&lt;=<span class="number">1</span> &amp;&amp; r&gt;=sz[p]) <span class="keyword">return</span> <span class="built_in">Add</span>(p,x,d);</span><br><span class="line">	<span class="type">int</span> t=sz[son[p][<span class="number">0</span>]]+<span class="number">1</span>;</span><br><span class="line">	<span class="built_in">Down</span>(p),<span class="built_in">Add</span>(son[p][<span class="number">0</span>],l,r,x,d),<span class="built_in">Add</span>(son[p][<span class="number">1</span>],l-t,r-t,x+d*t,d);</span><br><span class="line">	<span class="keyword">if</span>(t&gt;=l &amp;&amp; t&lt;=r) val[p]+=(t<span class="number">-1</span>)*d+x;</span><br><span class="line">	<span class="built_in">Up</span>(p);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">ll <span class="title">Que</span><span class="params">(<span class="type">int</span> p,<span class="type">int</span> l,<span class="type">int</span> r)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(!p || r&lt;=<span class="number">0</span> || l&gt;sz[p]) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span>(l&lt;=<span class="number">1</span> &amp;&amp; r&gt;=sz[p]) <span class="keyword">return</span> s[p];</span><br><span class="line">	ll t=sz[son[p][<span class="number">0</span>]]+<span class="number">1</span>,res=<span class="number">0</span>;</span><br><span class="line">	<span class="built_in">Down</span>(p),res+=<span class="built_in">Que</span>(son[p][<span class="number">0</span>],l,r),res+=<span class="built_in">Que</span>(son[p][<span class="number">1</span>],l-t,r-t);</span><br><span class="line">	<span class="keyword">if</span>(t&gt;=l &amp;&amp; t&lt;=r) res+=val[p];</span><br><span class="line">	<span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="type">int</span> n=<span class="built_in">rd</span>(),m=<span class="built_in">rd</span>();</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">0</span>,n<span class="number">-1</span>) <span class="built_in">Insert</span>(i,<span class="built_in">rd</span>());</span><br><span class="line">	<span class="keyword">while</span>(m--) &#123;</span><br><span class="line">		<span class="type">int</span> opt=<span class="built_in">rd</span>();</span><br><span class="line">		<span class="keyword">if</span>(opt==<span class="number">1</span>) &#123;</span><br><span class="line">			<span class="type">int</span> l=<span class="built_in">rd</span>(),r=<span class="built_in">rd</span>();</span><br><span class="line">			<span class="built_in">Set</span>(rt,l,r,<span class="built_in">rd</span>());</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span>(opt==<span class="number">2</span>) &#123;</span><br><span class="line">			<span class="type">int</span> l=<span class="built_in">rd</span>(),r=<span class="built_in">rd</span>(),x=<span class="built_in">rd</span>();</span><br><span class="line">			<span class="built_in">Add</span>(rt,l,r,x<span class="number">-1ll</span>*(l<span class="number">-1</span>)*x,x);</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span>(opt==<span class="number">3</span>) &#123;</span><br><span class="line">			<span class="type">int</span> x=<span class="built_in">rd</span>(),y=<span class="built_in">rd</span>();</span><br><span class="line">			<span class="built_in">Insert</span>(x<span class="number">-1</span>,y);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="type">int</span> l=<span class="built_in">rd</span>(),r=<span class="built_in">rd</span>();</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;%lld\n&quot;</span>,<span class="built_in">Que</span>(rt,l,r));</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>非旋Treap:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">long</span> <span class="type">long</span> ll;</span><br><span class="line"><span class="keyword">typedef</span> pair &lt;<span class="type">int</span>,<span class="type">int</span>&gt; Pii;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> mp make_pair</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">rd</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="type">char</span> c;<span class="type">int</span> s=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>((c=<span class="built_in">getchar</span>())&lt;<span class="number">48</span>);</span><br><span class="line">    <span class="keyword">do</span> s=s*<span class="number">10</span>+c<span class="number">-48</span>;</span><br><span class="line">    <span class="keyword">while</span>((c=<span class="built_in">getchar</span>())&gt;<span class="number">47</span>);</span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">enum</span>&#123;N=<span class="number">200010</span>&#125;;</span><br><span class="line"><span class="type">int</span> n,m,rt,ls[N],rs[N],key[N];</span><br><span class="line">ll s[N],t[N],d[N],st[N],val[N],sz[N];</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">Up</span><span class="params">(<span class="type">int</span> p)</span> </span>&#123;</span><br><span class="line">    s[p]=s[ls[p]]+s[rs[p]]+val[p];</span><br><span class="line">    sz[p]=sz[ls[p]]+sz[rs[p]]+<span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">Set</span><span class="params">(<span class="type">int</span> p,ll x)</span></span>&#123; t[p]=d[p]=<span class="number">0</span>,st[p]=val[p]=x,s[p]=sz[p]*x; &#125;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">Add</span><span class="params">(<span class="type">int</span> p,ll x,ll d)</span> </span>&#123;</span><br><span class="line">    val[p]+=x+d*sz[ls[p]];</span><br><span class="line">    s[p]+=sz[p]*(sz[p]<span class="number">-1</span>)/<span class="number">2</span>*d+x*sz[p];</span><br><span class="line">    t[p]+=x,::d[p]+=d;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">Down</span><span class="params">(<span class="type">int</span> p)</span> </span>&#123;</span><br><span class="line">    ~st[p] &amp;&amp; (<span class="built_in">Set</span>(ls[p],st[p]),<span class="built_in">Set</span>(rs[p],st[p]),st[p]=<span class="number">-1</span>);</span><br><span class="line">    (t[p] || d[p]) &amp;&amp; (<span class="built_in">Add</span>(ls[p],t[p],d[p]),<span class="built_in">Add</span>(rs[p],t[p]+(sz[ls[p]]+<span class="number">1</span>)*d[p],d[p]),t[p]=d[p]=<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Union</span><span class="params">(<span class="type">int</span> x,<span class="type">int</span> y)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!x || !y) <span class="keyword">return</span> x|y;</span><br><span class="line">    <span class="keyword">return</span> key[x]&lt;key[y]?(<span class="built_in">Down</span>(x),rs[x]=<span class="built_in">Union</span>(rs[x],y),<span class="built_in">Up</span>(x),x):(<span class="built_in">Down</span>(y),ls[y]=<span class="built_in">Union</span>(x,ls[y]),<span class="built_in">Up</span>(y),y);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">Pii <span class="title">Split</span><span class="params">(<span class="type">int</span> x,<span class="type">int</span> d)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(sz[x]&lt;=d) <span class="keyword">return</span> <span class="built_in">mp</span>(x,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(d==<span class="number">0</span>) <span class="keyword">return</span> <span class="built_in">mp</span>(<span class="number">0</span>,x);</span><br><span class="line">    <span class="built_in">Down</span>(x);</span><br><span class="line">    <span class="keyword">if</span>(sz[ls[x]]+<span class="number">1</span>&lt;=d) &#123;</span><br><span class="line">        Pii y=<span class="built_in">Split</span>(rs[x],d-sz[ls[x]]<span class="number">-1</span>);</span><br><span class="line">        <span class="keyword">return</span> rs[x]=y.first,<span class="built_in">Up</span>(x),<span class="built_in">mp</span>(x,y.second);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Pii y=<span class="built_in">Split</span>(ls[x],d);</span><br><span class="line">        <span class="keyword">return</span> ls[x]=y.second,<span class="built_in">Up</span>(x),<span class="built_in">mp</span>(y.first,x);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    n=<span class="built_in">rd</span>(),m=<span class="built_in">rd</span>();</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">1</span>;i&lt;=n+m;++i) key[i]=<span class="built_in">rand</span>(),st[i]=<span class="number">-1</span>,sz[i]=<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">1</span>;i&lt;=n;++i) val[i]=s[i]=<span class="built_in">rd</span>(),rt=<span class="built_in">Union</span>(rt,i);</span><br><span class="line">    <span class="keyword">while</span>(m--)&#123;</span><br><span class="line">        <span class="type">int</span> opt=<span class="built_in">rd</span>();</span><br><span class="line">        <span class="keyword">if</span>(opt==<span class="number">3</span>) &#123;</span><br><span class="line">            Pii t=<span class="built_in">Split</span>(rt,<span class="built_in">rd</span>()<span class="number">-1</span>); ++n,val[n]=s[n]=<span class="built_in">rd</span>();</span><br><span class="line">            rt=<span class="built_in">Union</span>(<span class="built_in">Union</span>(t.first,n),t.second);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">int</span> l=<span class="built_in">rd</span>(),r=<span class="built_in">rd</span>();</span><br><span class="line">            Pii a=<span class="built_in">Split</span>(rt,l<span class="number">-1</span>),b=<span class="built_in">Split</span>(a.second,r-l+<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">if</span>(opt==<span class="number">1</span>) <span class="built_in">Set</span>(b.first,<span class="built_in">rd</span>());</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(opt==<span class="number">2</span>) &#123;<span class="type">int</span> x=<span class="built_in">rd</span>(); <span class="built_in">Add</span>(b.first,x,x); &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(opt==<span class="number">4</span>) <span class="built_in">printf</span>(<span class="string">&quot;%lld\n&quot;</span>,s[b.first]);</span><br><span class="line">            rt=<span class="built_in">Union</span>(<span class="built_in">Union</span>(a.first,b.first),b.second);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://compilationfail.github.io/oi-solutions/COCI/[COCI2010-2011#2]%20CRNI/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="orangejuice">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="orangejuice's blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | orangejuice's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/oi-solutions/COCI/%5BCOCI2010-2011#2%5D%20CRNI/" class="post-title-link" itemprop="url">[COCI2010-2011#2] CRNI(单调栈)</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2023-08-12 11:05:24 / Modified: 12:37:29" itemprop="dateCreated datePublished" datetime="2023-08-12T11:05:24+08:00">2023-08-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/oi-solutions/" itemprop="url" rel="index"><span itemprop="name">oi-solutions</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="coci2010-20112-crni单调栈">[COCI2010-2011#2] CRNI(单调栈)</h1>
<h2 id="问题分析">问题分析</h2>
<p>首先考虑两个不相交的矩形可能存在的位置关系，我将其分成</p>
<p>1.左右</p>
<p>2.上下</p>
<p>3.左上右下</p>
<p>4.左下右上</p>
<p>发现1,2,3,4之间有相交,考虑四种情况的答案应该是1+2-3-4</p>
<h2 id="统计方法">统计方法</h2>
<p>核心: 统计以一个点作为顶点的矩形数量</p>
<p>以统计 <span class="math inline">\(i,j\)</span>
为右下角的矩形为例，先不考虑矩形大小&gt;1的限制</p>
<p>显然可以在线性时间内处理得到每个 <span
class="math inline">\(i,j\)</span> 向上连续延伸的连续1长度，设其为 <span
class="math inline">\(U_{i,j}\)</span></p>
<p>假设枚举了 <span class="math inline">\(i\)</span> ，从左到右依次扫描
<span class="math inline">\(j\)</span> ，则得到 <span
class="math inline">\(i,j\)</span> 位置的答案应该是</p>
<p><span class="math display">\[\begin{aligned} \sum_{k=1}^{j}
\min_{d=k}^j\lbrace U_{i,d}\rbrace\end{aligned} \]</span></p>
<p>这条式子中，相当于枚举了 <span class="math inline">\(i,(k,j)\)</span>
为底，统计向上延伸的最长长度</p>
<p>这个式子可以用<strong>单调栈</strong>在线性时间内求解，其过程可以描述为</p>
<p>1.每次插入元素 <span class="math inline">\(U_{i,j}\)</span>
，得到它的影响区间 <span class="math inline">\(k\in [L,j]\)</span></p>
<p>2.将原先单调栈内 <span class="math inline">\(k\in [L,j]\)</span>
这段区间的答案减掉，改为 <span class="math inline">\(U_{i,j}\cdot
(j-L+1)\)</span></p>
<p>类似的，可以通过改变循环顺序和额外记录向下延伸的长度 <span
class="math inline">\(D_{i,j}\)</span>
来统计四种顶点的答案(详细见代码)</p>
<p>然后可以用前缀和帮助统计以上4种答案，枚举一个端点，另一个查询前缀和即可</p>
<p>tips: 注意累和顺序，<del>前缀和要开long long</del></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">long</span> <span class="type">long</span> ll;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> rep(i,a,b) for(int i=a,i##end=b;i&lt;=i##end;++i)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> drep(i,a,b) for(int i=a,i##end=b;i&gt;=i##end;--i)</span></span><br><span class="line"></span><br><span class="line"><span class="type">char</span> IO;</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">T</span>=<span class="type">int</span>&gt; T <span class="built_in">rd</span>()&#123;</span><br><span class="line">	T s=<span class="number">0</span>; <span class="type">int</span> f=<span class="number">0</span>;</span><br><span class="line">	<span class="keyword">while</span>(!<span class="built_in">isdigit</span>(IO=<span class="built_in">getchar</span>())) <span class="keyword">if</span>(IO==<span class="string">&#x27;-&#x27;</span>) f=<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">do</span> s=(s&lt;&lt;<span class="number">1</span>)+(s&lt;&lt;<span class="number">3</span>)+(IO^<span class="string">&#x27;0&#x27;</span>);</span><br><span class="line">	<span class="keyword">while</span>(<span class="built_in">isdigit</span>(IO=<span class="built_in">getchar</span>()));</span><br><span class="line">	<span class="keyword">return</span> f?-s:s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> N=<span class="number">1e3</span>+<span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> n;</span><br><span class="line"><span class="type">char</span> a[N][N];</span><br><span class="line"><span class="type">int</span> D[N][N],U[N][N]; <span class="comment">//i,j向下/上延伸的最长长度</span></span><br><span class="line"><span class="type">int</span> stk[N],c[N],top;</span><br><span class="line"><span class="type">int</span> CRR[N][N]; <span class="comment">// 以i,j为右下角的矩形个数</span></span><br><span class="line"><span class="type">int</span> CLL[N][N]; <span class="comment">// 以i,j为左上角的矩形个数</span></span><br><span class="line"><span class="type">int</span> CLR[N][N]; <span class="comment">// 以i,j为右上角的矩形个数</span></span><br><span class="line"><span class="type">int</span> CRL[N][N]; <span class="comment">// 以i,j为左下角的矩形个数</span></span><br><span class="line">ll SLL[N][N],SRL[N][N]; <span class="comment">// 前缀和</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	n=<span class="built_in">rd</span>();</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">1</span>,n) <span class="built_in">scanf</span>(<span class="string">&quot;%s&quot;</span>,a[i]+<span class="number">1</span>);</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">1</span>,n) <span class="built_in">rep</span>(j,<span class="number">1</span>,n) <span class="keyword">if</span>(a[i][j]==<span class="string">&#x27;C&#x27;</span>) U[i][j]=U[i<span class="number">-1</span>][j]+<span class="number">1</span>;</span><br><span class="line">	<span class="built_in">drep</span>(i,n,<span class="number">1</span>) <span class="built_in">rep</span>(j,<span class="number">1</span>,n) <span class="keyword">if</span>(a[i][j]==<span class="string">&#x27;C&#x27;</span>) D[i][j]=D[i+<span class="number">1</span>][j]+<span class="number">1</span>;</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">1</span>,n) &#123;</span><br><span class="line">		<span class="comment">// 统计四种端点的情况</span></span><br><span class="line">		top=<span class="number">0</span>;</span><br><span class="line">		<span class="type">int</span> now=<span class="number">0</span>;</span><br><span class="line">		<span class="built_in">rep</span>(j,<span class="number">1</span>,n) &#123;</span><br><span class="line">			<span class="type">int</span> x=U[i][j],cnt=<span class="number">1</span>;</span><br><span class="line">			<span class="keyword">while</span>(top &amp;&amp; stk[top]&gt;=x) cnt+=c[top],now-=c[top]*stk[top],top--;</span><br><span class="line">			stk[++top]=x,c[top]=cnt; now+=x*cnt;</span><br><span class="line">			CRR[i][j]=<span class="built_in">max</span>(now<span class="number">-1</span>,<span class="number">0</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		now=top=<span class="number">0</span>;</span><br><span class="line">		<span class="built_in">rep</span>(j,<span class="number">1</span>,n) &#123;</span><br><span class="line">			<span class="type">int</span> x=D[i][j],cnt=<span class="number">1</span>;</span><br><span class="line">			<span class="keyword">while</span>(top &amp;&amp; stk[top]&gt;=x) cnt+=c[top],now-=c[top]*stk[top],top--;</span><br><span class="line">			stk[++top]=x,c[top]=cnt; now+=x*cnt;</span><br><span class="line">			CLR[i][j]=<span class="built_in">max</span>(now<span class="number">-1</span>,<span class="number">0</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		now=top=<span class="number">0</span>;</span><br><span class="line">		<span class="built_in">drep</span>(j,n,<span class="number">1</span>) &#123;</span><br><span class="line">			<span class="type">int</span> x=U[i][j],cnt=<span class="number">1</span>;</span><br><span class="line">			<span class="keyword">while</span>(top &amp;&amp; stk[top]&gt;=x) cnt+=c[top],now-=c[top]*stk[top],top--;</span><br><span class="line">			stk[++top]=x,c[top]=cnt; now+=x*cnt;</span><br><span class="line">			CRL[i][j]=<span class="built_in">max</span>(now<span class="number">-1</span>,<span class="number">0</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		now=top=<span class="number">0</span>;</span><br><span class="line">		<span class="built_in">drep</span>(j,n,<span class="number">1</span>) &#123;</span><br><span class="line">			<span class="type">int</span> x=D[i][j],cnt=<span class="number">1</span>;</span><br><span class="line">			<span class="keyword">while</span>(top &amp;&amp; stk[top]&gt;=x) cnt+=c[top],now-=c[top]*stk[top],top--;</span><br><span class="line">			stk[++top]=x,c[top]=cnt; now+=x*cnt;</span><br><span class="line">			CLL[i][j]=<span class="built_in">max</span>(now<span class="number">-1</span>,<span class="number">0</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">drep</span>(i,n,<span class="number">1</span>) <span class="built_in">drep</span>(j,n,<span class="number">1</span>) SLL[i][j]=SLL[i+<span class="number">1</span>][j]+SLL[i][j+<span class="number">1</span>]-SLL[i+<span class="number">1</span>][j+<span class="number">1</span>]+CLL[i][j];</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">1</span>,n) <span class="built_in">drep</span>(j,n,<span class="number">1</span>) SRL[i][j]=SRL[i<span class="number">-1</span>][j]+SRL[i][j+<span class="number">1</span>]-SRL[i<span class="number">-1</span>][j+<span class="number">1</span>]+CRL[i][j];</span><br><span class="line">	<span class="comment">// 前缀和</span></span><br><span class="line"></span><br><span class="line">	ll ans=<span class="number">0</span>;</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">1</span>,n) <span class="built_in">rep</span>(j,<span class="number">1</span>,n) <span class="keyword">if</span>(CRR[i][j]) ans+=CRR[i][j]*(SLL[i+<span class="number">1</span>][<span class="number">1</span>]+SLL[<span class="number">1</span>][j+<span class="number">1</span>]-SLL[i+<span class="number">1</span>][j+<span class="number">1</span>]);</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">1</span>,n) <span class="built_in">rep</span>(j,<span class="number">1</span>,n) ans-=CLR[i][j]*SRL[i<span class="number">-1</span>][j+<span class="number">1</span>];</span><br><span class="line">	<span class="comment">// 统计4种情况</span></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;%lld\n&quot;</span>,ans%<span class="number">10007</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://compilationfail.github.io/oi-solutions/COCI/%E4%BD%95%E4%BB%A5%E4%BC%8A%E5%90%8D%E5%A7%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="orangejuice">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="orangejuice's blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | orangejuice's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/oi-solutions/COCI/%E4%BD%95%E4%BB%A5%E4%BC%8A%E5%90%8D%E5%A7%8B/" class="post-title-link" itemprop="url">何以伊名始</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2023-08-12 11:05:24 / Modified: 12:37:29" itemprop="dateCreated datePublished" datetime="2023-08-12T11:05:24+08:00">2023-08-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/oi-solutions/" itemprop="url" rel="index"><span itemprop="name">oi-solutions</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="何以伊名始">何以伊名始</h1>
<p>本题现已知四种做法，如果不会后缀系列结构可以直接看Solution4</p>
<p>设初始树大小和查询总长均为 <span
class="math inline">\(O(n)\)</span></p>
<h3 id="solution1">Solution1</h3>
<p>由于查询只有1e6，因此出现的不同查询串长度最多 <span
class="math inline">\(\sqrt {10^6}=1000\)</span> 种</p>
<p>考虑对于每一种做一次dfs，在 <span class="math inline">\(\text{Hash
Table}\)</span> 中查询，复杂度为 <span class="math inline">\(O(n\sqrt
n)\)</span></p>
<h3 id="solution2">Solution2</h3>
<p>将树上节点后缀排序，然后每次插入需要询问的字符就二分后缀区间</p>
<p>预处理复杂度为 <span class="math inline">\(O(n\log n)\)</span>
，查询涉及二分和倍增，复杂度为 <span class="math inline">\(O(n\log ^2
n)\)</span></p>
<h3 id="solution3">Solution3</h3>
<p>给定的树看做trie树，可以对于trie树建广义后缀自动机，然后倒着让询问串去匹配，一旦失配答案为0，</p>
<p>需要预处理 <span class="math inline">\(link\)</span>
树的子树和，时间复杂度为 <span class="math inline">\(O(n)\)</span>
，空间复杂度为 <span class="math inline">\(O(n|\Sigma|)\)</span></p>
<h3 id="solution4">Solution4</h3>
<p>将询问的串倒着插入，构建AC自动机</p>
<p>由于AC自动机预处理，时间空间复杂度为 <span
class="math inline">\(O(n|\Sigma|)\)</span></p>
<p>然后考虑对于树上每一个前缀在AC自动机上匹配，每次从父亲转移过来，复杂度为
<span class="math inline">\(O(n)\)</span></p>
<p>然后是常见的AC自动机操作， <span class="math inline">\(fail\)</span>
树上的子树累和即可</p>
<p>需要询问离线，因此有一定局限性</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> GCC optimize(2)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> rep(i,a,b) for(int i=a,i##end=b;i&lt;=i##end;++i)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> drep(i,a,b) for(int i=a,i##end=b;i&gt;=i##end;--i)</span></span><br><span class="line"><span class="type">char</span> IO;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">rd</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="type">int</span> s=<span class="number">0</span>;</span><br><span class="line">	<span class="keyword">while</span>(!<span class="built_in">isdigit</span>(IO=<span class="built_in">getchar</span>()));</span><br><span class="line">	<span class="keyword">do</span> s=(s&lt;&lt;<span class="number">1</span>)+(s&lt;&lt;<span class="number">3</span>)+(IO^<span class="string">&#x27;0&#x27;</span>);</span><br><span class="line">	<span class="keyword">while</span>(<span class="built_in">isdigit</span>(IO=<span class="built_in">getchar</span>()));</span><br><span class="line">	<span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> N=<span class="number">1e6</span>+<span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> n,m,len,F[N],A[N];</span><br><span class="line"><span class="type">char</span> s[N],t[N];</span><br><span class="line"><span class="type">int</span> nxt[N][<span class="number">26</span>],fail[N],cnt,pos[N];</span><br><span class="line"><span class="type">int</span> Q[N],L=<span class="number">1</span>,R;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Build</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">0</span>,<span class="number">25</span>) <span class="keyword">if</span>(nxt[<span class="number">0</span>][i]) Q[++R]=nxt[<span class="number">0</span>][i];</span><br><span class="line">	<span class="keyword">while</span>(L&lt;=R) &#123;</span><br><span class="line">		<span class="type">int</span> u=Q[L++];</span><br><span class="line">		<span class="built_in">rep</span>(i,<span class="number">0</span>,<span class="number">25</span>) &#123;</span><br><span class="line">			<span class="type">int</span> &amp;v=nxt[u][i];</span><br><span class="line">			<span class="keyword">if</span>(v) fail[v]=nxt[fail[u]][i],Q[++R]=v;</span><br><span class="line">			<span class="keyword">else</span> v=nxt[fail[u]][i];</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	n=<span class="built_in">rd</span>(),m=<span class="built_in">rd</span>();</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">1</span>,n) <span class="built_in">scanf</span>(<span class="string">&quot;%c&quot;</span>,s+i),F[i]=<span class="built_in">rd</span>();</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">1</span>,m) &#123;</span><br><span class="line">		<span class="built_in">scanf</span>(<span class="string">&quot;%s&quot;</span>,t+<span class="number">1</span>);</span><br><span class="line">		<span class="type">int</span> now=<span class="number">0</span>;</span><br><span class="line">		<span class="built_in">drep</span>(j,<span class="built_in">strlen</span>(t+<span class="number">1</span>),<span class="number">1</span>) &#123;</span><br><span class="line">			<span class="type">int</span> c=t[j]-<span class="string">&#x27;A&#x27;</span>;</span><br><span class="line">			<span class="keyword">if</span>(!nxt[now][c]) nxt[now][c]=++cnt;</span><br><span class="line">			now=nxt[now][c];</span><br><span class="line">		&#125;</span><br><span class="line">		pos[i]=now;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">Build</span>();</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">1</span>,n) A[F[i]=nxt[F[F[i]]][s[i]-<span class="string">&#x27;A&#x27;</span>]]++;</span><br><span class="line">	<span class="built_in">drep</span>(i,R,<span class="number">1</span>) A[fail[Q[i]]]+=A[Q[i]];</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">1</span>,m) <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>,A[pos[i]]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://compilationfail.github.io/oi-solutions/COCI/%E7%BE%8E%E4%B8%BD%E7%9A%84%E6%A1%A5%E6%A2%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="orangejuice">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="orangejuice's blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | orangejuice's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/oi-solutions/COCI/%E7%BE%8E%E4%B8%BD%E7%9A%84%E6%A1%A5%E6%A2%81/" class="post-title-link" itemprop="url">美丽的桥梁</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2023-08-12 11:05:24 / Modified: 12:37:29" itemprop="dateCreated datePublished" datetime="2023-08-12T11:05:24+08:00">2023-08-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/oi-solutions/" itemprop="url" rel="index"><span itemprop="name">oi-solutions</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="美丽的桥梁">美丽的桥梁</h1>
<p>可以得到一个Naive的暴力方法来判断在 <span
class="math inline">\((L,R)\)</span> 上修桥是否合法:</p>
<p>显然的性质: 如果有相交，则一定存在一个关键点相交</p>
<p>设得到的圆半径为 <span
class="math inline">\(r=\frac{x_R-x_L}{2}\)</span> ，圆心为 <span
class="math inline">\((x,y)=(\frac{x_L+x_R}{2},h-r)\)</span></p>
<p>枚举每个 <span class="math inline">\(i\in [L,R]\)</span> 判断是否点
<span class="math inline">\(x_i,y_i\)</span>
是否相交，如果相交，只需要满足</p>
<p><span class="math inline">\(y_i&gt;y\)</span> ，且 其与圆心距离 <span
class="math inline">\(&gt;r\)</span></p>
<p><span class="math display">\[ \ \]</span></p>
<p>考虑优化判断，将生成的拱形分为左右两部分，分别考虑即可</p>
<p>推论: 对于每个 <span class="math inline">\(L\)</span>
，其左半边不相交的半径为描述为一个范围 <span
class="math inline">\([0,A_L]\)</span></p>
<p>同理的，对于每个 <span class="math inline">\(R\)</span>
也是如此，能求得一个范围 <span
class="math inline">\([0,B_R]\)</span></p>
<p>考虑对于每个 <span class="math inline">\(L\)</span> ，枚举每个 <span
class="math inline">\(i&gt;L\)</span> 来求出 <span
class="math inline">\(A_L\)</span></p>
<p>设半径为 <span class="math inline">\(r\)</span> ，列出圆心与点 <span
class="math inline">\(x_i,y_i\)</span> 距离的表达式，必须满足距离 <span
class="math inline">\(\leq r\)</span> ，就能得到一个二次方程</p>
<p>二次方程的解集为 <span class="math inline">\(x_1,x_2\)</span>
，但是实际上 <span class="math inline">\([0,x_1]\)</span> 这一段不满足
<span class="math inline">\(y_i&gt;y\)</span> ，因此也是合法的</p>
<p>即将每次求得的 <span class="math inline">\([0,x_2]\)</span>
区间取交集即可</p>
<p>复杂度为 <span class="math inline">\(O(n^2)\)</span></p>
<p>同理求得每个 <span class="math inline">\(B_R\)</span></p>
<p>考虑朴素的dp，令 <span class="math inline">\(dp_i\)</span> 表示解决了
<span class="math inline">\([1,i]\)</span> 前缀的最小代价</p>
<p>枚举 <span class="math inline">\(j\)</span> ， <span
class="math inline">\(O(1)\)</span> 判断 <span
class="math inline">\((i,j)\)</span> 是否合法，然后进行转移</p>
<p>tips: 题目的代价计算方法可能没讲清楚。。。</p>
<p>复杂度为 <span class="math inline">\(O(n^2)\)</span></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> GCC optimize(2)</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">double</span> db;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">long</span> <span class="type">long</span> ll;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> rep(i,a,b) for(int i=a,i##end=b;i&lt;=i##end;++i)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> drep(i,a,b) for(int i=a,i##end=b;i&gt;=i##end;--i)</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt; <span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">cmin</span><span class="params">(T &amp;a,<span class="type">const</span> T &amp;b)</span></span>&#123; ((a&gt;b)&amp;&amp;(a=b)); &#125;</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt; <span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">cmax</span><span class="params">(T &amp;a,<span class="type">const</span> T &amp;b)</span></span>&#123; ((a&lt;b)&amp;&amp;(a=b)); &#125;</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> IO;</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">T</span>=<span class="type">int</span>&gt; T <span class="built_in">rd</span>()&#123;</span><br><span class="line">	T s=<span class="number">0</span>; <span class="type">int</span> f=<span class="number">0</span>;</span><br><span class="line">	<span class="keyword">while</span>(!<span class="built_in">isdigit</span>(IO=<span class="built_in">getchar</span>())) <span class="keyword">if</span>(IO==<span class="string">&#x27;-&#x27;</span>) f=<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">do</span> s=(s&lt;&lt;<span class="number">1</span>)+(s&lt;&lt;<span class="number">3</span>)+(IO^<span class="string">&#x27;0&#x27;</span>);</span><br><span class="line">	<span class="keyword">while</span>(<span class="built_in">isdigit</span>(IO=<span class="built_in">getchar</span>()));</span><br><span class="line">	<span class="keyword">return</span> f?-s:s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> N=<span class="number">1e4</span>+<span class="number">10</span>;</span><br><span class="line"><span class="type">const</span> db eps=<span class="number">1e-9</span>;</span><br><span class="line"><span class="type">const</span> ll INF=<span class="number">4e18</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> n,h,a,b;</span><br><span class="line"><span class="type">int</span> X[N],Y[N];</span><br><span class="line">db L[N],R[N];</span><br><span class="line"><span class="function">db <span class="title">Sqr</span><span class="params">(db x)</span></span>&#123; <span class="keyword">return</span> x*x; &#125;</span><br><span class="line">ll dp[N];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	n=<span class="built_in">rd</span>(),h=<span class="built_in">rd</span>(),a=<span class="built_in">rd</span>(),b=<span class="built_in">rd</span>();</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">1</span>,n) X[i]=<span class="built_in">rd</span>(),Y[i]=<span class="built_in">rd</span>();</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">1</span>,n) &#123;</span><br><span class="line">		L[i]=<span class="built_in">min</span>((db)(X[n]-X[i])/<span class="number">2</span>,(db)(h-Y[i]));</span><br><span class="line">		<span class="built_in">rep</span>(j,i+<span class="number">1</span>,n) &#123;</span><br><span class="line">			<span class="keyword">if</span>(X[j]-X[i]&gt;L[i]+eps) <span class="keyword">break</span>;</span><br><span class="line">			db a=<span class="number">1</span>,b=<span class="number">2</span>*(X[i]-X[j]+Y[j]-h),c=<span class="built_in">Sqr</span>(X[i]-X[j])+<span class="built_in">Sqr</span>(Y[j]-h);</span><br><span class="line">			db d=<span class="built_in">sqrt</span>(b*b<span class="number">-4</span>*a*c);</span><br><span class="line">			db r=(-b+d)/(<span class="number">2</span>*a);</span><br><span class="line">			<span class="built_in">cmin</span>(L[i],r);</span><br><span class="line">		&#125;</span><br><span class="line">		L[i]*=<span class="number">2</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">1</span>,n) &#123;</span><br><span class="line">		R[i]=<span class="built_in">min</span>((db)(X[i]-X[<span class="number">1</span>])/<span class="number">2</span>,(db)(h-Y[i]));</span><br><span class="line">		<span class="built_in">drep</span>(j,i<span class="number">-1</span>,<span class="number">1</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span>(X[i]-X[j]&gt;R[i]+eps) <span class="keyword">break</span>;</span><br><span class="line">			db a=<span class="number">1</span>,b=<span class="number">2</span>*(X[j]-X[i]+Y[j]-h),c=<span class="built_in">Sqr</span>(X[j]-X[i])+<span class="built_in">Sqr</span>(Y[j]-h);</span><br><span class="line">			db d=<span class="built_in">sqrt</span>(b*b<span class="number">-4</span>*a*c);</span><br><span class="line">			db r=(-b+d)/(<span class="number">2</span>*a);</span><br><span class="line">			<span class="built_in">cmin</span>(R[i],r);</span><br><span class="line">		&#125;</span><br><span class="line">		R[i]*=<span class="number">2</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	dp[<span class="number">1</span>]=<span class="number">1ll</span>*a*(h-Y[<span class="number">1</span>]);</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">2</span>,n) &#123;</span><br><span class="line">		dp[i]=INF;</span><br><span class="line">		<span class="built_in">drep</span>(j,i<span class="number">-1</span>,<span class="number">1</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span>(X[i]-X[j]&gt;R[i]+eps) <span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">if</span>(X[i]-X[j]&gt;L[j]+eps) <span class="keyword">continue</span>;</span><br><span class="line">			<span class="built_in">cmin</span>(dp[i],dp[j]+<span class="number">1ll</span>*a*(h-Y[i])+<span class="number">1ll</span>*(X[i]-X[j])*(X[i]-X[j])*b);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(dp[n]&lt;INF) <span class="built_in">printf</span>(<span class="string">&quot;%lld\n&quot;</span>,dp[n]);</span><br><span class="line">	<span class="keyword">else</span> <span class="built_in">puts</span>(<span class="string">&quot;impossible&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://compilationfail.github.io/oi-solutions/CodeChef/CODECHEF%20Octchanllenge%20JIIT/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="orangejuice">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="orangejuice's blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | orangejuice's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/oi-solutions/CodeChef/CODECHEF%20Octchanllenge%20JIIT/" class="post-title-link" itemprop="url">Codechef Oct chanllenge Queries on Matrix-JIIT</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2023-08-12 11:05:24 / Modified: 12:37:29" itemprop="dateCreated datePublished" datetime="2023-08-12T11:05:24+08:00">2023-08-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/oi-solutions/" itemprop="url" rel="index"><span itemprop="name">oi-solutions</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="codechef-oct-chanllenge-queries-on-matrix-jiit">Codechef Oct
chanllenge Queries on Matrix-JIIT</h1>
<p>首先发现矩阵的两个维度显然是互不相干的，假设最后操作后有 <span
class="math inline">\(x\)</span> 列被操作奇数次， <span
class="math inline">\(y\)</span> 行操作奇数次</p>
<p>那么最后为奇数的格子个数就是 <span
class="math inline">\(x(m-y)+(n-x)y\)</span></p>
<p>考虑求出 <span class="math inline">\(q\)</span> 操作后有 <span
class="math inline">\(x\)</span> 个位置被操作奇数次的方案数</p>
<p>考虑一个Naive的 <span class="math inline">\(dp\)</span> ，令 <span
class="math inline">\(dp_{i,j}\)</span> 为操作 <span
class="math inline">\(i\)</span> 次后有 <span
class="math inline">\(j\)</span>
位置操作奇数的方案数，显然得到转移为</p>
<p><span class="math inline">\(dp_{i,j}\cdot j\rightarrow
dp_{i+1,j-1}\)</span></p>
<p><span class="math inline">\(dp_{i,j}\cdot (n-j)\rightarrow
dp_{i+1,j+1}\)</span></p>
<p>直接 <span class="math inline">\(dp\)</span> 复杂度为 <span
class="math inline">\(O(nq)\)</span> ，用矩阵优化复杂度为 <span
class="math inline">\(O(n^3\log q)\)</span></p>
<p>没有考虑过求向量列的现行递推式？说不定暴力求递推然后。。。</p>
<h2 id="on3"><span class="math inline">\(O(n^3)\)</span></h2>
<p><del>由于笔者不会数学，所以</del>考虑一个非常暴力非常直观的理解，可以完全抛开组合意义</p>
<p>每次是挑选一个位置异或上1，用形式幂级数可能比较蛋疼，不如直接搞成集合幂级数</p>
<p>即令集合 <span class="math inline">\(S\)</span>
包含所有被操作奇数次的位置，用一个多项式 <span
class="math inline">\(F=\sum_S a_S x^S\)</span> 表示答案</p>
<p>那么转移多项式即为 <span class="math inline">\(F=\sum_{i=1}^{n}
x^{\lbrace i \rbrace}\)</span>
，转移运算为集合对称差运算<del>(哎就是异或)</del></p>
<p>那么实际就是要求出 <span class="math inline">\(F^q\)</span>
，可以直接用 <span class="math inline">\(\text{FWT}\)</span> 优化，先
<span class="math inline">\(\text{FWT}\)</span> ，然后求出每一项的 <span
class="math inline">\(q\)</span> 次幂，然后 <span
class="math inline">\(\text{FWT}\)</span> 回来</p>
<p><del>(这样不是 <span class="math inline">\(n2^n\)</span>
的吗)</del></p>
<p>显然的可以发现， <span class="math inline">\(F^i\)</span>
的任意位置系数 <span class="math inline">\([x^S]F^i\)</span> 只与 <span
class="math inline">\(|S|\)</span> 有关，所以实际上只需要存下含有 <span
class="math inline">\(0,1,2\cdots,n\)</span> 个元素的项的系数即可</p>
<p>考虑在这样的多项式上模拟原先的 <span
class="math inline">\(\text{FWT}\)</span> 过程</p>
<hr />
<p>按照快速沃尔什变换的式子，令 <span
class="math inline">\(G=\text{FWT(F)}=\sum_{S}x^S \sum_{T}(-1)^{|S\cap
T|}\cdot [x^T]F\)</span></p>
<p>考虑枚举 <span class="math inline">\(|S|,|T|,|S\cap T|\)</span>
，然后组合数计算系数，令 <span class="math inline">\(F_i\)</span> 表示
<span class="math inline">\([x^S]F(|S|=i)\)</span></p>
<p>则有 <span class="math inline">\(\begin{aligned}
G_i=\sum_{j}F_j\sum_k C_i^k\cdot
C_{n-i}^{j-k}(-1)^{k}\end{aligned}\)</span> ，其中 <span
class="math inline">\(C_{n-i}^{j-k}\)</span> 表示从不相交的部分里选出
<span class="math inline">\(j\)</span> 中剩下的元素</p>
<p>按照该式即可完成 <span class="math inline">\(O(n^3)\)</span> 模拟
<span class="math inline">\(\text{FWT}\)</span> ，注意 <span
class="math inline">\(\text{IFWT}\)</span> 时需要除掉 <span
class="math inline">\(2^n\)</span></p>
<p>算上快速幂复杂度应为 <span class="math inline">\(O(n^3+n\log
q)\)</span></p>
<h2 id="on2log-n"><span class="math inline">\(O(n^2\log n)\)</span></h2>
<p>用 <span class="math inline">\(\text{NTT}\)</span> 优化上式</p>
<h2 id="on2"><span class="math inline">\(O(n^2)\)</span></h2>
<p>依然考虑上面 <span class="math inline">\(\text{FWT}\)</span>
的转移式，发现 <span class="math inline">\(i\)</span> 项得到 <span
class="math inline">\(j\)</span>
项的贡献为一个常数，考虑直接计算这个常数 <span
class="math inline">\(W_{i,j}=\sum_k C_i^k\cdot
C_{n-i}^{j-k}(-1)^{k}\)</span></p>
<p>我们知道组合数就是二项展开的结果，所以发现实际就是 <span
class="math inline">\(W_{i,j}=[x^j] (-x+1)^i\cdot
(x+1)^{n-i}\)</span></p>
<p>该式可以 <span class="math inline">\(O(n^2)\)</span> 按照 <span
class="math inline">\(i\)</span> 递推求出，每次乘上一个 <span
class="math inline">\(\frac{1-x}{1+x}\)</span> 即可</p>
<p>实际复杂度为 <span class="math inline">\(O(n^2+n\log q)\)</span></p>
<p>实际上应该还可以处理一些稍微复杂点的问题，比如每次可以操作若干个位置</p>
<p>不知道能否优化到 <span class="math inline">\(n^2\)</span> 以下</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// NTT Version</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">long</span> <span class="type">long</span> ll;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> ull;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">double</span> db;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">long</span> <span class="type">double</span> ldb;</span><br><span class="line"><span class="keyword">typedef</span> pair &lt;<span class="type">int</span>,<span class="type">int</span>&gt; Pii;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> reg register</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> pb push_back</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> mp make_pair</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> Mod1(x) ((x&gt;=P)&amp;&amp;(x-=P))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> Mod2(x) ((x&lt;0)&amp;&amp;(x+=P))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> rep(i,a,b) for(int i=a,i##end=b;i&lt;=i##end;++i)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> drep(i,a,b) for(int i=a,i##end=b;i&gt;=i##end;--i)</span></span><br><span class="line"></span><br><span class="line"><span class="type">bool</span> Mbe;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> N=<span class="number">2050</span>,P=<span class="number">998244353</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> n,m,Z; ll k;</span><br><span class="line"><span class="type">int</span> A[N],B[N];</span><br><span class="line"><span class="function">ll <span class="title">qpow</span><span class="params">(ll x,ll k=P<span class="number">-2</span>)</span> </span>&#123;</span><br><span class="line">	ll res=<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">for</span>(;k;k&gt;&gt;=<span class="number">1</span>,x=x*x%P) <span class="keyword">if</span>(k&amp;<span class="number">1</span>) res=res*x%P;</span><br><span class="line">	<span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> C[N][N];</span><br><span class="line"><span class="type">int</span> rev[N],T[N],IT[N];</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">NTT</span><span class="params">(<span class="type">int</span> n,<span class="type">int</span> *a,<span class="type">int</span> f)</span></span>&#123;</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">0</span>,n<span class="number">-1</span>) <span class="keyword">if</span>(i&lt;rev[i]) <span class="built_in">swap</span>(a[i],a[rev[i]]);</span><br><span class="line">	<span class="type">static</span> <span class="type">int</span> e[N&gt;&gt;<span class="number">1</span>];	</span><br><span class="line">	<span class="keyword">for</span>(reg <span class="type">int</span> i=e[<span class="number">0</span>]=<span class="number">1</span>;i&lt;n;i&lt;&lt;=<span class="number">1</span>) &#123;</span><br><span class="line">		ll t=f==<span class="number">1</span>?T[i]:IT[i];</span><br><span class="line">		<span class="comment">//qpow(f==1?3:(P+1)/3,(P-1)/i/2);</span></span><br><span class="line">		<span class="keyword">for</span>(reg <span class="type">int</span> j=i<span class="number">-2</span>;j&gt;=<span class="number">0</span>;j-=<span class="number">2</span>) e[j+<span class="number">1</span>]=t*(e[j]=e[j&gt;&gt;<span class="number">1</span>])%P;</span><br><span class="line">		<span class="keyword">for</span>(reg <span class="type">int</span> l=<span class="number">0</span>;l&lt;n;l+=i*<span class="number">2</span>) &#123;</span><br><span class="line">			<span class="keyword">for</span>(reg <span class="type">int</span> j=l;j&lt;l+i;++j) &#123;</span><br><span class="line">				reg <span class="type">int</span> t=<span class="number">1ll</span>*a[j+i]*e[j-l]%P;</span><br><span class="line">				a[j+i]=a[j]-t,<span class="built_in">Mod2</span>(a[j+i]);</span><br><span class="line">				a[j]+=t,<span class="built_in">Mod1</span>(a[j]);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(f==<span class="number">-1</span>) &#123;</span><br><span class="line">		ll base=<span class="built_in">qpow</span>(n);</span><br><span class="line">		<span class="built_in">rep</span>(i,<span class="number">0</span>,n<span class="number">-1</span>) a[i]=a[i]*base%P;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Init</span><span class="params">(<span class="type">int</span> n)</span></span>&#123;</span><br><span class="line">	<span class="type">int</span> R=<span class="number">1</span>,cc=<span class="number">-1</span>;</span><br><span class="line">	<span class="keyword">while</span>(R&lt;=n) R&lt;&lt;=<span class="number">1</span>,cc++;</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">1</span>,R<span class="number">-1</span>) rev[i]=(rev[i&gt;&gt;<span class="number">1</span>]&gt;&gt;<span class="number">1</span>)|((i&amp;<span class="number">1</span>)&lt;&lt;cc);</span><br><span class="line">	<span class="keyword">return</span> R;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> mk1[N],mk2[N];</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">FWT</span><span class="params">(<span class="type">int</span> n,<span class="type">int</span> *A,<span class="type">int</span> *B,<span class="type">int</span> f,<span class="type">int</span> *mk)</span></span>&#123;</span><br><span class="line">		<span class="type">static</span> <span class="type">int</span> X[N],Y[N];</span><br><span class="line">		<span class="built_in">rep</span>(i,<span class="number">0</span>,n) &#123;</span><br><span class="line">			<span class="built_in">memset</span>(X,<span class="number">0</span>,<span class="keyword">sizeof</span> X),<span class="built_in">memset</span>(Y,<span class="number">0</span>,<span class="keyword">sizeof</span> Y);</span><br><span class="line">			<span class="built_in">rep</span>(k,<span class="number">0</span>,i) X[i-k]=(k&amp;<span class="number">1</span>)?P-C[i][k]:C[i][k];</span><br><span class="line">			<span class="built_in">rep</span>(j,<span class="number">0</span>,n) Y[j]=A[j];</span><br><span class="line">			<span class="type">int</span> R=<span class="built_in">Init</span>(n+i+<span class="number">1</span>);</span><br><span class="line">			<span class="built_in">NTT</span>(R,X,<span class="number">1</span>),<span class="built_in">NTT</span>(R,Y,<span class="number">1</span>);</span><br><span class="line">			<span class="built_in">rep</span>(j,<span class="number">0</span>,R<span class="number">-1</span>) X[j]=<span class="number">1ll</span>*X[j]*Y[j]%P;</span><br><span class="line">			<span class="built_in">NTT</span>(R,X,<span class="number">-1</span>);</span><br><span class="line">			<span class="built_in">rep</span>(j,<span class="number">0</span>,n-i) B[i]=(B[i]+<span class="number">1ll</span>*C[n-i][j]*X[i+j])%P;</span><br><span class="line">		&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Solve</span><span class="params">(<span class="type">int</span> n,<span class="type">int</span> *A,<span class="type">int</span> *mk)</span> </span>&#123;</span><br><span class="line">	<span class="type">static</span> <span class="type">int</span> X[N],Y[N];</span><br><span class="line">	<span class="built_in">memset</span>(X,<span class="number">0</span>,<span class="keyword">sizeof</span> X),<span class="built_in">memset</span>(Y,<span class="number">0</span>,<span class="keyword">sizeof</span> Y);</span><br><span class="line">	X[<span class="number">1</span>]=<span class="number">1</span>,<span class="built_in">FWT</span>(n,X,Y,<span class="number">1</span>,mk);</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">0</span>,n) Y[i]=<span class="built_in">qpow</span>(Y[i],k);</span><br><span class="line">	<span class="built_in">memset</span>(X,<span class="number">0</span>,<span class="keyword">sizeof</span> X);</span><br><span class="line">	<span class="built_in">FWT</span>(n,Y,X,<span class="number">2</span>,mk);</span><br><span class="line">	ll base=<span class="built_in">qpow</span>(<span class="built_in">qpow</span>(<span class="number">2</span>,n),P<span class="number">-2</span>);</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">0</span>,n) A[i]=X[i]*base%P*C[n][i]%P;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">bool</span> Med;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="comment">//fprintf(stderr,&quot;%.2lf\n&quot;,(&amp;Med-&amp;Mbe)/1024.0/1024.0);</span></span><br><span class="line">	<span class="built_in">freopen</span>(<span class="string">&quot;clone.in&quot;</span>,<span class="string">&quot;r&quot;</span>,stdin),<span class="built_in">freopen</span>(<span class="string">&quot;clone.out&quot;</span>,<span class="string">&quot;w&quot;</span>,stdout);</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">0</span>,N<span class="number">-1</span>) <span class="built_in">rep</span>(j,C[i][<span class="number">0</span>]=<span class="number">1</span>,i) C[i][j]=(C[i<span class="number">-1</span>][j<span class="number">-1</span>]+C[i<span class="number">-1</span>][j])%P;</span><br><span class="line">	<span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">1</span>;i&lt;N;i&lt;&lt;=<span class="number">1</span>) &#123;</span><br><span class="line">		T[i]=<span class="built_in">qpow</span>(<span class="number">3</span>,(P<span class="number">-1</span>)/i/<span class="number">2</span>);</span><br><span class="line">		IT[i]=<span class="built_in">qpow</span>((P+<span class="number">1</span>)/<span class="number">3</span>,(P<span class="number">-1</span>)/i/<span class="number">2</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">scanf</span>(<span class="string">&quot;%d%d%lld%d&quot;</span>,&amp;n,&amp;m,&amp;k,&amp;Z);</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">0</span>,n) <span class="built_in">rep</span>(j,<span class="number">0</span>,m) &#123;</span><br><span class="line">		<span class="keyword">if</span>(i*(m-j)+j*(n-i)!=Z) <span class="keyword">continue</span>;</span><br><span class="line">		mk1[i]=<span class="number">1</span>,mk2[j]=<span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">Solve</span>(n,A,mk1),<span class="built_in">Solve</span>(m,B,mk2);</span><br><span class="line">	<span class="type">int</span> ans=<span class="number">0</span>;</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">0</span>,n) <span class="built_in">rep</span>(j,<span class="number">0</span>,m) &#123;</span><br><span class="line">		<span class="keyword">if</span>(i*(m-j)+j*(n-i)!=Z) <span class="keyword">continue</span>;</span><br><span class="line">		ans=(ans+<span class="number">1ll</span>*A[i]*B[j])%P;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>,ans);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// n^2</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">long</span> <span class="type">long</span> ll;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> Mod1(x) ((x&gt;=P)&amp;&amp;(x-=P))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> Mod2(x) ((x&lt;0)&amp;&amp;(x+=P))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> rep(i,a,b) for(int i=a,i##end=b;i&lt;=i##end;++i)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> drep(i,a,b) for(int i=a,i##end=b;i&gt;=i##end;--i)</span></span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> N=<span class="number">2050</span>,P=<span class="number">998244353</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> n,m,Z; ll k;</span><br><span class="line"><span class="type">int</span> A[N],B[N];</span><br><span class="line"><span class="function">ll <span class="title">qpow</span><span class="params">(ll x,ll k=P<span class="number">-2</span>)</span> </span>&#123;</span><br><span class="line">	ll res=<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">for</span>(;k;k&gt;&gt;=<span class="number">1</span>,x=x*x%P) <span class="keyword">if</span>(k&amp;<span class="number">1</span>) res=res*x%P;</span><br><span class="line">	<span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> C[N][N],W[N][N],mk1[N],mk2[N];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Solve</span><span class="params">(<span class="type">int</span> n,<span class="type">int</span> *A,<span class="type">int</span> *mk)</span> </span>&#123;</span><br><span class="line">	<span class="type">static</span> <span class="type">int</span> X[N],Y[N];</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">0</span>,n) W[<span class="number">0</span>][i]=C[n][i];</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">1</span>,n) &#123;</span><br><span class="line">		<span class="built_in">rep</span>(j,<span class="number">0</span>,n) W[i][j]=W[i<span class="number">-1</span>][j]-(j?W[i][j<span class="number">-1</span>]:<span class="number">0</span>),<span class="built_in">Mod2</span>(W[i][j]);</span><br><span class="line">		<span class="built_in">drep</span>(j,n,<span class="number">0</span>) W[i][j]=(j?-W[i][j<span class="number">-1</span>]:<span class="number">0</span>)+W[i][j],<span class="built_in">Mod2</span>(W[i][j]);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">memset</span>(Y,<span class="number">0</span>,<span class="keyword">sizeof</span> Y);</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">0</span>,n) X[i]=<span class="built_in">qpow</span>(W[i][<span class="number">1</span>],k);</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">0</span>,n) <span class="keyword">if</span>(mk[i]) <span class="built_in">rep</span>(j,<span class="number">0</span>,n) Y[i]=(Y[i]+<span class="number">1ll</span>*W[i][j]*X[j])%P;</span><br><span class="line">	ll base=<span class="built_in">qpow</span>(<span class="built_in">qpow</span>(<span class="number">2</span>,n),P<span class="number">-2</span>);</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">0</span>,n) A[i]=Y[i]*base%P*C[n][i]%P;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="built_in">freopen</span>(<span class="string">&quot;clone.in&quot;</span>,<span class="string">&quot;r&quot;</span>,stdin),<span class="built_in">freopen</span>(<span class="string">&quot;clone.out&quot;</span>,<span class="string">&quot;w&quot;</span>,stdout);</span><br><span class="line">	<span class="built_in">scanf</span>(<span class="string">&quot;%d%d%lld%d&quot;</span>,&amp;n,&amp;m,&amp;k,&amp;Z);</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">0</span>,<span class="built_in">max</span>(n,m)) <span class="built_in">rep</span>(j,C[i][<span class="number">0</span>]=<span class="number">1</span>,i) C[i][j]=C[i<span class="number">-1</span>][j<span class="number">-1</span>]+C[i<span class="number">-1</span>][j],<span class="built_in">Mod1</span>(C[i][j]);</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">0</span>,n) <span class="built_in">rep</span>(j,<span class="number">0</span>,m) &#123;</span><br><span class="line">		<span class="keyword">if</span>(i*(m-j)+j*(n-i)!=Z) <span class="keyword">continue</span>;</span><br><span class="line">		mk1[i]=mk2[j]=<span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">Solve</span>(n,A,mk1),<span class="built_in">Solve</span>(m,B,mk2);</span><br><span class="line">	<span class="type">int</span> ans=<span class="number">0</span>;</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">0</span>,n) <span class="built_in">rep</span>(j,<span class="number">0</span>,m) &#123;</span><br><span class="line">		<span class="keyword">if</span>(i*(m-j)+j*(n-i)!=Z) <span class="keyword">continue</span>;</span><br><span class="line">		ans=(ans+<span class="number">1ll</span>*A[i]*B[j])%P;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>,ans);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://compilationfail.github.io/oi-solutions/CodeChef/CodeChef%20Winning%20Ways/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="orangejuice">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="orangejuice's blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | orangejuice's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/oi-solutions/CodeChef/CodeChef%20Winning%20Ways/" class="post-title-link" itemprop="url">CodeChef November Challenge2019  Winning Ways (3-FWT)</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2023-08-12 11:05:24 / Modified: 12:37:29" itemprop="dateCreated datePublished" datetime="2023-08-12T11:05:24+08:00">2023-08-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/oi-solutions/" itemprop="url" rel="index"><span itemprop="name">oi-solutions</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="codechef-november-challenge2019-winning-ways-3-fwt">CodeChef
November Challenge2019 Winning Ways (3-FWT)</h1>
<p>显然每个把每个数换成其因子个数-1，就能转为一个扩展的 <span
class="math inline">\(\text{Nim}\)</span> 游戏</p>
<p>每次操作 <span class="math inline">\(1,2,\cdots,k\)</span> 堆的 <span
class="math inline">\(\text{Nim}\)</span> 游戏，其判定方法是：</p>
<p>将每个数二进制分解，对于每个二进制位上分别计算1的个数 <span
class="math inline">\(\mod (k+1)\)</span> ，如果均为0则先手必败</p>
<p>对于这道题 <span class="math inline">\(k=3\)</span>
，我们考虑将其转为二进制之后的形式累成3进制，然后就能进行3进制按位不进位加法，即类异或</p>
<p>然后问题实际上有非常多的部分需要考虑</p>
<h2 id="part1-如何求因子个数">Part1 如何求因子个数</h2>
<p>一个简单的方法是枚举 <span class="math inline">\([1,\sqrt n]\)</span>
判断是否整除，复杂度过高</p>
<p>对于 <span class="math inline">\(n=\prod p_i^{c_i}\)</span> ( <span
class="math inline">\(p_i\)</span> 为质数)，其因子个数为 <span
class="math inline">\(\prod (c_i+1)\)</span></p>
<p>由这个式子对于 <span class="math inline">\(n\)</span>
进行质因数分解，枚举 <span class="math inline">\([1,\sqrt n]\)</span>
中的质数，复杂度为 <span class="math inline">\(O(\pi(\sqrt
n))=O(\frac{\sqrt n}{\log n})\)</span> ，这个应该够了？</p>
<p>然后是一个常规套路型的分解方法：</p>
<p>先对于 <span class="math inline">\([1,n^{\frac{1}{3}}]\)</span>
的质数筛 <span class="math inline">\(n\)</span>
，剩余的部分只有3种情况</p>
<ol type="1">
<li><p><span class="math inline">\(n\)</span> 被筛成1了</p></li>
<li><p><span class="math inline">\(n\)</span> 被筛到只剩一个质数，可以用
<span class="math inline">\(\text{Miller_Rabin}\)</span>
算法快速判断，<a
target="_blank" rel="noopener" href="https://www.cnblogs.com/chasedeath/p/13492548.html"><strong>可以参考</strong></a></p></li>
<li><p><span class="math inline">\(n\)</span>
仍然是若干质数的乘积，此时质因子必然 <span
class="math inline">\(&gt;n^{\frac{1}{3}}\)</span>
，因此最多只有两个</p></li>
</ol>
<p>那么只需要判断 <span class="math inline">\(n\)</span>
是否是完全平方数即可</p>
<p>总复杂度为 <span class="math inline">\(O(w\cdot \log
n+\frac{n^{\frac{1}{3}}}{\log n})\)</span> ，其中 <span
class="math inline">\(w\)</span> 为 <span
class="math inline">\(\text{Miller_Rabin}\)</span> 筛选次数</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> <span class="type">int</span> N=<span class="number">2e5</span>+<span class="number">10</span>;</span><br><span class="line"><span class="type">int</span> notpri[N],pri[N],pc;</span><br><span class="line"></span><br><span class="line"><span class="function">ll <span class="title">qpow</span><span class="params">(ll x,ll k=P<span class="number">-2</span>,<span class="type">int</span> P=::P)</span> </span>&#123;</span><br><span class="line">    ll res=<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span>(;k;k&gt;&gt;=<span class="number">1</span>,x=x*x%P) <span class="keyword">if</span>(k&amp;<span class="number">1</span>) res=res*x%P;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Trans</span><span class="params">(<span class="type">int</span> x)</span></span>&#123; </span><br><span class="line">    <span class="type">static</span> <span class="type">int</span> buf[<span class="number">20</span>],l=<span class="number">0</span>;</span><br><span class="line">    l=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(x) buf[++l]=x%<span class="number">2</span>,x/=<span class="number">2</span>;</span><br><span class="line">    <span class="type">int</span> s=<span class="number">0</span>;</span><br><span class="line">    <span class="built_in">drep</span>(i,l,<span class="number">1</span>) s=s*<span class="number">3</span>+buf[i];</span><br><span class="line">    <span class="built_in">cmax</span>(ma,s);</span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Miller_Rabin</span><span class="params">(<span class="type">int</span> x)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(x&lt;N) <span class="keyword">return</span> !notpri[x];</span><br><span class="line">    <span class="keyword">if</span>(x==<span class="number">2</span>) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span>(x&lt;=<span class="number">1</span> || ~x&amp;<span class="number">1</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    ll s=<span class="number">0</span>,t=x<span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">while</span>(~t&amp;<span class="number">1</span>) s++,t&gt;&gt;=<span class="number">1</span>;</span><br><span class="line">    <span class="built_in">rep</span>(i,<span class="number">1</span>,<span class="number">4</span>) &#123;</span><br><span class="line">        ll a=pri[<span class="built_in">rand</span>()%pc+<span class="number">1</span>],b=<span class="built_in">qpow</span>(a,t,x),c;</span><br><span class="line">        <span class="built_in">rep</span>(j,<span class="number">1</span>,s) &#123;</span><br><span class="line">            c=<span class="number">1ll</span>*b*b%x;</span><br><span class="line">            <span class="keyword">if</span>(c==<span class="number">1</span> &amp;&amp; b!=<span class="number">1</span> &amp;&amp; b!=x<span class="number">-1</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            b=c;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(b!=<span class="number">1</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">CheckSqr</span><span class="params">(<span class="type">int</span> n)</span></span>&#123;</span><br><span class="line">    <span class="type">int</span> y=<span class="built_in">round</span>(<span class="built_in">sqrt</span>(n));</span><br><span class="line">    <span class="keyword">return</span> y*y==n;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Count</span><span class="params">(<span class="type">int</span> n)</span></span>&#123;</span><br><span class="line">    <span class="type">int</span> res=<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">1</span>;i&lt;=pc &amp;&amp; pri[i]*pri[i]*pri[i]&lt;=n;++i) <span class="keyword">if</span>(n%pri[i]==<span class="number">0</span>) &#123;</span><br><span class="line">        <span class="type">int</span> c=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>(n%pri[i]==<span class="number">0</span>) n/=pri[i],c++;</span><br><span class="line">        res*=c+<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(n==<span class="number">1</span>) <span class="keyword">return</span> res;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">CheckSqr</span>(n)) <span class="keyword">return</span> res*<span class="number">3</span>;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">Miller_Rabin</span>(n)) <span class="keyword">return</span> res*<span class="number">2</span>;</span><br><span class="line">    <span class="keyword">return</span> res*<span class="number">4</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Init</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">rep</span>(i,<span class="number">2</span>,N<span class="number">-1</span>) <span class="keyword">if</span>(!notpri[i]) &#123;</span><br><span class="line">        pri[++pc]=i;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> j=i+i;j&lt;N;j+=i) notpri[j]=<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="part2-快速计算答案">Part2 快速计算答案</h2>
<p><span class="math inline">\(10^9\)</span> 以内的数，最大因子个数为
<span class="math inline">\(1334\)</span> ，这个数为 <span
class="math inline">\(931170240\)</span></p>
<p>转成二进制之后最多包含 <span class="math inline">\(11\)</span>
位，三进制下最大为 <span class="math inline">\(3^{11}-1=177146\)</span>
，令这个上界为 <span class="math inline">\(M\)</span></p>
<p>一种非常暴力的方法就是直接枚举， <span
class="math inline">\(NM\)</span> 计算每次选择一个数，复杂度为 <span
class="math inline">\(O(NMK)\)</span> ，应该可以通过 <span
class="math inline">\(N\leq 12\)</span> 的数据</p>
<p>一个比较浅显的优化可以用快速幂维护乘法，复杂度为 <span
class="math inline">\(O(M^2\log K)\)</span></p>
<p>由于是3进制类异或，接下来考虑用 <span
class="math inline">\(\text{3-FWT}\)</span> 优化乘法，<a
target="_blank" rel="noopener" href="https://www.cnblogs.com/chasedeath/p/12785842.html"><strong>可以参考</strong></a></p>
<p>模数为 <span class="math inline">\(P=10^9+7\)</span> ，不存在整数
<span class="math inline">\(3\)</span> 阶单位根，因此要用类似拆系数
<span class="math inline">\(\text{FFT}\)</span> 方法做</p>
<p>复杂度为 <span class="math inline">\(O(M\log M\log K)\)</span>
，似乎已经比较小了，但是常数非常大，应该难以通过</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> R;<span class="comment">// R为上界</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Cp</span>&#123;</span><br><span class="line">    db x,y;</span><br><span class="line">    <span class="built_in">Cp</span>()&#123;&#125;</span><br><span class="line">    <span class="built_in">Cp</span>(db x,db y):<span class="built_in">x</span>(x),<span class="built_in">y</span>(y) &#123;&#125;</span><br><span class="line">    Cp <span class="keyword">operator</span> + (<span class="type">const</span> Cp t)&#123; <span class="keyword">return</span> <span class="built_in">Cp</span>(x+t.x,y+t.y); &#125;</span><br><span class="line">    Cp <span class="keyword">operator</span> - (<span class="type">const</span> Cp t)&#123; <span class="keyword">return</span> <span class="built_in">Cp</span>(x-t.x,y-t.y); &#125;</span><br><span class="line">    Cp <span class="keyword">operator</span> * (<span class="type">const</span> Cp t)&#123; <span class="keyword">return</span> <span class="built_in">Cp</span>(x*t.x-y*t.y,x*t.y+y*t.x); &#125;</span><br><span class="line">&#125; A[N],B[N],C[N],D[N];</span><br><span class="line">Cp w[<span class="number">30</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Add</span><span class="params">(<span class="type">int</span> x,<span class="type">int</span> y)</span> </span>&#123;</span><br><span class="line">    <span class="type">static</span> <span class="type">int</span> A[<span class="number">20</span>],B[<span class="number">20</span>];</span><br><span class="line">    <span class="built_in">rep</span>(i,<span class="number">0</span>,<span class="number">19</span>) A[i]=x%<span class="number">3</span>,x/=<span class="number">3</span>;</span><br><span class="line">    <span class="built_in">rep</span>(i,<span class="number">0</span>,<span class="number">19</span>) B[i]=y%<span class="number">3</span>,y/=<span class="number">3</span>;</span><br><span class="line">    <span class="type">int</span> ans=<span class="number">0</span>;</span><br><span class="line">    <span class="built_in">drep</span>(i,<span class="number">19</span>,<span class="number">0</span>) ans=ans*<span class="number">3</span>+((A[i]+B[i])%<span class="number">3</span>);</span><br><span class="line">    <span class="keyword">return</span> ans;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">FWT</span><span class="params">(Cp *a,<span class="type">int</span> f)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">1</span>;i&lt;R;i*=<span class="number">3</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> l=<span class="number">0</span>;l&lt;R;l+=i*<span class="number">3</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> j=l;j&lt;l+i;++j) &#123;</span><br><span class="line">                <span class="type">static</span> Cp t[<span class="number">3</span>];</span><br><span class="line">                <span class="keyword">if</span>(f==<span class="number">1</span>) &#123;</span><br><span class="line">                    t[<span class="number">0</span>]=a[j]+a[j+i]+a[j+i*<span class="number">2</span>];</span><br><span class="line">                    t[<span class="number">1</span>]=a[j]+w[<span class="number">1</span>]*a[j+i]+w[<span class="number">2</span>]*a[j+i*<span class="number">2</span>];</span><br><span class="line">                    t[<span class="number">2</span>]=a[j]+w[<span class="number">2</span>]*a[j+i]+w[<span class="number">1</span>]*a[j+i*<span class="number">2</span>];</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    t[<span class="number">0</span>]=a[j]+a[j+i]+a[j+i*<span class="number">2</span>];</span><br><span class="line">                    t[<span class="number">1</span>]=a[j]+w[<span class="number">2</span>]*a[j+i]+w[<span class="number">1</span>]*a[j+i*<span class="number">2</span>];</span><br><span class="line">                    t[<span class="number">2</span>]=a[j]+w[<span class="number">1</span>]*a[j+i]+w[<span class="number">2</span>]*a[j+i*<span class="number">2</span>];</span><br><span class="line">                &#125;</span><br><span class="line">                a[j]=t[<span class="number">0</span>],a[j+i]=t[<span class="number">1</span>],a[j+i*<span class="number">2</span>]=t[<span class="number">2</span>];</span><br><span class="line">                <span class="keyword">if</span>(f==<span class="number">-1</span>) &#123;</span><br><span class="line">                    <span class="built_in">rep</span>(d,<span class="number">0</span>,<span class="number">2</span>) &#123;</span><br><span class="line">                        a[j+i*d].x/=<span class="number">3</span>,a[j+i*d].y/=<span class="number">3</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> S=(<span class="number">1</span>&lt;&lt;<span class="number">15</span>)<span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FWTs</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Poly</span>&#123; </span><br><span class="line">    <span class="type">int</span> a[N];</span><br><span class="line">    Poly <span class="keyword">operator</span> * (<span class="type">const</span> Poly __) <span class="type">const</span> &#123;</span><br><span class="line">        Poly res;</span><br><span class="line">        <span class="comment">// 拆系数，任意模数3-FWT</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> FWTs</span></span><br><span class="line">        <span class="built_in">rep</span>(i,<span class="number">0</span>,R<span class="number">-1</span>) A[i]=<span class="built_in">Cp</span>((a[i]&amp;S),(a[i]&gt;&gt;<span class="number">15</span>)),B[i]=<span class="built_in">Cp</span>((a[i]&amp;S),<span class="number">0</span>);</span><br><span class="line">        <span class="built_in">rep</span>(i,<span class="number">0</span>,R<span class="number">-1</span>) C[i]=<span class="built_in">Cp</span>((__.a[i]&amp;S),(__.a[i]&gt;&gt;<span class="number">15</span>));</span><br><span class="line">        <span class="built_in">FWT</span>(A,<span class="number">1</span>),<span class="built_in">FWT</span>(B,<span class="number">1</span>),<span class="built_in">FWT</span>(C,<span class="number">1</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> E(x) ((ll)(x+0.5))%P</span></span><br><span class="line">        <span class="built_in">rep</span>(i,<span class="number">0</span>,R<span class="number">-1</span>) A[i]=A[i]*C[i];</span><br><span class="line">        <span class="built_in">rep</span>(i,<span class="number">0</span>,R<span class="number">-1</span>) B[i]=B[i]*C[i];</span><br><span class="line">        <span class="built_in">FWT</span>(A,<span class="number">-1</span>),<span class="built_in">FWT</span>(B,<span class="number">-1</span>);</span><br><span class="line">        <span class="built_in">rep</span>(i,<span class="number">0</span>,R<span class="number">-1</span>) &#123;</span><br><span class="line">            ll a=<span class="built_in">E</span>(B[i].x),b=<span class="built_in">E</span>(A[i].y),c=<span class="built_in">E</span>(B[i].x-A[i].x);</span><br><span class="line">            res.a[i]=(a+<span class="number">1ll</span>*b*(S+<span class="number">1</span>)+<span class="number">1ll</span>*c*(S+<span class="number">1</span>)*(S+<span class="number">1</span>))%P;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">        <span class="built_in">rep</span>(i,<span class="number">0</span>,R<span class="number">-1</span>) res.a[i]=<span class="number">0</span>;</span><br><span class="line">        <span class="built_in">rep</span>(i,<span class="number">0</span>,R<span class="number">-1</span>) <span class="keyword">if</span>(a[i]) <span class="built_in">rep</span>(j,<span class="number">0</span>,R<span class="number">-1</span>) <span class="keyword">if</span>(__.a[j]) &#123;</span><br><span class="line">            <span class="type">int</span> k=<span class="built_in">Add</span>(i,j);</span><br><span class="line">            res.a[k]=(res.a[k]+<span class="number">1ll</span>*a[i]*__.a[j])%P;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; x,res;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">ll <span class="title">qpow</span><span class="params">(ll x,ll k=P<span class="number">-2</span>)</span> </span>&#123;</span><br><span class="line">    ll res=<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span>(;k;k&gt;&gt;=<span class="number">1</span>,x=x*x%P) <span class="keyword">if</span>(k&amp;<span class="number">1</span>) res=res*x%P;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">rep</span>(i,<span class="number">2</span>,N<span class="number">-1</span>) <span class="keyword">if</span>(!notpri[i]) &#123;</span><br><span class="line">        pri[++pc]=i;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> j=i+i;j&lt;N;j+=i) notpri[j]=<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    w[<span class="number">0</span>]=<span class="built_in">Cp</span>(<span class="number">1</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="built_in">rep</span>(i,<span class="number">1</span>,<span class="number">29</span>) w[i]=w[i<span class="number">-1</span>]*<span class="built_in">Cp</span>(<span class="built_in">cos</span>(<span class="number">2</span>*Pi/<span class="number">3</span>),<span class="built_in">sin</span>(<span class="number">2</span>*Pi/<span class="number">3</span>));</span><br><span class="line">    <span class="comment">// 复平面3阶单位根</span></span><br><span class="line"></span><br><span class="line">    n=<span class="built_in">rd</span>(),m=<span class="built_in">rd</span>();</span><br><span class="line">    <span class="built_in">rep</span>(i,<span class="number">1</span>,n) x.a[<span class="built_in">Count</span>(<span class="built_in">rd</span>())]++;</span><br><span class="line">    <span class="keyword">for</span>(R=<span class="number">1</span>;R&lt;=ma;R*=<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">    res.a[<span class="number">0</span>]++;</span><br><span class="line">    <span class="keyword">for</span>(;m;m&gt;&gt;=<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>(m&amp;<span class="number">1</span>) res=res*x;</span><br><span class="line">        x=x*x;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> ans=<span class="number">0</span>;</span><br><span class="line">    <span class="built_in">rep</span>(i,<span class="number">1</span>,R<span class="number">-1</span>) ans+=res.a[i],<span class="built_in">Mod1</span>(ans);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>,ans);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="further">Further</h3>
<p>对于形式幂级数多项式，我们知道 <span class="math inline">\(K\)</span>
次幂的循环卷积可以直接 <span class="math inline">\(\text{DFT}\)</span>
一次，每一位快速幂，然后 <span
class="math inline">\(\text{IDFT}\)</span></p>
<p>同理的，如果你学习了 <span
class="math inline">\(\text{K-FWT}\)</span> 就知道这就是一个按 <span
class="math inline">\(K\)</span>
进制位，每一位分别进行循环卷积，因此也可以用类似的方法做</p>
<p>但是遇到一个非常大的问题就是无法找到模意义下的 <span
class="math inline">\(3\)</span> 阶单位根(指 <span
class="math inline">\(3\not |(P-1)\)</span> )</p>
<p>如果用复平面单位根 <span
class="math inline">\(\omega_n=cos(\frac{2\pi}{n})+sin(\frac{2\pi}{n})\cdot
i\)</span> ( <span class="math inline">\(i=\sqrt {-1})\)</span>
，无法在计算时保证值域精度</p>
<p>这里由于 <span class="math inline">\(n=3\)</span> 比较特殊，发现
<span
class="math inline">\(\omega_3=cos(\frac{2\pi}{3})+sin(\frac{2\pi}{3})\cdot
i=-\frac{1}{2}+\frac{\sqrt 3}{2}\cdot i\)</span></p>
<p>而 <span class="math inline">\(3\)</span> 在 <span
class="math inline">\(\mod 10^9+7\)</span>
下存在二次剩余，因此可以用一个模意义下的复数描述复平面单位根</p>
<p>应该是有通行的单位根求法，会根据 <span
class="math inline">\(n\)</span>
不同要用更复杂的高维复数描述，但是我并不会.jpg</p>
<p>总复杂度为 <span class="math inline">\(O(M(\log M+\log K))\)</span>
，分别为进行 <span class="math inline">\(\text{3-FWT}\)</span>
以及快速幂的复杂度</p>
<p>Code总览:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">long</span> <span class="type">long</span> ll;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> ull;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">long</span> <span class="type">double</span> db;</span><br><span class="line"><span class="keyword">typedef</span> pair &lt;<span class="type">int</span>,<span class="type">int</span>&gt; Pii;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> reg register</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> pb push_back</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> mp make_pair</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> Mod1(x) ((x&gt;=P)&amp;&amp;(x-=P))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> Mod2(x) ((x&lt;0)&amp;&amp;(x+=P))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> rep(i,a,b) for(int i=a,i##end=b;i&lt;=i##end;++i)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> drep(i,a,b) for(int i=a,i##end=b;i&gt;=i##end;--i)</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt; <span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">cmin</span><span class="params">(T &amp;a,T b)</span></span>&#123; ((a&gt;b)&amp;&amp;(a=b)); &#125;</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt; <span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">cmax</span><span class="params">(T &amp;a,T b)</span></span>&#123; ((a&lt;b)&amp;&amp;(a=b)); &#125;</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> IO;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">rd</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="type">int</span> s=<span class="number">0</span>,f=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(!<span class="built_in">isdigit</span>(IO=<span class="built_in">getchar</span>())) <span class="keyword">if</span>(IO==<span class="string">&#x27;-&#x27;</span>) f=<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">do</span> s=(s&lt;&lt;<span class="number">1</span>)+(s&lt;&lt;<span class="number">3</span>)+(IO^<span class="string">&#x27;0&#x27;</span>);</span><br><span class="line">    <span class="keyword">while</span>(<span class="built_in">isdigit</span>(IO=<span class="built_in">getchar</span>()));</span><br><span class="line">    <span class="keyword">return</span> f?-s:s;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">bool</span> Mbe;</span><br><span class="line"><span class="type">const</span> <span class="type">int</span> N=<span class="number">2e5</span>,P=<span class="number">1e9</span>+<span class="number">7</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">int</span> Quad3=<span class="number">82062379</span>; <span class="comment">// 3在Mod P意义下的二次剩余</span></span><br><span class="line"><span class="type">const</span> db Pi=<span class="built_in">acos</span>((db)<span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> MaxX=<span class="number">931170240</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> n,m,ma,R;</span><br><span class="line"><span class="type">int</span> notpri[N],pri[N],pc;</span><br><span class="line"></span><br><span class="line"><span class="function">ll <span class="title">qpow</span><span class="params">(ll x,ll k=P<span class="number">-2</span>,<span class="type">int</span> P=::P)</span> </span>&#123;</span><br><span class="line">    ll res=<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span>(;k;k&gt;&gt;=<span class="number">1</span>,x=x*x%P) <span class="keyword">if</span>(k&amp;<span class="number">1</span>) res=res*x%P;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Trans</span><span class="params">(<span class="type">int</span> x)</span></span>&#123; </span><br><span class="line">    <span class="type">static</span> <span class="type">int</span> buf[<span class="number">20</span>],l=<span class="number">0</span>;</span><br><span class="line">    l=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(x) buf[++l]=x%<span class="number">2</span>,x/=<span class="number">2</span>;</span><br><span class="line">    <span class="type">int</span> s=<span class="number">0</span>;</span><br><span class="line">    <span class="built_in">drep</span>(i,l,<span class="number">1</span>) s=s*<span class="number">3</span>+buf[i];</span><br><span class="line">    <span class="built_in">cmax</span>(ma,s);</span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Miller_Rabin</span><span class="params">(<span class="type">int</span> x)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(x&lt;N) <span class="keyword">return</span> !notpri[x];</span><br><span class="line">    <span class="keyword">if</span>(x==<span class="number">2</span>) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span>(x&lt;=<span class="number">1</span> || ~x&amp;<span class="number">1</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    ll s=<span class="number">0</span>,t=x<span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">while</span>(~t&amp;<span class="number">1</span>) s++,t&gt;&gt;=<span class="number">1</span>;</span><br><span class="line">    <span class="built_in">rep</span>(i,<span class="number">1</span>,<span class="number">4</span>) &#123;</span><br><span class="line">        ll a=pri[<span class="built_in">rand</span>()%pc+<span class="number">1</span>],b=<span class="built_in">qpow</span>(a,t,x),c;</span><br><span class="line">        <span class="built_in">rep</span>(j,<span class="number">1</span>,s) &#123;</span><br><span class="line">            c=<span class="number">1ll</span>*b*b%x;</span><br><span class="line">            <span class="keyword">if</span>(c==<span class="number">1</span> &amp;&amp; b!=<span class="number">1</span> &amp;&amp; b!=x<span class="number">-1</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            b=c;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(b!=<span class="number">1</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">CheckSqr</span><span class="params">(<span class="type">int</span> n)</span></span>&#123;</span><br><span class="line">    <span class="type">int</span> y=<span class="built_in">round</span>(<span class="built_in">sqrt</span>(n));</span><br><span class="line">    <span class="keyword">return</span> y*y==n;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Count</span><span class="params">(<span class="type">int</span> n)</span></span>&#123;</span><br><span class="line">    <span class="type">int</span> res=<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">1</span>;i&lt;=pc &amp;&amp; pri[i]*pri[i]*pri[i]&lt;=n;++i) <span class="keyword">if</span>(n%pri[i]==<span class="number">0</span>) &#123;</span><br><span class="line">        <span class="type">int</span> c=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>(n%pri[i]==<span class="number">0</span>) n/=pri[i],c++;</span><br><span class="line">        res*=c+<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(n==<span class="number">1</span>) <span class="keyword">return</span> res;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">CheckSqr</span>(n)) <span class="keyword">return</span> res*<span class="number">3</span>;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">Miller_Rabin</span>(n)) <span class="keyword">return</span> res*<span class="number">2</span>;</span><br><span class="line">    <span class="keyword">return</span> res*<span class="number">4</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Cp</span>&#123;</span><br><span class="line">    <span class="type">int</span> x,y;</span><br><span class="line">    <span class="built_in">Cp</span>()&#123;&#125;</span><br><span class="line">    <span class="built_in">Cp</span>(<span class="type">int</span> x,<span class="type">int</span> y):<span class="built_in">x</span>(x),<span class="built_in">y</span>(y) &#123;&#125;</span><br><span class="line">    Cp <span class="keyword">operator</span> + (<span class="type">const</span> Cp t)&#123; </span><br><span class="line">        <span class="function">Cp <span class="title">res</span><span class="params">(x+t.x,y+t.y)</span></span>;</span><br><span class="line">        <span class="built_in">Mod1</span>(res.x),<span class="built_in">Mod1</span>(res.y);</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">    Cp <span class="keyword">operator</span> * (<span class="type">const</span> Cp t)&#123; <span class="keyword">return</span> <span class="built_in">Cp</span>((<span class="number">1ll</span>*x*t.x+<span class="number">1ll</span>*(P-y)*t.y)%P,(<span class="number">1ll</span>*x*t.y+<span class="number">1ll</span>*y*t.x)%P); &#125;</span><br><span class="line">&#125; A[N]; <span class="comment">// 模意义下 模拟复平面单位根</span></span><br><span class="line">Cp w1,w2; <span class="comment">// 3阶单位根及其平方</span></span><br><span class="line"></span><br><span class="line"><span class="function">Cp <span class="title">qpow</span><span class="params">(Cp x,ll k=P<span class="number">-2</span>)</span> </span>&#123;</span><br><span class="line">    <span class="function">Cp <span class="title">res</span><span class="params">(<span class="number">1</span>,<span class="number">0</span>)</span></span>;</span><br><span class="line">    <span class="keyword">for</span>(;k;k&gt;&gt;=<span class="number">1</span>,x=x*x) <span class="keyword">if</span>(k&amp;<span class="number">1</span>) res=res*x;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 下面是展开的FWT式子</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">FWT</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">1</span>;i&lt;R;i*=<span class="number">3</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> l=<span class="number">0</span>;l&lt;R;l+=i*<span class="number">3</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> j=l;j&lt;l+i;++j) &#123;</span><br><span class="line">                Cp a=A[j]+A[j+i]+A[j+i*<span class="number">2</span>];</span><br><span class="line">                Cp b=A[j]+w1*A[j+i]+w2*A[j+i*<span class="number">2</span>];</span><br><span class="line">                Cp c=A[j]+w2*A[j+i]+w1*A[j+i*<span class="number">2</span>];</span><br><span class="line">                A[j]=a,A[j+i]=b,A[j+i*<span class="number">2</span>]=c;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">IFWT</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">1</span>;i&lt;R;i*=<span class="number">3</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> l=<span class="number">0</span>;l&lt;R;l+=i*<span class="number">3</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> j=l;j&lt;l+i;++j) &#123;</span><br><span class="line">                Cp a=A[j]+A[j+i]+A[j+i*<span class="number">2</span>];</span><br><span class="line">                Cp b=A[j]+w2*A[j+i]+w1*A[j+i*<span class="number">2</span>];</span><br><span class="line">                Cp c=A[j]+w1*A[j+i]+w2*A[j+i*<span class="number">2</span>];</span><br><span class="line">                A[j]=a,A[j+i]=b,A[j+i*<span class="number">2</span>]=c;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ll base=<span class="built_in">qpow</span>(R);</span><br><span class="line">    <span class="built_in">rep</span>(i,<span class="number">0</span>,R<span class="number">-1</span>) A[i].x=A[i].x*base%P;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">rep</span>(i,<span class="number">2</span>,N<span class="number">-1</span>) <span class="keyword">if</span>(!notpri[i]) &#123;</span><br><span class="line">        pri[++pc]=i;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> j=i+i;j&lt;N;j+=i) notpri[j]=<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    w1=<span class="built_in">Cp</span>(P-(P+<span class="number">1</span>)/<span class="number">2</span>,<span class="number">1ll</span>*Quad3*(P+<span class="number">1</span>)/<span class="number">2</span>%P);</span><br><span class="line">    w2=w1*w1;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">rep</span>(kase,<span class="number">1</span>,<span class="built_in">rd</span>()) &#123;</span><br><span class="line">        n=<span class="built_in">rd</span>(),m=<span class="built_in">rd</span>();</span><br><span class="line">        <span class="built_in">rep</span>(i,<span class="number">1</span>,n) A[<span class="built_in">Trans</span>(<span class="built_in">Count</span>(<span class="built_in">rd</span>())<span class="number">-1</span>)].x++;</span><br><span class="line">        <span class="keyword">for</span>(R=<span class="number">1</span>;R&lt;=ma;R*=<span class="number">3</span>);</span><br><span class="line">        <span class="built_in">FWT</span>();</span><br><span class="line">        <span class="built_in">rep</span>(i,<span class="number">0</span>,R<span class="number">-1</span>) A[i]=<span class="built_in">qpow</span>(A[i],m);</span><br><span class="line">        <span class="built_in">IFWT</span>();</span><br><span class="line">        <span class="type">int</span> ans=<span class="number">0</span>;</span><br><span class="line">        <span class="built_in">rep</span>(i,<span class="number">1</span>,R<span class="number">-1</span>) ans+=A[i].x,<span class="built_in">Mod1</span>(ans);</span><br><span class="line">        <span class="built_in">rep</span>(i,<span class="number">0</span>,R<span class="number">-1</span>) A[i].x=A[i].y=<span class="number">0</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>,ans);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://compilationfail.github.io/oi-solutions/CodeChef/Codechef%202020NOV%20Chef%20and%20the%20Combination%20Clock/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="orangejuice">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="orangejuice's blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | orangejuice's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/oi-solutions/CodeChef/Codechef%202020NOV%20Chef%20and%20the%20Combination%20Clock/" class="post-title-link" itemprop="url">CodeChef 2020 November - Challenge Chef and the Combination Lock (多项式)</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2023-08-12 11:05:24 / Modified: 12:37:29" itemprop="dateCreated datePublished" datetime="2023-08-12T11:05:24+08:00">2023-08-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/oi-solutions/" itemprop="url" rel="index"><span itemprop="name">oi-solutions</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1
id="codechef-2020-november---challenge-chef-and-the-combination-lock-多项式">CodeChef
2020 November - Challenge Chef and the Combination Lock (多项式)</h1>
<p>题目大意：给定了 <span class="math inline">\(n\)</span> 个随机变量
<span class="math inline">\(x_i\in{0,1,\cdots,A_i}\)</span> ，令 <span
class="math inline">\(\Chi=\min_i\lbrace x_i,A_i-x_i\rbrace\)</span>
，求 <span class="math inline">\(E(\Chi)\)</span></p>
<p>我们知道 <span class="math inline">\(E(\Chi)=\sum_{i=0}^{\infty}
P(\Chi&gt;i)\)</span></p>
<p>不妨考虑计算 <span class="math inline">\(P(\Chi&gt;i)\)</span>
，先计算方案数，发现方案数可以用一个多项式来表示</p>
<p>令 <span class="math inline">\(F(x)\)</span> 为 <span
class="math inline">\(\Chi&gt;x\)</span> 的方案数，则 <span
class="math inline">\(\begin{aligned}F(x)=\prod_{i=1}^n
(A_i-1-2x)　\end{aligned}\)</span></p>
<p>显然 <span class="math inline">\(\Chi \leq \min\lbrace \frac{A_i}{2}
\rbrace\)</span> ，不妨设这个上界为 <span
class="math inline">\(U\)</span> ，也就是说我们要求 <span
class="math inline">\(\sum_{i=0}^U F(i)\)</span></p>
<p>常识：一个 <span class="math inline">\(n\)</span>
次多项式前缀和可以用一个不超过 <span class="math inline">\(n+1\)</span>
次的多项式来表示</p>
<p>如果暴力求出 <span class="math inline">\(F(x)\)</span> 在 <span
class="math inline">\(x=0,1,\cdots,n+1\)</span>
处的值，累前缀和，然后用拉格朗日插值法求出解</p>
<p>暴力求值复杂度为 <span class="math inline">\(O(n^2)\)</span>
，拉格朗日插值复杂度为 <span class="math inline">\(O(n)\)</span></p>
<p>可以用分治 <span class="math inline">\(\text{NTT}\)</span> 优化 <span
class="math inline">\(F(x)\)</span> 的求解，然后用<a
target="_blank" rel="noopener" href="https://www.cnblogs.com/chasedeath/p/13073178.html"><strong>多项式多点求值</strong></a>求得点值</p>
<p>复杂度为 <span class="math inline">\(O(n\log ^2n)\)</span>
，实际在CodeChef上的运行时间为0.53s</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">long</span> <span class="type">long</span> ll;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">double</span> db;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> ull;</span><br><span class="line"><span class="keyword">typedef</span> pair &lt;<span class="type">int</span>,<span class="type">int</span>&gt; Pii;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> reg register</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> pb push_back</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> mp make_pair</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> Mod1(x) ((x&gt;=P)&amp;&amp;(x-=P))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> Mod2(x) ((x&lt;0)&amp;&amp;(x+=P))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> rep(i,a,b) for(int i=a,i##end=b;i&lt;=i##end;++i)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> drep(i,a,b) for(int i=a,i##end=b;i&gt;=i##end;--i)</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt; <span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">cmin</span><span class="params">(T &amp;a,T b)</span></span>&#123; ((a&gt;b)&amp;&amp;(a=b)); &#125;</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt; <span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">cmax</span><span class="params">(T &amp;a,T b)</span></span>&#123; ((a&lt;b)&amp;&amp;(a=b)); &#125;</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> IO;</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">T</span>=<span class="type">int</span>&gt; T <span class="built_in">rd</span>()&#123;</span><br><span class="line">	T s=<span class="number">0</span>; <span class="type">int</span> f=<span class="number">0</span>;</span><br><span class="line">	<span class="keyword">while</span>(!<span class="built_in">isdigit</span>(IO=<span class="built_in">getchar</span>())) <span class="keyword">if</span>(IO==<span class="string">&#x27;-&#x27;</span>) f=<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">do</span> s=(s&lt;&lt;<span class="number">1</span>)+(s&lt;&lt;<span class="number">3</span>)+(IO^<span class="string">&#x27;0&#x27;</span>);</span><br><span class="line">	<span class="keyword">while</span>(<span class="built_in">isdigit</span>(IO=<span class="built_in">getchar</span>()));</span><br><span class="line">	<span class="keyword">return</span> f?-s:s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> N=<span class="number">1</span>&lt;&lt;<span class="number">18</span>,P=<span class="number">998244353</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">ll <span class="title">qpow</span><span class="params">(ll x,ll k=P<span class="number">-2</span>)</span> </span>&#123;</span><br><span class="line">	ll res=<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">for</span>(;k;k&gt;&gt;=<span class="number">1</span>,x=x*x%P) <span class="keyword">if</span>(k&amp;<span class="number">1</span>) res=res*x%P;</span><br><span class="line">	<span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> vector &lt;<span class="type">int</span>&gt; Poly;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Show</span><span class="params">(Poly a,<span class="type">int</span> k=<span class="number">0</span>)</span></span>&#123; </span><br><span class="line">	<span class="keyword">if</span>(!k)&#123; <span class="keyword">for</span>(<span class="type">int</span> i:a) <span class="built_in">printf</span>(<span class="string">&quot;%d &quot;</span>,i); <span class="built_in">puts</span>(<span class="string">&quot;&quot;</span>); &#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">for</span>(<span class="type">int</span> i:a) <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>,i);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> rev[N],w[N];</span><br><span class="line"><span class="type">int</span> Inv[N+<span class="number">1</span>],Fac[N+<span class="number">1</span>],FInv[N+<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Init</span><span class="params">()</span> </span>&#123; </span><br><span class="line">	<span class="type">int</span> t=<span class="built_in">qpow</span>(<span class="number">3</span>,(P<span class="number">-1</span>)/N);</span><br><span class="line">	w[N&gt;&gt;<span class="number">1</span>]=<span class="number">1</span>;</span><br><span class="line">	<span class="built_in">rep</span>(i,(N&gt;&gt;<span class="number">1</span>)+<span class="number">1</span>,N<span class="number">-1</span>) w[i]=<span class="number">1ll</span>*w[i<span class="number">-1</span>]*t%P;</span><br><span class="line">	<span class="built_in">drep</span>(i,(N&gt;&gt;<span class="number">1</span>)<span class="number">-1</span>,<span class="number">1</span>) w[i]=w[i&lt;&lt;<span class="number">1</span>];</span><br><span class="line">	Inv[<span class="number">0</span>]=Inv[<span class="number">1</span>]=Fac[<span class="number">0</span>]=Fac[<span class="number">1</span>]=FInv[<span class="number">0</span>]=FInv[<span class="number">1</span>]=<span class="number">1</span>;</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">2</span>,N) &#123;</span><br><span class="line">		Inv[i]=<span class="number">1ll</span>*(P-P/i)*Inv[P%i]%P; </span><br><span class="line">		FInv[i]=<span class="number">1ll</span>*FInv[i<span class="number">-1</span>]*Inv[i]%P;</span><br><span class="line">		Fac[i]=<span class="number">1ll</span>*Fac[i<span class="number">-1</span>]*i%P;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Init</span><span class="params">(<span class="type">int</span> n)</span></span>&#123;</span><br><span class="line">	<span class="type">int</span> R=<span class="number">1</span>,c=<span class="number">-1</span>;</span><br><span class="line">	<span class="keyword">while</span>(R&lt;n) R&lt;&lt;=<span class="number">1</span>,c++;</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">1</span>,R<span class="number">-1</span>) rev[i]=(rev[i&gt;&gt;<span class="number">1</span>]&gt;&gt;<span class="number">1</span>)|((i&amp;<span class="number">1</span>)&lt;&lt;c);</span><br><span class="line">	<span class="keyword">return</span> R;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">NTT</span><span class="params">(<span class="type">int</span> n,<span class="type">int</span> *a,<span class="type">int</span> f)</span></span>&#123;</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">0</span>,n<span class="number">-1</span>) <span class="keyword">if</span>(rev[i]&lt;i) <span class="built_in">swap</span>(a[i],a[rev[i]]);</span><br><span class="line">	<span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">1</span>;i&lt;n;i&lt;&lt;=<span class="number">1</span>) &#123;</span><br><span class="line">		<span class="type">int</span> *e=w+i;</span><br><span class="line">		<span class="keyword">for</span>(<span class="type">int</span> l=<span class="number">0</span>;l&lt;n;l+=i*<span class="number">2</span>) &#123;</span><br><span class="line">			<span class="keyword">for</span>(<span class="type">int</span> j=l;j&lt;l+i;++j) &#123;</span><br><span class="line">				<span class="type">int</span> t=<span class="number">1ll</span>*a[j+i]*e[j-l]%P;</span><br><span class="line">				a[j+i]=a[j]-t,<span class="built_in">Mod2</span>(a[j+i]);</span><br><span class="line">				a[j]+=t,<span class="built_in">Mod1</span>(a[j]);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(f==<span class="number">-1</span>) &#123;</span><br><span class="line">		<span class="built_in">reverse</span>(a+<span class="number">1</span>,a+n);</span><br><span class="line">		ll base=Inv[n];</span><br><span class="line">		<span class="built_in">rep</span>(i,<span class="number">0</span>,n<span class="number">-1</span>) a[i]=a[i]*base%P;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">NTT</span><span class="params">(<span class="type">int</span> n,Poly &amp;a,<span class="type">int</span> f)</span></span>&#123;</span><br><span class="line">	<span class="type">static</span> <span class="type">int</span> A[N];</span><br><span class="line">	<span class="keyword">if</span>((<span class="type">int</span>)a.<span class="built_in">size</span>()&lt;n) a.<span class="built_in">resize</span>(n);</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">0</span>,n<span class="number">-1</span>) A[i]=a[i];</span><br><span class="line">	<span class="built_in">NTT</span>(n,A,f);</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">0</span>,n<span class="number">-1</span>) a[i]=A[i];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Poly <span class="keyword">operator</span> * (Poly a,Poly b)&#123;</span><br><span class="line">	<span class="type">int</span> n=a.<span class="built_in">size</span>()+b.<span class="built_in">size</span>()<span class="number">-1</span>;</span><br><span class="line">	<span class="type">int</span> R=<span class="built_in">Init</span>(n);</span><br><span class="line">	a.<span class="built_in">resize</span>(R),b.<span class="built_in">resize</span>(R);</span><br><span class="line">	<span class="built_in">NTT</span>(R,a,<span class="number">1</span>),<span class="built_in">NTT</span>(R,b,<span class="number">1</span>);</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">0</span>,R<span class="number">-1</span>) a[i]=<span class="number">1ll</span>*a[i]*b[i]%P;</span><br><span class="line">	<span class="built_in">NTT</span>(R,a,<span class="number">-1</span>);</span><br><span class="line">	a.<span class="built_in">resize</span>(n);</span><br><span class="line">	<span class="keyword">return</span> a;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Poly <span class="keyword">operator</span> + (Poly a,Poly b) &#123; </span><br><span class="line">	<span class="type">int</span> n=<span class="built_in">max</span>(a.<span class="built_in">size</span>(),b.<span class="built_in">size</span>());</span><br><span class="line">	a.<span class="built_in">resize</span>(n),b.<span class="built_in">resize</span>(n);</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">0</span>,n<span class="number">-1</span>) a[i]+=b[i],<span class="built_in">Mod1</span>(a[i]);</span><br><span class="line">	<span class="keyword">return</span> a; </span><br><span class="line">&#125;</span><br><span class="line">Poly <span class="keyword">operator</span> - (Poly a,Poly b) &#123; </span><br><span class="line">	<span class="type">int</span> n=<span class="built_in">max</span>(a.<span class="built_in">size</span>(),b.<span class="built_in">size</span>());</span><br><span class="line">	a.<span class="built_in">resize</span>(n),b.<span class="built_in">resize</span>(n);</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">0</span>,n<span class="number">-1</span>) a[i]-=b[i],<span class="built_in">Mod2</span>(a[i]);</span><br><span class="line">	<span class="keyword">return</span> a; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Poly <span class="title">Poly_Inv</span><span class="params">(Poly a)</span> </span>&#123; </span><br><span class="line">	<span class="type">int</span> n=a.<span class="built_in">size</span>();</span><br><span class="line">	<span class="keyword">if</span>(n==<span class="number">1</span>) <span class="keyword">return</span> Poly&#123;(<span class="type">int</span>)<span class="built_in">qpow</span>(a[<span class="number">0</span>],P<span class="number">-2</span>)&#125;;</span><br><span class="line">	Poly b=a; b.<span class="built_in">resize</span>((n+<span class="number">1</span>)/<span class="number">2</span>); b=<span class="built_in">Poly_Inv</span>(b);</span><br><span class="line">	<span class="type">int</span> R=<span class="built_in">Init</span>(n&lt;&lt;<span class="number">1</span>);</span><br><span class="line">	a.<span class="built_in">resize</span>(R),b.<span class="built_in">resize</span>(R);</span><br><span class="line">	<span class="built_in">NTT</span>(R,a,<span class="number">1</span>),<span class="built_in">NTT</span>(R,b,<span class="number">1</span>);</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">0</span>,R<span class="number">-1</span>) a[i]=(<span class="number">2</span><span class="number">-1ll</span>*a[i]*b[i]%P+P)*b[i]%P;</span><br><span class="line">	<span class="built_in">NTT</span>(R,a,<span class="number">-1</span>);</span><br><span class="line">	a.<span class="built_in">resize</span>(n);</span><br><span class="line">	<span class="keyword">return</span> a;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 应用转置原理优化的多项式多点求值</span></span><br><span class="line"><span class="function">Poly <span class="title">Evaluate</span><span class="params">(Poly F,Poly X)</span></span>&#123;</span><br><span class="line">	<span class="type">static</span> <span class="type">int</span> ls[N&lt;&lt;<span class="number">1</span>],rs[N&lt;&lt;<span class="number">1</span>],cnt;</span><br><span class="line">	<span class="type">static</span> Poly T[N&lt;&lt;<span class="number">1</span>];</span><br><span class="line">	<span class="type">static</span> <span class="keyword">auto</span> TMul=[&amp;] (Poly F,Poly G)&#123;</span><br><span class="line">		<span class="type">int</span> n=F.<span class="built_in">size</span>(),m=G.<span class="built_in">size</span>();</span><br><span class="line">		<span class="keyword">if</span>(n&lt;=<span class="number">20</span> &amp;&amp; m&lt;=<span class="number">20</span>)&#123;</span><br><span class="line">			<span class="built_in">rep</span>(i,<span class="number">0</span>,n-m) &#123;</span><br><span class="line">				<span class="type">int</span> t=<span class="number">0</span>;</span><br><span class="line">				<span class="built_in">rep</span>(j,<span class="number">0</span>,m<span class="number">-1</span>) t=(t+<span class="number">1ll</span>*F[i+j]*G[j])%P;</span><br><span class="line">				F[i]=t;</span><br><span class="line">			&#125; </span><br><span class="line">			F.<span class="built_in">resize</span>(n-m+<span class="number">1</span>);</span><br><span class="line">			<span class="keyword">return</span> F;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">reverse</span>(G.<span class="built_in">begin</span>(),G.<span class="built_in">end</span>());</span><br><span class="line">		<span class="type">int</span> R=<span class="built_in">Init</span>(n);</span><br><span class="line">		<span class="built_in">NTT</span>(R,F,<span class="number">1</span>),<span class="built_in">NTT</span>(R,G,<span class="number">1</span>);</span><br><span class="line">		<span class="built_in">rep</span>(i,<span class="number">0</span>,R<span class="number">-1</span>) F[i]=<span class="number">1ll</span>*F[i]*G[i]%P;</span><br><span class="line">		<span class="built_in">NTT</span>(R,F,<span class="number">-1</span>); <span class="function">Poly <span class="title">T</span><span class="params">(n-m+<span class="number">1</span>)</span></span>;</span><br><span class="line">		<span class="built_in">rep</span>(i,<span class="number">0</span>,n-m) T[i]=F[i+m<span class="number">-1</span>];</span><br><span class="line">		<span class="keyword">return</span> T;</span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="type">static</span> function &lt;<span class="type">int</span>(<span class="type">int</span>,<span class="type">int</span>)&gt; Build=[&amp;](<span class="type">int</span> l,<span class="type">int</span> r) &#123;</span><br><span class="line">		<span class="type">int</span> u=++cnt; ls[u]=rs[u]=<span class="number">0</span>;</span><br><span class="line">		<span class="keyword">if</span>(l==r) &#123;</span><br><span class="line">			T[u]=Poly&#123;<span class="number">1</span>,P-X[l]&#125;;</span><br><span class="line">			<span class="keyword">return</span> u;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="type">int</span> mid=(l+r)&gt;&gt;<span class="number">1</span>;</span><br><span class="line">		ls[u]=<span class="built_in">Build</span>(l,mid),rs[u]=<span class="built_in">Build</span>(mid+<span class="number">1</span>,r);</span><br><span class="line">		T[u]=T[ls[u]]*T[rs[u]];</span><br><span class="line">		<span class="keyword">return</span> u;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> n=F.<span class="built_in">size</span>(),m=X.<span class="built_in">size</span>();</span><br><span class="line">	<span class="built_in">cmax</span>(n,m),F.<span class="built_in">resize</span>(n),X.<span class="built_in">resize</span>(n);</span><br><span class="line">	cnt=<span class="number">0</span>,<span class="built_in">Build</span>(<span class="number">0</span>,n<span class="number">-1</span>);</span><br><span class="line">	F.<span class="built_in">resize</span>(n*<span class="number">2</span>+<span class="number">1</span>),T[<span class="number">1</span>]=<span class="built_in">TMul</span>(F,<span class="built_in">Poly_Inv</span>(T[<span class="number">1</span>]));</span><br><span class="line">	<span class="type">int</span> p=<span class="number">0</span>;</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">1</span>,cnt) <span class="keyword">if</span>(ls[i]) &#123;</span><br><span class="line">		<span class="built_in">swap</span>(T[ls[i]],T[rs[i]]);</span><br><span class="line"></span><br><span class="line">		<span class="type">int</span> R=<span class="built_in">Init</span>(T[i].<span class="built_in">size</span>()),n=T[i].<span class="built_in">size</span>(),m1=T[ls[i]].<span class="built_in">size</span>(),m2=T[rs[i]].<span class="built_in">size</span>();</span><br><span class="line">		<span class="built_in">NTT</span>(R,T[i],<span class="number">1</span>);</span><br><span class="line">		<span class="built_in">reverse</span>(T[ls[i]].<span class="built_in">begin</span>(),T[ls[i]].<span class="built_in">end</span>()); <span class="built_in">reverse</span>(T[rs[i]].<span class="built_in">begin</span>(),T[rs[i]].<span class="built_in">end</span>());</span><br><span class="line">		<span class="built_in">NTT</span>(R,T[ls[i]],<span class="number">1</span>); <span class="built_in">NTT</span>(R,T[rs[i]],<span class="number">1</span>);</span><br><span class="line">		<span class="built_in">rep</span>(j,<span class="number">0</span>,R<span class="number">-1</span>) &#123;</span><br><span class="line">			T[ls[i]][j]=<span class="number">1ll</span>*T[ls[i]][j]*T[i][j]%P;</span><br><span class="line">			T[rs[i]][j]=<span class="number">1ll</span>*T[rs[i]][j]*T[i][j]%P;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">NTT</span>(R,T[ls[i]],<span class="number">-1</span>); <span class="built_in">NTT</span>(R,T[rs[i]],<span class="number">-1</span>);</span><br><span class="line">		<span class="built_in">rep</span>(j,<span class="number">0</span>,n-m1) T[ls[i]][j]=T[ls[i]][j+m1<span class="number">-1</span>];</span><br><span class="line">		T[ls[i]].<span class="built_in">resize</span>(n-m1+<span class="number">1</span>);</span><br><span class="line">		<span class="built_in">rep</span>(j,<span class="number">0</span>,n-m2) T[rs[i]][j]=T[rs[i]][j+m2<span class="number">-1</span>];</span><br><span class="line">		T[rs[i]].<span class="built_in">resize</span>(n-m2+<span class="number">1</span>);</span><br><span class="line">	&#125; <span class="keyword">else</span> X[p++]=T[i][<span class="number">0</span>];</span><br><span class="line">	X.<span class="built_in">resize</span>(m);</span><br><span class="line">	<span class="keyword">return</span> X;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> n;</span><br><span class="line"><span class="type">int</span> A[N];</span><br><span class="line"><span class="type">int</span> I[N],J[N];</span><br><span class="line"><span class="type">int</span> F[N],L[N],R[N];</span><br><span class="line"></span><br><span class="line"><span class="function">Poly <span class="title">Solve</span><span class="params">(<span class="type">int</span> l,<span class="type">int</span> r)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(l==r) <span class="keyword">return</span> Poly&#123;A[l]<span class="number">-1</span>,P<span class="number">-2</span>&#125;;</span><br><span class="line">	<span class="type">int</span> mid=(l+r)&gt;&gt;<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">Solve</span>(l,mid)*<span class="built_in">Solve</span>(mid+<span class="number">1</span>,r);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="built_in">Init</span>();</span><br><span class="line">	<span class="built_in">rep</span>(i,J[<span class="number">0</span>]=<span class="number">1</span>,N<span class="number">-1</span>) J[i]=<span class="number">1ll</span>*J[i<span class="number">-1</span>]*i%P;</span><br><span class="line">	I[N<span class="number">-1</span>]=<span class="built_in">qpow</span>(J[N<span class="number">-1</span>]);</span><br><span class="line">	<span class="built_in">drep</span>(i,N<span class="number">-1</span>,<span class="number">1</span>) I[i<span class="number">-1</span>]=<span class="number">1ll</span>*I[i]*i%P;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">rep</span>(kase,<span class="number">1</span>,<span class="built_in">rd</span>()) &#123;</span><br><span class="line">		<span class="type">int</span> x=P,All=<span class="number">1</span>; </span><br><span class="line">		n=<span class="built_in">rd</span>();</span><br><span class="line">		<span class="built_in">rep</span>(i,<span class="number">1</span>,n+<span class="number">1</span>) F[i]=<span class="number">0</span>;</span><br><span class="line">		F[<span class="number">0</span>]=<span class="number">1</span>;</span><br><span class="line">		<span class="type">int</span> f=<span class="number">0</span>;</span><br><span class="line">		<span class="built_in">rep</span>(i,<span class="number">1</span>,n) &#123;</span><br><span class="line">			A[i]=<span class="built_in">rd</span>();</span><br><span class="line">			f|=!A[i];</span><br><span class="line">			<span class="built_in">cmin</span>(x,(A[i]<span class="number">-1</span>)/<span class="number">2</span>),All=<span class="number">1ll</span>*All*(A[i]+<span class="number">1</span>)%P;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>(f)&#123; <span class="built_in">puts</span>(<span class="string">&quot;0&quot;</span>); <span class="keyword">continue</span>; &#125;</span><br><span class="line">		Poly Y=<span class="built_in">Solve</span>(<span class="number">1</span>,n),<span class="built_in">X</span>(n+<span class="number">2</span>);</span><br><span class="line">		<span class="built_in">rep</span>(i,<span class="number">0</span>,n+<span class="number">1</span>) X[i]=i;</span><br><span class="line">		Y=<span class="built_in">Evaluate</span>(Y,X);</span><br><span class="line">		<span class="built_in">rep</span>(i,<span class="number">1</span>,n+<span class="number">1</span>) Y[i]=(Y[i]+Y[i<span class="number">-1</span>])%P;</span><br><span class="line">		<span class="type">int</span> ans=<span class="number">0</span>;</span><br><span class="line">		<span class="keyword">if</span>(x&lt;=n+<span class="number">1</span>) ans=Y[x];</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 拉格朗日插值</span></span><br><span class="line">			L[<span class="number">0</span>]=x;</span><br><span class="line">			<span class="built_in">rep</span>(i,<span class="number">1</span>,n+<span class="number">1</span>) L[i]=<span class="number">1ll</span>*L[i<span class="number">-1</span>]*(x-i)%P;</span><br><span class="line">			R[n+<span class="number">2</span>]=<span class="number">1</span>;</span><br><span class="line">			<span class="built_in">drep</span>(i,n+<span class="number">1</span>,<span class="number">0</span>) R[i]=<span class="number">1ll</span>*R[i+<span class="number">1</span>]*(x-i)%P;</span><br><span class="line">			<span class="built_in">rep</span>(i,<span class="number">0</span>,n+<span class="number">1</span>) &#123;</span><br><span class="line">				<span class="type">int</span> t=<span class="number">1ll</span>*Y[i]*(i?L[i<span class="number">-1</span>]:<span class="number">1</span>)%P*R[i+<span class="number">1</span>]%P*I[i]%P*I[n+<span class="number">1</span>-i]%P;</span><br><span class="line">				<span class="keyword">if</span>((n+<span class="number">1</span>-i)&amp;<span class="number">1</span>) t=P-t;</span><br><span class="line">				ans=(ans+t)%P;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		ans=ans*<span class="built_in">qpow</span>(All)%P;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>,ans);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="Previous page" aria-label="Previous page" href="/page/20/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/20/">20</a><span class="page-number current">21</span><a class="page-number" href="/page/22/">22</a><span class="space">&hellip;</span><a class="page-number" href="/page/26/">26</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/page/22/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2023</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">orangejuice</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>







  




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>



</body>
</html>
