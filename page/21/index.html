<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon32.jpg">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon16.jpg">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"compilationfail.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.18.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"mac"},"fold":{"enable":true,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="orangejuice&#39;s blog">
<meta property="og:url" content="https://compilationfail.github.io/page/21/index.html">
<meta property="og:site_name" content="orangejuice&#39;s blog">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="orangejuice">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://compilationfail.github.io/page/21/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"page/21/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>orangejuice's blog</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
  <script type="text/javascript">
    const bgc = 15;
    const bgu = "/images/bg";
    function getcookie() {
      // console.log("get", document.cookie);
      const s = document.cookie;
      return s.split('; ').find((row)=>row.startsWith("bgid="))?.split("=")[1];
    }
    function set_bg(index) {
      console.log("set", index);
      document.cookie = `bgid=${index}; path=/`;
      // console.log(document.cookie);
      url = `/images/bg${index}.jpg`;
      document.body.style=`background-image:url(${url});background-size:cover;background-repeat:no-repeat;background-position:center;background-attachment:fixed;`;
    }
    var index = parseInt(getcookie());
    if(isNaN(index) || index < 0 || index >= bgc) index = -1;
    window.onload = () => { set_bg(index) };
  </script>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">orangejuice's blog</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">挂了请务必叫我</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="orangejuice"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">orangejuice</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">268</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://twitter.com/ChenJerson" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;ChenJerson" rel="noopener me" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://weibo.com/3950662532/profile?rightmod=1&wvr=6&mod=personinfo" title="Weibo → https:&#x2F;&#x2F;weibo.com&#x2F;3950662532&#x2F;profile?rightmod&#x3D;1&amp;wvr&#x3D;6&amp;mod&#x3D;personinfo" rel="noopener me" target="_blank"><i class="fab fa-weibo fa-fw"></i>Weibo</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://github.com/CompilationFail" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;CompilationFail" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://steamcommunity.com/profiles/76561198969516062/" title="Steam → https:&#x2F;&#x2F;steamcommunity.com&#x2F;profiles&#x2F;76561198969516062&#x2F;" rel="noopener me" target="_blank"><i class="fab fa-steam fa-fw"></i>Steam</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.last.fm/user/chasedeath" title="Lastfm → https:&#x2F;&#x2F;www.last.fm&#x2F;user&#x2F;chasedeath" rel="noopener me" target="_blank"><i class="fab fa-lastfm-square fa-fw"></i>Lastfm</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://open.spotify.com/user/mgxnlznf9dli6bm4k3sp0iuwz" title="Spotify → https:&#x2F;&#x2F;open.spotify.com&#x2F;user&#x2F;mgxnlznf9dli6bm4k3sp0iuwz" rel="noopener me" target="_blank"><i class="fab fa-spotify fa-fw"></i>Spotify</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://compilationfail.github.io/oi-solutions/ROI%20-%20CEOI%20-%20CCO%20-%20APIO%20-%20Baltic%20OI%20-%20USACO/%E3%80%8CCCO%202020%E3%80%8D%E5%8D%83%E5%B1%B1%E4%B8%87%E5%A3%91/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="orangejuice">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="orangejuice's blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | orangejuice's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/oi-solutions/ROI%20-%20CEOI%20-%20CCO%20-%20APIO%20-%20Baltic%20OI%20-%20USACO/%E3%80%8CCCO%202020%E3%80%8D%E5%8D%83%E5%B1%B1%E4%B8%87%E5%A3%91/" class="post-title-link" itemprop="url">「CCO 2020」千山万壑</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-08-12 00:11:59" itemprop="dateCreated datePublished" datetime="2023-08-12T00:11:59+08:00">2023-08-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-08-17 21:28:48" itemprop="dateModified" datetime="2023-08-17T21:28:48+08:00">2023-08-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/CP-%E9%A2%98%E8%A7%A3/" itemprop="url" rel="index"><span itemprop="name">CP 题解</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="cco-2020千山万壑">「CCO 2020」千山万壑</h1>
<h3 id="性质推演">性质推演</h3>
<h4
id="推论1不选择非树边时答案为-2n-1--直径长">推论1:不选择非树边时，答案为
<span class="math inline">\(2(n-1)-\)</span> 直径长</h4>
<p>比较明显就不证了</p>
<h4 id="推论2最多只会选择一条非树边">推论2:最多只会选择一条非树边</h4>
<p>考虑如果选择两条非树边，此时必然有答案 <span
class="math inline">\(\ge n-1+3\lceil\frac{n}{3}\rceil\)</span></p>
<p>因为能够选择这样的非树边，则必然存在一条长度 <span
class="math inline">\(&gt;\frac{n}{3}\)</span> 的路径，也就是说</p>
<p>直径长度 <span class="math inline">\(&gt;\frac{n}{3}\)</span>
，故此时选择直径更优</p>
<p>因此不会选择两条非树边</p>
<p><span class="math display">\[ \  \]</span></p>
<h4 id="答案计算">答案计算</h4>
<p>下称起点终点路径 <span class="math inline">\((s,t)\)</span>
，选择的边为 <span class="math inline">\((u,v,w)\)</span></p>
<p>如果 <span class="math inline">\((s,t)\)</span> 与 <span
class="math inline">\((u,v)\)</span>
无交，则无序额外计算贡献，此时贡献为</p>
<p><span class="math inline">\(2(n-1)-dis(s,t)-(dis(u,v)-w)\)</span></p>
<p>当 <span class="math inline">\((s,t)\)</span> 与 <span
class="math inline">\((u,v)\)</span> 有交时，设交长度为 <span
class="math inline">\(len\)</span> ，则需要额外花费 <span
class="math inline">\(2(len-1)\)</span> 的代价取遍历交部分的点</p>
<p><img src="https://10.220.121.125/up/img/tree-pic1.png" /></p>
<p><span class="math display">\[ \ \]</span></p>
<h3 id="求解">求解</h3>
<p>显然我们需要先知道 <span class="math inline">\(dis(u,v)\)</span>
，可以 <span class="math inline">\(O(n)\)</span>
预处理，我们选择的非树边一定满足 <span
class="math inline">\(dis(u,v)&gt;w\)</span></p>
<p>考虑抽直径构成序列 <span class="math inline">\(L_i\)</span>
，然后考虑每一条非树边 <span class="math inline">\((u,v,w)\)</span>
的贡献，设 <span class="math inline">\(u,v\)</span>
在直径上对应根的编号为 <span class="math inline">\(x,y\)</span></p>
<p>如果 <span class="math inline">\(x=y\)</span>
，显然可以选择直径，下面讨论 <span class="math inline">\(x&lt;y\)</span>
的情况</p>
<ol type="1">
<li><span class="math inline">\((s,t)\)</span> 与 <span
class="math inline">\((u,v)\)</span> 无交</li>
</ol>
<p>1-1.对于 <span class="math inline">\((u,v)\)</span>
之间的部分可以区间查询最值</p>
<p>1-2.两边预处理前缀/后缀最值</p>
<p>1-3.直径连接到 <span class="math inline">\(u\)</span> ， <span
class="math inline">\(v\)</span> 子树的部分的答案可以换根 <span
class="math inline">\(dp\)</span> 预处理</p>
<ol start="2" type="1">
<li><span class="math inline">\((s,t)\)</span> 与 <span
class="math inline">\((u,v)\)</span> 有交，设交部分在直径上的区间为
<span class="math inline">\([l,r]\)</span></li>
</ol>
<p><img src="http://10.220.121.125/up/img/tree-pic2.png" /></p>
<p>2-1. 相交跨过直径上多个点</p>
<p>2-1-1.若 <span class="math inline">\(x&lt;l&lt;r&lt;y\)</span>
，此时容易用线段树维护答案</p>
<p><img src="http://10.220.121.125/up/img/tree-pic3.png" /></p>
<p>2-1-2. 若 <span class="math inline">\(x&lt;y , \text{and   } (l=x
\text{   or  } r=y)\)</span>
，此时显然两边部分最优一定是选择在直径上的部分</p>
<p><img src="http://10.220.121.125/up/img/tree-pic4.png" /></p>
<p>以下情况一定不优</p>
<p><img src="http://10.220.121.125/up/img/tree-pic5.png" /></p>
<p>另一边的答案可以在线段树上查询出来，是一个区间的前缀/后缀</p>
<p>2-2.若 <span class="math inline">\(l=r\)</span> ，此时 <span
class="math inline">\(l=x\)</span> 或 <span
class="math inline">\(l=y\)</span> ，且在 <span
class="math inline">\([u,x],[v,y]\)</span> 部分有交</p>
<p><img src="http://10.220.121.125/up/img/tree-pic6.png" /></p>
<p>容易发现，此时确定 <span class="math inline">\((s,t)\)</span>
一边一定在直径的一端，另一端 <span class="math inline">\(x,y\)</span>
对应的子树中</p>
<p>同样可以通过换根 <span class="math inline">\(dp\)</span> 解决</p>
<p>区间查询，如果使用线段树解决，复杂度为 <span
class="math inline">\(O(n+m\log n)\)</span></p>
<p>如果用奇怪数据结构<del>（猫树）</del>，复杂度为 <span
class="math inline">\(O(n\log n+m)\)</span></p>
<h1 id="cco-2020千山万壑-1">「CCO 2020」千山万壑</h1>
<h3 id="性质推演-1">性质推演</h3>
<h4
id="推论1不选择非树边时答案为-2n-1--直径长-1">推论1:不选择非树边时，答案为
<span class="math inline">\(2(n-1)-\)</span> 直径长</h4>
<p>比较明显就不证了</p>
<h4 id="推论2最多只会选择一条非树边-1">推论2:最多只会选择一条非树边</h4>
<p>考虑如果选择两条非树边，此时必然有答案 <span
class="math inline">\(\ge n-1+3\lceil\frac{n}{3}\rceil\)</span></p>
<p>因为能够选择这样的非树边，则必然存在一条长度 <span
class="math inline">\(&gt;\frac{n}{3}\)</span> 的路径，也就是说</p>
<p>直径长度 <span class="math inline">\(&gt;\frac{n}{3}\)</span>
，故此时选择直径更优</p>
<p>因此不会选择两条非树边</p>
<p><span class="math display">\[ \  \]</span></p>
<h4 id="答案计算-1">答案计算</h4>
<p>下称起点终点路径 <span class="math inline">\((s,t)\)</span>
，选择的边为 <span class="math inline">\((u,v,w)\)</span></p>
<p>如果 <span class="math inline">\((s,t)\)</span> 与 <span
class="math inline">\((u,v)\)</span>
无交，则无序额外计算贡献，此时贡献为</p>
<p><span class="math inline">\(2(n-1)-dis(s,t)-(dis(u,v)-w)\)</span></p>
<p>当 <span class="math inline">\((s,t)\)</span> 与 <span
class="math inline">\((u,v)\)</span> 有交时，设交长度为 <span
class="math inline">\(len\)</span> ，则需要额外花费 <span
class="math inline">\(2(len-1)\)</span> 的代价取遍历交部分的点</p>
<figure>
<img src="https://i.loli.net/2021/03/03/CF5b2LK37qRpgyx.png"
alt="Snipaste_2021-03-03_09-44-08.png" />
<figcaption
aria-hidden="true">Snipaste_2021-03-03_09-44-08.png</figcaption>
</figure>
<p><span class="math display">\[ \ \]</span></p>
<h3 id="求解-1">求解</h3>
<p>显然我们需要先知道 <span class="math inline">\(dis(u,v)\)</span>
，可以 <span class="math inline">\(O(n)\)</span>
预处理，我们选择的非树边一定满足 <span
class="math inline">\(dis(u,v)&gt;w\)</span></p>
<p>考虑抽直径构成序列 <span class="math inline">\(L_i\)</span>
，然后考虑每一条非树边 <span class="math inline">\((u,v,w)\)</span>
的贡献，设 <span class="math inline">\(u,v\)</span>
在直径上对应根的编号为 <span class="math inline">\(x,y\)</span></p>
<p>确定非树边之后，我们需要选择一个最优的 <span
class="math inline">\((s,t)\)</span> ，答案计算上面已经提及</p>
<p>如果 <span class="math inline">\(x=y\)</span>
，显然可以选择直径，下面讨论 <span class="math inline">\(x&lt;y\)</span>
的情况</p>
<ol type="1">
<li><span class="math inline">\((s,t)\)</span> 与 <span
class="math inline">\((u,v)\)</span> 无交</li>
</ol>
<p>1-1.对于 <span class="math inline">\((u,v)\)</span>
之间的部分可以区间查询子树最值</p>
<p>1-2.两边预处理前缀/后缀最值</p>
<p>1-3.直径连接到 <span class="math inline">\(u\)</span> ， <span
class="math inline">\(v\)</span> 子树的部分的答案</p>
<p>就是一棵树剔除根到一个点路径之后的直径长度，可以换根 <span
class="math inline">\(dp\)</span> 预处理</p>
<ol start="2" type="1">
<li><span class="math inline">\((s,t)\)</span> 与 <span
class="math inline">\((u,v)\)</span> 有交，设交部分在直径上的区间为
<span class="math inline">\([l,r]\)</span></li>
</ol>
<p>容易参分转化为求解： <span
class="math inline">\(dis(s,t)+dis(u,v)-w-2(r-l)+2\)</span> 最大值</p>
<figure>
<img src="https://i.loli.net/2021/03/03/G8TPMO6XjUlHCW7.png"
alt="Snipaste_2021-03-03_09-58-39.png" />
<figcaption
aria-hidden="true">Snipaste_2021-03-03_09-58-39.png</figcaption>
</figure>
<p>2-1. 相交跨过直径上多个点</p>
<p>2-1-1.若 <span class="math inline">\(x&lt;l&lt;r&lt;y\)</span>
，此时容易用线段树维护答案</p>
<p>合并时减去跨过长度的贡献即可</p>
<figure>
<img src="https://i.loli.net/2021/03/03/hdlGsfQ4eFicT8D.png"
alt="Snipaste_2021-03-03_10-00-38.png" />
<figcaption
aria-hidden="true">Snipaste_2021-03-03_10-00-38.png</figcaption>
</figure>
<p>2-1-2. 若 <span class="math inline">\(x&lt;y , \text{and   } (l=x
\text{   or  } r=y)\)</span>
，此时显然两边部分最优一定是选择在直径上的部分</p>
<figure>
<img src="https://i.loli.net/2021/03/03/o5itfJTen9XFCVO.png"
alt="Snipaste_2021-03-03_10-01-17.png" />
<figcaption
aria-hidden="true">Snipaste_2021-03-03_10-01-17.png</figcaption>
</figure>
<p>以下情况一定不优</p>
<figure>
<img src="https://i.loli.net/2021/03/03/EnsIrueTi5qJpYd.png"
alt="Snipaste_2021-03-03_10-03-49.png" />
<figcaption
aria-hidden="true">Snipaste_2021-03-03_10-03-49.png</figcaption>
</figure>
<p>另一边的答案可以在线段树上查询出来，是一个区间的前缀/后缀</p>
<p>2-2.若 <span class="math inline">\(l=r\)</span> ，此时 <span
class="math inline">\(l=x\)</span> 或 <span
class="math inline">\(l=y\)</span> ，且在 <span
class="math inline">\([u,x],[v,y]\)</span> 部分有交</p>
<figure>
<img src="https://i.loli.net/2021/03/03/pOANxDCRHG5d6E2.png"
alt="Snipaste_2021-03-03_10-05-43.png" />
<figcaption
aria-hidden="true">Snipaste_2021-03-03_10-05-43.png</figcaption>
</figure>
<p>容易发现，此时确定 <span class="math inline">\((s,t)\)</span>
一边一定在直径的一端，另一端 <span class="math inline">\(x,y\)</span>
对应的子树中</p>
<p>同样可以通过换根 <span class="math inline">\(dp\)</span> 解决</p>
<p>区间查询，如果使用线段树解决，复杂度为 <span
class="math inline">\(O(n+m\log n)\)</span></p>
<p>如果用奇怪数据结构<del>（猫树）</del>，复杂度为 <span
class="math inline">\(O(n\log n+m)\)</span></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">long</span> <span class="type">long</span> ll;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> ull;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">double</span> db;</span><br><span class="line"><span class="keyword">typedef</span> pair &lt;<span class="type">int</span>,<span class="type">int</span>&gt; Pii;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> reg register</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> mp make_pair</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> pb push_back</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> Mod1(x) ((x&gt;=P)&amp;&amp;(x-=P))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> Mod2(x) ((x&lt;0)&amp;&amp;(x+=P))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> rep(i,a,b) for(int i=a,i##end=b;i&lt;=i##end;++i)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> drep(i,a,b) for(int i=a,i##end=b;i&gt;=i##end;--i)</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt; <span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">cmin</span><span class="params">(T &amp;a,T b)</span></span>&#123; ((a&gt;b)&amp;&amp;(a=b)); &#125;</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt; <span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">cmax</span><span class="params">(T &amp;a,T b)</span></span>&#123; ((a&lt;b)&amp;&amp;(a=b)); &#125;</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> IO;</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">T</span>=<span class="type">int</span>&gt; T <span class="built_in">rd</span>()&#123;</span><br><span class="line">	T s=<span class="number">0</span>; <span class="type">int</span> f=<span class="number">0</span>;</span><br><span class="line">	<span class="keyword">while</span>(!<span class="built_in">isdigit</span>(IO=<span class="built_in">getchar</span>())) f|=IO==<span class="string">&#x27;-&#x27;</span>;</span><br><span class="line">	<span class="keyword">do</span> s=(s&lt;&lt;<span class="number">1</span>)+(s&lt;&lt;<span class="number">3</span>)+(IO^<span class="string">&#x27;0&#x27;</span>);</span><br><span class="line">	<span class="keyword">while</span>(<span class="built_in">isdigit</span>(IO=<span class="built_in">getchar</span>()));</span><br><span class="line">	<span class="keyword">return</span> f?-s:s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> N=<span class="number">5e5</span>+<span class="number">10</span>,M=<span class="number">2e6</span>+<span class="number">10</span>,INF=<span class="number">1e9</span>+<span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> n,m;</span><br><span class="line"><span class="type">int</span> U[M],V[M],W[M],D[M],vis[N];</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Edge</span>&#123;</span><br><span class="line">	<span class="type">int</span> to,nxt;</span><br><span class="line">&#125; e[N&lt;&lt;<span class="number">1</span>];</span><br><span class="line"><span class="type">int</span> head[N],ecnt;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">AddEdge</span><span class="params">(<span class="type">int</span> u,<span class="type">int</span> v)</span></span>&#123;</span><br><span class="line">	e[++ecnt]=(Edge)&#123;v,head[u]&#125;;</span><br><span class="line">	head[u]=ecnt;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> ma,num,fa[N],dep[N];</span><br><span class="line">vector &lt;Pii&gt; G[N];</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Find</span><span class="params">(<span class="type">int</span> x)</span></span>&#123; <span class="keyword">return</span> fa[x]==x?x:fa[x]=<span class="built_in">Find</span>(fa[x]); &#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">dfs1</span><span class="params">(<span class="type">int</span> u,<span class="type">int</span> f)</span></span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(dep[u]&gt;ma) ma=dep[u],num=u;</span><br><span class="line">	vis[fa[u]=u]=<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">for</span>(Pii v:G[u]) <span class="keyword">if</span>(vis[v.first]) D[v.second]=dep[u]+dep[v.first]<span class="number">-2</span>*dep[<span class="built_in">Find</span>(v.first)];</span><br><span class="line">	<span class="keyword">for</span>(<span class="type">int</span> i=head[u];i;i=e[i].nxt) &#123;</span><br><span class="line">		<span class="type">int</span> v=e[i].to;</span><br><span class="line">		<span class="keyword">if</span>(v==f) <span class="keyword">continue</span>;</span><br><span class="line">		dep[v]=dep[u]+<span class="number">1</span>,<span class="built_in">dfs1</span>(v,u);</span><br><span class="line">	&#125;</span><br><span class="line">	fa[u]=f;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">dfs2</span><span class="params">(<span class="type">int</span> u,<span class="type">int</span> f)</span></span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(dep[u]&gt;ma) ma=dep[u],num=u;</span><br><span class="line">	fa[u]=f;</span><br><span class="line">	<span class="keyword">for</span>(<span class="type">int</span> i=head[u];i;i=e[i].nxt) &#123;</span><br><span class="line">		<span class="type">int</span> v=e[i].to;</span><br><span class="line">		<span class="keyword">if</span>(v==f) <span class="keyword">continue</span>;</span><br><span class="line">		dep[v]=dep[u]+<span class="number">1</span>,<span class="built_in">dfs2</span>(v,u);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> id[N],L[N],C,dp[N][<span class="number">2</span>],dp2[N],g[N],h[N];</span><br><span class="line"><span class="type">int</span> subid[N];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">dfs3</span><span class="params">(<span class="type">int</span> u,<span class="type">int</span> f)</span></span>&#123;</span><br><span class="line">	fa[u]=f;</span><br><span class="line">	<span class="keyword">for</span>(<span class="type">int</span> i=head[u];i;i=e[i].nxt)&#123;</span><br><span class="line">		<span class="type">int</span> v=e[i].to;</span><br><span class="line">		<span class="keyword">if</span>(id[v]||v==f) <span class="keyword">continue</span>;</span><br><span class="line">		<span class="built_in">dfs3</span>(v,u);</span><br><span class="line">		<span class="built_in">cmax</span>(dp2[u],dp2[v]);</span><br><span class="line">		<span class="type">int</span> t=dp[v][<span class="number">0</span>]+<span class="number">1</span>;</span><br><span class="line">		<span class="keyword">if</span>(t&gt;dp[u][<span class="number">0</span>]) dp[u][<span class="number">1</span>]=dp[u][<span class="number">0</span>],dp[u][<span class="number">0</span>]=t;</span><br><span class="line">		<span class="keyword">else</span> <span class="built_in">cmax</span>(dp[u][<span class="number">1</span>],t);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">cmax</span>(dp2[u],dp[u][<span class="number">0</span>]+dp[u][<span class="number">1</span>]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">dfs4</span><span class="params">(<span class="type">int</span> u,<span class="type">int</span> f,<span class="type">int</span> d=<span class="number">0</span>)</span></span>&#123;</span><br><span class="line">	dep[u]=d,subid[u]=d&lt;=<span class="number">1</span>?u:subid[f];</span><br><span class="line">	<span class="type">int</span> tg[<span class="number">2</span>]=&#123;-INF,-INF&#125;,th[<span class="number">2</span>]=&#123;<span class="number">0</span>,<span class="number">0</span>&#125;;</span><br><span class="line">	<span class="keyword">for</span>(<span class="type">int</span> i=head[u];i;i=e[i].nxt)&#123;</span><br><span class="line">		<span class="type">int</span> v=e[i].to;</span><br><span class="line">		<span class="keyword">if</span>(id[v]||v==f) <span class="keyword">continue</span>;</span><br><span class="line">		<span class="type">int</span> x=dp[v][<span class="number">0</span>]+<span class="number">1</span>-(d?d:<span class="number">1e9</span>);</span><br><span class="line">		<span class="keyword">if</span>(x&gt;tg[<span class="number">0</span>]) tg[<span class="number">1</span>]=tg[<span class="number">0</span>],tg[<span class="number">0</span>]=x;</span><br><span class="line">		<span class="keyword">else</span> <span class="built_in">cmax</span>(tg[<span class="number">1</span>],x);</span><br><span class="line"></span><br><span class="line">		x=<span class="built_in">max</span>(dp2[v],dp[v][<span class="number">0</span>]+<span class="number">1</span>);</span><br><span class="line">		<span class="keyword">if</span>(x&gt;th[<span class="number">0</span>]) th[<span class="number">1</span>]=th[<span class="number">0</span>],th[<span class="number">0</span>]=x;</span><br><span class="line">		<span class="keyword">else</span> <span class="built_in">cmax</span>(th[<span class="number">1</span>],x);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span>(<span class="type">int</span> i=head[u];i;i=e[i].nxt)&#123;</span><br><span class="line">		<span class="type">int</span> v=e[i].to;</span><br><span class="line">		<span class="keyword">if</span>(id[v]||v==f) <span class="keyword">continue</span>;</span><br><span class="line">		h[v]=<span class="built_in">max</span>(h[u],th[<span class="number">0</span>]==<span class="built_in">max</span>(dp2[v],dp[v][<span class="number">0</span>]+<span class="number">1</span>)?th[<span class="number">1</span>]:th[<span class="number">0</span>]);</span><br><span class="line">		g[v]=<span class="built_in">max</span>(g[u],tg[<span class="number">0</span>]==dp[v][<span class="number">0</span>]+<span class="number">1</span>-(d?d:<span class="number">1e9</span>)?tg[<span class="number">1</span>]:tg[<span class="number">0</span>]);</span><br><span class="line">		id[v]=id[u],<span class="built_in">dfs4</span>(v,u,d+<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(f) <span class="built_in">cmax</span>(g[u],dp[u][<span class="number">0</span>]-d);</span><br><span class="line">	<span class="built_in">cmax</span>(h[u],dp2[u]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Node</span>&#123;</span><br><span class="line">	<span class="type">int</span> len,ans,l,r;</span><br><span class="line">	Node <span class="keyword">operator</span> + (<span class="type">const</span> Node __) <span class="type">const</span> &#123;</span><br><span class="line">		Node res; res.len=len+__.len;</span><br><span class="line">		res.ans=<span class="built_in">max</span>(ans,__.ans);</span><br><span class="line">		res.l=<span class="built_in">max</span>(l,__.l-len),res.r=<span class="built_in">max</span>(r-__.len,__.r);</span><br><span class="line">		<span class="built_in">cmax</span>(res.ans,r+__.l+<span class="number">1</span>);</span><br><span class="line">		<span class="keyword">return</span> res;</span><br><span class="line">	&#125;</span><br><span class="line">&#125; s[N&lt;&lt;<span class="number">2</span>];</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Build</span><span class="params">(<span class="type">int</span> p,<span class="type">int</span> l,<span class="type">int</span> r)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(l==r) &#123;</span><br><span class="line">		s[p]=(Node)&#123;<span class="number">1</span>,<span class="built_in">max</span>(dp2[L[l]],dp[L[l]][<span class="number">0</span>]),dp[L[l]][<span class="number">0</span>],dp[L[l]][<span class="number">0</span>]&#125;;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="type">int</span> mid=(l+r)&gt;&gt;<span class="number">1</span>;</span><br><span class="line">	<span class="built_in">Build</span>(p&lt;&lt;<span class="number">1</span>,l,mid),<span class="built_in">Build</span>(p&lt;&lt;<span class="number">1</span>|<span class="number">1</span>,mid+<span class="number">1</span>,r);</span><br><span class="line">	s[p]=s[p&lt;&lt;<span class="number">1</span>]+s[p&lt;&lt;<span class="number">1</span>|<span class="number">1</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">Node <span class="title">Que</span><span class="params">(<span class="type">int</span> p,<span class="type">int</span> l,<span class="type">int</span> r,<span class="type">int</span> ql,<span class="type">int</span> qr)</span></span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(ql&lt;=l &amp;&amp; r&lt;=qr) <span class="keyword">return</span> s[p];</span><br><span class="line">	<span class="type">int</span> mid=(l+r)&gt;&gt;<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">if</span>(qr&lt;=mid) <span class="keyword">return</span> <span class="built_in">Que</span>(p&lt;&lt;<span class="number">1</span>,l,mid,ql,qr);</span><br><span class="line">	<span class="keyword">if</span>(ql&gt;mid) <span class="keyword">return</span> <span class="built_in">Que</span>(p&lt;&lt;<span class="number">1</span>|<span class="number">1</span>,mid+<span class="number">1</span>,r,ql,qr);</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">Que</span>(p&lt;&lt;<span class="number">1</span>,l,mid,ql,qr)+<span class="built_in">Que</span>(p&lt;&lt;<span class="number">1</span>|<span class="number">1</span>,mid+<span class="number">1</span>,r,ql,qr);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> ls[N],rs[N];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	n=<span class="built_in">rd</span>();</span><br><span class="line">	<span class="built_in">rep</span>(t,<span class="number">1</span>,<span class="built_in">rd</span>())&#123;</span><br><span class="line">		<span class="type">int</span> u=<span class="built_in">rd</span>()+<span class="number">1</span>,v=<span class="built_in">rd</span>()+<span class="number">1</span>,w=<span class="built_in">rd</span>();</span><br><span class="line">		<span class="keyword">if</span>(w==<span class="number">1</span>) <span class="built_in">AddEdge</span>(u,v),<span class="built_in">AddEdge</span>(v,u);</span><br><span class="line">		<span class="keyword">else</span> U[++m]=u,V[m]=v,W[m]=w,G[u].<span class="built_in">pb</span>(<span class="built_in">mp</span>(v,m)),G[v].<span class="built_in">pb</span>(<span class="built_in">mp</span>(u,m));</span><br><span class="line">	&#125;</span><br><span class="line">	ma=<span class="number">-1</span>,<span class="built_in">dfs1</span>(<span class="number">1</span>,<span class="number">0</span>);</span><br><span class="line">	ma=<span class="number">-1</span>,dep[num]=<span class="number">0</span>,<span class="built_in">dfs2</span>(num,<span class="number">0</span>);</span><br><span class="line">	<span class="keyword">for</span>(<span class="type">int</span> u=num;u;u=fa[u]) L[id[u]=++C]=u;</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">1</span>,C) <span class="built_in">dfs3</span>(L[i],<span class="number">0</span>),g[L[i]]=-INF,<span class="built_in">dfs4</span>(L[i],<span class="number">0</span>);</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">1</span>,C) ls[i]=<span class="built_in">max</span>(ls[i<span class="number">-1</span>],i<span class="number">-1</span>+dp[L[i]][<span class="number">0</span>]);</span><br><span class="line">	<span class="built_in">drep</span>(i,C,<span class="number">1</span>) rs[i]=<span class="built_in">max</span>(rs[i+<span class="number">1</span>],C-i+dp[L[i]][<span class="number">0</span>]);</span><br><span class="line">	<span class="built_in">Build</span>(<span class="number">1</span>,<span class="number">1</span>,C);</span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> ans=C<span class="number">-1</span>;</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">1</span>,m) <span class="keyword">if</span>(D[i]&gt;W[i]) &#123;</span><br><span class="line">		<span class="type">int</span> u=U[i],v=V[i],d=<span class="number">0</span>;</span><br><span class="line">		<span class="keyword">if</span>(id[u]&gt;id[v]) <span class="built_in">swap</span>(u,v);</span><br><span class="line">		<span class="keyword">if</span>(id[u]==id[v]) d=C<span class="number">-1</span>;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">if</span>(fa[u]) &#123;</span><br><span class="line">				<span class="built_in">cmax</span>(d,h[u]);</span><br><span class="line">				<span class="type">int</span> f=subid[u],t=fa[f];</span><br><span class="line">				<span class="built_in">cmax</span>(d,id[u]<span class="number">-1</span>+(dp[f][<span class="number">0</span>]+<span class="number">1</span>==dp[t][<span class="number">0</span>]?dp[t][<span class="number">1</span>]:dp[t][<span class="number">0</span>]));</span><br><span class="line">				<span class="built_in">cmax</span>(d,id[u]<span class="number">-1</span>+g[u]+<span class="number">2</span>);</span><br><span class="line">			&#125; <span class="keyword">else</span> <span class="built_in">cmax</span>(d,dp[u][<span class="number">0</span>]+id[u]<span class="number">-1</span>);</span><br><span class="line">			<span class="keyword">if</span>(fa[v]) &#123;</span><br><span class="line">				<span class="built_in">cmax</span>(d,h[v]);</span><br><span class="line">				<span class="type">int</span> f=subid[v],t=fa[f];</span><br><span class="line">				<span class="built_in">cmax</span>(d,C-id[v]+(dp[f][<span class="number">0</span>]+<span class="number">1</span>==dp[t][<span class="number">0</span>]?dp[t][<span class="number">1</span>]:dp[t][<span class="number">0</span>]));</span><br><span class="line">				<span class="built_in">cmax</span>(d,C-id[v]+g[v]+<span class="number">2</span>);</span><br><span class="line">			&#125; <span class="keyword">else</span> <span class="built_in">cmax</span>(d,dp[v][<span class="number">0</span>]+C-id[v]);</span><br><span class="line">			<span class="built_in">cmax</span>(d,ls[id[u]<span class="number">-1</span>]),<span class="built_in">cmax</span>(d,rs[id[v]+<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">			<span class="type">int</span> g1=id[u]<span class="number">-1</span>,g2=C-id[v];</span><br><span class="line">			<span class="built_in">cmax</span>(d,g1+g2-(id[v]-id[u])+<span class="number">2</span>);</span><br><span class="line">			<span class="keyword">if</span>(id[u]+<span class="number">1</span>&lt;id[v]) &#123;</span><br><span class="line">				Node t=<span class="built_in">Que</span>(<span class="number">1</span>,<span class="number">1</span>,C,id[u]+<span class="number">1</span>,id[v]<span class="number">-1</span>);</span><br><span class="line">				<span class="built_in">cmax</span>(d,t.ans);</span><br><span class="line">				<span class="built_in">cmax</span>(d,t.l+g1+<span class="number">1</span>);</span><br><span class="line">				<span class="built_in">cmax</span>(d,t.r+g2+<span class="number">1</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">cmax</span>(ans,D[i]-W[i]+d);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>,<span class="number">2</span>*(n<span class="number">-1</span>)-ans);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://compilationfail.github.io/oi-solutions/ROI%20-%20CEOI%20-%20CCO%20-%20APIO%20-%20Baltic%20OI%20-%20USACO/%E3%80%8CCEOI2018%E3%80%8D%E6%96%90%E6%B3%A2%E9%82%A3%E5%A5%91%E8%A1%A8%E7%A4%BA%E6%B3%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="orangejuice">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="orangejuice's blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | orangejuice's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/oi-solutions/ROI%20-%20CEOI%20-%20CCO%20-%20APIO%20-%20Baltic%20OI%20-%20USACO/%E3%80%8CCEOI2018%E3%80%8D%E6%96%90%E6%B3%A2%E9%82%A3%E5%A5%91%E8%A1%A8%E7%A4%BA%E6%B3%95/" class="post-title-link" itemprop="url">「CEOI2018」斐波那契表示法</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-08-12 00:11:59" itemprop="dateCreated datePublished" datetime="2023-08-12T00:11:59+08:00">2023-08-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-08-17 21:28:48" itemprop="dateModified" datetime="2023-08-17T21:28:48+08:00">2023-08-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/CP-%E9%A2%98%E8%A7%A3/" itemprop="url" rel="index"><span itemprop="name">CP 题解</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="ceoi2018斐波那契表示法">「CEOI2018」斐波那契表示法</h1>
<p>思路：维护当前数值的唯一表示法，然后根据唯一表示法来确定答案</p>
<h3 id="part1-唯一表示法">Part1 唯一表示法</h3>
<p>任何一个数 <span class="math inline">\(x\)</span> 有唯一表示 <span
class="math inline">\(P_i\)</span> ，满足 <span
class="math inline">\(x=\sum F_{P_i},P_i&lt;P_{i+1}-1\)</span></p>
<p>即不会出现相邻两项</p>
<p>依次插入每一个数 <span class="math inline">\(x\)</span>
，考虑可能出现的情况</p>
<ol type="1">
<li><p><span class="math inline">\(x\)</span>
一位以及前后为空，那么直接插入</p></li>
<li><p><span class="math inline">\(x\)</span> 一位为空，且 <span
class="math inline">\(x-1\)</span> 为空， <span
class="math inline">\(x+1\)</span> 已经出现</p></li>
</ol>
<p>删除 <span class="math inline">\(x+1\)</span> ，插入 <span
class="math inline">\(x+2\)</span></p>
<ol start="3" type="1">
<li><span class="math inline">\(x\)</span> 一位为空，且 <span
class="math inline">\(x+1\)</span> 为空， <span
class="math inline">\(x-1\)</span> 已经出现</li>
</ol>
<p>删除 <span class="math inline">\(x-1\)</span> ，插入 <span
class="math inline">\(x+1\)</span></p>
<ol start="4" type="1">
<li><span class="math inline">\(x\)</span> 一位有</li>
</ol>
<p>先删除 <span class="math inline">\(x\)</span> ，然后插入 <span
class="math inline">\(x+1,x-2\)</span></p>
<p>对于操作1,2,3以及4中的 <span class="math inline">\(x+1\)</span>
，每次操作增加 <span class="math inline">\(O(1)\)</span>
个元素，每次递归进行删除 <span class="math inline">\(O(1)\)</span>
个元素</p>
<p>操作次数为均摊 <span class="math inline">\(O(n)\)</span></p>
<p>对于 <span class="math inline">\(4\)</span> 操作中的 <span
class="math inline">\(x-2\)</span> ，如果 <span
class="math inline">\(x-2\)</span> 已经出现就会不断进行递归</p>
<p>最终的效果就是所有被操作到的 <span
class="math inline">\(x-2,x-4,x-6\ldots\)</span> 向右平移了一位</p>
<p><del>大致如此，实际情况比较复杂，要讨论x-2=0,x-2&lt;0等等情况</del></p>
<p>用一棵平衡树维护 <span class="math inline">\(P_i-P_{i-1}\)</span>
的值即可，4操作可以二分左边第一个&gt;2的元素，然后进行平移</p>
<p>最终复杂度为 <span class="math inline">\(O(n\log n)\)</span></p>
<p><span class="math display">\[ \ \]</span></p>
<h3 id="part2-dp求答案">Part2 dp求答案</h3>
<p>令边界 <span class="math inline">\(P_0=0\)</span> ，根据上面维护的
<span class="math inline">\(\delta_i=P_i-P_{i-1}\)</span></p>
<p>考虑根据 <span class="math inline">\(\delta_i\)</span> 求解答案</p>
<p>显然一个数 <span class="math inline">\(x\)</span> 可以下分为 <span
class="math inline">\(x\)</span> 或者 <span
class="math inline">\(x-1,x-2\)</span> 或 <span
class="math inline">\(x-1,x-3,x-4\)</span> 或 <span
class="math inline">\(x-1,x-3,x-5,x-6\ldots\)</span></p>
<p>且不能碰到前面的数</p>
<p>简单分析发现 <span class="math inline">\(P_i\)</span> 有 <span
class="math inline">\(\lceil \frac{\delta_i}{2}\rceil\)</span>
种下分方案</p>
<p>然而， <span class="math inline">\(P_{i-1}\)</span> 如果被下分，那么
<span class="math inline">\(P_{i-1}\)</span> 这一位会消失，变成 <span
class="math inline">\(P_{i-1}-1\)</span> 作为限制点</p>
<p>也就是说， <span class="math inline">\(P_{i-1}\)</span>
的下分会影响到 <span class="math inline">\(\delta_i\)</span> ，使得
<span class="math inline">\(\delta_i\rightarrow \delta_i+1\)</span></p>
<p>那么依次考虑每个 <span class="math inline">\(\delta_i\)</span> ，令
<span class="math inline">\(dp_{i,f}\)</span> 表示前 <span
class="math inline">\(i\)</span> 个，最后一个是否下分的方案数，可以
<span class="math inline">\(dp\)</span> 求解</p>
<p>由于要动态维护，因此可以考虑用一个类似矩阵的东西来维护区间的dp情况</p>
<p>在平衡树中 <span class="math inline">\(up\)</span> 维护答案即可</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">long</span> <span class="type">long</span> ll;</span><br><span class="line"><span class="keyword">typedef</span> pair &lt;<span class="type">int</span>,<span class="type">int</span>&gt; Pii;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> reg register</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> mp make_pair</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> rep(i,a,b) for(int i=a,i##end=b;i&lt;=i##end;++i)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> drep(i,a,b) for(int i=a,i##end=b;i&gt;=i##end;--i)</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt; <span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">cmin</span><span class="params">(T &amp;a,T b)</span></span>&#123; ((a&gt;b)&amp;&amp;(a=b)); &#125;</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt; <span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">cmax</span><span class="params">(T &amp;a,T b)</span></span>&#123; ((a&lt;b)&amp;&amp;(a=b)); &#125;</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> IO;</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">T</span>=<span class="type">int</span>&gt; T <span class="built_in">rd</span>()&#123;</span><br><span class="line">    T s=<span class="number">0</span>; <span class="type">int</span> f=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(!<span class="built_in">isdigit</span>(IO=<span class="built_in">getchar</span>())) f|=IO==<span class="string">&#x27;-&#x27;</span>;</span><br><span class="line">    <span class="keyword">do</span> s=(s&lt;&lt;<span class="number">1</span>)+(s&lt;&lt;<span class="number">3</span>)+(IO^<span class="string">&#x27;0&#x27;</span>);</span><br><span class="line">    <span class="keyword">while</span>(<span class="built_in">isdigit</span>(IO=<span class="built_in">getchar</span>()));</span><br><span class="line">    <span class="keyword">return</span> f?-s:s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> N=<span class="number">4e5</span>+<span class="number">10</span>,P=<span class="number">1e9</span>+<span class="number">7</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> n;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Node</span>&#123;</span><br><span class="line">    <span class="type">int</span> l,r,ma,len;</span><br><span class="line">    <span class="type">int</span> a[<span class="number">2</span>][<span class="number">2</span>];</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">clear</span><span class="params">()</span></span>&#123; <span class="built_in">memset</span>(a,<span class="number">0</span>,<span class="keyword">sizeof</span> a); &#125;</span><br><span class="line">    <span class="built_in">Node</span>()&#123; &#125; </span><br><span class="line">    <span class="built_in">Node</span>(<span class="type">int</span> x)&#123;</span><br><span class="line">        l=r=ma=len=x;</span><br><span class="line">        <span class="built_in">rep</span>(i,<span class="number">0</span>,<span class="number">1</span>) &#123;</span><br><span class="line">            a[i][<span class="number">0</span>]=<span class="number">1</span>;</span><br><span class="line">            a[i][<span class="number">1</span>]=(x<span class="number">-1</span>+i)/<span class="number">2</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    Node <span class="keyword">operator</span> + (<span class="type">const</span> Node _) <span class="type">const</span> &#123;</span><br><span class="line">        Node res; res.l=l,res.r=_.r,res.ma=<span class="built_in">max</span>(ma,_.ma),res.len=len+_.len;</span><br><span class="line">        res.a[<span class="number">0</span>][<span class="number">0</span>]=(<span class="number">1ll</span>*a[<span class="number">0</span>][<span class="number">0</span>]*_.a[<span class="number">0</span>][<span class="number">0</span>]+<span class="number">1ll</span>*a[<span class="number">0</span>][<span class="number">1</span>]*_.a[<span class="number">1</span>][<span class="number">0</span>])%P;</span><br><span class="line">        res.a[<span class="number">1</span>][<span class="number">0</span>]=(<span class="number">1ll</span>*a[<span class="number">1</span>][<span class="number">0</span>]*_.a[<span class="number">0</span>][<span class="number">0</span>]+<span class="number">1ll</span>*a[<span class="number">1</span>][<span class="number">1</span>]*_.a[<span class="number">1</span>][<span class="number">0</span>])%P;</span><br><span class="line">        res.a[<span class="number">0</span>][<span class="number">1</span>]=(<span class="number">1ll</span>*a[<span class="number">0</span>][<span class="number">0</span>]*_.a[<span class="number">0</span>][<span class="number">1</span>]+<span class="number">1ll</span>*a[<span class="number">0</span>][<span class="number">1</span>]*_.a[<span class="number">1</span>][<span class="number">1</span>])%P;</span><br><span class="line">        res.a[<span class="number">1</span>][<span class="number">1</span>]=(<span class="number">1ll</span>*a[<span class="number">1</span>][<span class="number">0</span>]*_.a[<span class="number">0</span>][<span class="number">1</span>]+<span class="number">1ll</span>*a[<span class="number">1</span>][<span class="number">1</span>]*_.a[<span class="number">1</span>][<span class="number">1</span>])%P;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; s[N],val[N];</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> rt,ls[N],rs[N],key[N];</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Up</span><span class="params">(<span class="type">int</span> x)</span></span>&#123;</span><br><span class="line">    s[x]=val[x];</span><br><span class="line">    <span class="keyword">if</span>(ls[x]) s[x]=s[ls[x]]+s[x];</span><br><span class="line">    <span class="keyword">if</span>(rs[x]) s[x]=s[x]+s[rs[x]];</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">U</span><span class="params">(<span class="type">int</span> x,<span class="type">int</span> y)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!x||!y) <span class="keyword">return</span> x|y;</span><br><span class="line">    <span class="keyword">if</span>(key[x]&lt;key[y]) <span class="keyword">return</span> rs[x]=<span class="built_in">U</span>(rs[x],y),<span class="built_in">Up</span>(x),x;</span><br><span class="line">    <span class="keyword">return</span> ls[y]=<span class="built_in">U</span>(x,ls[y]),<span class="built_in">Up</span>(y),y;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Pii <span class="title">Lower</span><span class="params">(<span class="type">int</span> x,<span class="type">int</span> len)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(len&lt;=<span class="number">0</span> || !x) <span class="keyword">return</span> <span class="built_in">mp</span>(<span class="number">0</span>,x);</span><br><span class="line">    <span class="keyword">if</span>(s[x].len&lt;=len) <span class="keyword">return</span> <span class="built_in">mp</span>(x,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(s[ls[x]].len&gt;=len) &#123;</span><br><span class="line">        Pii y=<span class="built_in">Lower</span>(ls[x],len);</span><br><span class="line">        <span class="keyword">return</span> ls[x]=y.second,<span class="built_in">Up</span>(x),<span class="built_in">mp</span>(y.first,x);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Pii y=<span class="built_in">Lower</span>(rs[x],len-s[ls[x]].len-val[x].len);</span><br><span class="line">        <span class="keyword">return</span> rs[x]=y.first,<span class="built_in">Up</span>(x),<span class="built_in">mp</span>(x,y.second);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">EraseEnd</span><span class="params">(<span class="type">int</span> &amp;x)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!rs[x])&#123; x=ls[x]; <span class="keyword">return</span>; &#125;</span><br><span class="line">    <span class="type">static</span> <span class="type">int</span> T[N],C;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> y=x;y;y=rs[y]) T[++C]=y;</span><br><span class="line">    rs[T[C<span class="number">-1</span>]]=ls[T[C]];</span><br><span class="line">    <span class="built_in">drep</span>(i,C<span class="number">-1</span>,<span class="number">1</span>) <span class="built_in">Up</span>(T[i]);</span><br><span class="line">    C=<span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">AddR</span><span class="params">(<span class="type">int</span> x,<span class="type">int</span> y)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!x) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">if</span>(rs[x]) <span class="keyword">return</span> <span class="built_in">AddR</span>(rs[x],y),<span class="built_in">Up</span>(x);</span><br><span class="line">    val[x]=<span class="built_in">Node</span>(val[x].len+y),<span class="built_in">Up</span>(x);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">AddL</span><span class="params">(<span class="type">int</span> x,<span class="type">int</span> y)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!x) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">if</span>(ls[x]) <span class="keyword">return</span> <span class="built_in">AddL</span>(ls[x],y),<span class="built_in">Up</span>(x);</span><br><span class="line">    val[x]=<span class="built_in">Node</span>(val[x].len+y),<span class="built_in">Up</span>(x);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Pii <span class="title">Split</span><span class="params">(<span class="type">int</span> x)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(s[x].ma&lt;=<span class="number">2</span>) <span class="keyword">return</span> <span class="built_in">mp</span>(<span class="number">0</span>,x);</span><br><span class="line">    <span class="keyword">if</span>(val[x].ma&lt;=<span class="number">2</span> &amp;&amp; s[rs[x]].ma&lt;=<span class="number">2</span>) &#123;</span><br><span class="line">        Pii y=<span class="built_in">Split</span>(ls[x]);</span><br><span class="line">        <span class="keyword">return</span> ls[x]=y.second,<span class="built_in">Up</span>(x),<span class="built_in">mp</span>(y.first,x);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Pii y=<span class="built_in">Split</span>(rs[x]);</span><br><span class="line">        <span class="keyword">return</span> rs[x]=y.first,<span class="built_in">Up</span>(x),<span class="built_in">mp</span>(x,y.second);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">Pii <span class="title">Split2</span><span class="params">(<span class="type">int</span> x)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(s[x].ma&lt;=<span class="number">2</span>) <span class="keyword">return</span> <span class="built_in">mp</span>(x,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(s[ls[x]].ma&gt;<span class="number">2</span> || val[x].ma&gt;<span class="number">2</span>) &#123;</span><br><span class="line">        Pii y=<span class="built_in">Split2</span>(ls[x]);</span><br><span class="line">        <span class="keyword">return</span> ls[x]=y.second,<span class="built_in">Up</span>(x),<span class="built_in">mp</span>(y.first,x);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Pii y=<span class="built_in">Split2</span>(rs[x]);</span><br><span class="line">        <span class="keyword">return</span> rs[x]=y.first,<span class="built_in">Up</span>(x),<span class="built_in">mp</span>(x,y.second);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">New</span><span class="params">(<span class="type">int</span> x)</span></span>&#123; <span class="keyword">return</span> key[++n]=<span class="built_in">rand</span>(),s[n]=val[n]=<span class="built_in">Node</span>(x),n; &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Ins</span><span class="params">(<span class="type">int</span> x)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(x&lt;<span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line">    <span class="built_in">cmax</span>(x,<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span>(!rt) &#123; rt=<span class="built_in">New</span>(x); <span class="keyword">return</span>; &#125;</span><br><span class="line">    <span class="keyword">if</span>(s[rt].len&lt;x<span class="number">-1</span>) &#123;</span><br><span class="line">        rt=<span class="built_in">U</span>(rt,<span class="built_in">New</span>(x-s[rt].len));</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(s[rt].len==x<span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">EraseEnd</span>(rt);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">Ins</span>(x+<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    Pii t=<span class="built_in">Lower</span>(rt,x);</span><br><span class="line">    <span class="keyword">if</span>(s[t.first].len!=x) &#123;</span><br><span class="line">        <span class="keyword">if</span>(x&gt;<span class="number">1</span>) &#123;</span><br><span class="line">            Pii y=<span class="built_in">Lower</span>(t.first,x<span class="number">-1</span>);</span><br><span class="line">            <span class="keyword">if</span>(s[y.first].len==x<span class="number">-1</span>) &#123;</span><br><span class="line">                <span class="built_in">AddR</span>(y.first,s[y.second].len),rt=<span class="built_in">U</span>(y.first,t.second);</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">Ins</span>(x+<span class="number">1</span>);</span><br><span class="line">            &#125; </span><br><span class="line">            t.first=<span class="built_in">U</span>(y.first,y.second);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(s[t.first].len==x+<span class="number">1</span>) &#123;</span><br><span class="line">            Pii y=<span class="built_in">Split2</span>(t.second);</span><br><span class="line">            <span class="built_in">AddL</span>(y.second,<span class="number">-1</span>);</span><br><span class="line">            <span class="type">int</span> d=s[t.first].r+s[y.first].len+<span class="number">1</span>;</span><br><span class="line">            <span class="built_in">EraseEnd</span>(t.first);</span><br><span class="line">            rt=<span class="built_in">U</span>(<span class="built_in">U</span>(t.first,<span class="built_in">New</span>(d)),y.second);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> d=s[t.first].len-x;</span><br><span class="line">        <span class="built_in">AddR</span>(t.first,-d);</span><br><span class="line">        rt=<span class="built_in">U</span>(<span class="built_in">U</span>(t.first,<span class="built_in">New</span>(d)),t.second);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(s[t.second].l==<span class="number">2</span>) <span class="keyword">return</span> <span class="built_in">AddL</span>(t.second,s[t.first].r),<span class="built_in">EraseEnd</span>(t.first),rt=<span class="built_in">U</span>(t.first,t.second),<span class="built_in">Ins</span>(x+<span class="number">1</span>),<span class="built_in">Ins</span>(x<span class="number">-2</span>);</span><br><span class="line">    Pii y=<span class="built_in">Split</span>(t.first); <span class="built_in">AddL</span>(t.second,<span class="number">-1</span>);</span><br><span class="line">    <span class="keyword">if</span>(!y.first) &#123;</span><br><span class="line">        <span class="keyword">if</span>(s[y.second].l==<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="built_in">AddL</span>(y.second,<span class="number">1</span>),rt=<span class="built_in">U</span>(y.second,t.second);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        rt=<span class="built_in">U</span>(<span class="built_in">U</span>(<span class="built_in">New</span>(<span class="number">1</span>),y.second),t.second);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">if</span>(s[y.first].len&gt;<span class="number">3</span> &amp;&amp; s[y.first].r==<span class="number">3</span>) &#123;</span><br><span class="line">        <span class="built_in">EraseEnd</span>(y.first),<span class="built_in">AddR</span>(y.first,<span class="number">2</span>);</span><br><span class="line">        rt=<span class="built_in">U</span>(<span class="built_in">U</span>(<span class="built_in">U</span>(y.first,<span class="built_in">New</span>(<span class="number">2</span>)),y.second),t.second);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">AddR</span>(y.first,<span class="number">-2</span>);</span><br><span class="line">    rt=<span class="built_in">U</span>(<span class="built_in">U</span>(<span class="built_in">U</span>(y.first,<span class="built_in">New</span>(<span class="number">3</span>)),y.second),t.second);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">rep</span>(kase,<span class="number">1</span>,<span class="built_in">rd</span>()) <span class="built_in">Ins</span>(<span class="built_in">rd</span>()),<span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>,(s[rt].a[<span class="number">0</span>][<span class="number">0</span>]+s[rt].a[<span class="number">0</span>][<span class="number">1</span>])%P);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://compilationfail.github.io/oi-solutions/ROI%20-%20CEOI%20-%20CCO%20-%20APIO%20-%20Baltic%20OI%20-%20USACO/%E3%80%8CCEOI2020%E3%80%8D%E6%98%9F%E9%99%85%E8%BF%B7%E8%88%AA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="orangejuice">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="orangejuice's blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | orangejuice's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/oi-solutions/ROI%20-%20CEOI%20-%20CCO%20-%20APIO%20-%20Baltic%20OI%20-%20USACO/%E3%80%8CCEOI2020%E3%80%8D%E6%98%9F%E9%99%85%E8%BF%B7%E8%88%AA/" class="post-title-link" itemprop="url">「CEOI2020」星际迷航</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-08-12 00:11:59" itemprop="dateCreated datePublished" datetime="2023-08-12T00:11:59+08:00">2023-08-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-08-17 21:28:48" itemprop="dateModified" datetime="2023-08-17T21:28:48+08:00">2023-08-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/CP-%E9%A2%98%E8%A7%A3/" itemprop="url" rel="index"><span itemprop="name">CP 题解</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="ceoi2020星际迷航">「CEOI2020」星际迷航</h1>
<p>首先是最简单的判断是否必胜的 <span class="math inline">\(dp\)</span>
转移 <span class="math inline">\(\displaystyle dp_u=\bigcup_{v\in son_u}
\text{not  } dp_{v}\)</span></p>
<p>考虑第 <span class="math inline">\(i+1\)</span> 层对于第 <span
class="math inline">\(i\)</span> 层的贡献，实际上只和 <span
class="math inline">\(i+1\)</span> 层有多少个点 <span
class="math inline">\(dp\)</span> 值为0/1有关</p>
<p>下面称 <span class="math inline">\(dp\)</span> 值为0/1的点为 败/胜
点</p>
<p>考虑对于确定第 <span class="math inline">\(i\)</span>
层的根为某一节点 <span class="math inline">\(root\)</span> 之后</p>
<p>在某一个点下面接一个胜点，或者在一个胜点下面接一个点，对于胜败情况没有影响</p>
<p>在一个败点下面接一个败点，可能会导致一段连续祖先段的胜败翻转</p>
<p>考虑对于每个 <span class="math inline">\(u\)</span> 作为根求出：</p>
<p>1.没有接上下一层时的胜败情况 ： <span
class="math inline">\(dp_u\)</span></p>
<p>2.有多少个节点接上一个败点之后，会导致根的胜败情况翻转： <span
class="math inline">\(R_u\)</span></p>
<p>这是一个换根 <span class="math inline">\(dp\)</span> 问题</p>
<p>具体来说， <span class="math inline">\(R_u\)</span>
的值，根据子节点中败点的个数可以得到转移：</p>
<p>1.没有败点，那么就是所有子节点 <span class="math inline">\(R\)</span>
之和+自己</p>
<p>2.恰好有一个败点，那么就是败点的 <span
class="math inline">\(R\)</span></p>
<p>对此，每个点维护子节点中败点的个数，然后换根 <span
class="math inline">\(dp\)</span> 即可</p>
<p>求出每个 <span class="math inline">\(root\)</span>
的1，2后，可以用一个矩阵维护每层的转移，就不再赘述</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">long</span> <span class="type">long</span> ll;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> pb push_back</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> rep(i,a,b) for(int i=a,i##end=b;i&lt;=i##end;++i)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> drep(i,a,b) for(int i=a,i##end=b;i&gt;=i##end;--i)</span></span><br><span class="line"></span><br><span class="line"><span class="type">char</span> IO;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">rd</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="type">int</span> s=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(!<span class="built_in">isdigit</span>(IO=<span class="built_in">getchar</span>()));</span><br><span class="line">    <span class="keyword">do</span> s=(s&lt;&lt;<span class="number">1</span>)+(s&lt;&lt;<span class="number">3</span>)+(IO^<span class="string">&#x27;0&#x27;</span>);</span><br><span class="line">    <span class="keyword">while</span>(<span class="built_in">isdigit</span>(IO=<span class="built_in">getchar</span>()));</span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> N=<span class="number">1e5</span>+<span class="number">10</span>,INF=<span class="number">1e9</span>+<span class="number">10</span>,P=<span class="number">1e9</span>+<span class="number">7</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> n;</span><br><span class="line">ll m;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Mat</span>&#123;</span><br><span class="line">    <span class="type">int</span> a[<span class="number">2</span>][<span class="number">2</span>];</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">clear</span><span class="params">()</span></span>&#123; <span class="built_in">memset</span>(a,<span class="number">0</span>,<span class="keyword">sizeof</span> a); &#125;</span><br><span class="line">    Mat <span class="keyword">operator</span> * (<span class="type">const</span> Mat x) <span class="type">const</span> &#123;</span><br><span class="line">        Mat res; res.<span class="built_in">clear</span>();</span><br><span class="line">        <span class="built_in">rep</span>(i,<span class="number">0</span>,<span class="number">1</span>) <span class="built_in">rep</span>(j,<span class="number">0</span>,<span class="number">1</span>) <span class="built_in">rep</span>(k,<span class="number">0</span>,<span class="number">1</span>) res.a[i][k]=(res.a[i][k]+<span class="number">1ll</span>*a[i][j]*x.a[j][k])%P;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; Res,X;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> F[N],FC[N],FR[N],son[N][<span class="number">2</span>],SR[N];</span><br><span class="line"><span class="comment">// F子树胜败，FC子节点败点个数，FR子树翻转点个数，son存储两个儿子中的败点，SR存储儿子中的FR之和</span></span><br><span class="line"><span class="type">int</span> G[N],GC[N],GR[N];</span><br><span class="line"><span class="comment">// F,GC,GR是子树外的</span></span><br><span class="line"><span class="type">int</span> dp[N],R[N],fa[N];</span><br><span class="line"><span class="comment">// dp,R即上文所述</span></span><br><span class="line"></span><br><span class="line">vector &lt;<span class="type">int</span>&gt; E[N];</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">dfs1</span><span class="params">(<span class="type">int</span> u,<span class="type">int</span> f)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 子树处理</span></span><br><span class="line">    fa[u]=f;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> v:E[u]) <span class="keyword">if</span>(v!=f) &#123;</span><br><span class="line">        <span class="built_in">dfs1</span>(v,u);</span><br><span class="line">        FC[u]+=!F[v];</span><br><span class="line">        <span class="keyword">if</span>(!F[v]) &#123;</span><br><span class="line">            <span class="keyword">if</span>(!son[u][<span class="number">0</span>]) son[u][<span class="number">0</span>]=v;</span><br><span class="line">            <span class="keyword">else</span> son[u][<span class="number">1</span>]=v;</span><br><span class="line">        &#125;</span><br><span class="line">        SR[u]+=FR[v];</span><br><span class="line">    &#125;</span><br><span class="line">    F[u]=FC[u]&gt;<span class="number">0</span>;</span><br><span class="line">    FR[u]=!F[u];</span><br><span class="line">    <span class="keyword">if</span>(FC[u]&lt;=<span class="number">1</span>) <span class="keyword">for</span>(<span class="type">int</span> v:E[u]) <span class="keyword">if</span>(v!=f &amp;&amp; F[u]!=F[v]) FR[u]+=FR[v];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//换根dp</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">dfs2</span><span class="params">(<span class="type">int</span> u,<span class="type">int</span> f)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(f) GC[u]=G[u]=!G[f],GR[u]=GR[f]+!G[u];</span><br><span class="line">    <span class="keyword">else</span> GC[u]=G[u]=<span class="number">0</span>,GR[u]=<span class="number">1</span>;</span><br><span class="line">    dp[u]=F[u]|G[u];</span><br><span class="line">    <span class="keyword">if</span>(!dp[u]) R[u]=FR[u]+GR[u]<span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(FC[u]+G[u]==<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>(G[u]) R[u]=GR[u];</span><br><span class="line">        <span class="keyword">else</span> R[u]=FR[u];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> v:E[u]) <span class="keyword">if</span>(v!=f) &#123;</span><br><span class="line">        GC[u]=FC[u]-!F[v]+(f?!G[f]:<span class="number">0</span>);</span><br><span class="line">        G[u]=GC[u]&gt;<span class="number">0</span>;</span><br><span class="line">        GR[u]=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span>(!G[u]) GR[u]=GR[f]+SR[u]-FR[v]+<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(GC[u]==<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span>(son[u][<span class="number">0</span>] &amp;&amp; son[u][<span class="number">0</span>]!=v) GR[u]=FR[son[u][<span class="number">0</span>]];</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(son[u][<span class="number">1</span>] &amp;&amp; son[u][<span class="number">1</span>]!=v) GR[u]=FR[son[u][<span class="number">1</span>]];</span><br><span class="line">            <span class="keyword">else</span> GR[u]=GR[f];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">dfs2</span>(v,u);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> cnt[<span class="number">2</span>];</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    n=<span class="built_in">rd</span>(),<span class="built_in">scanf</span>(<span class="string">&quot;%lld&quot;</span>,&amp;m);</span><br><span class="line">    <span class="built_in">rep</span>(i,<span class="number">2</span>,n) &#123;</span><br><span class="line">        <span class="type">int</span> u=<span class="built_in">rd</span>(),v=<span class="built_in">rd</span>();</span><br><span class="line">        E[u].<span class="built_in">pb</span>(v),E[v].<span class="built_in">pb</span>(u);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">dfs1</span>(<span class="number">1</span>,<span class="number">0</span>),<span class="built_in">dfs2</span>(<span class="number">1</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="comment">// 矩阵处理</span></span><br><span class="line">    <span class="built_in">rep</span>(i,<span class="number">1</span>,n) &#123;</span><br><span class="line">        cnt[dp[i]]++;</span><br><span class="line">        X.a[<span class="number">1</span>][dp[i]]=(X.a[<span class="number">1</span>][dp[i]]+n)%P;</span><br><span class="line">        X.a[<span class="number">0</span>][!dp[i]]=(X.a[<span class="number">0</span>][!dp[i]]+R[i])%P;</span><br><span class="line">        X.a[<span class="number">0</span>][dp[i]]=(X.a[<span class="number">0</span>][dp[i]]+n-R[i])%P;</span><br><span class="line">    &#125;</span><br><span class="line">    m--,Res.a[<span class="number">0</span>][<span class="number">0</span>]=Res.a[<span class="number">1</span>][<span class="number">1</span>]=<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span>(m) &#123;</span><br><span class="line">        <span class="keyword">if</span>(m&amp;<span class="number">1</span>) Res=Res*X;</span><br><span class="line">        X=X*X;</span><br><span class="line">        m&gt;&gt;=<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> x=(<span class="number">1ll</span>*Res.a[<span class="number">0</span>][<span class="number">0</span>]*cnt[<span class="number">0</span>]+<span class="number">1ll</span>*Res.a[<span class="number">1</span>][<span class="number">0</span>]*cnt[<span class="number">1</span>])%P;</span><br><span class="line">    <span class="type">int</span> y=(<span class="number">1ll</span>*Res.a[<span class="number">0</span>][<span class="number">1</span>]*cnt[<span class="number">0</span>]+<span class="number">1ll</span>*Res.a[<span class="number">1</span>][<span class="number">1</span>]*cnt[<span class="number">1</span>])%P;</span><br><span class="line">    <span class="comment">// 得到第一层败/胜 的个数，与第0层合并</span></span><br><span class="line">    <span class="type">int</span> ans=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span>(!dp[<span class="number">1</span>]) ans=<span class="number">1ll</span>*x*R[<span class="number">1</span>]%P;</span><br><span class="line">    <span class="keyword">else</span> ans=(<span class="number">1ll</span>*x*(n-R[<span class="number">1</span>])+<span class="number">1ll</span>*n*y)%P;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>,ans);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://compilationfail.github.io/oi-solutions/ROI%20-%20CEOI%20-%20CCO%20-%20APIO%20-%20Baltic%20OI%20-%20USACO/%E3%80%8CCEOI2019%E3%80%8D%E5%BB%BA%E9%80%A0%E6%91%A9%E5%A4%A9%E6%A5%BC/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="orangejuice">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="orangejuice's blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | orangejuice's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/oi-solutions/ROI%20-%20CEOI%20-%20CCO%20-%20APIO%20-%20Baltic%20OI%20-%20USACO/%E3%80%8CCEOI2019%E3%80%8D%E5%BB%BA%E9%80%A0%E6%91%A9%E5%A4%A9%E6%A5%BC/" class="post-title-link" itemprop="url">「CEOI2019」建造摩天楼</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-08-12 00:11:59" itemprop="dateCreated datePublished" datetime="2023-08-12T00:11:59+08:00">2023-08-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-08-17 21:28:48" itemprop="dateModified" datetime="2023-08-17T21:28:48+08:00">2023-08-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/CP-%E9%A2%98%E8%A7%A3/" itemprop="url" rel="index"><span itemprop="name">CP 题解</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="ceoi2019建造摩天楼">「CEOI2019」建造摩天楼</h1>
<p>显然是倒着考虑删除每个大楼，此时每次面临的情况都是一个子问题</p>
<p>下文称当前局面未被删除的大楼为黑点，其余为白点</p>
<p>子问题有解的充要条件是：黑点之间能 8-连通</p>
<p>当前一个点能够被删掉的条件是：</p>
<p>1.这个点能够连通到无穷处</p>
<p>2.这个点不是当前8-连通图的割点</p>
<p><span class="math display">\[ \ \]</span></p>
<p>考虑用一个简单的方法维护条件1：</p>
<p>将一开始每个黑点周围的白点取出，按照白点之间4-连通构建连通块</p>
<p>能够4-连通接触到最外层连通块的黑点满足条件1</p>
<p>每次删除黑点之后，增加能够连通的白点，每个白点只会增加一次</p>
<p>ps:寻找最外层4-连通白点的一个方法：找到x最大的白点</p>
<p><span class="math display">\[ \ \]</span></p>
<p>接下来考虑如何判定一个点 <span class="math inline">\(u\)</span>
是否是割点：</p>
<p>首先删除 <span class="math inline">\(u\)</span>
之后，周围8连通内能够构成多个连通块，可以发现大致可以归结为以下几种情况，其中x,y为黑点</p>
<p>多个 <span class="math inline">\(x\)</span> 表示 <span
class="math inline">\(x\)</span> 在其中任何一个位置都可以</p>
<table>
<thead>
<tr class="header">
<th>1.</th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>x</td>
<td>①</td>
<td>y</td>
</tr>
<tr class="even">
<td>x</td>
<td>u</td>
<td>y</td>
</tr>
<tr class="odd">
<td>x</td>
<td>②</td>
<td>y</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr class="header">
<th>2.</th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>x</td>
<td>①</td>
<td>y</td>
</tr>
<tr class="even">
<td>②</td>
<td>u</td>
<td>y</td>
</tr>
<tr class="odd">
<td>y</td>
<td>y</td>
<td>y</td>
</tr>
</tbody>
</table>
<p>对于这两种情况，只要白点1和白点2在同一4-连通块，割掉 <span
class="math inline">\(u\)</span> 就会分开x和 <span
class="math inline">\(y\)</span></p>
<p>由此，每次插入一个白点，可以 <span
class="math inline">\(O(1)\)</span> 检测一个点是否合法</p>
<p>简单讨论可以发现，会被影响合法性的点，一定在新加入最外层连通块的白点周围</p>
<p>这样总共check了 <span class="math inline">\(O(n)\)</span>
次，每次用一个堆/set维护能选的最大编号的点即可</p>
<p>ps:代码非常丑非常垃圾。。。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> pair &lt;<span class="type">int</span>,<span class="type">int</span>&gt; Pii;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> mp make_pair</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> pb push_back</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> x first</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> y second</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> rep(i,a,b) for(int i=a,i##end=b;i&lt;=i##end;++i)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> drep(i,a,b) for(int i=a,i##end=b;i&gt;=i##end;--i)</span></span><br><span class="line"></span><br><span class="line"><span class="type">char</span> IO;</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">T</span>=<span class="type">int</span>&gt; T <span class="built_in">rd</span>()&#123;</span><br><span class="line">	T s=<span class="number">0</span>; <span class="type">int</span> f=<span class="number">0</span>;</span><br><span class="line">	<span class="keyword">while</span>(!<span class="built_in">isdigit</span>(IO=<span class="built_in">getchar</span>())) f|=IO==<span class="string">&#x27;-&#x27;</span>;</span><br><span class="line">	<span class="keyword">do</span> s=(s&lt;&lt;<span class="number">1</span>)+(s&lt;&lt;<span class="number">3</span>)+(IO^<span class="string">&#x27;0&#x27;</span>);</span><br><span class="line">	<span class="keyword">while</span>(<span class="built_in">isdigit</span>(IO=<span class="built_in">getchar</span>()));</span><br><span class="line">	<span class="keyword">return</span> f?-s:s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> N=<span class="number">1.3e6</span>+<span class="number">10</span>,INF=<span class="number">1e9</span>+<span class="number">10</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">int</span> z[<span class="number">5</span>][<span class="number">4</span>]=&#123;&#123;<span class="number">1</span>,<span class="number">0</span>&#125;,&#123;<span class="number">0</span>,<span class="number">-1</span>&#125;,&#123;<span class="number">-1</span>,<span class="number">0</span>&#125;,&#123;<span class="number">0</span>,<span class="number">1</span>&#125;&#125;;</span><br><span class="line"><span class="type">const</span> <span class="type">int</span> Z[<span class="number">9</span>][<span class="number">4</span>]=&#123;&#123;<span class="number">1</span>,<span class="number">1</span>&#125;,&#123;<span class="number">1</span>,<span class="number">0</span>&#125;,&#123;<span class="number">1</span>,<span class="number">-1</span>&#125;,&#123;<span class="number">0</span>,<span class="number">-1</span>&#125;,&#123;<span class="number">-1</span>,<span class="number">-1</span>&#125;,&#123;<span class="number">-1</span>,<span class="number">0</span>&#125;,&#123;<span class="number">-1</span>,<span class="number">1</span>&#125;,&#123;<span class="number">0</span>,<span class="number">1</span>&#125;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> n,m,k;</span><br><span class="line"><span class="type">int</span> F[N];</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Find</span><span class="params">(<span class="type">int</span> x)</span></span>&#123; <span class="keyword">return</span> F[x]==x?x:F[x]=<span class="built_in">Find</span>(F[x]);&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Union</span><span class="params">(<span class="type">int</span> x,<span class="type">int</span> y)</span></span>&#123; F[<span class="built_in">Find</span>(x)]=<span class="built_in">Find</span>(y); &#125;</span><br><span class="line">map &lt;Pii,<span class="type">int</span>&gt; B,W;</span><br><span class="line">set &lt;<span class="type">int</span>&gt; st;</span><br><span class="line">vector &lt;<span class="type">int</span>&gt; ans;</span><br><span class="line">Pii A[N],P[N];</span><br><span class="line"><span class="type">int</span> ma=<span class="number">-1e9</span>,maxid;</span><br><span class="line"><span class="type">int</span> G[N][<span class="number">4</span>];</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Ins</span><span class="params">(<span class="type">int</span> x,<span class="type">int</span> y)</span></span>&#123;</span><br><span class="line">    <span class="comment">// Insert white point</span></span><br><span class="line">	Pii T=<span class="built_in">mp</span>(x,y);</span><br><span class="line">	<span class="keyword">if</span>(B.<span class="built_in">count</span>(T)) <span class="keyword">return</span> ;</span><br><span class="line">	<span class="keyword">if</span>(!W.<span class="built_in">count</span>(T)) P[W[T]=++m]=T,F[m]=m;</span><br><span class="line">	<span class="type">int</span> u=W[T];</span><br><span class="line">	<span class="keyword">if</span>(x&gt;ma) ma=x,maxid=u;</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">0</span>,<span class="number">3</span>) &#123;</span><br><span class="line">		<span class="type">int</span> x1=x+z[i][<span class="number">0</span>],y1=y+z[i][<span class="number">1</span>];</span><br><span class="line">		<span class="keyword">if</span>(W.<span class="built_in">count</span>(<span class="built_in">mp</span>(x1,y1))) &#123;</span><br><span class="line">			<span class="type">int</span> v=W[<span class="built_in">mp</span>(x1,y1)];</span><br><span class="line">			G[u][i]=v;</span><br><span class="line">			G[v][(i+<span class="number">2</span>)%<span class="number">4</span>]=u;</span><br><span class="line">			<span class="built_in">Union</span>(u,v);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> del[N],vis[N],reach[N];</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Check</span><span class="params">(<span class="type">int</span> u)</span></span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(del[u]||!reach[u]) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	<span class="type">static</span> <span class="type">int</span> I[<span class="number">8</span>];</span><br><span class="line">	<span class="type">int</span> c=<span class="number">0</span>;</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">0</span>,<span class="number">7</span>) &#123;</span><br><span class="line">		Pii T=<span class="built_in">mp</span>(A[u].x+Z[i][<span class="number">0</span>],A[u].y+Z[i][<span class="number">1</span>]);</span><br><span class="line">		<span class="keyword">if</span>(W.<span class="built_in">count</span>(T)) I[i]=<span class="built_in">Find</span>(W[T]);</span><br><span class="line">		<span class="keyword">else</span> I[i]=<span class="number">0</span>,c++;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">1</span>,t=<span class="number">0</span>;t&lt;<span class="number">4</span>;t++,i=(i+<span class="number">2</span>)%<span class="number">8</span>)&#123;</span><br><span class="line">		<span class="type">int</span> j=(i+<span class="number">2</span>)%<span class="number">8</span>;</span><br><span class="line">		<span class="keyword">if</span>(I[i] &amp;&amp; I[i]==I[j] &amp;&amp; !I[(i+<span class="number">1</span>)%<span class="number">8</span>] &amp;&amp; c&gt;<span class="number">1</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>((!I[<span class="number">0</span>]||!I[<span class="number">1</span>]||!I[<span class="number">2</span>]) &amp;&amp; (!I[<span class="number">4</span>]||!I[<span class="number">5</span>]||!I[<span class="number">6</span>]) &amp;&amp; I[<span class="number">3</span>] &amp;&amp; I[<span class="number">3</span>]==I[<span class="number">7</span>]) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span>((!I[<span class="number">2</span>]||!I[<span class="number">3</span>]||!I[<span class="number">4</span>]) &amp;&amp; (!I[<span class="number">6</span>]||!I[<span class="number">7</span>]||!I[<span class="number">0</span>]) &amp;&amp; I[<span class="number">1</span>] &amp;&amp; I[<span class="number">5</span>]==I[<span class="number">1</span>]) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ReCheck</span><span class="params">(<span class="type">int</span> u)</span></span>&#123;</span><br><span class="line">	<span class="keyword">auto</span> it=st.<span class="built_in">find</span>(u);</span><br><span class="line">	<span class="keyword">if</span>(it!=st.<span class="built_in">end</span>()) st.<span class="built_in">erase</span>(it);</span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">Check</span>(u)) st.<span class="built_in">insert</span>(u);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vector &lt;<span class="type">int</span>&gt; tmp;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">dfs</span><span class="params">(<span class="type">int</span> u)</span></span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(!u) <span class="keyword">return</span>;</span><br><span class="line">	<span class="keyword">if</span>(vis[u]) <span class="keyword">return</span>;</span><br><span class="line">	vis[u]=<span class="number">1</span>;</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">0</span>,<span class="number">3</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span>(G[u][i]) <span class="built_in">dfs</span>(G[u][i]);</span><br><span class="line">		Pii T=<span class="built_in">mp</span>(P[u].x+z[i][<span class="number">0</span>],P[u].y+z[i][<span class="number">1</span>]);</span><br><span class="line">		<span class="keyword">if</span>(B.<span class="built_in">count</span>(T)) reach[B[T]]=<span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">rep</span>(dx,<span class="number">-1</span>,<span class="number">1</span>) <span class="built_in">rep</span>(dy,<span class="number">-1</span>,<span class="number">1</span>) <span class="keyword">if</span>(dx||dy) &#123;</span><br><span class="line">		Pii T=<span class="built_in">mp</span>(P[u].x+dx,P[u].y+dy);</span><br><span class="line">		<span class="keyword">if</span>(B.<span class="built_in">count</span>(T)) tmp.<span class="built_in">pb</span>(B[T]);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Dfs</span><span class="params">(<span class="type">int</span> u)</span></span>&#123;</span><br><span class="line">	<span class="built_in">dfs</span>(u);</span><br><span class="line">	<span class="built_in">sort</span>(tmp.<span class="built_in">begin</span>(),tmp.<span class="built_in">end</span>()),tmp.<span class="built_in">erase</span>(<span class="built_in">unique</span>(tmp.<span class="built_in">begin</span>(),tmp.<span class="built_in">end</span>()),tmp.<span class="built_in">end</span>());</span><br><span class="line">	<span class="keyword">for</span>(<span class="type">int</span> i:tmp) <span class="built_in">ReCheck</span>(i);</span><br><span class="line">	tmp.<span class="built_in">clear</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Del</span><span class="params">(<span class="type">int</span> u)</span></span>&#123;</span><br><span class="line">    <span class="comment">// delete black point</span></span><br><span class="line">	del[u]=<span class="number">1</span>;</span><br><span class="line">	B.<span class="built_in">erase</span>(A[u]),<span class="built_in">Ins</span>(A[u].x,A[u].y);</span><br><span class="line">	<span class="built_in">Dfs</span>(W[A[u]]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	n=<span class="built_in">rd</span>(),<span class="built_in">rd</span>();</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">1</span>,n) A[i].x=<span class="built_in">rd</span>(),A[i].y=<span class="built_in">rd</span>(),B[A[i]]=i;</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">1</span>,n) F[i]=i;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// Check NO</span></span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">1</span>,n) &#123; </span><br><span class="line">		<span class="built_in">rep</span>(dx,<span class="number">-1</span>,<span class="number">1</span>) <span class="built_in">rep</span>(dy,<span class="number">-1</span>,<span class="number">1</span>) &#123;</span><br><span class="line">			Pii T=<span class="built_in">mp</span>(A[i].x+dx,A[i].y+dy);</span><br><span class="line">			<span class="keyword">if</span>(B.<span class="built_in">count</span>(T)) <span class="built_in">Union</span>(i,B[T]);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">1</span>,n) <span class="keyword">if</span>(<span class="built_in">Find</span>(i)!=<span class="built_in">Find</span>(<span class="number">1</span>)) <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;NO&quot;</span>),<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">1</span>,n) <span class="built_in">rep</span>(dx,<span class="number">-1</span>,<span class="number">1</span>) <span class="built_in">rep</span>(dy,<span class="number">-1</span>,<span class="number">1</span>) <span class="keyword">if</span>(dx||dy) <span class="built_in">Ins</span>(A[i].x+dx,A[i].y+dy);</span><br><span class="line">	<span class="built_in">Dfs</span>(maxid);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">1</span>,n) &#123;</span><br><span class="line">		<span class="type">int</span> u=*st.<span class="built_in">rbegin</span>();</span><br><span class="line">		<span class="keyword">auto</span> it=st.<span class="built_in">end</span>(); --it;st.<span class="built_in">erase</span>(it);</span><br><span class="line">		<span class="built_in">Del</span>(u),ans.<span class="built_in">pb</span>(u);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">reverse</span>(ans.<span class="built_in">begin</span>(),ans.<span class="built_in">end</span>());</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;YES&quot;</span>);</span><br><span class="line">	<span class="keyword">for</span>(<span class="type">int</span> i:ans) <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>,i);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://compilationfail.github.io/oi-solutions/ROI%20-%20CEOI%20-%20CCO%20-%20APIO%20-%20Baltic%20OI%20-%20USACO/%E3%80%8CROI%202016%20Day1%E3%80%8D%E4%BA%BA%E7%83%9F%E4%B9%8B%E5%B1%B1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="orangejuice">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="orangejuice's blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | orangejuice's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/oi-solutions/ROI%20-%20CEOI%20-%20CCO%20-%20APIO%20-%20Baltic%20OI%20-%20USACO/%E3%80%8CROI%202016%20Day1%E3%80%8D%E4%BA%BA%E7%83%9F%E4%B9%8B%E5%B1%B1/" class="post-title-link" itemprop="url">「ROI 2016 Day1」人烟之山</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-08-12 00:11:59" itemprop="dateCreated datePublished" datetime="2023-08-12T00:11:59+08:00">2023-08-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-08-17 21:28:48" itemprop="dateModified" datetime="2023-08-17T21:28:48+08:00">2023-08-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/CP-%E9%A2%98%E8%A7%A3/" itemprop="url" rel="index"><span itemprop="name">CP 题解</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="roi-2016-day1人烟之山">「ROI 2016 Day1」人烟之山</h1>
<p>题目大意：</p>
<p>有 <span class="math inline">\(n\)</span> 段折线， <span
class="math inline">\(m\)</span> 个查询点 <span
class="math inline">\(A\)</span> （在折线以上），设折线拐点为 <span
class="math inline">\(X_i\)</span></p>
<p>求折线上在查询点投影两边最近的位置 <span
class="math inline">\(B\)</span> ，且直线 <span
class="math inline">\(AB\)</span> 与折线有非边缘的交点 (即从 <span
class="math inline">\(A\)</span> 点看过来会被折线遮住)</p>
<p>题目分析：</p>
<p><span class="math inline">\(B,C\)</span> 点满足的条件就是其旁边的直线
<span class="math inline">\(L\)</span> 在 <span
class="math inline">\(x_A\)</span> 处的值 <span
class="math inline">\(&gt;y_A\)</span></p>
<figure>
<img src="https://i.loli.net/2021/02/20/rguOJLKFG89Ipt2.png"
alt="Snipaste_2021-02-20_13-43-59.png" />
<figcaption
aria-hidden="true">Snipaste_2021-02-20_13-43-59.png</figcaption>
</figure>
<p>即找到最近的红色直线</p>
<h2 id="solution1-onlog-2n">Solution1 <span
class="math inline">\(O(n\log ^2n)\)</span></h2>
<p>以求左边为例</p>
<p>考虑二分答案，求出拐点为 <span class="math inline">\(X_i,i\ge
mid\)</span> 的直线中是否存在红色直线</p>
<p>也就是求最大值是否 <span class="math inline">\(&gt;y_A\)</span>
，维护直线最大值，并且区间查询，可以暴力可持久化李超树来解决</p>
<p>因为是求左边的，所以每条直线更新的范围 <span
class="math inline">\(&gt;X_i\)</span> ，李超树区间更新复杂度为 <span
class="math inline">\(O(\log ^2n)\)</span></p>
<p>李超树查询复杂度为 <span class="math inline">\(O(\log n)\)</span>
,加上二分，查询为 <span class="math inline">\(O(\log ^2n)\)</span></p>
<p><span class="math display">\[ \ \]</span></p>
<h3 id="solution2-onlog-n">Solution2 <span class="math inline">\(O(n\log
n)\)</span></h3>
<p>依然考虑二分，但是这次考虑在线段树上二分</p>
<p>对于所有的 <span class="math inline">\(X_i\)</span> 建立线段树，区间
<span class="math inline">\([L,R]\)</span> 内维护一个 <span
class="math inline">\(X_i,i\in [L,R]\)</span>
的上凸包，静态维护最大值</p>
<p>凸包可以归并子节点来建立，预处理复杂度为 <span
class="math inline">\(O(n\log n)\)</span></p>
<p>如果查询直接在凸包上二分，复杂度会增加一个 <span
class="math inline">\(\log n\)</span></p>
<p>解决方法是：将所有查询的 <span class="math inline">\(x_A\)</span>
排序，然后在凸包上查询时就可以做到线性</p>
<p>因此复杂度为 <span class="math inline">\(O(n\log n)\)</span></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">long</span> <span class="type">long</span> ll;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">double</span> db;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> pb push_back</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> rep(i,a,b) for(int i=a,i##end=b;i&lt;=i##end;++i)</span></span><br><span class="line"><span class="type">char</span> buf[<span class="number">200000</span>],*p1,*p2;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> getchar() (((p1==p2)&amp;&amp;(p2=(p1=buf)+fread(buf,1,200000,stdin))),*p1++)</span></span><br><span class="line"><span class="type">char</span> IO;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">rd</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="type">int</span> s=<span class="number">0</span>; <span class="type">int</span> f=<span class="number">0</span>;</span><br><span class="line">	<span class="keyword">while</span>(!<span class="built_in">isdigit</span>(IO=<span class="built_in">getchar</span>())) f|=IO==<span class="string">&#x27;-&#x27;</span>;</span><br><span class="line">	<span class="keyword">do</span> s=(s&lt;&lt;<span class="number">1</span>)+(s&lt;&lt;<span class="number">3</span>)+(IO^<span class="string">&#x27;0&#x27;</span>);</span><br><span class="line">	<span class="keyword">while</span>(<span class="built_in">isdigit</span>(IO=<span class="built_in">getchar</span>()));</span><br><span class="line">	<span class="keyword">return</span> f?-s:s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> N=<span class="number">4e5</span>+<span class="number">10</span>,U=<span class="number">1e9</span>+<span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> n,m,K[N],X[N],L[N],R[N];</span><br><span class="line">ll Y[N];</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Que</span>&#123;</span><br><span class="line">	<span class="type">int</span> x,y,id;</span><br><span class="line">	<span class="type">bool</span> <span class="keyword">operator</span> &lt; (<span class="type">const</span> Que __) <span class="type">const</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> x&lt;__.x;</span><br><span class="line">	&#125;</span><br><span class="line">&#125; Q[N];</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Node</span>&#123;</span><br><span class="line">	<span class="type">int</span> k; ll b;</span><br><span class="line">	ll <span class="keyword">operator</span> [] (<span class="type">const</span> ll x) <span class="type">const</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1ll</span>*k*x+b;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">friend</span> db <span class="title">Cross</span><span class="params">(Node x,Node y)</span></span>&#123; <span class="keyword">return</span> <span class="number">1.0</span>*(y.b-x.b)/(x.k-y.k); &#125;</span><br><span class="line">	<span class="type">bool</span> <span class="keyword">operator</span> &lt; (<span class="type">const</span> Node __) <span class="type">const</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> k&lt;__.k||(k==__.k &amp;&amp; b&lt;__.b);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;; </span><br><span class="line">vector &lt;Node&gt; H[N&lt;&lt;<span class="number">2</span>];</span><br><span class="line">vector &lt;Node&gt; ::iterator P[N&lt;&lt;<span class="number">2</span>];</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Build</span><span class="params">(<span class="type">int</span> p,<span class="type">int</span> l,<span class="type">int</span> r)</span></span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(l==r) <span class="keyword">return</span> H[p].<span class="built_in">pb</span>((Node)&#123;K[l],Y[l]<span class="number">-1ll</span>*K[l]*X[l]&#125;),P[p]=H[p].<span class="built_in">begin</span>(),<span class="built_in">void</span>();</span><br><span class="line">	<span class="type">int</span> mid=(l+r)&gt;&gt;<span class="number">1</span>;</span><br><span class="line">	<span class="built_in">Build</span>(p&lt;&lt;<span class="number">1</span>,l,mid),<span class="built_in">Build</span>(p&lt;&lt;<span class="number">1</span>|<span class="number">1</span>,mid+<span class="number">1</span>,r);</span><br><span class="line">	<span class="type">int</span> p1=<span class="number">0</span>,s1=H[p&lt;&lt;<span class="number">1</span>].<span class="built_in">size</span>(),p2=<span class="number">0</span>,s2=H[p&lt;&lt;<span class="number">1</span>|<span class="number">1</span>].<span class="built_in">size</span>(),R=<span class="number">-1</span>;</span><br><span class="line">	<span class="keyword">auto</span> Ins=[&amp;](Node L) &#123;</span><br><span class="line">		<span class="keyword">while</span>(~R &amp;&amp; H[p][R].b&lt;=L.b) R--,H[p].<span class="built_in">pop_back</span>();</span><br><span class="line">		<span class="keyword">while</span>(R&gt;<span class="number">0</span> &amp;&amp; <span class="built_in">Cross</span>(H[p][R],H[p][R<span class="number">-1</span>])&gt;=<span class="built_in">Cross</span>(H[p][R],L)<span class="number">-1e-8</span>) R--,H[p].<span class="built_in">pop_back</span>();</span><br><span class="line">		H[p].<span class="built_in">pb</span>(L),R++;</span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="keyword">while</span>(p1&lt;s1 || p2&lt;s2) &#123;</span><br><span class="line">		<span class="keyword">if</span>(p1&lt;s1 &amp;&amp; (p2==s2 || H[p&lt;&lt;<span class="number">1</span>][p1]&lt;H[p&lt;&lt;<span class="number">1</span>|<span class="number">1</span>][p2])) <span class="built_in">Ins</span>(H[p&lt;&lt;<span class="number">1</span>][p1++]);</span><br><span class="line">		<span class="keyword">else</span> <span class="built_in">Ins</span>(H[p&lt;&lt;<span class="number">1</span>|<span class="number">1</span>][p2++]);</span><br><span class="line">	&#125;</span><br><span class="line">	P[p]=H[p].<span class="built_in">begin</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">ll <span class="title">Que</span><span class="params">(<span class="type">int</span> p,<span class="type">int</span> x)</span></span>&#123;</span><br><span class="line">	<span class="keyword">while</span>(P[p]+<span class="number">1</span>!=H[p].<span class="built_in">end</span>() &amp;&amp; (*(P[p]+<span class="number">1</span>))[x]&gt;=(*P[p])[x]) P[p]++;</span><br><span class="line">	<span class="keyword">return</span> (*P[p])[x];</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">QueL</span><span class="params">(<span class="type">int</span> p,<span class="type">int</span> l,<span class="type">int</span> r,<span class="type">int</span> x,<span class="type">int</span> qx,<span class="type">int</span> y)</span></span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(x&lt;l || <span class="built_in">Que</span>(p,qx)&lt;=y) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span>(l==r) <span class="keyword">return</span> l;</span><br><span class="line">	<span class="type">int</span> mid=(l+r)&gt;&gt;<span class="number">1</span>,t;</span><br><span class="line">	<span class="keyword">if</span>(x&gt;mid &amp;&amp; (t=<span class="built_in">QueL</span>(p&lt;&lt;<span class="number">1</span>|<span class="number">1</span>,mid+<span class="number">1</span>,r,x,qx,y))) <span class="keyword">return</span> t;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">QueL</span>(p&lt;&lt;<span class="number">1</span>,l,mid,x,qx,y);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">QueR</span><span class="params">(<span class="type">int</span> p,<span class="type">int</span> l,<span class="type">int</span> r,<span class="type">int</span> x,<span class="type">int</span> qx,<span class="type">int</span> y)</span></span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(x&gt;r || <span class="built_in">Que</span>(p,qx)&lt;=y) <span class="keyword">return</span> n+<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">if</span>(l==r) <span class="keyword">return</span> l;</span><br><span class="line">	<span class="type">int</span> mid=(l+r)&gt;&gt;<span class="number">1</span>,t;</span><br><span class="line">	<span class="keyword">if</span>(x&lt;=mid &amp;&amp; (t=<span class="built_in">QueR</span>(p&lt;&lt;<span class="number">1</span>,l,mid,x,qx,y))&lt;=n) <span class="keyword">return</span> t;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">QueR</span>(p&lt;&lt;<span class="number">1</span>|<span class="number">1</span>,mid+<span class="number">1</span>,r,x,qx,y);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	n=<span class="built_in">rd</span>(),m=<span class="built_in">rd</span>();</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">1</span>,n) &#123;</span><br><span class="line">		X[i]=X[i<span class="number">-1</span>]+<span class="built_in">rd</span>(),K[i]=<span class="built_in">rd</span>();</span><br><span class="line">		Y[i]=Y[i<span class="number">-1</span>]+<span class="number">1ll</span>*(X[i]-X[i<span class="number">-1</span>])*K[i];</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">1</span>,m) Q[i].x=<span class="built_in">rd</span>(),Q[i].y=<span class="built_in">rd</span>(),Q[i].id=i;</span><br><span class="line">	<span class="built_in">sort</span>(Q+<span class="number">1</span>,Q+m+<span class="number">1</span>);</span><br><span class="line">	<span class="built_in">Build</span>(<span class="number">1</span>,<span class="number">1</span>,n);</span><br><span class="line">	<span class="type">int</span> p=<span class="number">1</span>;</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">1</span>,m) &#123;</span><br><span class="line">		<span class="keyword">while</span>(p&lt;=n &amp;&amp; X[p]&lt;Q[i].x) p++;</span><br><span class="line">		L[Q[i].id]=<span class="built_in">QueL</span>(<span class="number">1</span>,<span class="number">1</span>,n,p<span class="number">-1</span>,Q[i].x,Q[i].y);</span><br><span class="line">		R[Q[i].id]=<span class="built_in">QueR</span>(<span class="number">1</span>,<span class="number">1</span>,n,p+(X[p]==Q[i].x),Q[i].x,Q[i].y);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">1</span>,m) <span class="built_in">printf</span>(<span class="string">&quot;%d %d\n&quot;</span>,X[L[i]],X[R[i]<span class="number">-1</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://compilationfail.github.io/oi-solutions/ROI%20-%20CEOI%20-%20CCO%20-%20APIO%20-%20Baltic%20OI%20-%20USACO/%E3%80%8CROI%202017%20Day%201%E3%80%8D%E8%99%8E%20/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="orangejuice">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="orangejuice's blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | orangejuice's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/oi-solutions/ROI%20-%20CEOI%20-%20CCO%20-%20APIO%20-%20Baltic%20OI%20-%20USACO/%E3%80%8CROI%202017%20Day%201%E3%80%8D%E8%99%8E%20/" class="post-title-link" itemprop="url">「ROI 2017 Day 1」虎   (计算几何)</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-08-12 00:11:59" itemprop="dateCreated datePublished" datetime="2023-08-12T00:11:59+08:00">2023-08-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-08-17 21:28:48" itemprop="dateModified" datetime="2023-08-17T21:28:48+08:00">2023-08-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/CP-%E9%A2%98%E8%A7%A3/" itemprop="url" rel="index"><span itemprop="name">CP 题解</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="roi-2017-day-1虎-计算几何">「ROI 2017 Day 1」虎 (计算几何)</h1>
<p>题意：（交互题）</p>
<p>已知 <span class="math inline">\(n\)</span> 个点， <span
class="math inline">\(m\)</span>
次询问，每次询问交互器随机生成一个位置的关键点，要求在 <span
class="math inline">\(k\)</span> 次查询中给出一个合法解</p>
<p>查询：一个凸包，返回关键点是否在凸包中</p>
<p>解：一个凸包，包含关键点，且不包含其它点，保证有界</p>
<p>对关键点的包含是包括了边界线的，其它点的包含不包括边界线，凸包均要按照顺时针给出</p>
<h3 id="solution-1-未完全实现">Solution 1 <del>（未完全实现）</del></h3>
<p>先将给定点分层转化为若干凸包，容易通过二分得到关键点所在的层</p>
<p>如果关键点以内不再有凸包，显然得到一个解</p>
<p>否则，一个合法的解一定是在两层凸包中某一层选取两个点，另一层选取一个点得到的三角形</p>
<p>先考虑内层选两个点的情况，令二分边界为内层凸包上点的编号， <span
class="math inline">\(l,r\)</span></p>
<p>考虑实现一个操作，对于 <span class="math inline">\(l,r\)</span>
，找到其连接的直线在顺时针方向上在外层凸包上切到的段</p>
<p>由此得到一个凸包进行查询，即可进行二分，最终 <span
class="math inline">\(l+1=r\)</span>
时，再进行一次上述操作得到一组解（不一定合法）</p>
<p>如果不合法，同理再在外层上二分一次</p>
<p>最终写道第一种情况弃掉了。。。</p>
<p><span class="math display">\[ \ \]</span></p>
<p><span class="math display">\[ \ \]</span></p>
<h3 id="solution2-随机分裂">Solution2 随机分裂</h3>
<p>良好的随机分裂可以跑到max query times&lt;=33的好成绩</p>
<p>考虑一个非常简单的剖开 <span class="math inline">\(n\)</span>
个点的方法：</p>
<p>1.找到这些点的<strong>凸包</strong>，从点集中删掉</p>
<p>2.从剩余点中选择一个作为<strong>中心</strong>，分别与凸包上的点连边，将平面分开</p>
<p>3.确定每个三角形中包含的点，加上三个顶点，继续进行剖分</p>
<p>最终当凸包以外不再有点时，结束</p>
<p><span class="math display">\[ \ \]</span></p>
<p>查询也是比较显然的：</p>
<p>对于当前凸包及其中心，二分找到关键点对应的位置，然后继续进行，直到不存在中心</p>
<p>二分方法：</p>
<p>凸包构成一圈，取一个点为 <span class="math inline">\(l\)</span>
，顺时针180以内的范围最大角度的点为 <span
class="math inline">\(r\)</span> ，每次将中心和 <span
class="math inline">\(l,mid\)</span> 这连续一段查询判断是否包含</p>
<p>这样存在的问题是：可能不在 <span class="math inline">\(l\)</span>
的180范围内，需要在开始二分前判断一下</p>
<p>十分朴素的实现也可以获得90分的好成绩</p>
<p>优化：</p>
<p>每次选取中心时，多随机几次，估价找到一个最优剖分即可</p>
<p><a target="_blank" rel="noopener" href="https://loj.ac/s/1052555">Loj Submission
-包含大量调试语句和内嵌的交互部分</a></p>
<p><a target="_blank" rel="noopener" href="https://loj.ac/s/1053342">Loj Submission</a></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">long</span> <span class="type">long</span> ll;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> ull;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">double</span> db;</span><br><span class="line"><span class="keyword">typedef</span> pair &lt;<span class="type">int</span>,<span class="type">int</span>&gt; Pii;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> reg register</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> mp make_pair</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> pb push_back</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> Mod1(x) ((x&gt;=P)&amp;&amp;(x-=P))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> Mod2(x) ((x&lt;0)&amp;&amp;(x+=P))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> rep(i,a,b) for(int i=a,i##end=b;i&lt;=i##end;++i)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> drep(i,a,b) for(int i=a,i##end=b;i&gt;=i##end;--i)</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt; <span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">cmin</span><span class="params">(T&amp; a,T b)</span></span>&#123; ((a&gt;b)&amp;&amp;(a=b)); &#125;</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt; <span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">cmax</span><span class="params">(T&amp; a,T b)</span></span>&#123; ((a&lt;b)&amp;&amp;(a=b)); &#125;</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> IO;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">rd</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="type">int</span> s=<span class="number">0</span>,f=<span class="number">0</span>;</span><br><span class="line">	<span class="keyword">while</span>(!<span class="built_in">isdigit</span>(IO=<span class="built_in">getchar</span>())) <span class="keyword">if</span>(IO==<span class="string">&#x27;-&#x27;</span>) f=<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">do</span> s=(s&lt;&lt;<span class="number">1</span>)+(s&lt;&lt;<span class="number">3</span>)+(IO^<span class="string">&#x27;0&#x27;</span>);</span><br><span class="line">	<span class="keyword">while</span>(<span class="built_in">isdigit</span>(IO=<span class="built_in">getchar</span>()));</span><br><span class="line">	<span class="keyword">return</span> f?-s:s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">bool</span> Mbe;</span><br><span class="line"><span class="type">const</span> <span class="type">int</span> N=<span class="number">5010</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> n,q;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 计算几何部分</span></span><br><span class="line"><span class="keyword">namespace</span> Geometry&#123;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Node</span>&#123;</span><br><span class="line">	ll x,y;</span><br><span class="line">	<span class="built_in">Node</span>()&#123;&#125;</span><br><span class="line">	<span class="built_in">Node</span>(ll x,ll y):<span class="built_in">x</span>(x),<span class="built_in">y</span>(y)&#123;&#125;</span><br><span class="line">	Node <span class="keyword">operator</span> - (<span class="type">const</span> Node __) <span class="type">const</span> &#123; <span class="keyword">return</span> <span class="built_in">Node</span>(x-__.x,y-__.y); &#125;</span><br><span class="line">	Node <span class="keyword">operator</span> + (<span class="type">const</span> Node __) <span class="type">const</span> &#123; <span class="keyword">return</span> <span class="built_in">Node</span>(x+__.x,y+__.y); &#125;</span><br><span class="line">	ll <span class="keyword">operator</span> ^ (<span class="type">const</span> Node __) <span class="type">const</span> &#123; <span class="keyword">return</span> <span class="number">1ll</span>*x*__.y<span class="number">-1ll</span>*y*__.x; &#125;</span><br><span class="line">	<span class="type">bool</span> <span class="keyword">operator</span> == (<span class="type">const</span> Node __) <span class="type">const</span> &#123; <span class="keyword">return</span> x==__.x &amp;&amp; y==__.y; &#125;</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">Read</span><span class="params">()</span></span>&#123; x=<span class="built_in">rd</span>(),y=<span class="built_in">rd</span>(); &#125;</span><br><span class="line">&#125; A[N],QuePoint;</span><br><span class="line"><span class="keyword">typedef</span> vector &lt;<span class="type">int</span>&gt; V;</span><br><span class="line"><span class="comment">// check close wise</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">chk</span><span class="params">(<span class="type">int</span> i,<span class="type">int</span> j,<span class="type">int</span> k,<span class="type">int</span> bound=<span class="number">0</span>)</span></span>&#123; <span class="keyword">return</span> ((A[k]-A[i])^(A[j]-A[i]))&gt;=bound; &#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">chk</span><span class="params">(Node i,<span class="type">int</span> j,<span class="type">int</span> k,<span class="type">int</span> bound=<span class="number">0</span>)</span></span>&#123; <span class="keyword">return</span> ((A[k]-i)^(A[j]-i))&gt;=bound; &#125;</span><br><span class="line"><span class="comment">// this is clockwise</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">CheckConvex</span><span class="params">(<span class="type">const</span> V &amp;P)</span></span>&#123;</span><br><span class="line">	<span class="type">int</span> n=P.<span class="built_in">size</span>();</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">0</span>,n<span class="number">-1</span>) &#123;</span><br><span class="line">		<span class="type">int</span> j=(i+<span class="number">1</span>)%n,k=(j+<span class="number">1</span>)%n;</span><br><span class="line">		<span class="keyword">if</span>(!<span class="built_in">chk</span>(P[j],P[k],P[i])) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// this is clock-wise</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">CheckIn</span><span class="params">(<span class="type">const</span> V&amp;P,Node X,<span class="type">int</span> bound=<span class="number">0</span>)</span></span>&#123;</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">0</span>,P.<span class="built_in">size</span>()<span class="number">-1</span>) &#123;</span><br><span class="line">		<span class="type">int</span> j=(i+<span class="number">1</span>)%P.<span class="built_in">size</span>();</span><br><span class="line">		<span class="keyword">if</span>(<span class="built_in">chk</span>(X,P[i],P[j],bound)) <span class="keyword">continue</span>;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Check</span><span class="params">(V P)</span></span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(P.<span class="built_in">size</span>()&lt;=<span class="number">2</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;? %llu &quot;</span>,P.<span class="built_in">size</span>());</span><br><span class="line">	<span class="keyword">for</span>(<span class="type">int</span> i:P) <span class="built_in">printf</span>(<span class="string">&quot;%d &quot;</span>,i); </span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">	<span class="built_in">fflush</span>(stdout);</span><br><span class="line">	<span class="type">static</span> <span class="type">char</span> s[<span class="number">5</span>]; <span class="built_in">scanf</span>(<span class="string">&quot;%s&quot;</span>,s);</span><br><span class="line">	<span class="keyword">return</span> *s==<span class="string">&#x27;Y&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Output</span><span class="params">(V P)</span></span>&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;! %llu &quot;</span>,P.<span class="built_in">size</span>());</span><br><span class="line">	<span class="keyword">for</span>(<span class="type">int</span> i:P) <span class="built_in">printf</span>(<span class="string">&quot;%d &quot;</span>,i);</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">	<span class="built_in">fflush</span>(stdout);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">V <span class="title">Convex</span><span class="params">(V P)</span></span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(P.<span class="built_in">size</span>()&lt;=<span class="number">2</span>) <span class="keyword">return</span> P;</span><br><span class="line">	V Ans;</span><br><span class="line">	<span class="type">int</span> n=P.<span class="built_in">size</span>();</span><br><span class="line">	<span class="type">static</span> <span class="type">int</span> I[N],mk[N],S[N],T;</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">0</span>,n<span class="number">-1</span>) mk[I[P[i]]=i]=<span class="number">0</span>;</span><br><span class="line">	<span class="built_in">sort</span>(P.<span class="built_in">begin</span>(),P.<span class="built_in">end</span>(),[&amp;](<span class="type">int</span> x,<span class="type">int</span> y)&#123; <span class="keyword">return</span> A[x].x&lt;A[y].x || (A[x].x==A[y].x &amp;&amp; A[x].y&gt;A[y].y); &#125;);</span><br><span class="line">	T=<span class="number">0</span>;</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">0</span>,n<span class="number">-1</span>) &#123;</span><br><span class="line">		<span class="keyword">while</span>(T&gt;<span class="number">1</span> &amp;&amp; ((A[P[i]]-A[S[T]])^(A[S[T<span class="number">-1</span>]]-A[S[T]]))&gt;<span class="number">0</span> ) T--;</span><br><span class="line">		S[++T]=P[i];</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">1</span>,T) Ans.<span class="built_in">pb</span>(S[i]),mk[I[S[i]]]=<span class="number">1</span>;</span><br><span class="line">	<span class="built_in">sort</span>(P.<span class="built_in">begin</span>(),P.<span class="built_in">end</span>(),[&amp;](<span class="type">int</span> x,<span class="type">int</span> y)&#123; <span class="keyword">return</span> A[x].x&lt;A[y].x || (A[x].x==A[y].x &amp;&amp; A[x].y&lt;A[y].y); &#125;);</span><br><span class="line">	T=<span class="number">0</span>;</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">0</span>,n<span class="number">-1</span>) &#123;</span><br><span class="line">		<span class="keyword">while</span>(T&gt;<span class="number">1</span> &amp;&amp; ((A[P[i]]-A[S[T]])^(A[S[T<span class="number">-1</span>]]-A[S[T]]))&lt;<span class="number">0</span> ) T--;</span><br><span class="line">		S[++T]=P[i];</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">drep</span>(i,T,<span class="number">1</span>) <span class="keyword">if</span>(!mk[I[S[i]]]) Ans.<span class="built_in">pb</span>(S[i]);</span><br><span class="line">	<span class="keyword">return</span> Ans;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> Geometry;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> M=<span class="number">2e5</span>+<span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">V C[M],S[M];</span><br><span class="line"><span class="type">int</span> K[M],D[M],E[M],rt,m,mk[M];</span><br><span class="line"><span class="comment">// 剖分</span></span><br><span class="line"><span class="comment">// C凸包，S子节点</span></span><br><span class="line"><span class="comment">// K中心，D凸包上0号点对应的180范围内的最大点，E凸包上D号点对应180范围内的最大点</span></span><br><span class="line"><span class="comment">// m个数</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Build</span><span class="params">(<span class="type">int</span> &amp;u,V P)</span> </span>&#123;</span><br><span class="line">	<span class="built_in">sort</span>(P.<span class="built_in">begin</span>(),P.<span class="built_in">end</span>());</span><br><span class="line">	<span class="type">int</span> n=P.<span class="built_in">size</span>();</span><br><span class="line">	C[u=++m]=<span class="built_in">Convex</span>(P);</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">0</span>,n<span class="number">-1</span>) mk[i]=<span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span>(C[u].<span class="built_in">size</span>()==P.<span class="built_in">size</span>()) <span class="keyword">return</span>;</span><br><span class="line">	<span class="keyword">for</span>(<span class="type">int</span> i:C[u]) mk[<span class="built_in">lower_bound</span>(P.<span class="built_in">begin</span>(),P.<span class="built_in">end</span>(),i)-P.<span class="built_in">begin</span>()]=<span class="number">1</span>;</span><br><span class="line">	V T; <span class="built_in">rep</span>(i,<span class="number">0</span>,n<span class="number">-1</span>) <span class="keyword">if</span>(!mk[i]) T.<span class="built_in">pb</span>(P[i]);</span><br><span class="line">	n=C[u].<span class="built_in">size</span>();</span><br><span class="line">    <span class="comment">// 获取剖分结果</span></span><br><span class="line">	<span class="keyword">auto</span> Get=[&amp;]() &#123;</span><br><span class="line">		<span class="keyword">if</span>(<span class="built_in">rand</span>()&amp;<span class="number">1</span>) K[u]=T[(T.<span class="built_in">size</span>()/(<span class="built_in">rand</span>()%<span class="number">3</span>+<span class="number">2</span>)+<span class="built_in">rand</span>()%<span class="number">8</span>)%T.<span class="built_in">size</span>()];</span><br><span class="line">		<span class="keyword">else</span> K[u]=T[<span class="built_in">rand</span>()%T.<span class="built_in">size</span>()];</span><br><span class="line">		V P=T; P.<span class="built_in">erase</span>(<span class="built_in">lower_bound</span>(P.<span class="built_in">begin</span>(),P.<span class="built_in">end</span>(),K[u]));</span><br><span class="line">		D[u]=E[u]=<span class="number">0</span>;</span><br><span class="line">		<span class="keyword">while</span>(D[u]&lt;n<span class="number">-1</span> &amp;&amp; <span class="built_in">chk</span>(K[u],C[u][<span class="number">0</span>],C[u][D[u]+<span class="number">1</span>])) D[u]++;</span><br><span class="line">		E[u]=D[u];</span><br><span class="line">		<span class="keyword">while</span>(E[u]&lt;n<span class="number">-1</span> &amp;&amp; <span class="built_in">chk</span>(K[u],C[u][D[u]],C[u][E[u]+<span class="number">1</span>])) E[u]++;</span><br><span class="line">		vector &lt;V&gt; <span class="built_in">ST</span>(n);</span><br><span class="line">		<span class="keyword">for</span>(<span class="type">int</span> x:P) &#123;</span><br><span class="line">			<span class="built_in">rep</span>(i,<span class="number">0</span>,n<span class="number">-1</span>) &#123;</span><br><span class="line">				<span class="keyword">if</span>(<span class="built_in">chk</span>(K[u],C[u][i],x) &amp;&amp; <span class="built_in">chk</span>(K[u],x,C[u][(i+<span class="number">1</span>)%n])) &#123;</span><br><span class="line">					ST[i].<span class="built_in">pb</span>(x);</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">rep</span>(i,<span class="number">0</span>,n<span class="number">-1</span>) ST[i].<span class="built_in">pb</span>(K[u]),ST[i].<span class="built_in">pb</span>(C[u][i]),ST[i].<span class="built_in">pb</span>(C[u][(i+<span class="number">1</span>)%n]);</span><br><span class="line">		<span class="keyword">return</span> ST;</span><br><span class="line">	&#125;;</span><br><span class="line">	vector &lt;V&gt; st;</span><br><span class="line">	<span class="type">int</span> mi=<span class="number">1e9</span>;</span><br><span class="line">	<span class="built_in">rep</span>(kase,<span class="number">1</span>,<span class="number">5</span>) &#123;</span><br><span class="line">		<span class="type">int</span> d=D[u],e=E[u],k=K[u];</span><br><span class="line">		<span class="keyword">auto</span> ST=<span class="built_in">Get</span>();</span><br><span class="line">		<span class="type">int</span> now=<span class="number">0</span>;</span><br><span class="line">		<span class="keyword">for</span>(V j:ST) <span class="built_in">cmax</span>(now,(<span class="type">int</span>)j.<span class="built_in">size</span>());</span><br><span class="line">		<span class="keyword">if</span>(now&gt;mi)&#123; D[u]=d,E[u]=e,K[u]=k; <span class="keyword">continue</span>; &#125;</span><br><span class="line">		st=ST,mi=now;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">0</span>,n<span class="number">-1</span>) &#123;</span><br><span class="line">		<span class="type">int</span> x; <span class="built_in">Build</span>(x,st[i]);</span><br><span class="line">		S[u].<span class="built_in">pb</span>(x);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="function">V <span class="title">T</span><span class="params">(n)</span></span>;</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">0</span>,n<span class="number">-1</span>) T[i]=i+<span class="number">1</span>;</span><br><span class="line">	<span class="built_in">Build</span>(rt,T);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Find</span><span class="params">(<span class="type">int</span> u=rt)</span></span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(!S[u].<span class="built_in">size</span>()) <span class="keyword">return</span> <span class="built_in">Output</span>(C[u]);</span><br><span class="line">	<span class="type">int</span> n=C[u].<span class="built_in">size</span>();</span><br><span class="line">	<span class="type">int</span> l,r;</span><br><span class="line">	<span class="keyword">auto</span> Get=[&amp;](<span class="type">int</span> l,<span class="type">int</span> r) &#123;</span><br><span class="line">		V T; T.<span class="built_in">pb</span>(K[u]);</span><br><span class="line">		l%=n,r%=n;</span><br><span class="line">		<span class="keyword">for</span>(<span class="type">int</span> i=l;;i=(i+<span class="number">1</span>)%n) &#123;</span><br><span class="line">			T.<span class="built_in">pb</span>(C[u][i]);</span><br><span class="line">			<span class="keyword">if</span>(i==r) <span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">Check</span>(T);</span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">Get</span>(<span class="number">0</span>,D[u])) l=<span class="number">0</span>,r=D[u];</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">Get</span>(D[u],E[u])) l=D[u],r=E[u];</span><br><span class="line">	<span class="keyword">else</span> l=E[u],r=n;</span><br><span class="line">	<span class="keyword">while</span>(l+<span class="number">1</span>&lt;r) &#123;</span><br><span class="line">		<span class="type">int</span> mid=(l+r)&gt;&gt;<span class="number">1</span>;</span><br><span class="line">		<span class="keyword">if</span>(<span class="built_in">Get</span>(l,mid)) r=mid;</span><br><span class="line">		<span class="keyword">else</span> l=mid;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">Find</span>(S[u][l]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123; </span><br><span class="line">	n=<span class="built_in">rd</span>();</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">1</span>,n) A[i].<span class="built_in">Read</span>();</span><br><span class="line">	<span class="built_in">Init</span>();</span><br><span class="line">	q=<span class="built_in">rd</span>();</span><br><span class="line">	<span class="built_in">rep</span>(_,<span class="number">1</span>,q) <span class="built_in">Find</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://compilationfail.github.io/oi-solutions/ROI%20-%20CEOI%20-%20CCO%20-%20APIO%20-%20Baltic%20OI%20-%20USACO/%E3%80%8CROI%202016%20Day2%E3%80%8D%E4%BA%8C%E6%8C%87%E7%A6%85/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="orangejuice">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="orangejuice's blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | orangejuice's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/oi-solutions/ROI%20-%20CEOI%20-%20CCO%20-%20APIO%20-%20Baltic%20OI%20-%20USACO/%E3%80%8CROI%202016%20Day2%E3%80%8D%E4%BA%8C%E6%8C%87%E7%A6%85/" class="post-title-link" itemprop="url">「ROI 2016 Day2」二指禅</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-08-12 00:11:59" itemprop="dateCreated datePublished" datetime="2023-08-12T00:11:59+08:00">2023-08-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-08-17 21:28:48" itemprop="dateModified" datetime="2023-08-17T21:28:48+08:00">2023-08-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/CP-%E9%A2%98%E8%A7%A3/" itemprop="url" rel="index"><span itemprop="name">CP 题解</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="roi-2016-day2二指禅">「ROI 2016 Day2」二指禅</h1>
<p>考虑对于每个点，有前缀和后缀两种转移</p>
<p>对于两种转移分别建立 <span class="math inline">\(\text{trie}\)</span>
树，并且维护最小权值，对于 <span class="math inline">\(dp_i\)</span>
，可以匹配一段后缀从 <span class="math inline">\(j&lt;i\)</span>
得到</p>
<p>也可以匹配一段前缀更新 <span class="math inline">\(j&gt;i\)</span>
，分别 <span class="math inline">\(O(n)\)</span>
枚举在两棵树上匹配即可完成转移</p>
<p>暴力转移复杂度为 <span class="math inline">\(O(n^2)\)</span></p>
<p>考虑优化转移效率，以 <span class="math inline">\(dp_i\)</span>
匹配某一段前缀向 <span class="math inline">\(dp_j(j&gt;i)\)</span>
转移为例</p>
<h3 id="part1-考虑求出最大的-j">Part1 考虑求出最大的 <span
class="math inline">\(j\)</span></h3>
<p>这个问题实际上就是求出每一个后缀的最大前缀匹配，也就是一个 <span
class="math inline">\(\text{exkmp}\)</span> 问题</p>
<p>而且这题是一个多模板串版本，并不能用 <span
class="math inline">\(\text{exkmp}\)</span> 解决</p>
<h4 id="solution-1">Solution 1</h4>
<p>是把所有前缀hash值取出来，放到 <span
class="math inline">\(\text{hash_table}\)</span> 里，然后二分长度+ <span
class="math inline">\(\text{hash_table}\)</span> 查询，复杂度为 <span
class="math inline">\(O(\log L)\)</span></p>
<h4 id="solution-2">Solution 2</h4>
<p>树剖+hash</p>
<p>对于 <span class="math inline">\(\text{trie}\)</span>
树树剖并且预处理hash值，重链上二分hash匹配，轻儿子暴力走，复杂度为 <span
class="math inline">\(O(\log ^2L)\)</span></p>
<p>如果使用全局平衡二叉树，可以做到单次查询复杂度为 <span
class="math inline">\(O(\log L)\)</span> ，常数应该远小于 <span
class="math inline">\(\text{hash_table}\)</span></p>
<p><span class="math display">\[ \ \]</span></p>
<p><span class="math display">\[ \ \]</span></p>
<h3 id="part2-在-j_max-基础上转移">Part2 在 <span
class="math inline">\(j_{max}\)</span> 基础上转移</h3>
<p>考虑先求出最大的 <span class="math inline">\(j\)</span>
之后，得到其对应的 <span class="math inline">\(\text{trie}\)</span>
树节点 <span class="math inline">\(u\)</span> ，在的祖先 <span
class="math inline">\(u\)</span> 中，每一种不同的权值更新一次</p>
<p>显然每一个祖先长度不同，因此最多只有 <span
class="math inline">\(O(\sqrt L)\)</span> 中不同的权值</p>
<p>因此可以for过去更新每一种权值，每次更新是一段区间，可以用树状数组维护</p>
<p>但是实际上极限情况下段极短，可以暴力枚举区间，所以并不是真的 <span
class="math inline">\(O(\sqrt L\log L)\)</span></p>
<p>比较容易说明复杂度的优化方法是：</p>
<p>采用分块 <span class="math inline">\(O(1)\)</span> 更新， <span
class="math inline">\(O(\sqrt L)\)</span> 查询</p>
<p>这样可以做到稳定 <span class="math inline">\(O(\sqrt L)\)</span>
完成转移</p>
<p><span class="math display">\[\ \]</span></p>
<p>因此预处理复杂度为 <span class="math inline">\(O(m\log L-m\log
^2L)\)</span> ，转移复杂度为 <span class="math inline">\(O(m\sqrt
L-m\sqrt L\log L)\)</span></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">long</span> <span class="type">long</span> ll;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> rep(i,a,b) for(int i=a,i##end=b;i&lt;=i##end;++i)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> drep(i,a,b) for(int i=a,i##end=b;i&gt;=i##end;--i)</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt; <span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">cmin</span><span class="params">(T &amp;a,T b)</span></span>&#123; ((a&gt;b)&amp;&amp;(a=b)); &#125;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> N=<span class="number">3e5</span>+<span class="number">10</span>,INF=<span class="number">1e9</span>+<span class="number">10</span>,D=<span class="number">6</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> n,m;</span><br><span class="line"><span class="type">char</span> T[N];</span><br><span class="line"><span class="type">int</span> Pow1[N],Pow2[N];</span><br><span class="line"><span class="type">int</span> S[N];</span><br><span class="line"><span class="type">const</span> ll K1=<span class="number">19260817</span>,P1=<span class="number">114514</span>;</span><br><span class="line"><span class="type">const</span> ll K2=<span class="number">1e9</span>+<span class="number">13</span>,P2=<span class="number">1919810</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Solver</span>&#123;</span><br><span class="line">    <span class="type">int</span> S[N];</span><br><span class="line">    <span class="type">int</span> trie[N][<span class="number">2</span>],s[N],cnt,H1[N],H2[N];</span><br><span class="line">    <span class="type">int</span> fa[N],top[N],sz[N],h1[N],h2[N],son[N],lst[N],bot[N],L[N],id[N],dfn,dep[N];</span><br><span class="line">    <span class="comment">// lst[i] 记录祖先中第一个s[f]!=s[i]的节点</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">dfs</span><span class="params">(<span class="type">int</span> u)</span></span>&#123;</span><br><span class="line">        sz[u]=<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span>(s[u]==s[fa[u]]) lst[u]=lst[fa[u]];</span><br><span class="line">        <span class="keyword">else</span> lst[u]=fa[u];</span><br><span class="line">        <span class="built_in">rep</span>(i,<span class="number">0</span>,<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="type">int</span> v=trie[u][i];</span><br><span class="line">            <span class="keyword">if</span>(!v) <span class="keyword">continue</span>;</span><br><span class="line">            fa[v]=u,dep[v]=dep[u]+<span class="number">1</span>;</span><br><span class="line">            h1[v]=(h1[u]*K1+i+<span class="number">1</span>)%P1;</span><br><span class="line">            h2[v]=(h2[u]*K2+i+<span class="number">1</span>)%P2;</span><br><span class="line">            <span class="built_in">dfs</span>(v);</span><br><span class="line">            sz[u]+=sz[v];</span><br><span class="line">            <span class="keyword">if</span>(son[u]==<span class="number">0</span> || sz[v]&gt;sz[son[u]]) son[u]=v;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">dfs</span><span class="params">(<span class="type">int</span> u,<span class="type">int</span> t)</span></span>&#123;</span><br><span class="line">        id[L[u]=++dfn]=u;</span><br><span class="line">        bot[top[u]=t]=u; <span class="keyword">if</span>(son[u]) <span class="built_in">dfs</span>(son[u],t);</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> v:trie[u]) <span class="keyword">if</span>(v&amp;&amp;v!=son[u]) <span class="built_in">dfs</span>(v,v);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Ins</span><span class="params">(<span class="type">char</span> *T,<span class="type">int</span> l,<span class="type">int</span> w)</span></span>&#123;</span><br><span class="line">        <span class="type">int</span> now=<span class="number">0</span>;</span><br><span class="line">        <span class="built_in">rep</span>(i,<span class="number">1</span>,l) &#123;</span><br><span class="line">            <span class="type">int</span> c=T[i]-<span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">            <span class="keyword">if</span>(!trie[now][c]) s[trie[now][c]=++cnt]=<span class="number">2e9</span>;</span><br><span class="line">            <span class="built_in">cmin</span>(s[now=trie[now][c]],w);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Init</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="built_in">rep</span>(i,<span class="number">1</span>,n) &#123;</span><br><span class="line">            H1[i]=(H1[i<span class="number">-1</span>]*K1+S[i]+<span class="number">1</span>)%P1;</span><br><span class="line">            H2[i]=(H2[i<span class="number">-1</span>]*K2+S[i]+<span class="number">1</span>)%P2;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">dfs</span>(<span class="number">0</span>),<span class="built_in">dfs</span>(<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">Que</span><span class="params">(<span class="type">int</span> i)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 求i 的最长匹配位置</span></span><br><span class="line">        <span class="type">int</span> u=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>(i&lt;=n) &#123;</span><br><span class="line">            <span class="keyword">if</span>(!trie[u][S[i]]) <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">if</span>(trie[u][S[i]]!=son[u])&#123; u=trie[u][S[i++]]; <span class="keyword">continue</span>; &#125;</span><br><span class="line">            <span class="type">int</span> l=<span class="number">1</span>,r=<span class="built_in">min</span>(n-i+<span class="number">1</span>,dep[bot[top[u]]]-dep[u]),res=<span class="number">1</span>;</span><br><span class="line">            <span class="keyword">while</span>(l&lt;=r)&#123;</span><br><span class="line">                <span class="type">int</span> mid=(l+r)&gt;&gt;<span class="number">1</span>;</span><br><span class="line">                <span class="keyword">if</span>( (H1[i+mid<span class="number">-1</span>]<span class="number">-1ll</span>*H1[i<span class="number">-1</span>]*Pow1[mid]%P1+P1)%P1 ==  (h1[id[L[u]+mid]]<span class="number">-1ll</span>*h1[u]*Pow1[mid]%P1+P1)%P1 &amp;&amp;</span><br><span class="line">                        (H2[i+mid<span class="number">-1</span>]<span class="number">-1ll</span>*H2[i<span class="number">-1</span>]*Pow2[mid]%P2+P2)%P2 == (h2[id[L[u]+mid]]<span class="number">-1ll</span>*h2[u]*Pow2[mid]%P2+P2)%P2)</span><br><span class="line">                    l=mid+<span class="number">1</span>,res=mid;</span><br><span class="line">                <span class="keyword">else</span> r=mid<span class="number">-1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            i+=res,u=id[L[u]+res];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> u;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; X,Y;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">BIT</span>&#123;</span><br><span class="line">    ll s[N];</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Init</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="built_in">memset</span>(s,<span class="number">127</span>,<span class="keyword">sizeof</span> s);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Add</span><span class="params">(<span class="type">int</span> p,ll x)</span></span>&#123;</span><br><span class="line">        <span class="keyword">while</span>(p) <span class="built_in">cmin</span>(s[p],x),p-=p&amp;-p;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">ll <span class="title">Que</span><span class="params">(<span class="type">int</span> p)</span></span>&#123;</span><br><span class="line">        ll res=<span class="number">1e18</span>;</span><br><span class="line">        <span class="keyword">while</span>(p&lt;=n) <span class="built_in">cmin</span>(res,s[p]),p+=p&amp;-p;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; TX,TY;</span><br><span class="line">ll dp[N];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">rep</span>(i,Pow1[<span class="number">0</span>]=Pow2[<span class="number">0</span>]=<span class="number">1</span>,N<span class="number">-1</span>) &#123;</span><br><span class="line">        Pow1[i]=Pow1[i<span class="number">-1</span>]*K1%P1;</span><br><span class="line">        Pow2[i]=Pow2[i<span class="number">-1</span>]*K2%P2;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d%d%*d&quot;</span>,&amp;n,&amp;m);</span><br><span class="line">    <span class="built_in">rep</span>(i,<span class="number">1</span>,n) <span class="built_in">scanf</span>(<span class="string">&quot;%1d&quot;</span>,S+i),X.S[i]=Y.S[n-i+<span class="number">1</span>]=S[i];</span><br><span class="line">    <span class="built_in">rep</span>(t,<span class="number">1</span>,m) &#123;</span><br><span class="line">        <span class="type">int</span> w,l; <span class="built_in">scanf</span>(<span class="string">&quot;%d%s&quot;</span>,&amp;w,T+<span class="number">1</span>),l=<span class="built_in">strlen</span>(T+<span class="number">1</span>);</span><br><span class="line">        X.<span class="built_in">Ins</span>(T,l,w),<span class="built_in">reverse</span>(T+<span class="number">1</span>,T+l+<span class="number">1</span>),Y.<span class="built_in">Ins</span>(T,l,w);</span><br><span class="line">    &#125;</span><br><span class="line">    X.<span class="built_in">Init</span>(),Y.<span class="built_in">Init</span>();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">rep</span>(i,<span class="number">1</span>,n) dp[i]=<span class="number">1e18</span>;</span><br><span class="line">    TX.<span class="built_in">Init</span>(),TY.<span class="built_in">Init</span>();</span><br><span class="line">    TY.<span class="built_in">Add</span>(<span class="number">1</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="built_in">rep</span>(i,<span class="number">0</span>,n) &#123;</span><br><span class="line">        <span class="comment">// 暴力维护转移</span></span><br><span class="line">        <span class="keyword">if</span>(i) &#123;</span><br><span class="line">            <span class="built_in">cmin</span>(dp[i],TX.<span class="built_in">Que</span>(i));</span><br><span class="line">            <span class="type">int</span> u=Y.<span class="built_in">Que</span>(n-i+<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">while</span>(u) &#123;</span><br><span class="line">                <span class="type">int</span> l=Y.dep[Y.lst[u]]+<span class="number">1</span>,r=Y.dep[u];</span><br><span class="line">                <span class="keyword">if</span>(r-l+<span class="number">1</span>&lt;=D) <span class="built_in">rep</span>(j,l,r) <span class="built_in">cmin</span>(dp[i],dp[i-j]+Y.s[u]);</span><br><span class="line">                <span class="keyword">else</span> <span class="built_in">cmin</span>(dp[i],TY.<span class="built_in">Que</span>(i-r+<span class="number">1</span>)+Y.s[u]);</span><br><span class="line">                u=Y.lst[u];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        TY.<span class="built_in">Add</span>(i+<span class="number">1</span>,dp[i]);</span><br><span class="line">        <span class="keyword">if</span>(i==n||dp[i]==<span class="number">1e18</span>) <span class="keyword">continue</span>;</span><br><span class="line">        <span class="type">int</span> u=X.<span class="built_in">Que</span>(i+<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">while</span>(u) &#123;</span><br><span class="line">            <span class="type">int</span> l=X.dep[X.lst[u]]+<span class="number">1</span>,r=X.dep[u];</span><br><span class="line">            <span class="keyword">if</span>(r-l+<span class="number">1</span>&lt;=D) <span class="built_in">rep</span>(j,l,r) <span class="built_in">cmin</span>(dp[i+j],dp[i]+X.s[u]);</span><br><span class="line">            <span class="keyword">else</span> TX.<span class="built_in">Add</span>(i+r,dp[i]+X.s[u]);</span><br><span class="line">            u=X.lst[u];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%lld\n&quot;</span>,dp[n]&lt;<span class="number">1e18</span>?dp[n]:<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://compilationfail.github.io/oi-solutions/ROI%20-%20CEOI%20-%20CCO%20-%20APIO%20-%20Baltic%20OI%20-%20USACO/%E3%80%8CROI%202018%20Day%201%E3%80%8D%E9%87%8F%E5%AD%90%E9%9A%90%E5%BD%A2%E4%BC%A0%E6%80%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="orangejuice">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="orangejuice's blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | orangejuice's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/oi-solutions/ROI%20-%20CEOI%20-%20CCO%20-%20APIO%20-%20Baltic%20OI%20-%20USACO/%E3%80%8CROI%202018%20Day%201%E3%80%8D%E9%87%8F%E5%AD%90%E9%9A%90%E5%BD%A2%E4%BC%A0%E6%80%81/" class="post-title-link" itemprop="url">「ROI 2018 Day 1」量子隐形传态</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-08-12 00:11:59" itemprop="dateCreated datePublished" datetime="2023-08-12T00:11:59+08:00">2023-08-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-08-17 21:28:48" itemprop="dateModified" datetime="2023-08-17T21:28:48+08:00">2023-08-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/CP-%E9%A2%98%E8%A7%A3/" itemprop="url" rel="index"><span itemprop="name">CP 题解</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="roi-2018-day-1量子隐形传态">「ROI 2018 Day 1」量子隐形传态</h1>
<p>题目大意：</p>
<p>在 <span class="math inline">\(N\times M\)</span> 的网格上给定 <span
class="math inline">\(K\)</span> 个点 <span
class="math inline">\(1\ldots K\)</span> ，定义两点间的距离为 <span
class="math inline">\(\displaystyle
2^{\max\{|x_i-x_j|,|y_i-y_j|\}}\)</span></p>
<p><span class="math inline">\(N,M,K\leq 10^4\)</span> ，求 <span
class="math inline">\(1\)</span> 到 <span
class="math inline">\(k\)</span> 的最短路，下文认为 <span
class="math inline">\(N,M\)</span> 同阶</p>
<h3 id="如何存储距离">如何存储距离</h3>
<p>显然距离是一个不超过 <span class="math inline">\(10^4\)</span>
位的二进制数，用 <span class="math inline">\(\text{bitset}\)</span>
存下来</p>
<p>每一次转移需要维护一个位+1操作，比较大小操作，都可以 <span
class="math inline">\(O(\frac{N}{w})\)</span> 实现，其中 <span
class="math inline">\(\text{w}\)</span> 为压位数</p>
<p><span class="math display">\[ \ \]</span></p>
<h3 id="lemma">Lemma:</h3>
<p>对于点 <span class="math inline">\(A(x,y)\)</span> ，将平面分为 <span
class="math inline">\(8\)</span> 个部分</p>
<figure>
<img src="https://i.loli.net/2021/02/16/ucKdVED4bmHfoSF.png"
alt="Snipaste_2021-02-16_08-28-24.png" />
<figcaption
aria-hidden="true">Snipaste_2021-02-16_08-28-24.png</figcaption>
</figure>
<p>注意对于 <span class="math inline">\(x&#39;=x\)</span> 或者 <span
class="math inline">\(y&#39;=y\)</span> 的区域一定要分离</p>
<p>则有：在任意一个平面区域中，有效的转移点一定是距离 <span
class="math inline">\((x,y)\)</span> 最近的点</p>
<p>简要证明：</p>
<p>对于 <span class="math inline">\(A\)</span>
来说，切比雪夫距离相同的的点构成一条带</p>
<figure>
<img src="https://i.loli.net/2021/02/16/BM6JbDVQChpg3Al.png"
alt="Snipaste_2021-02-16_08-39-07.png" />
<figcaption
aria-hidden="true">Snipaste_2021-02-16_08-39-07.png</figcaption>
</figure>
<p>设最近的点为 <span class="math inline">\(B\)</span>
，那么对于任意一个其它点 <span class="math inline">\(C\)</span> ，显然有
<span
class="math inline">\(dis(A,C)&gt;dis(B,C),dis(A,C)&gt;dis(A,B)\)</span></p>
<p>故走 <span class="math inline">\(A\rightarrow B\rightarrow C\)</span>
不劣</p>
<h3 id="快速完成转移">快速完成转移</h3>
<p>这样的 <span class="math inline">\(B\)</span>
显然不唯一存在，每次转移需要的是 <span
class="math inline">\(\text{L}\)</span> 形的段</p>
<p>故可以对于每行每列用线段树优化区间连边</p>
<p>故得到一个 <span class="math inline">\(O(K)\)</span> 点数， <span
class="math inline">\(O(K\log K)\)</span> 边数的图</p>
<p>用 <span class="math inline">\(\text{Dijkstra}\)</span>
完成最短路，复杂度为 <span class="math inline">\(O(K\log ^2
K\frac{N}{W})\)</span></p>
<p>ps: 这里没有考虑找到最近点的过程 ，下面的代码是直接暴力找的。。。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> ull;</span><br><span class="line"><span class="keyword">typedef</span> pair &lt;<span class="type">int</span>,<span class="type">int</span>&gt; Pii;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> reg register</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> pb push_back</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> mp make_pair</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> rep(i,a,b) for(int i=a,i##end=b;i&lt;=i##end;++i)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> drep(i,a,b) for(int i=a,i##end=b;i&gt;=i##end;--i)</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt; <span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">cmin</span><span class="params">(T &amp;a,<span class="type">const</span> T &amp;b)</span></span>&#123; ((a&gt;b)&amp;&amp;(a=b)); &#125;</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt; <span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">cmax</span><span class="params">(T &amp;a,<span class="type">const</span> T &amp;b)</span></span>&#123; ((a&lt;b)&amp;&amp;(a=b)); &#125;</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> IO;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">rd</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="type">int</span> s=<span class="number">0</span>;</span><br><span class="line">	<span class="keyword">while</span>(!<span class="built_in">isdigit</span>(IO=<span class="built_in">getchar</span>()));</span><br><span class="line">	<span class="keyword">do</span> s=(s&lt;&lt;<span class="number">1</span>)+(s&lt;&lt;<span class="number">3</span>)+(IO^<span class="string">&#x27;0&#x27;</span>);</span><br><span class="line">	<span class="keyword">while</span>(<span class="built_in">isdigit</span>(IO=<span class="built_in">getchar</span>()));</span><br><span class="line">	<span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> N=<span class="number">30011</span>,INF=<span class="number">1e9</span>+<span class="number">10</span>,U=<span class="number">10000</span>,D=<span class="number">6</span>;</span><br><span class="line"><span class="type">bool</span> Mbe;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> n,m,k;</span><br><span class="line"><span class="type">int</span> X[N],Y[N],pre[N],vis[N];</span><br><span class="line">vector &lt;Pii&gt; E[N];</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> ull;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Bitset</span>&#123;</span><br><span class="line">	ull a[N/<span class="number">64</span>+<span class="number">10</span>];</span><br><span class="line">	<span class="type">int</span> l;</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">Add</span><span class="params">(<span class="type">int</span> x)</span></span>&#123;</span><br><span class="line">		<span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">			ull t=a[x&gt;&gt;D];</span><br><span class="line">			a[x&gt;&gt;D]+=<span class="number">1ull</span>&lt;&lt;(x&amp;<span class="number">63</span>);</span><br><span class="line">			<span class="keyword">if</span>(t&gt;a[x&gt;&gt;D]) x=((x&gt;&gt;D)+<span class="number">1</span>)&lt;&lt;D;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">cmax</span>(l,((x&gt;&gt;D)&lt;&lt;D)+<span class="number">63</span>-__builtin_clzll(a[x&gt;&gt;D]));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="type">bool</span> <span class="keyword">operator</span> &lt; (<span class="type">const</span> Bitset &amp;__) <span class="type">const</span> &#123;</span><br><span class="line">		<span class="keyword">if</span>(__.l&gt;<span class="number">10009</span>) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">		<span class="keyword">if</span>(l!=__.l) <span class="keyword">return</span> l&lt;__.l;</span><br><span class="line">		<span class="built_in">drep</span>(i,(l&gt;&gt;D)+<span class="number">1</span>,<span class="number">0</span>) <span class="keyword">if</span>(a[i]!=__.a[i]) <span class="keyword">return</span> a[i]&lt;__.a[i];</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125; dis[N];</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Queue</span>&#123;</span><br><span class="line">	<span class="type">int</span> s[N&lt;&lt;<span class="number">2</span>],bit;</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">Up</span><span class="params">(<span class="type">int</span> p)</span> </span>&#123; s[p]=dis[s[p&lt;&lt;<span class="number">1</span>]]&lt;dis[s[p&lt;&lt;<span class="number">1</span>|<span class="number">1</span>]]?s[p&lt;&lt;<span class="number">1</span>]:s[p&lt;&lt;<span class="number">1</span>|<span class="number">1</span>]; &#125;</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">Build</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">for</span>(bit=<span class="number">1</span>;bit&lt;=n+<span class="number">1</span>;bit&lt;&lt;=<span class="number">1</span>);</span><br><span class="line">		s[bit+<span class="number">1</span>]=<span class="number">1</span>;</span><br><span class="line">		<span class="keyword">for</span>(<span class="type">int</span> p=bit+<span class="number">1</span>;p;p&gt;&gt;=<span class="number">1</span>) s[p]=<span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">push</span><span class="params">(<span class="type">int</span> p)</span> </span>&#123; <span class="keyword">for</span>(s[p+bit]=p,p+=bit;p&gt;&gt;=<span class="number">1</span>;) <span class="built_in">Up</span>(p); &#125;</span><br><span class="line">	<span class="function"><span class="type">int</span> <span class="title">top</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="type">int</span> res=s[<span class="number">1</span>],p=s[<span class="number">1</span>];</span><br><span class="line">		<span class="keyword">for</span>(s[p+=bit]=<span class="number">0</span>;p&gt;&gt;=<span class="number">1</span>;) <span class="built_in">Up</span>(p);</span><br><span class="line">		<span class="keyword">return</span> res;</span><br><span class="line">	&#125;</span><br><span class="line">&#125; que;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Dis</span><span class="params">(<span class="type">int</span> x,<span class="type">int</span> y)</span> </span>&#123; <span class="keyword">return</span> <span class="built_in">max</span>(<span class="built_in">abs</span>(X[x]-X[y]),<span class="built_in">abs</span>(Y[x]-Y[y])); &#125;</span><br><span class="line"><span class="type">int</span> Ans[N],Ac;</span><br><span class="line"><span class="type">int</span> Min[N][<span class="number">8</span>];</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Dir</span><span class="params">(<span class="type">int</span> u,<span class="type">int</span> v)</span></span>&#123;</span><br><span class="line">	<span class="type">int</span> x=X[v]-X[u],y=Y[v]-Y[u];</span><br><span class="line">	<span class="keyword">if</span>(y==<span class="number">0</span>) <span class="keyword">return</span> x&gt;<span class="number">0</span>?<span class="number">0</span>:<span class="number">4</span>;</span><br><span class="line">	<span class="keyword">if</span>(y&gt;<span class="number">0</span>) <span class="keyword">return</span> x==<span class="number">0</span>?<span class="number">2</span>:(x&gt;<span class="number">0</span>?<span class="number">1</span>:<span class="number">3</span>);</span><br><span class="line">	<span class="keyword">return</span> x==<span class="number">0</span>?<span class="number">6</span>:(x&gt;<span class="number">0</span>?<span class="number">7</span>:<span class="number">5</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> vector &lt;<span class="type">int</span>&gt; V;</span><br><span class="line">V A[N],B[N];</span><br><span class="line"><span class="type">int</span> rtx[N],rty[N],ls[N],rs[N];</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Build</span><span class="params">(<span class="type">const</span> V &amp;vec,<span class="type">int</span> l,<span class="type">int</span> r)</span></span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(l==r) <span class="keyword">return</span> vec[l];</span><br><span class="line">	<span class="type">int</span> mid=(l+r)&gt;&gt;<span class="number">1</span>,u=++n;</span><br><span class="line">	ls[u]=<span class="built_in">Build</span>(vec,l,mid),rs[u]=<span class="built_in">Build</span>(vec,mid+<span class="number">1</span>,r);</span><br><span class="line">	E[u].<span class="built_in">pb</span>(<span class="built_in">mp</span>(ls[u],<span class="number">-1</span>)),E[u].<span class="built_in">pb</span>(<span class="built_in">mp</span>(rs[u],<span class="number">-1</span>));</span><br><span class="line">	<span class="keyword">return</span> u;</span><br><span class="line">&#125;</span><br><span class="line">V Res;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Que</span><span class="params">(<span class="type">const</span> V &amp;vec,<span class="type">int</span> p,<span class="type">int</span> l,<span class="type">int</span> r,<span class="type">int</span> ql,<span class="type">int</span> qr)</span></span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(!p) <span class="keyword">return</span>;</span><br><span class="line">	<span class="keyword">if</span>(ql&lt;=vec[l] &amp;&amp; vec[r]&lt;=qr) <span class="keyword">return</span> Res.<span class="built_in">pb</span>(p);</span><br><span class="line">	<span class="type">int</span> mid=(l+r)&gt;&gt;<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">if</span>(ql&lt;=vec[mid]) <span class="built_in">Que</span>(vec,ls[p],l,mid,ql,qr);</span><br><span class="line">	<span class="keyword">if</span>(qr&gt;=vec[mid+<span class="number">1</span>]) <span class="built_in">Que</span>(vec,rs[p],mid+<span class="number">1</span>,r,ql,qr);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">AddX</span><span class="params">(<span class="type">int</span> u,<span class="type">int</span> x,<span class="type">int</span> l,<span class="type">int</span> r)</span></span>&#123;</span><br><span class="line">	<span class="type">int</span> d=<span class="built_in">abs</span>(x-X[u]);</span><br><span class="line">	<span class="keyword">if</span>(rtx[x]) <span class="built_in">Que</span>(A[x],rtx[x],<span class="number">0</span>,A[x].<span class="built_in">size</span>()<span class="number">-1</span>,l,r);</span><br><span class="line">	<span class="keyword">for</span>(<span class="type">int</span> v:Res) &#123;</span><br><span class="line">		E[u].<span class="built_in">pb</span>(<span class="built_in">mp</span>(v,d));</span><br><span class="line">	&#125;</span><br><span class="line">	Res.<span class="built_in">clear</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">AddY</span><span class="params">(<span class="type">int</span> u,<span class="type">int</span> y,<span class="type">int</span> l,<span class="type">int</span> r)</span></span>&#123;</span><br><span class="line">	<span class="type">int</span> d=<span class="built_in">abs</span>(y-Y[u]);</span><br><span class="line">	<span class="keyword">if</span>(rty[y]) <span class="built_in">Que</span>(B[y],rty[y],<span class="number">0</span>,B[y].<span class="built_in">size</span>()<span class="number">-1</span>,l,r);</span><br><span class="line">	<span class="keyword">for</span>(<span class="type">int</span> v:Res) &#123;</span><br><span class="line">		E[u].<span class="built_in">pb</span>(<span class="built_in">mp</span>(v,d));</span><br><span class="line">	&#125;</span><br><span class="line">	Res.<span class="built_in">clear</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Init</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">1</span>,k) A[X[i]].<span class="built_in">pb</span>(i),B[Y[i]].<span class="built_in">pb</span>(i);</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">1</span>,U) &#123;</span><br><span class="line">		<span class="keyword">if</span>(A[i].<span class="built_in">size</span>()) &#123;</span><br><span class="line">			<span class="built_in">sort</span>(A[i].<span class="built_in">begin</span>(),A[i].<span class="built_in">end</span>(),[&amp;](<span class="type">int</span> x,<span class="type">int</span> y)&#123; <span class="keyword">return</span> Y[x]&lt;Y[y]; &#125;);</span><br><span class="line">			rtx[i]=<span class="built_in">Build</span>(A[i],<span class="number">0</span>,A[i].<span class="built_in">size</span>()<span class="number">-1</span>);</span><br><span class="line">			<span class="keyword">for</span>(<span class="type">int</span> &amp;j:A[i]) j=Y[j];</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>(B[i].<span class="built_in">size</span>()) &#123;</span><br><span class="line">			<span class="built_in">sort</span>(B[i].<span class="built_in">begin</span>(),B[i].<span class="built_in">end</span>(),[&amp;](<span class="type">int</span> x,<span class="type">int</span> y)&#123; <span class="keyword">return</span> X[x]&lt;X[y]; &#125;);</span><br><span class="line">			rty[i]=<span class="built_in">Build</span>(B[i],<span class="number">0</span>,B[i].<span class="built_in">size</span>()<span class="number">-1</span>);</span><br><span class="line">			<span class="keyword">for</span>(<span class="type">int</span> &amp;j:B[i]) j=X[j];</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">1</span>,k) <span class="built_in">rep</span>(j,<span class="number">0</span>,<span class="number">7</span>) Min[i][j]=INF;</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">1</span>,k) <span class="built_in">rep</span>(j,i+<span class="number">1</span>,k)&#123;</span><br><span class="line">		<span class="type">int</span> d=<span class="built_in">Dir</span>(i,j),dis=<span class="built_in">Dis</span>(i,j);</span><br><span class="line">		<span class="built_in">cmin</span>(Min[i][d],dis);</span><br><span class="line">		<span class="built_in">cmin</span>(Min[j][(d+<span class="number">4</span>)&amp;<span class="number">7</span>],dis);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">1</span>,k) &#123;</span><br><span class="line">		<span class="keyword">if</span>(Min[i][<span class="number">0</span>]!=INF) <span class="built_in">AddX</span>(i,X[i]+Min[i][<span class="number">0</span>],Y[i],Y[i]);</span><br><span class="line">		<span class="keyword">if</span>(Min[i][<span class="number">1</span>]!=INF) &#123;</span><br><span class="line">			<span class="built_in">AddX</span>(i,X[i]+Min[i][<span class="number">1</span>],Y[i]+<span class="number">1</span>,Y[i]+Min[i][<span class="number">1</span>]);</span><br><span class="line">			<span class="built_in">AddY</span>(i,Y[i]+Min[i][<span class="number">1</span>],X[i]+<span class="number">1</span>,X[i]+Min[i][<span class="number">1</span>]);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>(Min[i][<span class="number">2</span>]!=INF) <span class="built_in">AddY</span>(i,Y[i]+Min[i][<span class="number">2</span>],X[i],X[i]);</span><br><span class="line">		<span class="keyword">if</span>(Min[i][<span class="number">3</span>]!=INF) &#123;</span><br><span class="line">			<span class="built_in">AddX</span>(i,X[i]-Min[i][<span class="number">3</span>],Y[i]+<span class="number">1</span>,Y[i]+Min[i][<span class="number">3</span>]);</span><br><span class="line">			<span class="built_in">AddY</span>(i,Y[i]+Min[i][<span class="number">3</span>],X[i]-Min[i][<span class="number">3</span>],X[i]<span class="number">-1</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>(Min[i][<span class="number">4</span>]!=INF) <span class="built_in">AddX</span>(i,X[i]-Min[i][<span class="number">4</span>],Y[i],Y[i]);</span><br><span class="line">		<span class="keyword">if</span>(Min[i][<span class="number">5</span>]!=INF) &#123;</span><br><span class="line">			<span class="built_in">AddX</span>(i,X[i]-Min[i][<span class="number">5</span>],Y[i]-Min[i][<span class="number">5</span>],Y[i]<span class="number">-1</span>);</span><br><span class="line">			<span class="built_in">AddY</span>(i,Y[i]-Min[i][<span class="number">5</span>],X[i]-Min[i][<span class="number">5</span>],X[i]<span class="number">-1</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>(Min[i][<span class="number">6</span>]!=INF) <span class="built_in">AddY</span>(i,Y[i]-Min[i][<span class="number">6</span>],X[i],X[i]);</span><br><span class="line">		<span class="keyword">if</span>(Min[i][<span class="number">7</span>]!=INF) &#123;</span><br><span class="line">			<span class="built_in">AddX</span>(i,X[i]+Min[i][<span class="number">7</span>],Y[i]-Min[i][<span class="number">7</span>],Y[i]<span class="number">-1</span>);</span><br><span class="line">			<span class="built_in">AddY</span>(i,Y[i]-Min[i][<span class="number">7</span>],X[i]+<span class="number">1</span>,X[i]+Min[i][<span class="number">7</span>]);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">bool</span> Med;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="built_in">fprintf</span>(stderr,<span class="string">&quot;%.2lf\n&quot;</span>,(&amp;Med-&amp;Mbe)/<span class="number">1024.0</span>/<span class="number">1024.0</span>);</span><br><span class="line">	n=<span class="built_in">rd</span>(),m=<span class="built_in">rd</span>(),k=<span class="built_in">rd</span>(),n=k;</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">1</span>,k) X[i]=<span class="built_in">rd</span>(),Y[i]=<span class="built_in">rd</span>();</span><br><span class="line">	<span class="built_in">Init</span>();</span><br><span class="line">	que.<span class="built_in">Build</span>();</span><br><span class="line">	dis[<span class="number">0</span>].<span class="built_in">Add</span>(<span class="number">10111</span>);</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">2</span>,n) dis[i].<span class="built_in">Add</span>(<span class="number">10110</span>);</span><br><span class="line">	<span class="keyword">while</span>(que.s[<span class="number">1</span>]) &#123;</span><br><span class="line">		<span class="type">int</span> u=que.<span class="built_in">top</span>();</span><br><span class="line">		vis[u]=<span class="number">1</span>;</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">auto</span> t:E[u]) &#123;</span><br><span class="line">			<span class="type">int</span> v=t.first;</span><br><span class="line">			Bitset w=dis[u]; <span class="keyword">if</span>(~t.second) w.<span class="built_in">Add</span>(t.second);</span><br><span class="line">			<span class="keyword">if</span>(w&lt;dis[v]) dis[v]=w,que.<span class="built_in">push</span>(v),pre[v]=u;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span>(<span class="type">int</span> u=k;u;u=pre[u]) <span class="keyword">if</span>(u&lt;=k) Ans[++Ac]=u;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>,Ac);</span><br><span class="line">	<span class="built_in">drep</span>(i,Ac,<span class="number">1</span>) <span class="built_in">printf</span>(<span class="string">&quot;%d &quot;</span>,Ans[i]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://compilationfail.github.io/oi-solutions/ROI%20-%20CEOI%20-%20CCO%20-%20APIO%20-%20Baltic%20OI%20-%20USACO/%E3%80%8CROI%202018%20Day%202%E3%80%8D%E6%97%A0%E8%BF%9B%E4%BD%8D%E5%8A%A0%E6%B3%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="orangejuice">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="orangejuice's blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | orangejuice's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/oi-solutions/ROI%20-%20CEOI%20-%20CCO%20-%20APIO%20-%20Baltic%20OI%20-%20USACO/%E3%80%8CROI%202018%20Day%202%E3%80%8D%E6%97%A0%E8%BF%9B%E4%BD%8D%E5%8A%A0%E6%B3%95/" class="post-title-link" itemprop="url">「ROI 2018 Day 2」无进位加法</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-08-12 00:11:59" itemprop="dateCreated datePublished" datetime="2023-08-12T00:11:59+08:00">2023-08-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-08-17 21:28:48" itemprop="dateModified" datetime="2023-08-17T21:28:48+08:00">2023-08-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/CP-%E9%A2%98%E8%A7%A3/" itemprop="url" rel="index"><span itemprop="name">CP 题解</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="roi-2018-day-2无进位加法">「ROI 2018 Day 2」无进位加法</h1>
<p>题目大意：</p>
<p>给出二进制数 <span class="math inline">\(a_1,\ldots a_n\)</span>
，对于 <span class="math inline">\(b_1\ldots b_n\)</span></p>
<p>满足 <span class="math inline">\(a_i\leq b_i\)</span> ， <span
class="math inline">\(\bigoplus b_i=\sum b_i\)</span> ，其中 <span
class="math inline">\(\bigoplus\)</span> 为异或和</p>
<p>求 <span class="math inline">\(\sum b_i\)</span> 最小值</p>
<p>设长度量级为 <span class="math inline">\(N=\sum len(a_i)\)</span></p>
<h3 id="on2-n3-从高到低确定答案的每一个位"><span
class="math inline">\(O(N^2-N^3)\)</span> ，
从高到低确定答案的每一个位</h3>
<p>枚举当前位为0，下面的位为1，贪心确定是否存在方案</p>
<p>检查一个答案是否合法：</p>
<p>动态维护一个倒序的 <span class="math inline">\(a_i\)</span>
集合，从高到低考虑每一个位置</p>
<p>1.如果当前位为0：</p>
<p>如果 <span class="math inline">\(a_i\)</span>
中存在大于等于这一位的数，非法</p>
<p>2.如果当前位为1：</p>
<p>2-1.如果 <span class="math inline">\(a_i\)</span>
中存在2个当前位为1的数，非法</p>
<p>2-2.如果 <span class="math inline">\(a_i\)</span>
中存在恰好一个，则将这个1用于这个 <span
class="math inline">\(a_i\)</span> ，并将 <span
class="math inline">\(a_i\)</span> 去掉最高位后放回集合</p>
<p>2-3.不存在，用这个 <span class="math inline">\(1\)</span>
删除最大的一个 <span class="math inline">\(a_i\)</span></p>
<p>实际看来，这个贪心本身效率并不高</p>
<p><span class="math display">\[\ \]</span></p>
<h3
id="优化1快速确定答案最高位的可能范围">优化1：快速确定答案最高位的可能范围</h3>
<p>令 <span class="math inline">\(B=\max\{ len(a_i)+i-1\}\)</span></p>
<p>则 <span class="math inline">\(len(Ans)\in[B,B+1]\)</span></p>
<p>上下界均可以由上面的贪心模拟得到</p>
<p><span class="math display">\[  \ \]</span></p>
<h3 id="优化2快速维护-a_i-倒序">优化2：快速维护 <span
class="math inline">\(a_i\)</span> 倒序</h3>
<p>显然在不断更改的过程中，当前的 <span
class="math inline">\(a_i\)</span> 一定是原先的某一个 <span
class="math inline">\(a_i\)</span> 的一段后缀</p>
<p>考虑将所有这样的后缀排序，为了方便，用每一个最高的1来表示一个合法的后缀</p>
<p>显然可以先按照后缀长度分类，同长度的后缀，按照后缀中下一个1出现的位置排序</p>
<p>也就是一个类似基数排序个过程，额外维护每一个后缀中下一个出现的 <span
class="math inline">\(1\)</span> 所对应的后缀即可</p>
<p>预处理复杂度为 <span class="math inline">\(O(N\log N)\)</span></p>
<p>同时，也可以用线段树快速维护插入/删除的排名，得到 <span
class="math inline">\(B\)</span> 的值，单次操作复杂度 <span
class="math inline">\(O(\log N)\)</span></p>
<p><span class="math display">\[ \ \]</span></p>
<h3 id="优化3">优化3</h3>
<p>称满足 <span class="math inline">\(len(a_i)+i-1=B\)</span> 的 <span
class="math inline">\(i\)</span> 为 <span
class="math inline">\(\text{critical number}\)</span></p>
<p>令 <span class="math inline">\(p\)</span> 为最小的 <span
class="math inline">\(\text{critical number}\)</span>
，也就是在贪心过程中第一个出现情况2-1./2-2.的位置</p>
<p>决策答案为 <span class="math inline">\(B\)</span> 还是为 <span
class="math inline">\(B+1\)</span> ，也就是决策</p>
<p>是用 <span class="math inline">\(len(a_p)\)</span> 这个位置删除 <span
class="math inline">\(a_p\)</span> 的最高位，还是用 <span
class="math inline">\(len(a_p)+1\)</span> 的位置删除 <span
class="math inline">\(a_p\)</span></p>
<p>( <span class="math inline">\([1,p-1]\)</span>
的部分一定会被删掉)</p>
<p><span class="math inline">\(\text{intended solution}\)</span>
采用暴力递归来完成确定每一位的这个操作</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Function Solve(Limit) Limit为当前可以使用的最高位的1</span><br><span class="line">	求得 B,p</span><br><span class="line">	删除 a[1,p-1]</span><br><span class="line">	删除 a[p]最高位</span><br><span class="line">	if B&lt;=Limit and Solve(p-1) then</span><br><span class="line">		ans[len(a[p]),B]=1</span><br><span class="line">		return True</span><br><span class="line">	删除a[p]</span><br><span class="line">	if B+1&lt;=Limit and Solve(p) then </span><br><span class="line">		ans[len(a[p])+1,B+1]=1</span><br><span class="line">		return True</span><br><span class="line">	else return False</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>至于复杂度，官方题解给出为 <span class="math inline">\(O(N)\)</span>
次递归和删除/加入操作，最终复杂度为 <span class="math inline">\(O(N\log
N)\)</span></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> pb push_back</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> rep(i,a,b) for(int i=a,i##end=b;i&lt;=i##end;++i)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> drep(i,a,b) for(int i=a,i##end=b;i&gt;=i##end;--i)</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt; <span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">cmin</span><span class="params">(T &amp;a,<span class="type">const</span> T &amp;b)</span></span>&#123; ((a&gt;b)&amp;&amp;(a=b)); &#125;</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt; <span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">cmax</span><span class="params">(T &amp;a,<span class="type">const</span> T &amp;b)</span></span>&#123; ((a&lt;b)&amp;&amp;(a=b)); &#125;</span><br><span class="line"><span class="type">char</span> IO;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">rd</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="type">int</span> s=<span class="number">0</span>;</span><br><span class="line">	<span class="keyword">while</span>(!<span class="built_in">isdigit</span>(IO=<span class="built_in">getchar</span>()));</span><br><span class="line">	<span class="keyword">do</span> s=(s&lt;&lt;<span class="number">1</span>)+(s&lt;&lt;<span class="number">3</span>)+(IO^<span class="string">&#x27;0&#x27;</span>);</span><br><span class="line">	<span class="keyword">while</span>(<span class="built_in">isdigit</span>(IO=<span class="built_in">getchar</span>()));</span><br><span class="line">	<span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> vector &lt;<span class="type">int</span>&gt; V;</span><br><span class="line"><span class="type">const</span> <span class="type">int</span> N=<span class="number">3e5</span>+<span class="number">10</span>,INF=<span class="number">1e9</span>+<span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> n,m,I[N],L;</span><br><span class="line"><span class="type">char</span> s[N];</span><br><span class="line"><span class="type">int</span> fir[N],nxt[N],rk[N],len[N],id[N];</span><br><span class="line">V A[N];</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Affirmation_Of_My_Existence</span>&#123;</span><br><span class="line">	<span class="type">int</span> s[N&lt;&lt;<span class="number">2</span>],t[N&lt;&lt;<span class="number">2</span>];</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">Down</span><span class="params">(<span class="type">int</span> p)</span></span>&#123;</span><br><span class="line">		<span class="built_in">rep</span>(v,p&lt;&lt;<span class="number">1</span>,p&lt;&lt;<span class="number">1</span>|<span class="number">1</span>) t[v]+=t[p],s[v]+=t[p];</span><br><span class="line">		t[p]=<span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">Upd</span><span class="params">(<span class="type">int</span> p,<span class="type">int</span> l,<span class="type">int</span> r,<span class="type">int</span> ql,<span class="type">int</span> qr,<span class="type">int</span> x)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(ql&gt;qr) <span class="keyword">return</span>;</span><br><span class="line">		<span class="keyword">if</span>(ql&lt;=l &amp;&amp; r&lt;=qr) &#123;</span><br><span class="line">			s[p]+=x,t[p]+=x;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">Down</span>(p);</span><br><span class="line">		<span class="type">int</span> mid=(l+r)&gt;&gt;<span class="number">1</span>;</span><br><span class="line">		<span class="keyword">if</span>(ql&lt;=mid) <span class="built_in">Upd</span>(p&lt;&lt;<span class="number">1</span>,l,mid,ql,qr,x);</span><br><span class="line">		<span class="keyword">if</span>(qr&gt;mid) <span class="built_in">Upd</span>(p&lt;&lt;<span class="number">1</span>|<span class="number">1</span>,mid+<span class="number">1</span>,r,ql,qr,x);</span><br><span class="line">		s[p]=<span class="built_in">max</span>(s[p&lt;&lt;<span class="number">1</span>],s[p&lt;&lt;<span class="number">1</span>|<span class="number">1</span>]);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">Build</span><span class="params">(<span class="type">int</span> p,<span class="type">int</span> l,<span class="type">int</span> r)</span></span>&#123; </span><br><span class="line">		s[p]=len[id[l]]-INF;</span><br><span class="line">		<span class="keyword">if</span>(l==r) <span class="keyword">return</span>;</span><br><span class="line">		<span class="type">int</span> mid=(l+r)&gt;&gt;<span class="number">1</span>;</span><br><span class="line">		<span class="built_in">Build</span>(p&lt;&lt;<span class="number">1</span>,l,mid),<span class="built_in">Build</span>(p&lt;&lt;<span class="number">1</span>|<span class="number">1</span>,mid+<span class="number">1</span>,r);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">Add</span><span class="params">(<span class="type">int</span> x,<span class="type">int</span> k)</span></span>&#123;</span><br><span class="line">		x=rk[x];</span><br><span class="line">		<span class="built_in">Upd</span>(<span class="number">1</span>,<span class="number">1</span>,m,x,x,INF*k),<span class="built_in">Upd</span>(<span class="number">1</span>,<span class="number">1</span>,m,x+<span class="number">1</span>,m,k);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// Find the first critical position &quot;p&quot;, and return all the bits in [1,p]</span></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">Get</span><span class="params">(<span class="type">int</span> p,<span class="type">int</span> l,<span class="type">int</span> r,<span class="type">int</span> x,V &amp;R)</span></span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(s[p]&lt;<span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line">		<span class="keyword">if</span>(l==r) <span class="keyword">return</span> R.<span class="built_in">pb</span>(id[l]);</span><br><span class="line">		<span class="built_in">Down</span>(p);</span><br><span class="line">		<span class="type">int</span> mid=(l+r)&gt;&gt;<span class="number">1</span>;</span><br><span class="line">		<span class="built_in">Get</span>(p&lt;&lt;<span class="number">1</span>,l,mid,x,R);</span><br><span class="line">		<span class="keyword">if</span>(s[p&lt;&lt;<span class="number">1</span>]!=x) <span class="built_in">Get</span>(p&lt;&lt;<span class="number">1</span>|<span class="number">1</span>,mid+<span class="number">1</span>,r,x,R);</span><br><span class="line">	&#125;</span><br><span class="line">&#125; T;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Solve</span><span class="params">(<span class="type">int</span> L)</span></span>&#123;</span><br><span class="line">	<span class="comment">// L denotes the maxmium bit we can use</span></span><br><span class="line">	<span class="type">int</span> B=T.s[<span class="number">1</span>];</span><br><span class="line">	<span class="keyword">if</span>(B&lt;<span class="number">0</span>) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">if</span>(B&gt;L) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	V R; T.<span class="built_in">Get</span>(<span class="number">1</span>,<span class="number">1</span>,m,B,R);</span><br><span class="line">	<span class="type">int</span> p=*R.<span class="built_in">rbegin</span>(),l=len[p];</span><br><span class="line">	<span class="keyword">for</span>(<span class="type">int</span> i:R) T.<span class="built_in">Add</span>(i,<span class="number">-1</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// Try ans B , so we use bit [nxt,B] to delete the number [1,p-1] </span></span><br><span class="line">    <span class="comment">// and the number a[p] will be set to a[p]-2^l</span></span><br><span class="line">	<span class="keyword">if</span>(nxt[p]) T.<span class="built_in">Add</span>(nxt[p],<span class="number">1</span>);</span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">Solve</span>(l<span class="number">-1</span>)) &#123;</span><br><span class="line">		<span class="built_in">rep</span>(i,l,B) s[i]=<span class="number">1</span>;</span><br><span class="line">		<span class="keyword">return</span> B+<span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Try ans B+1 , so we use bit [nxt+1,B+1] to delete the [1,p]</span></span><br><span class="line">	<span class="keyword">if</span>(nxt[p]) T.<span class="built_in">Add</span>(nxt[p],<span class="number">-1</span>);</span><br><span class="line">	<span class="keyword">if</span>(B&lt;L &amp;&amp; <span class="built_in">Solve</span>(l)) &#123;</span><br><span class="line">		<span class="built_in">rep</span>(i,l+<span class="number">1</span>,B+<span class="number">1</span>) s[i]=<span class="number">1</span>;</span><br><span class="line">		<span class="keyword">return</span> B+<span class="number">2</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span>(<span class="type">int</span> i:R) T.<span class="built_in">Add</span>(i,<span class="number">1</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">1</span>,n=<span class="built_in">rd</span>()) &#123;</span><br><span class="line">		<span class="built_in">scanf</span>(<span class="string">&quot;%s&quot;</span>,s); <span class="type">int</span> l=<span class="built_in">strlen</span>(s);</span><br><span class="line">		<span class="built_in">cmax</span>(L,l);</span><br><span class="line">		<span class="built_in">drep</span>(j,l<span class="number">-1</span>,<span class="number">0</span>) <span class="keyword">if</span>(s[j]==<span class="string">&#x27;1&#x27;</span>) &#123;</span><br><span class="line">			nxt[++m]=fir[i];</span><br><span class="line">			A[len[m]=l-j<span class="number">-1</span>].<span class="built_in">pb</span>(m);</span><br><span class="line">			fir[i]=m;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	rk[<span class="number">0</span>]=<span class="number">1e9</span>;</span><br><span class="line">	<span class="type">int</span> k=m;</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">0</span>,L<span class="number">-1</span>) &#123;</span><br><span class="line">		k-=A[i].<span class="built_in">size</span>();</span><br><span class="line">		<span class="built_in">sort</span>(A[i].<span class="built_in">begin</span>(),A[i].<span class="built_in">end</span>(),[&amp;](<span class="type">int</span> x,<span class="type">int</span> y)&#123; <span class="keyword">return</span> rk[nxt[x]]&lt;rk[nxt[y]]; &#125;);</span><br><span class="line">		<span class="keyword">for</span>(<span class="type">int</span> j:A[i]) id[rk[j]=++k]=j;</span><br><span class="line">		k-=A[i].<span class="built_in">size</span>();</span><br><span class="line">	&#125;</span><br><span class="line">	T.<span class="built_in">Build</span>(<span class="number">1</span>,<span class="number">1</span>,m);</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">1</span>,n) T.<span class="built_in">Add</span>(fir[i],<span class="number">1</span>);</span><br><span class="line">	<span class="built_in">memset</span>(s,<span class="number">0</span>,<span class="keyword">sizeof</span> s);</span><br><span class="line">	<span class="built_in">drep</span>(i,<span class="built_in">Solve</span>(INF)<span class="number">-1</span>,<span class="number">0</span>) <span class="built_in">putchar</span>(s[i]^<span class="number">48</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://compilationfail.github.io/oi-solutions/ROI%20-%20CEOI%20-%20CCO%20-%20APIO%20-%20Baltic%20OI%20-%20USACO/%E3%80%8CROI%202019%20Day1%E3%80%8D%E8%BF%90%E8%BE%93%202019/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="orangejuice">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="orangejuice's blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | orangejuice's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/oi-solutions/ROI%20-%20CEOI%20-%20CCO%20-%20APIO%20-%20Baltic%20OI%20-%20USACO/%E3%80%8CROI%202019%20Day1%E3%80%8D%E8%BF%90%E8%BE%93%202019/" class="post-title-link" itemprop="url">「ROI 2019 Day1」运输 20/19</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-08-12 00:11:59" itemprop="dateCreated datePublished" datetime="2023-08-12T00:11:59+08:00">2023-08-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-08-17 21:28:48" itemprop="dateModified" datetime="2023-08-17T21:28:48+08:00">2023-08-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/CP-%E9%A2%98%E8%A7%A3/" itemprop="url" rel="index"><span itemprop="name">CP 题解</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="roi-2019-day1运输-2019">「ROI 2019 Day1」运输 20/19</h1>
<p>题目大意：</p>
<p>给定一个带权 <span class="math inline">\(DAG\)</span> ， <span
class="math inline">\(1\)</span> 为起始点，给定小常数 <span
class="math inline">\(p\)</span></p>
<p>每次查询一个点 <span class="math inline">\(u\)</span> ，一个权值
<span class="math inline">\(r\)</span> ，问是否存在一条路径 <span
class="math inline">\(1\ldots u\)</span> ，其长度 <span
class="math inline">\(x\)</span> 满足 <span class="math inline">\(r\leq
x\leq \frac{p}{p-1}\cdot r\)</span></p>
<p>转换一下， <span class="math inline">\(dp\)</span> 每个点是否存在
<span class="math inline">\(r\)</span> ，那么对于路径的权值 <span
class="math inline">\(x\)</span> ，合法的 <span
class="math inline">\(r\)</span> 即为 <span
class="math inline">\([\frac{p-1}{p}\cdot x,x]\)</span></p>
<p>对于任意两个区间，如果其相交，则可以合并，并且用两个区间中最小和最大的
<span class="math inline">\(x\)</span> 来表示这个区间</p>
<p>而不相交的区间最多只有 <span
class="math inline">\(\log_{\frac{p}{p-1}} w\)</span> 段，大概 <span
class="math inline">\(700\)</span> 段</p>
<p>任意时刻，每个点的 <span class="math inline">\(dp\)</span> 情况可以用
<span class="math inline">\(700\)</span>
段不交的区间表示，转移可以归并数组进行</p>
<p>因此维护 <span class="math inline">\(dp\)</span> 复杂度为 <span
class="math inline">\(O(m\log_{\frac{p}{p-1}} w)\)</span>
常数极小，单次查询复杂度为 <span class="math inline">\(O(\log
\log_{\frac{p}{p-1}} w)\)</span></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">long</span> <span class="type">long</span> ll;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> pb push_back</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> rep(i,a,b) for(int i=a,i##end=b;i&lt;=i##end;++i)</span></span><br><span class="line"><span class="type">char</span> IO;</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">T</span>=<span class="type">int</span>&gt; T <span class="built_in">rd</span>()&#123;</span><br><span class="line">	T s=<span class="number">0</span>; <span class="type">int</span> f=<span class="number">0</span>;</span><br><span class="line">	<span class="keyword">while</span>(!<span class="built_in">isdigit</span>(IO=<span class="built_in">getchar</span>())) <span class="keyword">if</span>(IO==<span class="string">&#x27;-&#x27;</span>) f=<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">do</span> s=(s&lt;&lt;<span class="number">1</span>)+(s&lt;&lt;<span class="number">3</span>)+(IO^<span class="string">&#x27;0&#x27;</span>);</span><br><span class="line">	<span class="keyword">while</span>(<span class="built_in">isdigit</span>(IO=<span class="built_in">getchar</span>()));</span><br><span class="line">	<span class="keyword">return</span> f?-s:s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> N=<span class="number">5e5</span>+<span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> n,m,q,p;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Interval</span>&#123;</span><br><span class="line">	ll l,r,x,y;</span><br><span class="line">	<span class="built_in">Interval</span>(ll a,ll b)&#123; </span><br><span class="line">		x=a,y=b;</span><br><span class="line">		l=(x*(p<span class="number">-1</span>)+p<span class="number">-1</span>)/p,r=y;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">Add</span><span class="params">(ll c)</span></span>&#123;</span><br><span class="line">		x+=c,y+=c;</span><br><span class="line">		l=(x*(p<span class="number">-1</span>)+p<span class="number">-1</span>)/p,r=y;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="type">bool</span> <span class="keyword">operator</span> &amp; (<span class="type">const</span> Interval &amp;__) <span class="type">const</span> &#123; <span class="keyword">return</span> <span class="built_in">min</span>(r,__.r)&gt;=<span class="built_in">max</span>(l,__.l)<span class="number">-1</span>; &#125;</span><br><span class="line">	Interval <span class="keyword">operator</span> + (<span class="type">const</span> Interval &amp;__) <span class="type">const</span> &#123; <span class="keyword">return</span> <span class="built_in">Interval</span>(<span class="built_in">min</span>(x,__.x),<span class="built_in">max</span>(y,__.y)); &#125;</span><br><span class="line">	<span class="type">bool</span> <span class="keyword">operator</span> &lt; (<span class="type">const</span> ll &amp;x) <span class="type">const</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> r&lt;x;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line">vector &lt;Interval&gt; dp[N];</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Edge</span>&#123;</span><br><span class="line">	<span class="type">int</span> to,nxt; ll w;</span><br><span class="line">&#125; e[N];</span><br><span class="line"><span class="type">int</span> head[N],ecnt;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">AddEdge</span><span class="params">(<span class="type">int</span> u,<span class="type">int</span> v,ll w)</span></span>&#123;</span><br><span class="line">	e[++ecnt]=(Edge)&#123;v,head[u],w&#125;;</span><br><span class="line">	head[u]=ecnt;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Trans</span><span class="params">(vector &lt;Interval&gt; &amp;x,vector &lt;Interval&gt; y,ll c)</span></span>&#123;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">auto</span> &amp;i:y) i.<span class="built_in">Add</span>(c);</span><br><span class="line">	vector &lt;Interval&gt; res;</span><br><span class="line">	<span class="type">int</span> p1=<span class="number">0</span>,p2=<span class="number">0</span>,s1=x.<span class="built_in">size</span>(),s2=y.<span class="built_in">size</span>();</span><br><span class="line">	<span class="keyword">while</span>(p1&lt;s1 || p2&lt;s2) &#123;</span><br><span class="line">		<span class="keyword">if</span>(p1&lt;s1 &amp;&amp; (p2==s2 || x[p1].l&lt;=y[p2].l)) &#123;</span><br><span class="line">			<span class="keyword">if</span>(res.<span class="built_in">size</span>() &amp;&amp; *res.<span class="built_in">rbegin</span>()&amp;x[p1]) res[res.<span class="built_in">size</span>()<span class="number">-1</span>]=*res.<span class="built_in">rbegin</span>()+x[p1++];</span><br><span class="line">			<span class="keyword">else</span> res.<span class="built_in">pb</span>(x[p1++]);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">if</span>(res.<span class="built_in">size</span>() &amp;&amp; *res.<span class="built_in">rbegin</span>()&amp;y[p2]) res[res.<span class="built_in">size</span>()<span class="number">-1</span>]=*res.<span class="built_in">rbegin</span>()+y[p2++];</span><br><span class="line">			<span class="keyword">else</span> res.<span class="built_in">pb</span>(y[p2++]);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	x=res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="built_in">rep</span>(kase,<span class="number">1</span>,<span class="built_in">rd</span>()) &#123;</span><br><span class="line">		n=<span class="built_in">rd</span>(),m=<span class="built_in">rd</span>(),q=<span class="built_in">rd</span>(),p=<span class="built_in">rd</span>();</span><br><span class="line">		<span class="built_in">rep</span>(i,<span class="number">1</span>,n) head[i]=ecnt=<span class="number">0</span>;</span><br><span class="line">		<span class="built_in">rep</span>(i,<span class="number">1</span>,m)&#123;</span><br><span class="line">			<span class="type">int</span> u=<span class="built_in">rd</span>(),v=<span class="built_in">rd</span>(); ll w=<span class="built_in">rd</span>&lt;ll&gt;();</span><br><span class="line">			<span class="built_in">AddEdge</span>(u,v,w);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">rep</span>(i,<span class="number">1</span>,n) dp[i].<span class="built_in">clear</span>();</span><br><span class="line">		dp[<span class="number">1</span>].<span class="built_in">pb</span>(<span class="built_in">Interval</span>(<span class="number">0</span>,<span class="number">0</span>));</span><br><span class="line">		<span class="built_in">rep</span>(u,<span class="number">1</span>,n) &#123;</span><br><span class="line">			<span class="keyword">for</span>(<span class="type">int</span> i=head[u];i;i=e[i].nxt) &#123;</span><br><span class="line">				<span class="built_in">Trans</span>(dp[e[i].to],dp[u],e[i].w);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">while</span>(q--)&#123;</span><br><span class="line">			<span class="type">int</span> x=<span class="built_in">rd</span>(); ll y=<span class="built_in">rd</span>&lt;ll&gt;();</span><br><span class="line">			<span class="keyword">auto</span> p=<span class="built_in">lower_bound</span>(dp[x].<span class="built_in">begin</span>(),dp[x].<span class="built_in">end</span>(),y);</span><br><span class="line">			<span class="keyword">if</span>(p!=dp[x].<span class="built_in">end</span>() &amp;&amp; p-&gt;l&lt;=y) <span class="built_in">putchar</span>(<span class="string">&#x27;1&#x27;</span>);</span><br><span class="line">			<span class="keyword">else</span> <span class="built_in">putchar</span>(<span class="string">&#x27;0&#x27;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">puts</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="Previous page" aria-label="Previous page" href="/page/20/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/20/">20</a><span class="page-number current">21</span><a class="page-number" href="/page/22/">22</a><span class="space">&hellip;</span><a class="page-number" href="/page/27/">27</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/page/22/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2023</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">orangejuice</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>







  




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>



</body>
</html>
