<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"compilationfail.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.18.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"mac"},"fold":{"enable":true,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="orangejuice&#39;s blog">
<meta property="og:url" content="https://compilationfail.github.io/page/20/index.html">
<meta property="og:site_name" content="orangejuice&#39;s blog">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="orangejuice">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://compilationfail.github.io/page/20/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"page/20/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>orangejuice's blog</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">orangejuice's blog</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">挂了请务必叫我</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="orangejuice"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">orangejuice</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">257</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://twitter.com/ChenJerson" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;ChenJerson" rel="noopener me" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://weibo.com/3950662532/profile?rightmod=1&wvr=6&mod=personinfo" title="Weibo → https:&#x2F;&#x2F;weibo.com&#x2F;3950662532&#x2F;profile?rightmod&#x3D;1&amp;wvr&#x3D;6&amp;mod&#x3D;personinfo" rel="noopener me" target="_blank"><i class="fab fa-weibo fa-fw"></i>Weibo</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://github.com/CompilationFail" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;CompilationFail" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://steamcommunity.com/profiles/76561198969516062/" title="Steam → https:&#x2F;&#x2F;steamcommunity.com&#x2F;profiles&#x2F;76561198969516062&#x2F;" rel="noopener me" target="_blank"><i class="fab fa-steam fa-fw"></i>Steam</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.last.fm/user/chasedeath" title="Lastfm → https:&#x2F;&#x2F;www.last.fm&#x2F;user&#x2F;chasedeath" rel="noopener me" target="_blank"><i class="fab fa-lastfm-square fa-fw"></i>Lastfm</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://open.spotify.com/user/mgxnlznf9dli6bm4k3sp0iuwz" title="Spotify → https:&#x2F;&#x2F;open.spotify.com&#x2F;user&#x2F;mgxnlznf9dli6bm4k3sp0iuwz" rel="noopener me" target="_blank"><i class="fab fa-spotify fa-fw"></i>Spotify</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://compilationfail.github.io/oi-solutions/COCI/COCI2011-2012%20Contest#1%20F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="orangejuice">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="orangejuice's blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | orangejuice's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/oi-solutions/COCI/COCI2011-2012%20Contest#1%20F/" class="post-title-link" itemprop="url">COCI2011/2012 Contest#1 F  状压加速dp</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2023-08-12 11:05:24 / Modified: 12:45:20" itemprop="dateCreated datePublished" datetime="2023-08-12T11:05:24+08:00">2023-08-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/oi-solutions/" itemprop="url" rel="index"><span itemprop="name">oi-solutions</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="coci20112012-contest1-f-状压加速dp">COCI2011/2012 Contest#1 F
状压加速dp</h1>
<p>首先是一个非常Naive的dp，令 <span
class="math inline">\(dp[i][x][y]\)</span> 表示 <span
class="math inline">\(i\)</span> 时刻 <span
class="math inline">\(x,y\)</span> 是否能被跳到</p>
<p>枚举，然后转移，如果滚动数组，就可以做到 <span
class="math inline">\(O(n^2)\)</span> 空间， <span
class="math inline">\(O(Tn^2)\)</span> 时间复杂度</p>
<p>这显然是TLE的。。。</p>
<p><span class="math display">\[ \ \]</span></p>
<p>注意到题目的 <span class="math inline">\(n\leq 30\)</span>
，可以直接用一个int存在某一行/列的答案</p>
<p>设时刻 <span class="math inline">\(i\)</span> 第 <span
class="math inline">\(j\)</span> 列的答案为 <span
class="math inline">\(dp[i][j]\)</span></p>
<p>假设不考虑答案的限制，两之间转移可以做到 <span
class="math inline">\(O(1)\)</span> ，即</p>
<ol type="1">
<li><p><span class="math inline">\(dp[i][j\pm 1]\)</span>
左/右移两位</p></li>
<li><p><span class="math inline">\(dp[i][j\pm 2]\)</span>
左/右移一位</p></li>
</ol>
<p>两者转移即可，但是涉及到倍数的限制，设 <span
class="math inline">\(can[i][j]\)</span> 为 <span
class="math inline">\(i\)</span> 时刻 <span
class="math inline">\(j\)</span> 列的可行跳跃位置</p>
<p>则只需要最后的时候让 <span class="math inline">\(dp[i][j]\)</span> 与
<span class="math inline">\(can[i][j]\)</span> 取交集即可</p>
<p>如果直接枚举倍数，复杂度上限是 <span class="math inline">\(O(n^2
T)\)</span></p>
<p>考虑分块决策，设将 <span class="math inline">\([1,D]\)</span>
的因数挑出来额外记录一个数组 <span
class="math inline">\(can2[x][j]\)</span> 表示值为 <span
class="math inline">\(x\)</span> 的第 <span
class="math inline">\(j\)</span> 列有那些</p>
<p>不直接枚举他们，而是在每次访问时考虑他们对于 <span
class="math inline">\(can[i][j]\)</span> 的贡献</p>
<p>在优秀实现下，复杂度上限为 <span
class="math inline">\(O(n^2\frac{T}{D+1}+T (D+\sum_{t=1}^{D} \frac{1}{t}
n))=O(n^2\frac{T}{D+1}+T (n\ln D+D))\)</span></p>
<p>这个实现上来说，就是枚举时间 <span class="math inline">\(i\)</span>
后，判断是否满足 <span class="math inline">\(t|i\)</span> ，然后再将
<span class="math inline">\(can2[t][j]\)</span> 贡献到 <span
class="math inline">\(can[i][j]\)</span></p>
<p>显然， <span class="math inline">\(t|i\)</span> 成立的次数就是 <span
class="math inline">\(T\sum_{t=1}^{D} \frac{1}{t}\)</span>
，也就是要循环这么多次取贡献 <span class="math inline">\(j\)</span>
这一维</p>
<p>调整一下 <span class="math inline">\(D\)</span> 的参数</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> GCC optimize(2)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> reg register</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> rep(i,a,b) for(reg int i=a,i##end=b;i&lt;=i##end;++i)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> drep(i,a,b) for(reg int i=a,i##end=b;i&gt;=i##end;--i)</span></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> N=<span class="number">30</span>,D=<span class="number">7</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> n,m,a[N][N],dp[<span class="number">2</span>][N];</span><br><span class="line"><span class="type">int</span> can[<span class="number">1000010</span>][N],t[D+<span class="number">1</span>][N];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="built_in">scanf</span>(<span class="string">&quot;%d%d&quot;</span>,&amp;n,&amp;m);</span><br><span class="line">	<span class="type">int</span> sx,sy; <span class="built_in">scanf</span>(<span class="string">&quot;%d%d&quot;</span>,&amp;sx,&amp;sy),sx--,sy--;</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">0</span>,n<span class="number">-1</span>) <span class="built_in">rep</span>(j,<span class="number">0</span>,n<span class="number">-1</span>) &#123;</span><br><span class="line">		<span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>,&amp;a[i][j]);</span><br><span class="line">		<span class="keyword">if</span>(a[i][j]&lt;=D) t[a[i][j]][i]|=<span class="number">1</span>&lt;&lt;j;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">for</span>(reg <span class="type">int</span> T=a[i][j];T&lt;=m;T+=a[i][j]) can[T][i]|=<span class="number">1</span>&lt;&lt;j;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="type">int</span> cur=<span class="number">0</span>; dp[cur][sx]=<span class="number">1</span>&lt;&lt;sy;</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">1</span>,m) &#123;</span><br><span class="line">		<span class="built_in">rep</span>(j,<span class="number">1</span>,D) <span class="keyword">if</span>(i%j==<span class="number">0</span>) <span class="built_in">rep</span>(k,<span class="number">0</span>,n<span class="number">-1</span>) can[i][k]|=t[j][k];</span><br><span class="line">		<span class="built_in">rep</span>(j,<span class="number">0</span>,n<span class="number">-1</span>) &#123;</span><br><span class="line">			dp[!cur][j]=<span class="number">0</span>;</span><br><span class="line">			<span class="keyword">if</span>(j) &#123;</span><br><span class="line">				dp[!cur][j]|=dp[cur][j<span class="number">-1</span>]&lt;&lt;<span class="number">2</span>;</span><br><span class="line">				dp[!cur][j]|=dp[cur][j<span class="number">-1</span>]&gt;&gt;<span class="number">2</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span>(j&lt;n<span class="number">-1</span>) &#123;</span><br><span class="line">				dp[!cur][j]|=dp[cur][j+<span class="number">1</span>]&lt;&lt;<span class="number">2</span>;</span><br><span class="line">				dp[!cur][j]|=dp[cur][j+<span class="number">1</span>]&gt;&gt;<span class="number">2</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span>(j&gt;<span class="number">1</span>) &#123;</span><br><span class="line">				dp[!cur][j]|=dp[cur][j<span class="number">-2</span>]&lt;&lt;<span class="number">1</span>;</span><br><span class="line">				dp[!cur][j]|=dp[cur][j<span class="number">-2</span>]&gt;&gt;<span class="number">1</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span>(j&lt;n<span class="number">-2</span>) &#123;</span><br><span class="line">				dp[!cur][j]|=dp[cur][j+<span class="number">2</span>]&lt;&lt;<span class="number">1</span>;</span><br><span class="line">				dp[!cur][j]|=dp[cur][j+<span class="number">2</span>]&gt;&gt;<span class="number">1</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			dp[!cur][j]&amp;=can[i][j];</span><br><span class="line">		&#125;</span><br><span class="line">		cur^=<span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="type">int</span> ans=<span class="number">0</span>;</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">0</span>,n<span class="number">-1</span>) <span class="built_in">rep</span>(j,<span class="number">0</span>,n<span class="number">-1</span>) <span class="keyword">if</span>(dp[cur][i]&amp;(<span class="number">1</span>&lt;&lt;j)) ans++;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>,ans);</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">0</span>,n<span class="number">-1</span>) <span class="built_in">rep</span>(j,<span class="number">0</span>,n<span class="number">-1</span>) <span class="keyword">if</span>(dp[cur][i]&amp;(<span class="number">1</span>&lt;&lt;j)) <span class="built_in">printf</span>(<span class="string">&quot;%d %d\n&quot;</span>,i+<span class="number">1</span>,j+<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://compilationfail.github.io/oi-solutions/Atcoder/ARC114%20-%20Sequence%20Scores/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="orangejuice">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="orangejuice's blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | orangejuice's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/oi-solutions/Atcoder/ARC114%20-%20Sequence%20Scores/" class="post-title-link" itemprop="url">ARC114 - Sequence Scores</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2023-08-12 11:05:24 / Modified: 12:45:20" itemprop="dateCreated datePublished" datetime="2023-08-12T11:05:24+08:00">2023-08-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/oi-solutions/" itemprop="url" rel="index"><span itemprop="name">oi-solutions</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="arc114---sequence-scores">ARC114 - Sequence Scores</h1>
<p>题目大意：对于一个序列 <span
class="math inline">\(A=a_i,a_i\in[1,m]\)</span> ，定义 <span
class="math inline">\(f(A)\)</span> 为</p>
<p>对于一个全零的初始序列，每次选择一个区间对于某一个值取 <span
class="math inline">\(\max\)</span> ，最少生成 <span
class="math inline">\(A\)</span> 的步数</p>
<p>求所有 <span class="math inline">\(m^n\)</span> 种 <span
class="math inline">\(A\)</span> 的 <span
class="math inline">\(f(A)\)</span> 之和</p>
<p>首先考虑 <span class="math inline">\(f(A)\)</span>
的计算，显然可以采用如下方法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">b[i]=0</span><br><span class="line">Function Solve(l,r)</span><br><span class="line">	v=min a[l..r]</span><br><span class="line">	for i in l,r</span><br><span class="line">		b[i]=max&#123;b[i],v&#125;</span><br><span class="line">	Divide a[l..r] into contiguous ranges that a[i]!=b[i] , Solve(l&#x27;,r&#x27;)</span><br><span class="line">	</span><br></pre></td></tr></table></figure>
<p>那么考虑计算一个区间 <span class="math inline">\([l,r]\)</span> 被
<span class="math inline">\(\text{Solve}\)</span> 的次数</p>
<p>显然区间 <span class="math inline">\([l,r]\)</span> 被 <span
class="math inline">\(\text{Solve}\)</span> 当且仅当</p>
<p><span
class="math inline">\(\min\{a_i|i\in[l,r]\}&gt;\max(a_{l-1},a_{r+1})\)</span></p>
<p>对于不同的 <span class="math inline">\(r-l+1\)</span> ，枚举 <span
class="math inline">\(\min\)</span> ，计算方案数即可</p>
<p>注意考虑 <span class="math inline">\(l=1\or r=n\)</span>
的边界情况</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> <span class="type">int</span> N=<span class="number">5010</span>,P=<span class="number">998244353</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> n,m;</span><br><span class="line"><span class="type">int</span> Pow[N][N],F[N][<span class="number">3</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	n=<span class="built_in">rd</span>(),m=<span class="built_in">rd</span>();</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">0</span>,N<span class="number">-1</span>) <span class="built_in">rep</span>(j,*Pow[i]=<span class="number">1</span>,N<span class="number">-1</span>) Pow[i][j]=<span class="number">1ll</span>*Pow[i][j<span class="number">-1</span>]*i%P;</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">1</span>,n) <span class="built_in">rep</span>(j,<span class="number">0</span>,<span class="number">2</span>) <span class="built_in">rep</span>(k,<span class="number">1</span>,m) &#123;</span><br><span class="line">		F[i][j]=(F[i][j]+<span class="number">1ll</span>*(Pow[m-k+<span class="number">1</span>][i]-Pow[m-k][i]+P)*Pow[k<span class="number">-1</span>][j])%P;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="type">int</span> ans=<span class="number">0</span>;</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">1</span>,n) <span class="built_in">rep</span>(j,i,n) &#123;</span><br><span class="line">		<span class="type">int</span> c=(i&gt;<span class="number">1</span>)+(j&lt;n);</span><br><span class="line">		ans=(ans+<span class="number">1ll</span>*F[j-i+<span class="number">1</span>][c]*Pow[m][n-(j-i+<span class="number">1</span>)-c])%P;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>,ans);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://compilationfail.github.io/oi-solutions/COCI/COCI2013-2014%20Contest#3%20F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="orangejuice">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="orangejuice's blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | orangejuice's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/oi-solutions/COCI/COCI2013-2014%20Contest#3%20F/" class="post-title-link" itemprop="url">COCI2013-2014 Contest#3 F 单调栈</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2023-08-12 11:05:24 / Modified: 12:45:20" itemprop="dateCreated datePublished" datetime="2023-08-12T11:05:24+08:00">2023-08-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/oi-solutions/" itemprop="url" rel="index"><span itemprop="name">oi-solutions</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="coci2013-2014-contest3-f-单调栈">COCI2013-2014 Contest#3 F
单调栈</h1>
<p>考虑每个小区间 <span class="math inline">\([x_i,x_{i+1}]\)</span>
中，外部光照进来只能是这样</p>
<figure>
<img src="https://i.loli.net/2020/09/03/ZojvbGetxOIMmXF.png"
alt="Light1.png" />
<figcaption aria-hidden="true">Light1.png</figcaption>
</figure>
<p>其中两边是光源，红色表示被照到了</p>
<p>那么所有合法的被照到的段可以表示为 <span
class="math inline">\([x_i,x_{i+1}]\)</span> 中的两个小段，即</p>
<p>1.左边照进来的 <span
class="math inline">\([s0_i,x_{i+1}]\)</span></p>
<p>2.右边照进来的 <span class="math inline">\([x_i,s1_i]\)</span></p>
<p>考虑从左到右维护可能照到右边的<strong>较优光源</strong></p>
<p>显然对于每一个光源都有一个<strong>当前能遮住它最多</strong>的城市，构成(光源，限制城市)这样的点对</p>
<p>对于每一个<strong>较优的</strong>这样的点对
可以维护一个<strong>单调栈</strong>，维护出来应该是这样的</p>
<figure>
<img src="https://i.loli.net/2020/09/03/jgtAk8omSYafON3.png"
alt="Light2.png" />
<figcaption aria-hidden="true">Light2.png</figcaption>
</figure>
<p>有几个较为显然的性质:</p>
<p>1.所有点对的 <span class="math inline">\(h_i\)</span>
<strong>递减</strong>，否则要么是上一个光源被完全遮住了，要么是这个点可以遮住上一个光源更多</p>
<p>2.靠右的点对能够覆盖的范围较大，即可行区间的左端点较小</p>
<p>否则它此时不会产生贡献，而当后面较高的点进来时，相对更矮的它也更容易被遮住</p>
<p>实际上，这样的形状就会构成一个类似上凸包的东西，但是凸包上只有一部分点产生贡献</p>
<p><span class="math display">\[  \ \]</span></p>
<p>考虑依次加入点 <span class="math inline">\((x_i,h_i)\)</span>
，显然可以弹掉 <span class="math inline">\(h_j&lt;h_i\)</span>
的所有点对(为了防止下面计算左端点时出现问题)</p>
<p>接下来的情况，类似维护凸包，但是要考虑更新限制城市 或者 弹掉点对</p>
<p><span class="math display">\[ \ \]</span></p>
<p>对于向左的情况，反着求一遍即可，最后可以减去两种区间都覆盖不到的部分</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">double</span> db;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> rep(i,a,b) for(int i=a,i##end=b;i&lt;=i##end;++i)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> drep(i,a,b) for(int i=a,i##end=b;i&gt;=i##end;--i)</span></span><br><span class="line"></span><br><span class="line"><span class="type">char</span> IO;</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">T</span>=<span class="type">int</span>&gt; T <span class="built_in">rd</span>()&#123;</span><br><span class="line">	T s=<span class="number">0</span>; <span class="type">int</span> f=<span class="number">0</span>;</span><br><span class="line">	<span class="keyword">while</span>(!<span class="built_in">isdigit</span>(IO=<span class="built_in">getchar</span>())) <span class="keyword">if</span>(IO==<span class="string">&#x27;-&#x27;</span>) f=<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">do</span> s=(s&lt;&lt;<span class="number">1</span>)+(s&lt;&lt;<span class="number">3</span>)+(IO^<span class="string">&#x27;0&#x27;</span>);</span><br><span class="line">	<span class="keyword">while</span>(<span class="built_in">isdigit</span>(IO=<span class="built_in">getchar</span>()));</span><br><span class="line">	<span class="keyword">return</span> f?-s:s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> N=<span class="number">3e5</span>+<span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> n,D;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">City</span>&#123; <span class="type">int</span> k,x,h; &#125; C[N];</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Lightpair</span>&#123;</span><br><span class="line">	<span class="comment">//描述一个灯塔和右边遮住它最多的城市</span></span><br><span class="line">	<span class="type">int</span> x,y;</span><br><span class="line">	<span class="built_in">Lightpair</span>(<span class="type">const</span> <span class="type">int</span> &amp;_x=<span class="number">0</span>,<span class="type">const</span> <span class="type">int</span> &amp;_y=<span class="number">0</span>) : <span class="built_in">x</span>(_x),<span class="built_in">y</span>(_y) &#123; &#125;</span><br><span class="line">	<span class="function">db <span class="title">Left</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">return</span> C[y].x+<span class="number">1.0</span>*(C[y].x-C[x].x)/(C[x].h-C[y].h)*C[y].h;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// z这个发光对能照到的范围为[Left(),+oo)</span></span><br><span class="line">&#125; stk[N];</span><br><span class="line"><span class="type">int</span> top;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Cover</span><span class="params">(Lightpair &amp;x,<span class="type">int</span> y)</span></span>&#123; <span class="keyword">if</span>(<span class="built_in">Lightpair</span>(x.x,y).<span class="built_in">Left</span>()&gt;x.<span class="built_in">Left</span>()) x.y=y; &#125;</span><br><span class="line">db s[<span class="number">2</span>][N];</span><br><span class="line"><span class="comment">// 将所有可能的发光区间描述为 [C[i].x,s[k][i]]</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	n=<span class="built_in">rd</span>(),D=<span class="built_in">rd</span>();</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">1</span>,n) C[i].k=<span class="built_in">rd</span>(),C[i].x=<span class="built_in">rd</span>(),C[i].h=<span class="built_in">rd</span>();</span><br><span class="line">	C[n+<span class="number">1</span>].x=D;</span><br><span class="line">	<span class="built_in">rep</span>(k,<span class="number">0</span>,<span class="number">1</span>) &#123;</span><br><span class="line">		<span class="built_in">rep</span>(i,<span class="number">0</span>,n) &#123;</span><br><span class="line">			<span class="keyword">while</span>(top &amp;&amp; C[stk[top].x].h&lt;=C[i].h) top--; <span class="comment">// 完全被遮住的，先弹掉</span></span><br><span class="line">			<span class="keyword">if</span>(top) &#123;</span><br><span class="line">				<span class="built_in">Cover</span>(stk[top],i);</span><br><span class="line">				<span class="keyword">while</span>(top&gt;<span class="number">1</span>)&#123;</span><br><span class="line">					<span class="built_in">Cover</span>(stk[top<span class="number">-1</span>],i);</span><br><span class="line">					<span class="keyword">if</span>(stk[top<span class="number">-1</span>].<span class="built_in">Left</span>()&gt;stk[top].<span class="built_in">Left</span>()) <span class="keyword">break</span>;</span><br><span class="line">					top--;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span>(C[i].k) stk[++top]=i,s[k][i]=C[i].x; <span class="comment">// 一定覆盖C[i].x,C[i+1].x</span></span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span>(top) s[k][i]=<span class="built_in">min</span>(stk[top].<span class="built_in">Left</span>(),(db)C[i+<span class="number">1</span>].x); <span class="comment">// 尝试让当前最优的点对覆盖过来</span></span><br><span class="line">			<span class="keyword">else</span> s[k][i]=C[i+<span class="number">1</span>].x; <span class="comment">// 无覆盖</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>(!k) &#123;</span><br><span class="line">			<span class="built_in">reverse</span>(C+<span class="number">1</span>,C+n+<span class="number">1</span>),top=<span class="number">0</span>;</span><br><span class="line">			<span class="built_in">rep</span>(i,<span class="number">1</span>,n) C[i].x=D-C[i].x;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="built_in">reverse</span>(s[k],s[k]+n+<span class="number">1</span>);</span><br><span class="line">			<span class="built_in">rep</span>(i,<span class="number">0</span>,n) s[k][i]=D-s[k][i];</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	db ans=D; <span class="comment">// 减去不合法的</span></span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">0</span>,n) <span class="keyword">if</span>(s[<span class="number">0</span>][i]&gt;s[<span class="number">1</span>][i]) ans-=s[<span class="number">0</span>][i]-s[<span class="number">1</span>][i];</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;%.3lf\n&quot;</span>,ans);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://compilationfail.github.io/oi-solutions/COCI/COCI2010-2011%20Contest#Final%20D%20/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="orangejuice">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="orangejuice's blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | orangejuice's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/oi-solutions/COCI/COCI2010-2011%20Contest#Final%20D%20/" class="post-title-link" itemprop="url">COCI20102011 Contest#Final D (dp)</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2023-08-12 11:05:24 / Modified: 12:45:20" itemprop="dateCreated datePublished" datetime="2023-08-12T11:05:24+08:00">2023-08-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/oi-solutions/" itemprop="url" rel="index"><span itemprop="name">oi-solutions</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="coci20102011-contestfinal-d-dp">COCI20102011 Contest#Final D
(dp)</h1>
<p>我们将一个操作序列看做由左右括号，空格构成的字符串，则序列大致长这个样子</p>
<p><span class="math inline">\(\text{_ ( ( ) _ ( ) ) ( _ ( ( ) ) (
}\)</span></p>
<p>很显然，一个失配的左括号只能在最外层出现，而空格可以出现在任意位置</p>
<p>dp一个括号序列让人想到区间dp，但是这个题目的区间实际只需要用长度就可以描述</p>
<p>令 <span class="math inline">\(dp[t][l][r][f1][f2]\)</span> 表示用
<span class="math inline">\(t\)</span> 的时间从 <span
class="math inline">\(l\)</span> 走到 <span
class="math inline">\(r\)</span> ， <span
class="math inline">\(f1\)</span> 表示是不是最外层括号， <span
class="math inline">\(f2\)</span> 表示当前 <span
class="math inline">\(dp\)</span>
是否受到<strong>单纯括号序列</strong>的限制</p>
<p>其中，引入的<strong>单纯括号序列</strong>是为了防止出现重复转移，其意思就是这个括号序列两端必须是一对匹配的左右括号，而中间随意</p>
<p>转移大致如下:</p>
<p>1.那么对于非单纯的括号序列，可以在序列插入空格或者失配的左括号(需要满足
<span class="math inline">\(f1\)</span> )，从 <span
class="math inline">\(dp[t-1]\)</span> 转移过来</p>
<p>2.对于任何的括号序列，都可以在两端找到匹配的的左右括号，从 <span
class="math inline">\(dp[t-2]\)</span> 转移过来，且完成匹配后 <span
class="math inline">\(f1\)</span> 应为 <span
class="math inline">\(0\)</span></p>
<p>3.且一个非单纯的括号序列是可以分割的，为了不重复，强制分割的左序列是单纯的即可</p>
<p>实际会发现，一个单纯的括号序列可以认为一定不是最外层括号，即 <span
class="math inline">\(f2\)</span> 为真时， <span
class="math inline">\(f1\)</span> 一定为假，所以可以压缩为三种状态</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">long</span> <span class="type">long</span> ll;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> reg register</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> rep(i,a,b) for(reg int i=a;i&lt;=b;++i)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> drep(i,a,b) for(reg int i=a;i&gt;=b;--i)</span></span><br><span class="line"><span class="type">char</span> IO;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">rd</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="type">int</span> s=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(!<span class="built_in">isdigit</span>(IO=<span class="built_in">getchar</span>()));</span><br><span class="line">    <span class="keyword">do</span> s=(s&lt;&lt;<span class="number">1</span>)+(s&lt;&lt;<span class="number">3</span>)+(IO^<span class="string">&#x27;0&#x27;</span>);</span><br><span class="line">    <span class="keyword">while</span>(<span class="built_in">isdigit</span>(IO=<span class="built_in">getchar</span>()));</span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> N=<span class="number">51</span>,P=<span class="number">10007</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> n,m,T;</span><br><span class="line"><span class="type">int</span> E[N][N];</span><br><span class="line"><span class="type">int</span> dp[N][N][N][<span class="number">2</span>][<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    n=<span class="built_in">rd</span>(),m=<span class="built_in">rd</span>(),T=<span class="built_in">rd</span>();</span><br><span class="line">    <span class="built_in">memset</span>(E,<span class="number">-63</span>,<span class="keyword">sizeof</span> E);</span><br><span class="line">    <span class="built_in">rep</span>(i,<span class="number">1</span>,m) &#123;</span><br><span class="line">        <span class="type">int</span> u=<span class="built_in">rd</span>(),v=<span class="built_in">rd</span>(),c=IO==<span class="string">&#x27; &#x27;</span>?<span class="built_in">getchar</span>():IO;</span><br><span class="line">        <span class="keyword">if</span>(c&gt;=<span class="string">&#x27;A&#x27;</span> &amp;&amp; c&lt;=<span class="string">&#x27;Z&#x27;</span>) E[u][v]=c-<span class="string">&#x27;A&#x27;</span>+<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(c&gt;=<span class="string">&#x27;a&#x27;</span> &amp;&amp; c&lt;=<span class="string">&#x27;z&#x27;</span>) E[u][v]=<span class="string">&#x27;a&#x27;</span>-c<span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">else</span> E[u][v]=<span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">rep</span>(i,<span class="number">1</span>,n) <span class="built_in">rep</span>(j,<span class="number">0</span>,<span class="number">1</span>) dp[<span class="number">0</span>][i][i][j][<span class="number">0</span>]=<span class="number">1</span>;</span><br><span class="line">    <span class="built_in">rep</span>(k,<span class="number">1</span>,T)&#123;</span><br><span class="line">        <span class="built_in">rep</span>(l,<span class="number">1</span>,n) <span class="built_in">rep</span>(r,(k&lt;T?<span class="number">1</span>:n),n) <span class="built_in">rep</span>(fl,<span class="number">0</span>,<span class="number">1</span>) <span class="built_in">rep</span>(fl2,<span class="number">0</span>,<span class="number">1</span>) &#123;</span><br><span class="line">            ll res=<span class="number">0</span>;</span><br><span class="line">            <span class="keyword">if</span>(!fl2) &#123;</span><br><span class="line">                <span class="built_in">rep</span>(i,<span class="number">2</span>,k<span class="number">-1</span>) <span class="built_in">rep</span>(j,<span class="number">1</span>,n) res+=dp[i][l][j][<span class="number">0</span>][<span class="number">1</span>]*dp[k-i][j][r][fl][<span class="number">0</span>];</span><br><span class="line">                <span class="built_in">rep</span>(i,<span class="number">1</span>,n) <span class="keyword">if</span>(E[l][i]&gt;=<span class="number">0</span> &amp;&amp; (!E[l][i] || fl)) res+=dp[k<span class="number">-1</span>][i][r][fl][fl2];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(k&gt;<span class="number">1</span>) <span class="built_in">rep</span>(i,<span class="number">1</span>,n)</span><br><span class="line">                <span class="keyword">if</span>(E[l][i]&gt;<span class="number">0</span>) <span class="built_in">rep</span>(j,<span class="number">1</span>,n) </span><br><span class="line">                    <span class="keyword">if</span>(E[j][r]+E[l][i]==<span class="number">0</span>) res+=dp[k<span class="number">-2</span>][i][j][<span class="number">0</span>][<span class="number">0</span>];</span><br><span class="line">            dp[k][l][r][fl][fl2]=res%P;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> ans=<span class="number">0</span>;</span><br><span class="line">    <span class="built_in">rep</span>(i,<span class="number">1</span>,T) ans+=dp[i][<span class="number">1</span>][n][<span class="number">1</span>][<span class="number">0</span>];</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>,ans%P);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://compilationfail.github.io/oi-solutions/Atcoder/ARC117%20-%20Gateau%20/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="orangejuice">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="orangejuice's blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | orangejuice's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/oi-solutions/Atcoder/ARC117%20-%20Gateau%20/" class="post-title-link" itemprop="url">ARC117 - Gateau</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2023-08-12 11:05:24 / Modified: 12:45:20" itemprop="dateCreated datePublished" datetime="2023-08-12T11:05:24+08:00">2023-08-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/oi-solutions/" itemprop="url" rel="index"><span itemprop="name">oi-solutions</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="arc117---gateau">ARC117 - Gateau</h1>
<p>题目大意：给定一个长度为 <span class="math inline">\(2n\)</span>
的非负环序列 <span class="math inline">\(x_0,x_1,\cdots
x_{2n-1}\)</span> ，以及 <span class="math inline">\(2n\)</span>
条限制，每条都是</p>
<p><span class="math inline">\(\forall A_i,\sum_{j=0}^{n-1} x_{i+j\mod
2n}\ge A_i\)</span></p>
<p>求最小化 <span class="math inline">\(\sum x_i\)</span></p>
<hr />
<p><span class="math display">\[  \ \]</span></p>
<p>转化为前缀和作差之后，令人联想到差分约束，但是难以处理跨过环末的限制</p>
<p>于是二分答案 <span class="math inline">\(s=x_{2n-1}\)</span>
，建立最长路图</p>
<p><span class="math inline">\(\forall i&lt;n,dis_{i+n}\ge
dis_{i}+A_i\)</span></p>
<p><span class="math inline">\(\forall i\ge n,dis_{i-n}\ge
dis_{i}+A_i-s\)</span></p>
<p><span class="math inline">\(\forall i&lt;2n-1,dis_{i+1}\leq
dis_i\)</span></p>
<p>那么无解的条件就是：存在正环或者求得 <span
class="math inline">\(dis_{2n-1}&gt;s\)</span></p>
<p>自然无法直接通过 <span class="math inline">\(\text{SPFA}\)</span>
来跑。。。</p>
<p>考虑所有的边构成了一条 <span class="math inline">\(0-2n-1\)</span>
的零链 和若干极小的二元环</p>
<p>如果二元环出现正环则无解，否则任意一条最长路路径总是可以描述为</p>
<p><span class="math inline">\(i&lt;j&lt;n , i(+n)\rightarrow
j(+n)\)</span></p>
<p>在中间点 <span class="math inline">\(k\)</span>
可以选择花费0的代价向后走，或者</p>
<p><span class="math inline">\(k&lt;n:k\rightarrow
k+n,cost=A_k\)</span></p>
<p><span class="math inline">\(k\ge n:k\rightarrow
k-n,cost=A_k-s\)</span></p>
<p>也就是在 <span class="math inline">\(k,k+n\)</span>
之间反复横跳，由此发现一条路径就是</p>
<p>从 <span class="math inline">\(0-n-1\)</span> 进行扫描，并且允许中间
<span class="math inline">\(\pm n\)</span> 横跳</p>
<p>（当然这里漏掉了一个特殊边，即 <span class="math inline">\(dis_{n}\ge
dis_{n-1}\)</span> ，这是构成环的边）</p>
<p>这样写出一个变种的 <span class="math inline">\(\text{Bellman
Ford}\)</span> ，由于图的特殊性，只需要常数轮即可确定正环</p>
<p>具体的，当图上不存在正环时，扫描最多经过一次环就会停止更新</p>
<p>也就是这样横跳的扫描更新只会进行常数轮（2轮？）</p>
<p>如果若干轮后依然在更新，说明出现了正环</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">long</span> <span class="type">long</span> ll;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> ull;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">double</span> db;</span><br><span class="line"><span class="keyword">typedef</span> pair &lt;<span class="type">int</span>,<span class="type">int</span>&gt; Pii;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> reg register</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> mp make_pair</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> pb push_back</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> Mod1(x) ((x&gt;=P)&amp;&amp;(x-=P))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> Mod2(x) ((x&lt;0)&amp;&amp;(x+=P))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> rep(i,a,b) for(int i=a,i##end=b;i&lt;=i##end;++i)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> drep(i,a,b) for(int i=a,i##end=b;i&gt;=i##end;--i)</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt; <span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">cmin</span><span class="params">(T &amp;a,T b)</span></span>&#123; ((a&gt;b)&amp;&amp;(a=b)); &#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">cmax</span><span class="params">(<span class="type">int</span> &amp;a,<span class="type">int</span> b)</span></span>&#123; <span class="keyword">return</span> a&lt;b?a=b,<span class="number">1</span>:<span class="number">0</span>; &#125;</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> IO;</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">T</span>=<span class="type">int</span>&gt; T <span class="built_in">rd</span>()&#123;</span><br><span class="line">	T s=<span class="number">0</span>; <span class="type">int</span> f=<span class="number">0</span>;</span><br><span class="line">	<span class="keyword">while</span>(!<span class="built_in">isdigit</span>(IO=<span class="built_in">getchar</span>())) f|=IO==<span class="string">&#x27;-&#x27;</span>;</span><br><span class="line">	<span class="keyword">do</span> s=(s&lt;&lt;<span class="number">1</span>)+(s&lt;&lt;<span class="number">3</span>)+(IO^<span class="string">&#x27;0&#x27;</span>);</span><br><span class="line">	<span class="keyword">while</span>(<span class="built_in">isdigit</span>(IO=<span class="built_in">getchar</span>()));</span><br><span class="line">	<span class="keyword">return</span> f?-s:s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> N=<span class="number">3e5</span>+<span class="number">10</span>,INF=<span class="number">1e9</span>+<span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> n;</span><br><span class="line"><span class="type">int</span> A[N],dp[N];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Check</span><span class="params">(<span class="type">int</span> s)</span> </span>&#123;</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">0</span>,n<span class="number">-1</span>) <span class="keyword">if</span>(A[i]+A[i+n]-s&gt;<span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">0</span>,n*<span class="number">2</span><span class="number">-1</span>) dp[i]=<span class="number">0</span>;</span><br><span class="line">	dp[n*<span class="number">2</span><span class="number">-1</span>]=s;</span><br><span class="line">	<span class="type">int</span> f=<span class="number">0</span>;</span><br><span class="line">	<span class="built_in">rep</span>(k,<span class="number">0</span>,<span class="number">5</span>) &#123; </span><br><span class="line">		f=<span class="number">0</span>;</span><br><span class="line">		<span class="built_in">rep</span>(i,<span class="number">0</span>,n<span class="number">-1</span>) &#123;</span><br><span class="line">			f|=<span class="built_in">cmax</span>(dp[i+n],dp[i]+A[i]);</span><br><span class="line">			f|=<span class="built_in">cmax</span>(dp[i],dp[i+n]+A[i+n]-s);</span><br><span class="line">			<span class="keyword">if</span>(i&lt;n<span class="number">-1</span>) &#123;</span><br><span class="line">				f|=<span class="built_in">cmax</span>(dp[i+<span class="number">1</span>],dp[i]);</span><br><span class="line">				f|=<span class="built_in">cmax</span>(dp[i+n+<span class="number">1</span>],dp[i+n]);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		f|=<span class="built_in">cmax</span>(dp[n],dp[n<span class="number">-1</span>]);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(f || dp[n*<span class="number">2</span><span class="number">-1</span>]&gt;s) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	n=<span class="built_in">rd</span>();</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">0</span>,n*<span class="number">2</span><span class="number">-1</span>) A[i]=<span class="built_in">rd</span>();</span><br><span class="line">	<span class="type">int</span> res=<span class="number">-1</span>;</span><br><span class="line">	<span class="keyword">for</span>(<span class="type">int</span> l=<span class="number">0</span>,r=<span class="number">1.05e9</span>,mid;l&lt;=r;) <span class="built_in">Check</span>(mid=(l+r)&gt;&gt;<span class="number">1</span>)?r=mid<span class="number">-1</span>,res=mid:l=mid+<span class="number">1</span>;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>,res);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://compilationfail.github.io/oi-solutions/COCI/COCI2013-2014%20Contest#1%20F%20/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="orangejuice">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="orangejuice's blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | orangejuice's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/oi-solutions/COCI/COCI2013-2014%20Contest#1%20F%20/" class="post-title-link" itemprop="url">COCI2013-2014 Contest#1 F  SLASTIČAR</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2023-08-12 11:05:24 / Modified: 12:45:20" itemprop="dateCreated datePublished" datetime="2023-08-12T11:05:24+08:00">2023-08-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/oi-solutions/" itemprop="url" rel="index"><span itemprop="name">oi-solutions</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="coci2013-2014-contest1-f-slastičar">COCI2013-2014 Contest#1 F
SLASTIČAR</h1>
<p>其实挺妙的一个数据结构题</p>
<p>题意: 给定一个A串，对于查询的每个 <span
class="math inline">\(B\)</span> 串，从头开始匹配匹配 <span
class="math inline">\(A\)</span> 的每个后缀，每次匹配失败的代价是 <span
class="math inline">\(\text{LCP}+1\)</span> 可，匹配成功的代价是 <span
class="math inline">\(|B|\)</span> ，且立即停止，求代价总和</p>
<p>设 <span class="math inline">\(A\)</span> 串长为 <span
class="math inline">\(n\)</span> ，查询个数为 <span
class="math inline">\(q\)</span> ，查询总长为 <span
class="math inline">\(m\)</span></p>
<p>我们知道求两个串的 <span class="math inline">\(\text{LCP}\)</span>
可以把两个串中间放一个符号分开，跑后缀数组/后缀自动机</p>
<p>但是首先是 <span class="math inline">\(m=3\cdot 10^6\)</span>
，内存就开不下</p>
<p>而且发现，如果 <span class="math inline">\(|B|\)</span>
的某个前缀未出现在 <span class="math inline">\(A\)</span>
中，后面的部分都不造成贡献，所以可以在 <span
class="math inline">\(A\)</span> 串中定位 <span
class="math inline">\(B\)</span> 的每个前缀</p>
<p>这样就只需要求 <span class="math inline">\(A\)</span>
的后缀数组即可，然而，这个并不好实现</p>
<p>假设当前已经定位了一个长度为 <span class="math inline">\(i\)</span>
的前缀，其对应的合法后缀排名范围为 <span
class="math inline">\([L_i,R_i]\)</span></p>
<p>那么接下来就是在当前前缀上接上下一个字符 <span
class="math inline">\(c\)</span> ，这个如果再外加数据结构并不好实现</p>
<p>考虑后缀数组的性质， <span class="math inline">\([L_i,R_i]\)</span>
这些后缀前 <span class="math inline">\(d\)</span> 个字符相同， <span
class="math inline">\(d+1\)</span> 个字符呈单调非递减</p>
<p>所以字符 <span class="math inline">\(c\)</span>
出现的范围也一定是一段区间，可以直接两次二分得到</p>
<p>这样查询 <span class="math inline">\([L_i,R_i]\)</span> 的复杂度为
<span class="math inline">\(\log n\)</span> ，这样就用 <span
class="math inline">\(O(m\log n)\)</span> 的复杂度完成了串定位</p>
<p>如果不考虑每次完成匹配后停止，其实答案就是 <span
class="math inline">\(\sum R_i-L_i+1\)</span> ，即 <span
class="math inline">\(\sum_i LCP_i=\sum_i \sum_j [LCP_j\ge
i]\)</span></p>
<p>设最终的匹配位置为 <span class="math inline">\(p\)</span>
，这个位置可以用线段树在最后的一段 <span
class="math inline">\([L_{|B|},R_{|B|}]\)</span> 中求最小值得到</p>
<p>考虑减掉多余的部分，即减去实际位置 <span
class="math inline">\(&gt;p\)</span> 的且在后缀数组排名在 <span
class="math inline">\([L_i,R_i]\)</span> 中的部分</p>
<p>可以把所有的 <span class="math inline">\([L_i,R_i]\)</span>
拿出来作为，离线询问，用树状数组维护查询，复杂度为 <span
class="math inline">\(O((n+m)\log n)\)</span></p>
<p>因此总复杂度为 <span class="math inline">\(O((n+m)\log
n)\)</span></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">long</span> <span class="type">long</span> ll;</span><br><span class="line"><span class="keyword">typedef</span> pair &lt;<span class="type">int</span>,<span class="type">int</span>&gt; Pii;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> reg register</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> pb push_back</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> mp make_pair</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> rep(i,a,b) for(int i=a,i##end=b;i&lt;=i##end;++i)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> drep(i,a,b) for(int i=a,i##end=b;i&gt;=i##end;--i)</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt; <span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">cmin</span><span class="params">(T &amp;a,<span class="type">const</span> T &amp;b)</span></span>&#123; ((a&gt;b)&amp;&amp;(a=b)); &#125;</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt; <span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">cmax</span><span class="params">(T &amp;a,<span class="type">const</span> T &amp;b)</span></span>&#123; ((a&lt;b)&amp;&amp;(a=b)); &#125;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> N=<span class="number">1e5</span>+<span class="number">10</span>,M=<span class="number">3e6</span>+<span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> n,m;</span><br><span class="line"><span class="type">char</span> s[N],t[N];</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> rk[N&lt;&lt;<span class="number">1</span>],tmp[N],cnt[N],sa[N];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Build</span><span class="params">(<span class="type">int</span> n)</span></span>&#123;</span><br><span class="line">    <span class="built_in">rep</span>(i,<span class="number">1</span>,n) cnt[<span class="built_in">int</span>(s[i])]++;</span><br><span class="line">    <span class="built_in">rep</span>(i,<span class="number">1</span>,<span class="number">200</span>) cnt[i]+=cnt[i<span class="number">-1</span>];</span><br><span class="line">    <span class="built_in">rep</span>(i,<span class="number">1</span>,n) rk[i]=cnt[(<span class="type">int</span>)s[i]],sa[i]=i;</span><br><span class="line">    <span class="keyword">for</span>(reg <span class="type">int</span> k=<span class="number">1</span>;k&lt;n;k&lt;&lt;=<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span>(reg <span class="type">int</span> i=<span class="number">0</span>;i&lt;=n;++i) cnt[i]=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(reg <span class="type">int</span> i=<span class="number">1</span>;i&lt;=n;++i) cnt[rk[i+k]]++;</span><br><span class="line">        <span class="keyword">for</span>(reg <span class="type">int</span> i=<span class="number">1</span>;i&lt;=n;++i) cnt[i]+=cnt[i<span class="number">-1</span>];</span><br><span class="line">        <span class="keyword">for</span>(reg <span class="type">int</span> i=n;i&gt;=<span class="number">1</span>;--i) tmp[cnt[rk[i+k]]--]=i;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(reg <span class="type">int</span> i=<span class="number">0</span>;i&lt;=n;++i) cnt[i]=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(reg <span class="type">int</span> i=<span class="number">1</span>;i&lt;=n;++i) cnt[rk[i]]++;</span><br><span class="line">        <span class="keyword">for</span>(reg <span class="type">int</span> i=<span class="number">1</span>;i&lt;=n;++i) cnt[i]+=cnt[i<span class="number">-1</span>];</span><br><span class="line">        <span class="keyword">for</span>(reg <span class="type">int</span> i=n;i&gt;=<span class="number">1</span>;--i) sa[cnt[rk[tmp[i]]]--]=tmp[i];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(reg <span class="type">int</span> i=<span class="number">1</span>;i&lt;=n;++i) tmp[sa[i]]=tmp[sa[i<span class="number">-1</span>]]+(rk[sa[i]]!=rk[sa[i<span class="number">-1</span>]]||rk[sa[i]+k]!=rk[sa[i<span class="number">-1</span>]+k]);</span><br><span class="line">        <span class="keyword">for</span>(reg <span class="type">int</span> i=<span class="number">1</span>;i&lt;=n;++i) rk[i]=tmp[i];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">FindChar</span><span class="params">(<span class="type">int</span> &amp;l,<span class="type">int</span> &amp;r,<span class="type">int</span> len,<span class="type">int</span> c)</span></span>&#123;</span><br><span class="line">    <span class="type">int</span> tl=l,tr=r;</span><br><span class="line">    <span class="type">int</span> lres=<span class="number">-1</span>,rres=<span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">while</span>(l&lt;=r)&#123;</span><br><span class="line">        <span class="type">int</span> mid=(l+r)&gt;&gt;<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span>(s[sa[mid]+len]&lt;=c) l=mid+<span class="number">1</span>,lres=mid;</span><br><span class="line">        <span class="keyword">else</span> r=mid<span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(lres==<span class="number">-1</span> || s[sa[lres]+len]!=c) &#123; l=<span class="number">0</span>; <span class="keyword">return</span>; &#125;</span><br><span class="line">    l=tl,r=tr;</span><br><span class="line">    <span class="keyword">while</span>(l&lt;=r)&#123;</span><br><span class="line">        <span class="type">int</span> mid=(l+r)&gt;&gt;<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span>(s[sa[mid]+len]&gt;=c) r=mid<span class="number">-1</span>,rres=mid;</span><br><span class="line">        <span class="keyword">else</span> l=mid+<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    l=rres,r=lres;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ll ans[N];</span><br><span class="line"><span class="type">int</span> ql[M],qr[M],qid[M],qnxt[M];</span><br><span class="line"><span class="type">int</span> head[N],qc;</span><br><span class="line"><span class="type">int</span> L[N],R[N];</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">BIT</span>&#123;</span><br><span class="line">    <span class="type">int</span> s[N];</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Add</span><span class="params">(<span class="type">int</span> p)</span> </span>&#123; <span class="keyword">while</span>(p&lt;=n) s[p]++,p+=p&amp;-p; &#125;</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">Que</span><span class="params">(<span class="type">int</span> p)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> res=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>(p) res+=s[p],p-=p&amp;-p;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">Que</span><span class="params">(<span class="type">int</span> l,<span class="type">int</span> r)</span></span>&#123; <span class="keyword">return</span> <span class="built_in">Que</span>(r)-<span class="built_in">Que</span>(l<span class="number">-1</span>); &#125;</span><br><span class="line">&#125; T;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Tree</span>&#123;</span><br><span class="line">    <span class="type">int</span> s[N&lt;&lt;<span class="number">2</span>];</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Build</span><span class="params">(<span class="type">int</span> p,<span class="type">int</span> l,<span class="type">int</span> r)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(l==r) &#123; s[p]=sa[l]; <span class="keyword">return</span> ;&#125;</span><br><span class="line">        <span class="type">int</span> mid=(l+r)&gt;&gt;<span class="number">1</span>;</span><br><span class="line">        <span class="built_in">Build</span>(p&lt;&lt;<span class="number">1</span>,l,mid),<span class="built_in">Build</span>(p&lt;&lt;<span class="number">1</span>|<span class="number">1</span>,mid+<span class="number">1</span>,r);</span><br><span class="line">        s[p]=<span class="built_in">min</span>(s[p&lt;&lt;<span class="number">1</span>],s[p&lt;&lt;<span class="number">1</span>|<span class="number">1</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">Que</span><span class="params">(<span class="type">int</span> p,<span class="type">int</span> l,<span class="type">int</span> r,<span class="type">int</span> ql,<span class="type">int</span> qr)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(ql&lt;=l &amp;&amp; r&lt;=qr) <span class="keyword">return</span> s[p];</span><br><span class="line">        <span class="type">int</span> mid=(l+r)&gt;&gt;<span class="number">1</span>,res=<span class="number">1e9</span>;</span><br><span class="line">        <span class="keyword">if</span>(ql&lt;=mid) <span class="built_in">cmin</span>(res,<span class="built_in">Que</span>(p&lt;&lt;<span class="number">1</span>,l,mid,ql,qr));</span><br><span class="line">        <span class="keyword">if</span>(qr&gt;mid) <span class="built_in">cmin</span>(res,<span class="built_in">Que</span>(p&lt;&lt;<span class="number">1</span>|<span class="number">1</span>,mid+<span class="number">1</span>,r,ql,qr));</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;SGT;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d%s&quot;</span>,&amp;n,s+<span class="number">1</span>);</span><br><span class="line">    <span class="built_in">Build</span>(n),<span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>,&amp;m);</span><br><span class="line">    SGT.<span class="built_in">Build</span>(<span class="number">1</span>,<span class="number">1</span>,n);</span><br><span class="line">    <span class="built_in">rep</span>(i,<span class="number">1</span>,m) &#123;</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">&quot;%s&quot;</span>,t+<span class="number">1</span>);</span><br><span class="line">        L[<span class="number">0</span>]=<span class="number">1</span>,R[<span class="number">0</span>]=n;</span><br><span class="line">        <span class="type">int</span> len=<span class="number">0</span>,pos=<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> j=<span class="number">1</span>;t[j];++j) &#123;</span><br><span class="line">            L[len=j]=L[j<span class="number">-1</span>],R[j]=R[j<span class="number">-1</span>];</span><br><span class="line">            <span class="built_in">FindChar</span>(L[j],R[j],j<span class="number">-1</span>,t[j]);</span><br><span class="line">            <span class="keyword">if</span>(!L[j])&#123; pos=<span class="number">0</span>; <span class="keyword">break</span>; &#125;</span><br><span class="line">            ans[i]+=R[j]-L[j]+<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(pos &amp;&amp; (pos=SGT.<span class="built_in">Que</span>(<span class="number">1</span>,<span class="number">1</span>,n,L[len],R[len]))&lt;n) &#123;</span><br><span class="line">            ans[i]+=pos<span class="number">-1</span>,pos++;</span><br><span class="line">            <span class="built_in">rep</span>(j,<span class="number">1</span>,len)&#123;</span><br><span class="line">                qc++,ql[qc]=L[j],qr[qc]=R[j],qid[qc]=i,qnxt[qc]=head[pos];</span><br><span class="line">                head[pos]=qc;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> ans[i]+=n;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">drep</span>(i,n,<span class="number">1</span>)&#123;</span><br><span class="line">        T.<span class="built_in">Add</span>(rk[i]);</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> j=head[i];j;j=qnxt[j]) ans[qid[j]]-=T.<span class="built_in">Que</span>(ql[j],qr[j]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">rep</span>(i,<span class="number">1</span>,m) <span class="built_in">printf</span>(<span class="string">&quot;%lld\n&quot;</span>,ans[i]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://compilationfail.github.io/oi-solutions/COCI/COCI20162017%20Contest#2%20F%20/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="orangejuice">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="orangejuice's blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | orangejuice's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/oi-solutions/COCI/COCI20162017%20Contest#2%20F%20/" class="post-title-link" itemprop="url">COCI2016-2017 Contest#2 F</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2023-08-12 11:05:24 / Modified: 12:45:20" itemprop="dateCreated datePublished" datetime="2023-08-12T11:05:24+08:00">2023-08-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/oi-solutions/" itemprop="url" rel="index"><span itemprop="name">oi-solutions</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="coci2016-2017-contest2-f">COCI2016-2017 Contest#2 F</h1>
<p>首先分析题意: 任意走都能在 <span class="math inline">\(k\)</span>
步内结束，也就是说，一定可以在 <span class="math inline">\(k\)</span>
步内封锁所有出路</p>
<p>注意游戏停止的条件是后手不能走，因此即使在 <span
class="math inline">\(k\)</span>
步封住了出路，下一轮依然要标记一个点</p>
<p>因此必须是 <span class="math inline">\(&lt;k\)</span> 的</p>
<p>设树根1的 <span class="math inline">\(dep=0\)</span> ，第 <span
class="math inline">\(i\)</span> 层表示所有 <span
class="math inline">\(dep=i\)</span> 的节点</p>
<p>发现第 <span class="math inline">\(i\)</span> 次操作，一定是从 <span
class="math inline">\(i-1\)</span> 层走到了 <span
class="math inline">\(i\)</span></p>
<p>假设最后的封路决策在 <span class="math inline">\(i\)</span>
层封掉了2个点，那么这个决策一定是不优的</p>
<p>因为在 <span class="math inline">\(i\)</span> 层花2的时间一定不如在
<span class="math inline">\(i-1\)</span> 层和 <span
class="math inline">\(i\)</span> 层各花1的时间</p>
<p>因此，问题可以转化为: 在 <span class="math inline">\(1-k\)</span>
层每层选择一个点，判断是否存在一种方案使得选择完成后完全封死出路</p>
<p>显然在最优情况下，选择的点之间不会有祖先关系，并且我们可以删掉所有
<span class="math inline">\(dep&gt;k\)</span> 的点</p>
<p>因此可以写出一个 <span class="math inline">\(n\cdot 2^k\)</span> 的
<span class="math inline">\(dp\)</span></p>
<p>由于最后要阻塞其实是阻塞所有的叶子( <span
class="math inline">\(dep=k\)</span> 的点)</p>
<p>因此考虑令选择每个节点是覆盖了一段叶子，将叶子按照 <span
class="math inline">\(\text{dfs}\)</span> 序从小到大依次标号，设选择
<span class="math inline">\(i\)</span> 子树能覆盖叶子范围 <span
class="math inline">\(L_i,R_i\)</span></p>
<p>因此按照 <span class="math inline">\(L_i\)</span>
从小到大依次考虑每个节点，加入的转移就是</p>
<p><span class="math inline">\(\begin{aligned} dep_i\notin
S,dp_{L_i,S}\rightarrow dp_{R_i+1,S\cup \lbrace dep_i\rbrace
}\end{aligned}\)</span></p>
<p>如果用bitset实现，时间/空间复杂度均为 <span class="math inline">\(O(n
\cdot 2^{k-5})\)</span></p>
<p>如果直接 <span class="math inline">\(dp\)</span> 显然。。。考虑缩小
<span class="math inline">\(k\)</span> 的范围</p>
<p>推论1: 当 <span class="math inline">\(n&lt; \frac{(k-1)\cdot
(k+2)}{2}\)</span> 时，一定有解</p>
<p>考虑一个浅显的贪心： 在第 <span class="math inline">\(i\)</span> 层用
<span class="math inline">\(\leq i\)</span> 的代价标记这层所有点</p>
<p>这个方法不可用的条件就是第 <span class="math inline">\(i\)</span>
层的点个数 <span class="math inline">\(&gt;i\)</span> ，那么就有 <span
class="math inline">\(n\ge
2+3+\cdots+k=\frac{(k-1)(k+2)}{2}\)</span></p>
<p>可以看到此时 <span class="math inline">\(k\)</span> 的上界已经缩小到
<span class="math inline">\(O(\sqrt n)\)</span>
级别，但由于实际常数，还是太大了</p>
<p><span class="math display">\[ \ \]</span></p>
<p>推论2: 当 <span class="math inline">\(n\leq k\cdot k\)</span>
时，一定有解</p>
<p>假设删除原树的1节点，则我们决策的对象变为一片森林</p>
<p>考虑依次决策每一层，每次推进一层，都会把选择一棵树删除，并且当前森林所有顶端的节点删除</p>
<p>要求 <span class="math inline">\(k\)</span> 次决策后森林为空</p>
<p>设森林第一层包含 <span class="math inline">\(d\)</span> 个节点</p>
<p>此时一定存在一个子树大小 <span class="math inline">\(\ge
\frac{n}{d}\)</span></p>
<p>删除这个子树后，规模变为 <span
class="math inline">\(n-d-\frac{n}{d}+1\)</span></p>
<p>我们知道 <span class="math inline">\(d+\frac{n}{d}\ge 2\sqrt
n\)</span></p>
<p><span class="math inline">\(n-d-\frac{n}{d}+1\leq n-2\sqrt n+1=(\sqrt
n-1)^2\)</span></p>
<p>因此得证</p>
<p>此时 <span class="math inline">\(k\)</span>
的上界已经缩小到19，完全可以通过</p>
<p>带入优化的复杂度为 <span class="math inline">\(O(n\cdot
2^{15})\)</span></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> GCC optimize(2)</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">long</span> <span class="type">long</span> ll;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> reg register</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> pb push_back</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> rep(i,a,b) for(int i=a,i##end=b;i&lt;=i##end;++i)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> drep(i,a,b) for(int i=a,i##end=b;i&gt;=i##end;--i)</span></span><br><span class="line"></span><br><span class="line"><span class="type">char</span> IO;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">rd</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="type">int</span> s=<span class="number">0</span>;</span><br><span class="line">	<span class="keyword">while</span>(!<span class="built_in">isdigit</span>(IO=<span class="built_in">getchar</span>()));</span><br><span class="line">	<span class="keyword">do</span> s=(s&lt;&lt;<span class="number">1</span>)+(s&lt;&lt;<span class="number">3</span>)+(IO^<span class="string">&#x27;0&#x27;</span>);</span><br><span class="line">	<span class="keyword">while</span>(<span class="built_in">isdigit</span>(IO=<span class="built_in">getchar</span>()));</span><br><span class="line">	<span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> N=<span class="number">410</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> n,m;</span><br><span class="line">vector &lt;<span class="type">int</span>&gt; G[N],Q[N];</span><br><span class="line"><span class="type">int</span> dep[N],L[N],R[N],cnt;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">pre_dfs</span><span class="params">(<span class="type">int</span> u,<span class="type">int</span> f)</span> </span>&#123;</span><br><span class="line">	dep[u]=dep[f]+<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">if</span>(dep[u]==m<span class="number">-1</span>) &#123; L[u]=cnt++,R[u]=cnt; <span class="keyword">return</span>; &#125;</span><br><span class="line">	L[u]=cnt;</span><br><span class="line">	<span class="keyword">for</span>(<span class="type">int</span> v:G[u]) <span class="keyword">if</span>(v!=f) <span class="built_in">pre_dfs</span>(v,u);</span><br><span class="line">	R[u]=cnt;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">bitset &lt;1&lt;&lt;19&gt; dp[<span class="number">401</span>],rev[<span class="number">20</span>];</span><br><span class="line"><span class="type">int</span> F[N]; </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	n=<span class="built_in">rd</span>(),m=<span class="built_in">rd</span>();</span><br><span class="line">	<span class="keyword">if</span>(m*m&gt;=n) <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;DA&quot;</span>),<span class="number">0</span>;</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">2</span>,n) &#123;</span><br><span class="line">		<span class="type">int</span> u=<span class="built_in">rd</span>(),v=<span class="built_in">rd</span>();</span><br><span class="line">		G[u].<span class="built_in">pb</span>(v),G[v].<span class="built_in">pb</span>(u);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">memset</span>(dep,<span class="number">-1</span>,<span class="keyword">sizeof</span> dep),dep[<span class="number">0</span>]=<span class="number">-2</span>,<span class="built_in">pre_dfs</span>(<span class="number">1</span>,<span class="number">0</span>);</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">1</span>,n) <span class="keyword">if</span>(~dep[i]) Q[L[i]].<span class="built_in">pb</span>(i);</span><br><span class="line">	dp[<span class="number">0</span>][<span class="number">0</span>]=<span class="number">1</span>;</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">0</span>,m<span class="number">-1</span>) <span class="built_in">rep</span>(j,<span class="number">0</span>,(<span class="number">1</span>&lt;&lt;m)<span class="number">-1</span>) <span class="keyword">if</span>(~j&amp;(<span class="number">1</span>&lt;&lt;i)) rev[i][j]=<span class="number">1</span>;</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">0</span>,cnt<span class="number">-1</span>) </span><br><span class="line">		<span class="keyword">for</span>(<span class="type">int</span> v:Q[i]) &#123;</span><br><span class="line">			dp[R[v]]|=(dp[i]&amp;rev[dep[v]])&lt;&lt;(<span class="number">1</span>&lt;&lt;dep[v]);</span><br><span class="line">		&#125;</span><br><span class="line">	<span class="built_in">puts</span>(dp[cnt].<span class="built_in">count</span>()?<span class="string">&quot;DA&quot;</span>:<span class="string">&quot;NE&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://compilationfail.github.io/oi-solutions/Atcoder/ARC115%20#D/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="orangejuice">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="orangejuice's blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | orangejuice's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/oi-solutions/Atcoder/ARC115%20#D/" class="post-title-link" itemprop="url">[AtCoder Regular Contest 115](https://atcoder.jp/contests/arc115) #D</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2023-08-12 11:05:24 / Modified: 12:45:20" itemprop="dateCreated datePublished" datetime="2023-08-12T11:05:24+08:00">2023-08-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/oi-solutions/" itemprop="url" rel="index"><span itemprop="name">oi-solutions</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="atcoder-regular-contest-115-d"><a
target="_blank" rel="noopener" href="https://atcoder.jp/contests/arc115">AtCoder Regular Contest
115</a> #D</h1>
<h3 id="solution1">Solution1</h3>
<p>考虑用 <span class="math inline">\(\text{FWT}\)</span>
来理解这个式子，容易发现 <span class="math inline">\(\text{FWT}\)</span>
之后求积的式子，满足</p>
<p>对于任意 <span class="math inline">\((u_i,v_i)\)</span></p>
<p>如果 <span class="math inline">\(u_i,v_i\)</span>
中有一者被选择，答案为0，否则权值 <span class="math inline">\(\times
2\)</span></p>
<p>那么显然对于一个连通块，设其大小为 <span
class="math inline">\(c\)</span> ，放在一起考虑</p>
<p>在 <span class="math inline">\(\text{FWT}\)</span>
的式子里它们同时出现或者同时不出现</p>
<p>枚举最后 <span class="math inline">\(\text{FWT}\)</span>
回来时的项与在这 <span class="math inline">\(c\)</span> 个位置中出现
<span class="math inline">\(i\)</span> 个</p>
<p>对于选择这个连通块的情况，贡献为 <span
class="math inline">\((-1)^i\)</span></p>
<p>对于不选的情况，贡献为 <span class="math inline">\(1\)</span></p>
<p>显然只有 <span class="math inline">\(2|i\)</span>
时贡献为2，乘上组合数完成转移，连通块之间背包合并</p>
<p>就能得到最终计算答案的项中出现了几个1，然后与 <span
class="math inline">\(\text{FWT}\)</span> 的系数合并即可</p>
<p><span class="math display">\[  \ \]</span></p>
<h3 id="solution2">Solution2</h3>
<p>对于一个连通块，考虑取出一个生成树</p>
<p>容易发现，仅使用这个生成树上的边，就能构成任何一个包含 <span
class="math inline">\(2k\)</span> 个奇点的情况</p>
<p>对于多余的边，类似异或线性基，它们都是可选可不选的</p>
<p>于是直接统计答案即可</p>
<p>Sol1 和 Sol2 的式子是一样的</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> <span class="type">int</span> N=<span class="number">5010</span>,P=<span class="number">998244353</span>;</span><br><span class="line"><span class="type">int</span> n,m,dp[N];</span><br><span class="line"><span class="function">ll <span class="title">qpow</span><span class="params">(ll x,ll k=P<span class="number">-2</span>)</span></span>&#123;</span><br><span class="line">	ll res=<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">for</span>(;k;k&gt;&gt;=<span class="number">1</span>,x=x*x%P) <span class="keyword">if</span>(k&amp;<span class="number">1</span>) res=res*x%P;</span><br><span class="line">	<span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line">vector &lt;<span class="type">int</span>&gt; G[N];</span><br><span class="line"><span class="type">int</span> c,vis[N],C[N][N];</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">dfs</span><span class="params">(<span class="type">int</span> u)</span></span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(vis[u]) <span class="keyword">return</span>;</span><br><span class="line">	vis[u]=<span class="number">1</span>,c++;</span><br><span class="line">	<span class="keyword">for</span>(<span class="type">int</span> v:G[u]) <span class="built_in">dfs</span>(v);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	n=<span class="built_in">rd</span>(),m=<span class="built_in">rd</span>();</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">0</span>,n) <span class="built_in">rep</span>(j,*C[i]=<span class="number">1</span>,i) C[i][j]=C[i<span class="number">-1</span>][j]+C[i<span class="number">-1</span>][j<span class="number">-1</span>],<span class="built_in">Mod1</span>(C[i][j]);</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">1</span>,m) &#123;</span><br><span class="line">		<span class="type">int</span> u=<span class="built_in">rd</span>(),v=<span class="built_in">rd</span>();</span><br><span class="line">		G[u].<span class="built_in">pb</span>(v),G[v].<span class="built_in">pb</span>(u);</span><br><span class="line">	&#125;</span><br><span class="line">	dp[<span class="number">0</span>]=<span class="number">1</span>;</span><br><span class="line">	<span class="built_in">rep</span>(u,<span class="number">1</span>,n) <span class="keyword">if</span>(!vis[u]) &#123;</span><br><span class="line">		c=<span class="number">0</span>,<span class="built_in">dfs</span>(u);</span><br><span class="line">		<span class="built_in">drep</span>(i,n,<span class="number">0</span>) &#123;</span><br><span class="line">			<span class="type">int</span> s=<span class="number">0</span>;</span><br><span class="line">			<span class="built_in">rep</span>(j,<span class="number">0</span>,<span class="built_in">min</span>(i,c)) <span class="keyword">if</span>(~j&amp;<span class="number">1</span>) &#123;</span><br><span class="line">				s=(s+<span class="number">2ll</span>*dp[i-j]*C[c][j])%P;</span><br><span class="line">			&#125;</span><br><span class="line">			dp[i]=s;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="type">int</span> d=<span class="built_in">qpow</span>(<span class="number">2</span>,P<span class="number">-1</span>-n+m);</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">0</span>,n) <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>,<span class="built_in">int</span>(<span class="number">1ll</span>*dp[i]*d%P));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://compilationfail.github.io/oi-solutions/COCI/COCI20162017%20Contest#3%20F%20/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="orangejuice">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="orangejuice's blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | orangejuice's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/oi-solutions/COCI/COCI20162017%20Contest#3%20F%20/" class="post-title-link" itemprop="url">COCI2016/2017 Contest#3 F Meksikanac</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2023-08-12 11:05:24 / Modified: 12:45:20" itemprop="dateCreated datePublished" datetime="2023-08-12T11:05:24+08:00">2023-08-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/oi-solutions/" itemprop="url" rel="index"><span itemprop="name">oi-solutions</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="coci20162017-contest3-f-meksikanac">COCI2016/2017 Contest#3 F
Meksikanac</h1>
<p>设 <span class="math inline">\(M=\max\lbrace
X_p,Y_p\rbrace\)</span></p>
<h2 id="分析">分析:</h2>
<p>给定的多边形很难直接处理</p>
<p>如果直接枚举平移位置，然后判断每个点是否在多边形内部</p>
<p>由于不是凸包，判断点的位置可以用1.射线法,2.转角判断是否是360</p>
<p>一次判断复杂度为 <span class="math inline">\(O(K)\)</span>
，因此复杂度为 <span class="math inline">\(O(M^2\cdot N\cdot K)\)</span>
，显然不可取</p>
<p>但是观察题目的条件，不管怎么移动，多边形都只包含一些整点</p>
<p>由于多边形内的整点只有 <span class="math inline">\(O(M^2)\)</span>
个，如果能全部求出，直接匹配判断会方便很多，且复杂度降为 <span
class="math inline">\(O(M^4)\)</span></p>
<p>那么如何求出多边形内部的整点?</p>
<h3 id="做法1">做法1</h3>
<p>考虑枚举每个点，暴力判断，复杂度为 <span
class="math inline">\(O(M^2K)\)</span></p>
<h3 id="做法2">做法2</h3>
<p>考虑枚举 <span class="math inline">\(x\)</span>
一维，像写扫描线一样，把所有合法的 <span
class="math inline">\(y\)</span> 扫描出来(跨过奇数次在内部)</p>
<p>复杂度为 <span class="math inline">\(O(MK\log K)\)</span> 或者可能
<span class="math inline">\(O(MK)\)</span></p>
<p><span class="math display">\[ \ \]</span></p>
<h3 id="优化">优化</h3>
<p>发现转化后，问题变为了 :</p>
<p>给定点集 <span class="math inline">\(A,B\)</span> ，判断将 <span
class="math inline">\(A\)</span> 点集平移 <span
class="math inline">\((dx,dy)\)</span> 后，是否存在点与 <span
class="math inline">\(B\)</span> 中重合</p>
<p>考虑这个问题的一维情形:</p>
<p>在给定的数轴上的 <span class="math inline">\([0,M]\)</span> 内部有
<span class="math inline">\(A,B\)</span> 两个数集</p>
<p>那么出现重合的平移量即 <span class="math inline">\(B_i-A_j\)</span>
，这个问题可以用一次卷积解决，复杂度为 <span
class="math inline">\(O(M\log M)\)</span></p>
<p><span class="math display">\[ \ \]</span></p>
<p>类似的，将 <span class="math inline">\(x,y\)</span>
两维压在一起，做类似的卷积就可以判断 <span
class="math inline">\((dx,dy)\)</span> 是否合法了</p>
<p>复杂度为 <span class="math inline">\(O(M^2\log M^2)=O(M^2\log
M)\)</span></p>
<p>实现上的话，把 <span class="math inline">\((x,y)\)</span> 变为 <span
class="math inline">\(x\cdot (y_p+2)+y\)</span> 即可</p>
<p>注意这里的减法向下溢出没有关系，因为溢出的部分恰好不会被调用到</p>
<p><span class="math display">\[ \ \]</span></p>
<p>综上，总复杂度为 <span class="math inline">\(O(KM+M^2\log
M)\)</span></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">long</span> <span class="type">long</span> ll;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> reg register</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> Mod1(x) ((x&gt;=P)&amp;&amp;(x-=P))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> Mod2(x) ((x&lt;0)&amp;&amp;(x+=P))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> rep(i,a,b) for(int i=a,i##end=b;i&lt;=i##end;++i)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> drep(i,a,b) for(int i=a,i##end=b;i&gt;=i##end;--i)</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt; <span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">cmin</span><span class="params">(T &amp;a,T b)</span></span>&#123; ((a&gt;b)&amp;&amp;(a=b)); &#125;</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt; <span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">cmax</span><span class="params">(T &amp;a,T b)</span></span>&#123; ((a&lt;b)&amp;&amp;(a=b)); &#125;</span><br><span class="line"><span class="type">char</span> IO;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">rd</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="type">int</span> s=<span class="number">0</span>,f=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(!<span class="built_in">isdigit</span>(IO=<span class="built_in">getchar</span>())) <span class="keyword">if</span>(IO==<span class="string">&#x27;-&#x27;</span>) f=<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">do</span> s=(s&lt;&lt;<span class="number">1</span>)+(s&lt;&lt;<span class="number">3</span>)+(IO^<span class="string">&#x27;0&#x27;</span>);</span><br><span class="line">    <span class="keyword">while</span>(<span class="built_in">isdigit</span>(IO=<span class="built_in">getchar</span>()));</span><br><span class="line">    <span class="keyword">return</span> f?-s:s;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">const</span> <span class="type">int</span> N=<span class="number">510</span>,M=<span class="number">10010</span>,P=<span class="number">998244353</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">double</span> eps=<span class="number">1e-9</span>;</span><br><span class="line"> </span><br><span class="line"><span class="type">int</span> X,Y,D,n,m;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Point</span>&#123;</span><br><span class="line">    <span class="type">int</span> x,y;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Read</span><span class="params">()</span></span>&#123; x=<span class="built_in">rd</span>(), y=<span class="built_in">rd</span>(); &#125;</span><br><span class="line">&#125; A[M];</span><br><span class="line"> </span><br><span class="line"><span class="type">const</span> <span class="type">int</span> K=N*N*<span class="number">4.2</span>;</span><br><span class="line"><span class="type">int</span> F[K],G[K];</span><br><span class="line"><span class="type">double</span> U[M];</span><br><span class="line"><span class="type">int</span> cnt,rev[K];</span><br><span class="line"><span class="function">ll <span class="title">qpow</span><span class="params">(ll x,ll k=P<span class="number">-2</span>)</span> </span>&#123;</span><br><span class="line">    ll res=<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span>(;k;k&gt;&gt;=<span class="number">1</span>,x=x*x%P) <span class="keyword">if</span>(k&amp;<span class="number">1</span>) res=res*x%P;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">NTT</span><span class="params">(<span class="type">int</span> n,<span class="type">int</span> *a,<span class="type">int</span> f)</span></span>&#123;</span><br><span class="line">    <span class="type">static</span> <span class="type">int</span> e[K&gt;&gt;<span class="number">1</span>];</span><br><span class="line">    <span class="built_in">rep</span>(i,<span class="number">1</span>,n<span class="number">-1</span>) <span class="keyword">if</span>(i&lt;rev[i]) <span class="built_in">swap</span>(a[i],a[rev[i]]);</span><br><span class="line">    e[<span class="number">0</span>]=<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">1</span>;i&lt;n;i&lt;&lt;=<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="type">int</span> w=<span class="built_in">qpow</span>(f==<span class="number">1</span>?<span class="number">3</span>:(P+<span class="number">1</span>)/<span class="number">3</span>,(P<span class="number">-1</span>)/i/<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> j=i<span class="number">-2</span>;j&gt;=<span class="number">0</span>;j-=<span class="number">2</span>) e[j+<span class="number">1</span>]=<span class="number">1ll</span>*(e[j]=e[j&gt;&gt;<span class="number">1</span>])*w%P;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> l=<span class="number">0</span>;l&lt;n;l+=i*<span class="number">2</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> j=l;j&lt;l+i;++j) &#123;</span><br><span class="line">                <span class="type">int</span> t=<span class="number">1ll</span>*a[j+i]*e[j-l]%P;</span><br><span class="line">                a[j+i]=a[j]-t,<span class="built_in">Mod2</span>(a[j+i]);</span><br><span class="line">                a[j]+=t,<span class="built_in">Mod1</span>(a[j]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(f==<span class="number">-1</span>) &#123;</span><br><span class="line">        ll base=<span class="built_in">qpow</span>(n);</span><br><span class="line">        <span class="built_in">rep</span>(i,<span class="number">0</span>,n<span class="number">-1</span>) a[i]=a[i]*base%P;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Cover</span><span class="params">(<span class="type">int</span> x,<span class="type">int</span> y)</span></span>&#123;</span><br><span class="line">    F[(X+<span class="number">1</span>-x)*D+Y-y]=<span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    X=<span class="built_in">rd</span>(),Y=<span class="built_in">rd</span>(),D=Y+<span class="number">2</span>;</span><br><span class="line">    <span class="built_in">rep</span>(i,<span class="number">1</span>,n=<span class="built_in">rd</span>()) &#123;</span><br><span class="line">        <span class="type">int</span> x=<span class="built_in">rd</span>(),y=<span class="built_in">rd</span>();</span><br><span class="line">        G[x*D+y]=<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> mix=<span class="number">1e9</span>,miy=<span class="number">1e9</span>,max=<span class="number">-1e9</span>,may=<span class="number">-1e9</span>;</span><br><span class="line">    <span class="built_in">rep</span>(i,<span class="number">1</span>,m=<span class="built_in">rd</span>()) &#123;</span><br><span class="line">        A[i].<span class="built_in">Read</span>();</span><br><span class="line">        <span class="built_in">cmin</span>(mix,A[i].x),<span class="built_in">cmax</span>(max,A[i].x);</span><br><span class="line">        <span class="built_in">cmin</span>(miy,A[i].y),<span class="built_in">cmax</span>(may,A[i].y);</span><br><span class="line">    &#125;</span><br><span class="line">    max-=mix,may-=miy;</span><br><span class="line">    <span class="keyword">if</span>(max&gt;X || may&gt;Y) <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;0&quot;</span>),<span class="number">0</span>;</span><br><span class="line">    <span class="built_in">rep</span>(i,<span class="number">1</span>,m) A[i].x-=mix,A[i].y-=miy;</span><br><span class="line">    A[m+<span class="number">1</span>]=A[<span class="number">1</span>];</span><br><span class="line">    <span class="built_in">rep</span>(i,<span class="number">0</span>,X) &#123;</span><br><span class="line">        cnt=<span class="number">0</span>;</span><br><span class="line">        <span class="built_in">rep</span>(j,<span class="number">1</span>,m) &#123;</span><br><span class="line">            Point L=A[j],R=A[j+<span class="number">1</span>];</span><br><span class="line">            <span class="keyword">if</span>(L.x&gt;R.x) <span class="built_in">swap</span>(L,R);</span><br><span class="line">            <span class="keyword">if</span>(i&lt;L.x || i&gt;R.x) <span class="keyword">continue</span>;</span><br><span class="line">            <span class="keyword">if</span>(L.x==R.x) &#123;</span><br><span class="line">                <span class="built_in">rep</span>(y,<span class="built_in">min</span>(L.y,R.y),::<span class="built_in">max</span>(L.y,R.y)) <span class="built_in">Cover</span>(i,y);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">double</span> y=<span class="number">1.0</span>*(R.y-L.y)/(R.x-L.x)*(i-L.x)+L.y;</span><br><span class="line">            <span class="keyword">if</span>(i&lt;R.x) U[++cnt]=y;</span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">abs</span>(y-<span class="built_in">int</span>(y))&lt;eps) <span class="built_in">Cover</span>(i,y);</span><br><span class="line">        &#125;</span><br><span class="line">         </span><br><span class="line">        <span class="built_in">sort</span>(U+<span class="number">1</span>,U+cnt+<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> j=<span class="number">1</span>;j&lt;=cnt;j+=<span class="number">2</span>) <span class="keyword">for</span>(<span class="type">int</span> y=<span class="built_in">ceil</span>(U[j]);y&lt;=U[j+<span class="number">1</span>]+eps;++y) <span class="built_in">Cover</span>(i,y);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="type">int</span> R=<span class="number">1</span>,cc=<span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">while</span>(R&lt;=(X+<span class="number">1</span>)*<span class="number">2</span>*D) R&lt;&lt;=<span class="number">1</span>,cc++;</span><br><span class="line">    <span class="built_in">rep</span>(i,<span class="number">1</span>,R<span class="number">-1</span>) rev[i]=(rev[i&gt;&gt;<span class="number">1</span>]&gt;&gt;<span class="number">1</span>)|((i&amp;<span class="number">1</span>)&lt;&lt;cc);</span><br><span class="line">    <span class="built_in">NTT</span>(R,F,<span class="number">1</span>),<span class="built_in">NTT</span>(R,G,<span class="number">1</span>);</span><br><span class="line">    <span class="built_in">rep</span>(i,<span class="number">0</span>,R<span class="number">-1</span>) F[i]=<span class="number">1ll</span>*F[i]*G[i]%P;</span><br><span class="line">    <span class="built_in">NTT</span>(R,F,<span class="number">-1</span>);</span><br><span class="line">    <span class="type">int</span> ans=<span class="number">0</span>;</span><br><span class="line">    <span class="built_in">rep</span>(i,<span class="number">0</span>,X-max) <span class="built_in">rep</span>(j,<span class="number">0</span>,Y-may) <span class="keyword">if</span>(!F[(X+<span class="number">1</span>+i)*D+Y+j]) ans++;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>,ans);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://compilationfail.github.io/oi-solutions/COCI/[COCI2010-2011#7]%20UPIT/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="orangejuice">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="orangejuice's blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | orangejuice's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/oi-solutions/COCI/%5BCOCI2010-2011#7%5D%20UPIT/" class="post-title-link" itemprop="url">[COCI2010-2011#7] UPIT</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2023-08-12 11:05:24 / Modified: 12:45:20" itemprop="dateCreated datePublished" datetime="2023-08-12T11:05:24+08:00">2023-08-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/oi-solutions/" itemprop="url" rel="index"><span itemprop="name">oi-solutions</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="coci2010-20117-upit">[COCI2010-2011#7] UPIT</h1>
<p>约定:视 <span class="math inline">\(n,q\)</span> 同阶</p>
<p>看一下题目的操作</p>
<p>1.区间赋值</p>
<p>2.区间差分加</p>
<p>3.插入元素</p>
<p>4.区间查询</p>
<p>我们知道1,2操作都是可以用懒标记维护的，具体过程可能有一点细节</p>
<p>1.记录区间差分加的过程，要记录等差数列首项和公差，两个等差数列相加直接首项和公差都相加即可</p>
<p>2.区间赋值的优先级要高于加法，即打上赋值标记就要清空加法标记，标记下传时注意先下传赋值标记</p>
<p>然后具体问题落到如何实现插入元素这个操作上</p>
<h3 id="块状链表">块状链表</h3>
<p>对于静态的数组，可以直接静态分块来做</p>
<p>而要动态插入时，找到对应块，插入即可，但是涉及到编号问题</p>
<p>所以需要每个块维护一个 <span class="math inline">\(Size\)</span>
，块内每个元素维护一个标号 <span class="math inline">\(id_i\)</span></p>
<p>同时需要对于块的 <span class="math inline">\(Size\)</span> 累前缀和
<span class="math inline">\(SumSize\)</span> ，则块 <span
class="math inline">\(i\)</span> 内编号为 <span
class="math inline">\(j\)</span> 的元素在数组中的实际编号为 <span
class="math inline">\(SumSize_{i-1}+j\)</span></p>
<p>插入时把整个块内的元素取出重新标号即可</p>
<p>但是这样插入后，一个块的 <span class="math inline">\(Size\)</span>
会变大，再实现分块的操作时复杂度没有保证</p>
<p>因此需要加入一个操作:当 <span class="math inline">\(Size_i&gt;2\sqrt
n\)</span> 时, <span class="math inline">\(O(n)\)</span>
重构整个序列，这样每 <span class="math inline">\(\sqrt n\)</span>
次插入操作会导致一次重构，复杂度为均摊的 <span
class="math inline">\(O(n\sqrt n)\)</span></p>
<p>然后可以用类似分块的方法来直接维护</p>
<p><span class="math display">\[ \ \]</span></p>
<h3 id="线段树">线段树</h3>
<p>静态的操作线段树可以直接维护</p>
<p>在线段树上额外维护一个01，表示这个元素是否出现</p>
<p>将插入操作转化为在让对应位置的0变为1，但是由于不知道插入后的位置，所以不能直接操作</p>
<p>于是有两种解决办法</p>
<h4 id="暴力值域">暴力值域</h4>
<p>静态情况下我们对于 <span class="math inline">\([1,n]\)</span>
建树，但是动态可以对于 <span class="math inline">\([1,n\cdot q]\)</span>
建函数式线段树</p>
<h3 id="离线">离线</h3>
<p>离线维护，预处理出插入的位置</p>
<p><span class="math display">\[ \ \]</span></p>
<h3 id="平衡树">平衡树</h3>
<p><del>下面是安利时间</del></p>
<p>来学Treap吧</p>
<p>它可以</p>
<p>1.查询k大</p>
<p>2.插入元素</p>
<p>3.区间修改</p>
<p>4.区间翻转</p>
<p>5.可持久化!!</p>
<p><del>6.吊打Splay</del></p>
<p>Treap 即树堆，意思是在满足二叉查找树的性质同时满足二叉堆的性质</p>
<p>给定每个节点一个额外的随机权值，让二叉查找树对于这个权值满足堆的性质即可</p>
<p>这样构造的二叉查找树，树高是 <span class="math inline">\(O(\log
n)\)</span> 的</p>
<h4 id="带旋treap">带旋Treap</h4>
<p>像普通二叉查找树一样每次插入节点到叶子位置后，可能不满足二叉堆的性质，因此需要不断向上zig/zag来调整满足</p>
<p>区间操作可以尝试像写线段树一样写</p>
<p>但是它不可持久化</p>
<h4 id="非旋treap">非旋Treap</h4>
<p>维护两个基础操作</p>
<p>1.平衡树合并，操作需要满足两棵树的大小顺序确定，返回新的根</p>
<p>2.平衡树分裂为 <span class="math inline">\([1,d],[d+1,n]\)</span>
的两部分，返回两棵树的根</p>
<p>1.合并操作 <span class="math inline">\(x,y\)</span></p>
<p>按照节点的权值比较谁是平衡树的根，然后将根的左/右子树与另一棵树合并作为新的子树，递归实现</p>
<p>2.分裂 <span class="math inline">\(x,d\)</span></p>
<p>维护 <span class="math inline">\(Size\)</span>
判断是要分裂左子树还是右子树，将子树分裂得到的部分作为 <span
class="math inline">\(x\)</span> 新的子树，递归实现即可</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> pair &lt;<span class="type">int</span>,<span class="type">int</span>&gt; Pii;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> mp make_pair</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Union</span><span class="params">(<span class="type">int</span> x,<span class="type">int</span> y)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(!x || !y) <span class="keyword">return</span> x|y;</span><br><span class="line">	<span class="built_in">Down</span>(x),<span class="built_in">Down</span>(y);</span><br><span class="line">	<span class="keyword">if</span>(key[x]&lt;key[y]) <span class="keyword">return</span> rs[x]=<span class="built_in">Union</span>(rs[x],y),<span class="built_in">Up</span>(x),x;</span><br><span class="line">	<span class="keyword">return</span> ls[y]=<span class="built_in">Union</span>(x,ls[y]),<span class="built_in">Up</span>(y),y;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Pii <span class="title">Split</span><span class="params">(<span class="type">int</span> x,<span class="type">int</span> d)</span></span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(!x) <span class="keyword">return</span> <span class="built_in">mp</span>(x,x);</span><br><span class="line">	<span class="keyword">if</span>(sz[x]&lt;=d) <span class="keyword">return</span> <span class="built_in">mp</span>(x,<span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span>(d==<span class="number">0</span>) <span class="keyword">return</span> <span class="built_in">mp</span>(<span class="number">0</span>,x);</span><br><span class="line">	<span class="built_in">Down</span>(x);</span><br><span class="line">	<span class="keyword">if</span>(sz[ls[x]]+<span class="number">1</span>&lt;=d) &#123;</span><br><span class="line">		Pii y=<span class="built_in">Split</span>(rs[x],d-sz[ls[x]]<span class="number">-1</span>);</span><br><span class="line">		<span class="keyword">return</span> rs[x]=y.first,<span class="built_in">Up</span>(x),<span class="built_in">mp</span>(x,y.second);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		Pii y=<span class="built_in">Split</span>(ls[x],d);</span><br><span class="line">		<span class="keyword">return</span> ls[x]=y.second,<span class="built_in">Up</span>(x),<span class="built_in">mp</span>(y.first,x);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>插入操作可以分裂前 <span class="math inline">\(k\)</span>
个，将新节点和得到的两棵树按次合并</p>
<p>区间更新可以分裂两次，将对应区间的子树操作即可</p>
<h2 id="code">Code</h2>
<p>块状链表</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> GCC optimize(2)</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">double</span> db;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">long</span> <span class="type">double</span> ldb;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">long</span> <span class="type">long</span> ll;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> ull;</span><br><span class="line"><span class="keyword">typedef</span> pair &lt;<span class="type">int</span>,<span class="type">int</span>&gt; Pii;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> reg register</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> pb push_back</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> mp make_pair</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> Mod1(x) ((x&gt;=P)&amp;&amp;(x-=P))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> Mod2(x) ((x&lt;0)&amp;&amp;(x+=P))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> rep(i,a,b) for(int i=a,i##end=b;i&lt;=i##end;++i)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> drep(i,a,b) for(int i=a,i##end=b;i&gt;=i##end;--i)</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt; <span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">cmin</span><span class="params">(T &amp;a,T b)</span></span>&#123; ((a&gt;b)&amp;&amp;(a=b)); &#125;</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt; <span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">cmax</span><span class="params">(T &amp;a,T b)</span></span>&#123; ((a&lt;b)&amp;&amp;(a=b)); &#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="type">char</span> IO;</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">T</span>=<span class="type">int</span>&gt; T <span class="built_in">rd</span>()&#123;</span><br><span class="line">    T s=<span class="number">0</span>; <span class="type">int</span> f=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(!<span class="built_in">isdigit</span>(IO=<span class="built_in">getchar</span>())) <span class="keyword">if</span>(IO==<span class="string">&#x27;-&#x27;</span>) f=<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">do</span> s=(s&lt;&lt;<span class="number">1</span>)+(s&lt;&lt;<span class="number">3</span>)+(IO^<span class="string">&#x27;0&#x27;</span>);</span><br><span class="line">    <span class="keyword">while</span>(<span class="built_in">isdigit</span>(IO=<span class="built_in">getchar</span>()));</span><br><span class="line">    <span class="keyword">return</span> f?-s:s;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">const</span> <span class="type">int</span> N=<span class="number">2e5</span>+<span class="number">10</span>;</span><br><span class="line"> </span><br><span class="line"><span class="type">int</span> n,m,cnt;</span><br><span class="line"><span class="type">int</span> head[N],nxt[N],sz[N];</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Node</span>&#123; <span class="type">int</span> rk,id; &#125; E[N];</span><br><span class="line">ll s[N],st[N],t[N],d[N],a[N]; </span><br><span class="line"><span class="type">int</span> ssz[N];</span><br><span class="line"> </span><br><span class="line"><span class="function">ll <span class="title">Get</span><span class="params">(ll l,ll r)</span></span>&#123; <span class="keyword">return</span> (r-l+<span class="number">1</span>)*(l+r)/<span class="number">2</span>; &#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Down</span><span class="params">(<span class="type">int</span> p)</span> </span>&#123;</span><br><span class="line">    s[p]=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=head[p];i;i=nxt[i]) &#123;</span><br><span class="line">        <span class="keyword">if</span>(~st[p]) a[E[i].id]=st[p];</span><br><span class="line">        a[E[i].id]+=<span class="number">1ll</span>*(E[i].rk<span class="number">-1</span>)*d[p]+t[p];</span><br><span class="line">        s[p]+=a[E[i].id];</span><br><span class="line">    &#125;</span><br><span class="line">    st[p]=<span class="number">-1</span>,t[p]=d[p]=<span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Up</span><span class="params">(<span class="type">int</span> p)</span> </span>&#123;</span><br><span class="line">    s[p]=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=head[p];i;i=nxt[i]) s[p]+=a[E[i].id];</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Build</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">sort</span>(E+<span class="number">1</span>,E+n+<span class="number">1</span>,[&amp;](Node x,Node y)&#123; <span class="keyword">return</span> x.rk&lt;y.rk; &#125;);</span><br><span class="line">    <span class="built_in">rep</span>(i,<span class="number">0</span>,cnt) sz[i]=head[i]=<span class="number">0</span>,st[i]=<span class="number">-1</span>;</span><br><span class="line">    <span class="built_in">rep</span>(i,<span class="number">1</span>,n) &#123;</span><br><span class="line">        <span class="type">int</span> p=i/cnt+<span class="number">1</span>;</span><br><span class="line">        nxt[i]=head[p],E[i].rk=++sz[p];</span><br><span class="line">        head[p]=i;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">rep</span>(i,<span class="number">1</span>,cnt) ssz[i]=ssz[i<span class="number">-1</span>]+sz[i],<span class="built_in">Up</span>(i);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Break</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">rep</span>(i,<span class="number">1</span>,cnt) &#123;</span><br><span class="line">        sz[i]+=sz[i<span class="number">-1</span>],<span class="built_in">Down</span>(i);</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> j=head[i];j;j=nxt[j]) E[j].rk+=sz[i<span class="number">-1</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">Build</span>();</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Get</span><span class="params">(<span class="type">int</span> x)</span></span>&#123;</span><br><span class="line">    x--;</span><br><span class="line">    <span class="type">int</span> l=<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span>(sz[l]&lt;=x) x-=sz[l++];</span><br><span class="line">    <span class="keyword">return</span> l;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Insert</span><span class="params">(<span class="type">int</span> p,<span class="type">int</span> x)</span></span>&#123;</span><br><span class="line">    <span class="type">int</span> l=p&lt;=n?<span class="built_in">Get</span>(p):cnt;</span><br><span class="line">    <span class="built_in">Down</span>(l),p-=ssz[l<span class="number">-1</span>];</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=head[l];i;i=nxt[i]) <span class="keyword">if</span>(E[i].rk&gt;=p) E[i].rk++;</span><br><span class="line">    a[++n]=x,E[n]=(Node)&#123;p,n&#125;,nxt[n]=head[l],head[l]=n;</span><br><span class="line">    sz[l]++,s[l]+=x;</span><br><span class="line">    <span class="keyword">if</span>(sz[l]&gt;cnt*<span class="number">2.4</span>) <span class="built_in">Break</span>();</span><br><span class="line">    <span class="built_in">rep</span>(i,<span class="number">1</span>,cnt) ssz[i]=ssz[i<span class="number">-1</span>]+sz[i];</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Set</span><span class="params">(<span class="type">int</span> l,<span class="type">int</span> r,<span class="type">int</span> x)</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> p1=<span class="built_in">Get</span>(l),p2=<span class="built_in">Get</span>(r);</span><br><span class="line">    <span class="keyword">if</span>(p1==p2) &#123;</span><br><span class="line">        <span class="built_in">Down</span>(p1);</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=head[p1];i;i=nxt[i]) <span class="keyword">if</span>(ssz[p1<span class="number">-1</span>]+E[i].rk&gt;=l &amp;&amp; ssz[p1<span class="number">-1</span>]+E[i].rk&lt;=r) a[E[i].id]=x;</span><br><span class="line">        <span class="built_in">Up</span>(p1);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">Down</span>(p1),<span class="built_in">Down</span>(p2);</span><br><span class="line">    s[p1]=s[p2]=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=head[p1];i;i=nxt[i]) &#123;</span><br><span class="line">        <span class="keyword">if</span>(ssz[p1<span class="number">-1</span>]+E[i].rk&gt;=l) a[E[i].id]=x;</span><br><span class="line">        s[p1]+=a[E[i].id];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=head[p2];i;i=nxt[i]) &#123;</span><br><span class="line">        <span class="keyword">if</span>(ssz[p2<span class="number">-1</span>]+E[i].rk&lt;=r) a[E[i].id]=x;</span><br><span class="line">        s[p2]+=a[E[i].id];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">rep</span>(i,p1+<span class="number">1</span>,p2<span class="number">-1</span>) st[i]=x,d[i]=t[i]=<span class="number">0</span>,s[i]=<span class="number">1ll</span>*x*sz[i];</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Add</span><span class="params">(<span class="type">int</span> l,<span class="type">int</span> r,<span class="type">int</span> x)</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> p1=<span class="built_in">Get</span>(l),p2=<span class="built_in">Get</span>(r);</span><br><span class="line">    <span class="keyword">if</span>(p1==p2) &#123;</span><br><span class="line">        <span class="built_in">Down</span>(p1);</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=head[p1];i;i=nxt[i]) <span class="keyword">if</span>(ssz[p1<span class="number">-1</span>]+E[i].rk&gt;=l &amp;&amp; ssz[p1<span class="number">-1</span>]+E[i].rk&lt;=r) a[E[i].id]+=<span class="number">1ll</span>*(ssz[p1<span class="number">-1</span>]+E[i].rk-l+<span class="number">1</span>)*x;</span><br><span class="line">        <span class="built_in">Up</span>(p1);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">Down</span>(p1),<span class="built_in">Down</span>(p2);</span><br><span class="line">    s[p1]=s[p2]=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=head[p1];i;i=nxt[i]) &#123;</span><br><span class="line">        <span class="keyword">if</span>(ssz[p1<span class="number">-1</span>]+E[i].rk&gt;=l) a[E[i].id]+=<span class="number">1ll</span>*(ssz[p1<span class="number">-1</span>]+E[i].rk-l+<span class="number">1</span>)*x;</span><br><span class="line">        s[p1]+=a[E[i].id];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=head[p2];i;i=nxt[i]) &#123;</span><br><span class="line">        <span class="keyword">if</span>(ssz[p2<span class="number">-1</span>]+E[i].rk&lt;=r) a[E[i].id]+=<span class="number">1ll</span>*(ssz[p2<span class="number">-1</span>]+E[i].rk-l+<span class="number">1</span>)*x;</span><br><span class="line">        s[p2]+=a[E[i].id];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">rep</span>(i,p1+<span class="number">1</span>,p2<span class="number">-1</span>) &#123;</span><br><span class="line">        t[i]+=<span class="number">1ll</span>*(ssz[i<span class="number">-1</span>]-l+<span class="number">2</span>)*x,d[i]+=x;</span><br><span class="line">        s[i]+=<span class="built_in">Get</span>(ssz[i<span class="number">-1</span>]-l+<span class="number">2</span>,ssz[i]-l+<span class="number">1</span>)*x;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function">ll <span class="title">Que</span><span class="params">(<span class="type">int</span> l,<span class="type">int</span> r)</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> p1=<span class="built_in">Get</span>(l),p2=<span class="built_in">Get</span>(r);</span><br><span class="line">    ll ans=<span class="number">0</span>;</span><br><span class="line">    <span class="built_in">Down</span>(p1),<span class="built_in">Down</span>(p2);</span><br><span class="line">    <span class="keyword">if</span>(p1==p2) &#123;</span><br><span class="line">        <span class="built_in">Down</span>(p1);</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=head[p1];i;i=nxt[i]) <span class="keyword">if</span>(ssz[p1<span class="number">-1</span>]+E[i].rk&gt;=l &amp;&amp; ssz[p1<span class="number">-1</span>]+E[i].rk&lt;=r) ans+=a[E[i].id];</span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">Down</span>(p1),<span class="built_in">Down</span>(p2);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=head[p1];i;i=nxt[i]) <span class="keyword">if</span>(ssz[p1<span class="number">-1</span>]+E[i].rk&gt;=l) ans+=a[E[i].id];</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=head[p2];i;i=nxt[i]) <span class="keyword">if</span>(ssz[p2<span class="number">-1</span>]+E[i].rk&lt;=r) ans+=a[E[i].id];</span><br><span class="line">    <span class="built_in">rep</span>(i,p1+<span class="number">1</span>,p2<span class="number">-1</span>) ans+=s[i];</span><br><span class="line">    <span class="keyword">return</span> ans;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    n=<span class="built_in">rd</span>(),m=<span class="built_in">rd</span>();</span><br><span class="line">    cnt=<span class="built_in">ceil</span>(<span class="built_in">sqrt</span>(n+m));</span><br><span class="line">    <span class="built_in">rep</span>(i,<span class="number">1</span>,n) a[i]=<span class="built_in">rd</span>(),E[i]=(Node)&#123;i,i&#125;;</span><br><span class="line">    <span class="built_in">Build</span>();</span><br><span class="line">    <span class="built_in">rep</span>(i,<span class="number">1</span>,m) &#123;</span><br><span class="line">        <span class="type">int</span> opt=<span class="built_in">rd</span>();</span><br><span class="line">        <span class="keyword">if</span>(opt==<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="type">int</span> l=<span class="built_in">rd</span>(),r=<span class="built_in">rd</span>(),x=<span class="built_in">rd</span>();</span><br><span class="line">            <span class="built_in">Set</span>(l,r,x);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(opt==<span class="number">2</span>) &#123;</span><br><span class="line">            <span class="type">int</span> l=<span class="built_in">rd</span>(),r=<span class="built_in">rd</span>(),x=<span class="built_in">rd</span>();</span><br><span class="line">            <span class="built_in">Add</span>(l,r,x);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(opt==<span class="number">3</span>) &#123;</span><br><span class="line">            <span class="type">int</span> p=<span class="built_in">rd</span>(),x=<span class="built_in">rd</span>();</span><br><span class="line">            <span class="built_in">Insert</span>(p,x);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(opt==<span class="number">4</span>) &#123;</span><br><span class="line">            <span class="type">int</span> l=<span class="built_in">rd</span>(),r=<span class="built_in">rd</span>();</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%lld\n&quot;</span>,<span class="built_in">Que</span>(l,r));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br></pre></td></tr></table></figure>
<p>旋Treap:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="comment">//#pragma GCC optimize(2)</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">double</span> db;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">long</span> <span class="type">double</span> ldb;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">long</span> <span class="type">long</span> ll;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> ull;</span><br><span class="line"><span class="keyword">typedef</span> pair &lt;<span class="type">int</span>,<span class="type">int</span>&gt; Pii;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> reg register</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> pb push_back</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> mp make_pair</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> Mod1(x) ((x&gt;=P)&amp;&amp;(x-=P))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> Mod2(x) ((x&lt;0)&amp;&amp;(x+=P))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> rep(i,a,b) for(int i=a,i##end=b;i&lt;=i##end;++i)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> drep(i,a,b) for(int i=a,i##end=b;i&gt;=i##end;--i)</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt; <span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">cmin</span><span class="params">(T &amp;a,T b)</span></span>&#123; ((a&gt;b)&amp;&amp;(a=b)); &#125;</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt; <span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">cmax</span><span class="params">(T &amp;a,T b)</span></span>&#123; ((a&lt;b)&amp;&amp;(a=b)); &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">char</span> IO;</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">T</span>=<span class="type">int</span>&gt; T <span class="built_in">rd</span>()&#123;</span><br><span class="line">	T s=<span class="number">0</span>; <span class="type">int</span> f=<span class="number">0</span>;</span><br><span class="line">	<span class="keyword">while</span>(!<span class="built_in">isdigit</span>(IO=<span class="built_in">getchar</span>())) <span class="keyword">if</span>(IO==<span class="string">&#x27;-&#x27;</span>) f=<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">do</span> s=(s&lt;&lt;<span class="number">1</span>)+(s&lt;&lt;<span class="number">3</span>)+(IO^<span class="string">&#x27;0&#x27;</span>);</span><br><span class="line">	<span class="keyword">while</span>(<span class="built_in">isdigit</span>(IO=<span class="built_in">getchar</span>()));</span><br><span class="line">	<span class="keyword">return</span> f?-s:s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> N=<span class="number">2e5</span>+<span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> n;</span><br><span class="line"><span class="type">int</span> rt,son[N][<span class="number">2</span>],fa[N];</span><br><span class="line">ll s[N],t[N],d[N],st[N],val[N];</span><br><span class="line">ll sz[N],key[N];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Up</span><span class="params">(<span class="type">int</span> p)</span> </span>&#123;</span><br><span class="line">	s[p]=s[son[p][<span class="number">0</span>]]+s[son[p][<span class="number">1</span>]]+val[p];</span><br><span class="line">	sz[p]=sz[son[p][<span class="number">0</span>]]+sz[son[p][<span class="number">1</span>]]+<span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Set</span><span class="params">(<span class="type">int</span> p,ll x)</span></span>&#123;</span><br><span class="line">	t[p]=d[p]=<span class="number">0</span>,st[p]=val[p]=x,s[p]=sz[p]*x;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Add</span><span class="params">(<span class="type">int</span> p,ll x,ll d)</span> </span>&#123;</span><br><span class="line">	val[p]+=x+d*sz[son[p][<span class="number">0</span>]];</span><br><span class="line">	s[p]+=sz[p]*(sz[p]<span class="number">-1</span>)/<span class="number">2</span>*d+x*sz[p];</span><br><span class="line">	t[p]+=x,::d[p]+=d;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Down</span><span class="params">(<span class="type">int</span> p)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(~st[p]) <span class="built_in">Set</span>(son[p][<span class="number">0</span>],st[p]),<span class="built_in">Set</span>(son[p][<span class="number">1</span>],st[p]),st[p]=<span class="number">-1</span>;</span><br><span class="line">	<span class="keyword">if</span>(t[p] || d[p]) <span class="built_in">Add</span>(son[p][<span class="number">0</span>],t[p],d[p]),<span class="built_in">Add</span>(son[p][<span class="number">1</span>],t[p]+(sz[son[p][<span class="number">0</span>]]+<span class="number">1</span>)*d[p],d[p]),t[p]=d[p]=<span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">rotate</span><span class="params">(<span class="type">int</span> u)</span> </span>&#123;</span><br><span class="line">	<span class="type">int</span> f=fa[u],ff=fa[f],d=son[f][<span class="number">1</span>]==u;</span><br><span class="line">	fa[u]=ff; <span class="keyword">if</span>(ff) son[ff][son[ff][<span class="number">1</span>]==f]=u;</span><br><span class="line">	son[f][d]=son[u][!d]; <span class="keyword">if</span>(son[u][!d]) fa[son[u][!d]]=f;</span><br><span class="line">	son[u][!d]=f,fa[f]=u;</span><br><span class="line">	<span class="built_in">Up</span>(f),<span class="built_in">Up</span>(u);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Insert</span><span class="params">(<span class="type">int</span> p,<span class="type">int</span> x)</span></span>&#123;</span><br><span class="line">	<span class="type">int</span> v=++n;</span><br><span class="line">	val[v]=s[v]=x,sz[v]=<span class="number">1</span>,st[v]=<span class="number">-1</span>,key[v]=<span class="built_in">rand</span>();</span><br><span class="line">	<span class="keyword">if</span>(!rt)&#123; rt=v; <span class="keyword">return</span>; &#125;</span><br><span class="line">	<span class="type">int</span> u=rt;</span><br><span class="line">	<span class="keyword">while</span>(u) &#123;</span><br><span class="line">		<span class="built_in">Down</span>(u);</span><br><span class="line">		<span class="keyword">if</span>(sz[son[u][<span class="number">0</span>]]&gt;=p) &#123;</span><br><span class="line">			<span class="keyword">if</span>(!son[u][<span class="number">0</span>]) &#123; son[fa[v]=u][<span class="number">0</span>]=v; <span class="keyword">break</span>; &#125;</span><br><span class="line">			u=son[u][<span class="number">0</span>]; </span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			p-=sz[son[u][<span class="number">0</span>]]+<span class="number">1</span>;</span><br><span class="line">			<span class="keyword">if</span>(!son[u][<span class="number">1</span>]) &#123; son[fa[v]=u][<span class="number">1</span>]=v; <span class="keyword">break</span>; &#125;</span><br><span class="line">			u=son[u][<span class="number">1</span>];</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">while</span>(fa[v] &amp;&amp; key[v]&lt;key[fa[v]]) <span class="built_in">rotate</span>(v);</span><br><span class="line">	<span class="keyword">if</span>(!fa[v]) rt=v;</span><br><span class="line">	<span class="keyword">while</span>(fa[v]) <span class="built_in">Up</span>(v=fa[v]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Set</span><span class="params">(<span class="type">int</span> p,<span class="type">int</span> l,<span class="type">int</span> r,<span class="type">int</span> x)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(!p || r&lt;=<span class="number">0</span> || l&gt;sz[p]) <span class="keyword">return</span>;</span><br><span class="line">	<span class="keyword">if</span>(l&lt;=<span class="number">1</span> &amp;&amp; r&gt;=sz[p]) <span class="keyword">return</span> <span class="built_in">Set</span>(p,x);</span><br><span class="line">	<span class="type">int</span> t=sz[son[p][<span class="number">0</span>]]+<span class="number">1</span>;</span><br><span class="line">	<span class="built_in">Down</span>(p),<span class="built_in">Set</span>(son[p][<span class="number">0</span>],l,r,x),<span class="built_in">Set</span>(son[p][<span class="number">1</span>],l-t,r-t,x);</span><br><span class="line">	<span class="keyword">if</span>(t&gt;=l &amp;&amp; t&lt;=r) val[p]=x;</span><br><span class="line">	<span class="built_in">Up</span>(p);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Add</span><span class="params">(<span class="type">int</span> p,<span class="type">int</span> l,<span class="type">int</span> r,ll x,ll d)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(!p || r&lt;=<span class="number">0</span> || l&gt;sz[p]) <span class="keyword">return</span>;</span><br><span class="line">	<span class="keyword">if</span>(l&lt;=<span class="number">1</span> &amp;&amp; r&gt;=sz[p]) <span class="keyword">return</span> <span class="built_in">Add</span>(p,x,d);</span><br><span class="line">	<span class="type">int</span> t=sz[son[p][<span class="number">0</span>]]+<span class="number">1</span>;</span><br><span class="line">	<span class="built_in">Down</span>(p),<span class="built_in">Add</span>(son[p][<span class="number">0</span>],l,r,x,d),<span class="built_in">Add</span>(son[p][<span class="number">1</span>],l-t,r-t,x+d*t,d);</span><br><span class="line">	<span class="keyword">if</span>(t&gt;=l &amp;&amp; t&lt;=r) val[p]+=(t<span class="number">-1</span>)*d+x;</span><br><span class="line">	<span class="built_in">Up</span>(p);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">ll <span class="title">Que</span><span class="params">(<span class="type">int</span> p,<span class="type">int</span> l,<span class="type">int</span> r)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(!p || r&lt;=<span class="number">0</span> || l&gt;sz[p]) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span>(l&lt;=<span class="number">1</span> &amp;&amp; r&gt;=sz[p]) <span class="keyword">return</span> s[p];</span><br><span class="line">	ll t=sz[son[p][<span class="number">0</span>]]+<span class="number">1</span>,res=<span class="number">0</span>;</span><br><span class="line">	<span class="built_in">Down</span>(p),res+=<span class="built_in">Que</span>(son[p][<span class="number">0</span>],l,r),res+=<span class="built_in">Que</span>(son[p][<span class="number">1</span>],l-t,r-t);</span><br><span class="line">	<span class="keyword">if</span>(t&gt;=l &amp;&amp; t&lt;=r) res+=val[p];</span><br><span class="line">	<span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="type">int</span> n=<span class="built_in">rd</span>(),m=<span class="built_in">rd</span>();</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">0</span>,n<span class="number">-1</span>) <span class="built_in">Insert</span>(i,<span class="built_in">rd</span>());</span><br><span class="line">	<span class="keyword">while</span>(m--) &#123;</span><br><span class="line">		<span class="type">int</span> opt=<span class="built_in">rd</span>();</span><br><span class="line">		<span class="keyword">if</span>(opt==<span class="number">1</span>) &#123;</span><br><span class="line">			<span class="type">int</span> l=<span class="built_in">rd</span>(),r=<span class="built_in">rd</span>();</span><br><span class="line">			<span class="built_in">Set</span>(rt,l,r,<span class="built_in">rd</span>());</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span>(opt==<span class="number">2</span>) &#123;</span><br><span class="line">			<span class="type">int</span> l=<span class="built_in">rd</span>(),r=<span class="built_in">rd</span>(),x=<span class="built_in">rd</span>();</span><br><span class="line">			<span class="built_in">Add</span>(rt,l,r,x<span class="number">-1ll</span>*(l<span class="number">-1</span>)*x,x);</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span>(opt==<span class="number">3</span>) &#123;</span><br><span class="line">			<span class="type">int</span> x=<span class="built_in">rd</span>(),y=<span class="built_in">rd</span>();</span><br><span class="line">			<span class="built_in">Insert</span>(x<span class="number">-1</span>,y);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="type">int</span> l=<span class="built_in">rd</span>(),r=<span class="built_in">rd</span>();</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;%lld\n&quot;</span>,<span class="built_in">Que</span>(rt,l,r));</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>非旋Treap:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">long</span> <span class="type">long</span> ll;</span><br><span class="line"><span class="keyword">typedef</span> pair &lt;<span class="type">int</span>,<span class="type">int</span>&gt; Pii;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> mp make_pair</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">rd</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="type">char</span> c;<span class="type">int</span> s=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>((c=<span class="built_in">getchar</span>())&lt;<span class="number">48</span>);</span><br><span class="line">    <span class="keyword">do</span> s=s*<span class="number">10</span>+c<span class="number">-48</span>;</span><br><span class="line">    <span class="keyword">while</span>((c=<span class="built_in">getchar</span>())&gt;<span class="number">47</span>);</span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">enum</span>&#123;N=<span class="number">200010</span>&#125;;</span><br><span class="line"><span class="type">int</span> n,m,rt,ls[N],rs[N],key[N];</span><br><span class="line">ll s[N],t[N],d[N],st[N],val[N],sz[N];</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">Up</span><span class="params">(<span class="type">int</span> p)</span> </span>&#123;</span><br><span class="line">    s[p]=s[ls[p]]+s[rs[p]]+val[p];</span><br><span class="line">    sz[p]=sz[ls[p]]+sz[rs[p]]+<span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">Set</span><span class="params">(<span class="type">int</span> p,ll x)</span></span>&#123; t[p]=d[p]=<span class="number">0</span>,st[p]=val[p]=x,s[p]=sz[p]*x; &#125;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">Add</span><span class="params">(<span class="type">int</span> p,ll x,ll d)</span> </span>&#123;</span><br><span class="line">    val[p]+=x+d*sz[ls[p]];</span><br><span class="line">    s[p]+=sz[p]*(sz[p]<span class="number">-1</span>)/<span class="number">2</span>*d+x*sz[p];</span><br><span class="line">    t[p]+=x,::d[p]+=d;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">Down</span><span class="params">(<span class="type">int</span> p)</span> </span>&#123;</span><br><span class="line">    ~st[p] &amp;&amp; (<span class="built_in">Set</span>(ls[p],st[p]),<span class="built_in">Set</span>(rs[p],st[p]),st[p]=<span class="number">-1</span>);</span><br><span class="line">    (t[p] || d[p]) &amp;&amp; (<span class="built_in">Add</span>(ls[p],t[p],d[p]),<span class="built_in">Add</span>(rs[p],t[p]+(sz[ls[p]]+<span class="number">1</span>)*d[p],d[p]),t[p]=d[p]=<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Union</span><span class="params">(<span class="type">int</span> x,<span class="type">int</span> y)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!x || !y) <span class="keyword">return</span> x|y;</span><br><span class="line">    <span class="keyword">return</span> key[x]&lt;key[y]?(<span class="built_in">Down</span>(x),rs[x]=<span class="built_in">Union</span>(rs[x],y),<span class="built_in">Up</span>(x),x):(<span class="built_in">Down</span>(y),ls[y]=<span class="built_in">Union</span>(x,ls[y]),<span class="built_in">Up</span>(y),y);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">Pii <span class="title">Split</span><span class="params">(<span class="type">int</span> x,<span class="type">int</span> d)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(sz[x]&lt;=d) <span class="keyword">return</span> <span class="built_in">mp</span>(x,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(d==<span class="number">0</span>) <span class="keyword">return</span> <span class="built_in">mp</span>(<span class="number">0</span>,x);</span><br><span class="line">    <span class="built_in">Down</span>(x);</span><br><span class="line">    <span class="keyword">if</span>(sz[ls[x]]+<span class="number">1</span>&lt;=d) &#123;</span><br><span class="line">        Pii y=<span class="built_in">Split</span>(rs[x],d-sz[ls[x]]<span class="number">-1</span>);</span><br><span class="line">        <span class="keyword">return</span> rs[x]=y.first,<span class="built_in">Up</span>(x),<span class="built_in">mp</span>(x,y.second);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Pii y=<span class="built_in">Split</span>(ls[x],d);</span><br><span class="line">        <span class="keyword">return</span> ls[x]=y.second,<span class="built_in">Up</span>(x),<span class="built_in">mp</span>(y.first,x);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    n=<span class="built_in">rd</span>(),m=<span class="built_in">rd</span>();</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">1</span>;i&lt;=n+m;++i) key[i]=<span class="built_in">rand</span>(),st[i]=<span class="number">-1</span>,sz[i]=<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">1</span>;i&lt;=n;++i) val[i]=s[i]=<span class="built_in">rd</span>(),rt=<span class="built_in">Union</span>(rt,i);</span><br><span class="line">    <span class="keyword">while</span>(m--)&#123;</span><br><span class="line">        <span class="type">int</span> opt=<span class="built_in">rd</span>();</span><br><span class="line">        <span class="keyword">if</span>(opt==<span class="number">3</span>) &#123;</span><br><span class="line">            Pii t=<span class="built_in">Split</span>(rt,<span class="built_in">rd</span>()<span class="number">-1</span>); ++n,val[n]=s[n]=<span class="built_in">rd</span>();</span><br><span class="line">            rt=<span class="built_in">Union</span>(<span class="built_in">Union</span>(t.first,n),t.second);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">int</span> l=<span class="built_in">rd</span>(),r=<span class="built_in">rd</span>();</span><br><span class="line">            Pii a=<span class="built_in">Split</span>(rt,l<span class="number">-1</span>),b=<span class="built_in">Split</span>(a.second,r-l+<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">if</span>(opt==<span class="number">1</span>) <span class="built_in">Set</span>(b.first,<span class="built_in">rd</span>());</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(opt==<span class="number">2</span>) &#123;<span class="type">int</span> x=<span class="built_in">rd</span>(); <span class="built_in">Add</span>(b.first,x,x); &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(opt==<span class="number">4</span>) <span class="built_in">printf</span>(<span class="string">&quot;%lld\n&quot;</span>,s[b.first]);</span><br><span class="line">            rt=<span class="built_in">Union</span>(<span class="built_in">Union</span>(a.first,b.first),b.second);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="Previous page" aria-label="Previous page" href="/page/19/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/19/">19</a><span class="page-number current">20</span><a class="page-number" href="/page/21/">21</a><span class="space">&hellip;</span><a class="page-number" href="/page/26/">26</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/page/21/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2023</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">orangejuice</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>







  




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>



</body>
</html>
