<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon32.jpg">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon16.jpg">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"compilationfail.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.18.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"mac"},"fold":{"enable":true,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="orangejuice&#39;s blog">
<meta property="og:url" content="https://compilationfail.github.io/page/18/index.html">
<meta property="og:site_name" content="orangejuice&#39;s blog">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="orangejuice">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://compilationfail.github.io/page/18/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"page/18/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>orangejuice's blog</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">orangejuice's blog</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">挂了请务必叫我</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="orangejuice"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">orangejuice</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">261</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://twitter.com/ChenJerson" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;ChenJerson" rel="noopener me" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://weibo.com/3950662532/profile?rightmod=1&wvr=6&mod=personinfo" title="Weibo → https:&#x2F;&#x2F;weibo.com&#x2F;3950662532&#x2F;profile?rightmod&#x3D;1&amp;wvr&#x3D;6&amp;mod&#x3D;personinfo" rel="noopener me" target="_blank"><i class="fab fa-weibo fa-fw"></i>Weibo</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://github.com/CompilationFail" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;CompilationFail" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://steamcommunity.com/profiles/76561198969516062/" title="Steam → https:&#x2F;&#x2F;steamcommunity.com&#x2F;profiles&#x2F;76561198969516062&#x2F;" rel="noopener me" target="_blank"><i class="fab fa-steam fa-fw"></i>Steam</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.last.fm/user/chasedeath" title="Lastfm → https:&#x2F;&#x2F;www.last.fm&#x2F;user&#x2F;chasedeath" rel="noopener me" target="_blank"><i class="fab fa-lastfm-square fa-fw"></i>Lastfm</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://open.spotify.com/user/mgxnlznf9dli6bm4k3sp0iuwz" title="Spotify → https:&#x2F;&#x2F;open.spotify.com&#x2F;user&#x2F;mgxnlznf9dli6bm4k3sp0iuwz" rel="noopener me" target="_blank"><i class="fab fa-spotify fa-fw"></i>Spotify</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://compilationfail.github.io/oi-solutions/CodeChef/CODECHEF%20Octchanllenge%20JIIT/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="orangejuice">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="orangejuice's blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | orangejuice's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/oi-solutions/CodeChef/CODECHEF%20Octchanllenge%20JIIT/" class="post-title-link" itemprop="url">Codechef Oct chanllenge Queries on Matrix-JIIT</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2023-08-12 00:11:59 / Modified: 14:44:14" itemprop="dateCreated datePublished" datetime="2023-08-12T00:11:59+08:00">2023-08-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/CP-%E9%A2%98%E8%A7%A3/" itemprop="url" rel="index"><span itemprop="name">CP 题解</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="codechef-oct-chanllenge-queries-on-matrix-jiit">Codechef Oct
chanllenge Queries on Matrix-JIIT</h1>
<p>首先发现矩阵的两个维度显然是互不相干的，假设最后操作后有 <span
class="math inline">\(x\)</span> 列被操作奇数次， <span
class="math inline">\(y\)</span> 行操作奇数次</p>
<p>那么最后为奇数的格子个数就是 <span
class="math inline">\(x(m-y)+(n-x)y\)</span></p>
<p>考虑求出 <span class="math inline">\(q\)</span> 操作后有 <span
class="math inline">\(x\)</span> 个位置被操作奇数次的方案数</p>
<p>考虑一个Naive的 <span class="math inline">\(dp\)</span> ，令 <span
class="math inline">\(dp_{i,j}\)</span> 为操作 <span
class="math inline">\(i\)</span> 次后有 <span
class="math inline">\(j\)</span>
位置操作奇数的方案数，显然得到转移为</p>
<p><span class="math inline">\(dp_{i,j}\cdot j\rightarrow
dp_{i+1,j-1}\)</span></p>
<p><span class="math inline">\(dp_{i,j}\cdot (n-j)\rightarrow
dp_{i+1,j+1}\)</span></p>
<p>直接 <span class="math inline">\(dp\)</span> 复杂度为 <span
class="math inline">\(O(nq)\)</span> ，用矩阵优化复杂度为 <span
class="math inline">\(O(n^3\log q)\)</span></p>
<p>没有考虑过求向量列的现行递推式？说不定暴力求递推然后。。。</p>
<h2 id="on3"><span class="math inline">\(O(n^3)\)</span></h2>
<p><del>由于笔者不会数学，所以</del>考虑一个非常暴力非常直观的理解，可以完全抛开组合意义</p>
<p>每次是挑选一个位置异或上1，用形式幂级数可能比较蛋疼，不如直接搞成集合幂级数</p>
<p>即令集合 <span class="math inline">\(S\)</span>
包含所有被操作奇数次的位置，用一个多项式 <span
class="math inline">\(F=\sum_S a_S x^S\)</span> 表示答案</p>
<p>那么转移多项式即为 <span class="math inline">\(F=\sum_{i=1}^{n}
x^{\lbrace i \rbrace}\)</span>
，转移运算为集合对称差运算<del>(哎就是异或)</del></p>
<p>那么实际就是要求出 <span class="math inline">\(F^q\)</span>
，可以直接用 <span class="math inline">\(\text{FWT}\)</span> 优化，先
<span class="math inline">\(\text{FWT}\)</span> ，然后求出每一项的 <span
class="math inline">\(q\)</span> 次幂，然后 <span
class="math inline">\(\text{FWT}\)</span> 回来</p>
<p><del>(这样不是 <span class="math inline">\(n2^n\)</span>
的吗)</del></p>
<p>显然的可以发现， <span class="math inline">\(F^i\)</span>
的任意位置系数 <span class="math inline">\([x^S]F^i\)</span> 只与 <span
class="math inline">\(|S|\)</span> 有关，所以实际上只需要存下含有 <span
class="math inline">\(0,1,2\cdots,n\)</span> 个元素的项的系数即可</p>
<p>考虑在这样的多项式上模拟原先的 <span
class="math inline">\(\text{FWT}\)</span> 过程</p>
<hr />
<p>按照快速沃尔什变换的式子，令 <span
class="math inline">\(G=\text{FWT(F)}=\sum_{S}x^S \sum_{T}(-1)^{|S\cap
T|}\cdot [x^T]F\)</span></p>
<p>考虑枚举 <span class="math inline">\(|S|,|T|,|S\cap T|\)</span>
，然后组合数计算系数，令 <span class="math inline">\(F_i\)</span> 表示
<span class="math inline">\([x^S]F(|S|=i)\)</span></p>
<p>则有 <span class="math inline">\(\begin{aligned}
G_i=\sum_{j}F_j\sum_k C_i^k\cdot
C_{n-i}^{j-k}(-1)^{k}\end{aligned}\)</span> ，其中 <span
class="math inline">\(C_{n-i}^{j-k}\)</span> 表示从不相交的部分里选出
<span class="math inline">\(j\)</span> 中剩下的元素</p>
<p>按照该式即可完成 <span class="math inline">\(O(n^3)\)</span> 模拟
<span class="math inline">\(\text{FWT}\)</span> ，注意 <span
class="math inline">\(\text{IFWT}\)</span> 时需要除掉 <span
class="math inline">\(2^n\)</span></p>
<p>算上快速幂复杂度应为 <span class="math inline">\(O(n^3+n\log
q)\)</span></p>
<h2 id="on2log-n"><span class="math inline">\(O(n^2\log n)\)</span></h2>
<p>用 <span class="math inline">\(\text{NTT}\)</span> 优化上式</p>
<h2 id="on2"><span class="math inline">\(O(n^2)\)</span></h2>
<p>依然考虑上面 <span class="math inline">\(\text{FWT}\)</span>
的转移式，发现 <span class="math inline">\(i\)</span> 项得到 <span
class="math inline">\(j\)</span>
项的贡献为一个常数，考虑直接计算这个常数 <span
class="math inline">\(W_{i,j}=\sum_k C_i^k\cdot
C_{n-i}^{j-k}(-1)^{k}\)</span></p>
<p>我们知道组合数就是二项展开的结果，所以发现实际就是 <span
class="math inline">\(W_{i,j}=[x^j] (-x+1)^i\cdot
(x+1)^{n-i}\)</span></p>
<p>该式可以 <span class="math inline">\(O(n^2)\)</span> 按照 <span
class="math inline">\(i\)</span> 递推求出，每次乘上一个 <span
class="math inline">\(\frac{1-x}{1+x}\)</span> 即可</p>
<p>实际复杂度为 <span class="math inline">\(O(n^2+n\log q)\)</span></p>
<p>实际上应该还可以处理一些稍微复杂点的问题，比如每次可以操作若干个位置</p>
<p>不知道能否优化到 <span class="math inline">\(n^2\)</span> 以下</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// NTT Version</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">long</span> <span class="type">long</span> ll;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> ull;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">double</span> db;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">long</span> <span class="type">double</span> ldb;</span><br><span class="line"><span class="keyword">typedef</span> pair &lt;<span class="type">int</span>,<span class="type">int</span>&gt; Pii;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> reg register</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> pb push_back</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> mp make_pair</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> Mod1(x) ((x&gt;=P)&amp;&amp;(x-=P))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> Mod2(x) ((x&lt;0)&amp;&amp;(x+=P))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> rep(i,a,b) for(int i=a,i##end=b;i&lt;=i##end;++i)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> drep(i,a,b) for(int i=a,i##end=b;i&gt;=i##end;--i)</span></span><br><span class="line"></span><br><span class="line"><span class="type">bool</span> Mbe;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> N=<span class="number">2050</span>,P=<span class="number">998244353</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> n,m,Z; ll k;</span><br><span class="line"><span class="type">int</span> A[N],B[N];</span><br><span class="line"><span class="function">ll <span class="title">qpow</span><span class="params">(ll x,ll k=P<span class="number">-2</span>)</span> </span>&#123;</span><br><span class="line">	ll res=<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">for</span>(;k;k&gt;&gt;=<span class="number">1</span>,x=x*x%P) <span class="keyword">if</span>(k&amp;<span class="number">1</span>) res=res*x%P;</span><br><span class="line">	<span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> C[N][N];</span><br><span class="line"><span class="type">int</span> rev[N],T[N],IT[N];</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">NTT</span><span class="params">(<span class="type">int</span> n,<span class="type">int</span> *a,<span class="type">int</span> f)</span></span>&#123;</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">0</span>,n<span class="number">-1</span>) <span class="keyword">if</span>(i&lt;rev[i]) <span class="built_in">swap</span>(a[i],a[rev[i]]);</span><br><span class="line">	<span class="type">static</span> <span class="type">int</span> e[N&gt;&gt;<span class="number">1</span>];	</span><br><span class="line">	<span class="keyword">for</span>(reg <span class="type">int</span> i=e[<span class="number">0</span>]=<span class="number">1</span>;i&lt;n;i&lt;&lt;=<span class="number">1</span>) &#123;</span><br><span class="line">		ll t=f==<span class="number">1</span>?T[i]:IT[i];</span><br><span class="line">		<span class="comment">//qpow(f==1?3:(P+1)/3,(P-1)/i/2);</span></span><br><span class="line">		<span class="keyword">for</span>(reg <span class="type">int</span> j=i<span class="number">-2</span>;j&gt;=<span class="number">0</span>;j-=<span class="number">2</span>) e[j+<span class="number">1</span>]=t*(e[j]=e[j&gt;&gt;<span class="number">1</span>])%P;</span><br><span class="line">		<span class="keyword">for</span>(reg <span class="type">int</span> l=<span class="number">0</span>;l&lt;n;l+=i*<span class="number">2</span>) &#123;</span><br><span class="line">			<span class="keyword">for</span>(reg <span class="type">int</span> j=l;j&lt;l+i;++j) &#123;</span><br><span class="line">				reg <span class="type">int</span> t=<span class="number">1ll</span>*a[j+i]*e[j-l]%P;</span><br><span class="line">				a[j+i]=a[j]-t,<span class="built_in">Mod2</span>(a[j+i]);</span><br><span class="line">				a[j]+=t,<span class="built_in">Mod1</span>(a[j]);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(f==<span class="number">-1</span>) &#123;</span><br><span class="line">		ll base=<span class="built_in">qpow</span>(n);</span><br><span class="line">		<span class="built_in">rep</span>(i,<span class="number">0</span>,n<span class="number">-1</span>) a[i]=a[i]*base%P;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Init</span><span class="params">(<span class="type">int</span> n)</span></span>&#123;</span><br><span class="line">	<span class="type">int</span> R=<span class="number">1</span>,cc=<span class="number">-1</span>;</span><br><span class="line">	<span class="keyword">while</span>(R&lt;=n) R&lt;&lt;=<span class="number">1</span>,cc++;</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">1</span>,R<span class="number">-1</span>) rev[i]=(rev[i&gt;&gt;<span class="number">1</span>]&gt;&gt;<span class="number">1</span>)|((i&amp;<span class="number">1</span>)&lt;&lt;cc);</span><br><span class="line">	<span class="keyword">return</span> R;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> mk1[N],mk2[N];</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">FWT</span><span class="params">(<span class="type">int</span> n,<span class="type">int</span> *A,<span class="type">int</span> *B,<span class="type">int</span> f,<span class="type">int</span> *mk)</span></span>&#123;</span><br><span class="line">		<span class="type">static</span> <span class="type">int</span> X[N],Y[N];</span><br><span class="line">		<span class="built_in">rep</span>(i,<span class="number">0</span>,n) &#123;</span><br><span class="line">			<span class="built_in">memset</span>(X,<span class="number">0</span>,<span class="keyword">sizeof</span> X),<span class="built_in">memset</span>(Y,<span class="number">0</span>,<span class="keyword">sizeof</span> Y);</span><br><span class="line">			<span class="built_in">rep</span>(k,<span class="number">0</span>,i) X[i-k]=(k&amp;<span class="number">1</span>)?P-C[i][k]:C[i][k];</span><br><span class="line">			<span class="built_in">rep</span>(j,<span class="number">0</span>,n) Y[j]=A[j];</span><br><span class="line">			<span class="type">int</span> R=<span class="built_in">Init</span>(n+i+<span class="number">1</span>);</span><br><span class="line">			<span class="built_in">NTT</span>(R,X,<span class="number">1</span>),<span class="built_in">NTT</span>(R,Y,<span class="number">1</span>);</span><br><span class="line">			<span class="built_in">rep</span>(j,<span class="number">0</span>,R<span class="number">-1</span>) X[j]=<span class="number">1ll</span>*X[j]*Y[j]%P;</span><br><span class="line">			<span class="built_in">NTT</span>(R,X,<span class="number">-1</span>);</span><br><span class="line">			<span class="built_in">rep</span>(j,<span class="number">0</span>,n-i) B[i]=(B[i]+<span class="number">1ll</span>*C[n-i][j]*X[i+j])%P;</span><br><span class="line">		&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Solve</span><span class="params">(<span class="type">int</span> n,<span class="type">int</span> *A,<span class="type">int</span> *mk)</span> </span>&#123;</span><br><span class="line">	<span class="type">static</span> <span class="type">int</span> X[N],Y[N];</span><br><span class="line">	<span class="built_in">memset</span>(X,<span class="number">0</span>,<span class="keyword">sizeof</span> X),<span class="built_in">memset</span>(Y,<span class="number">0</span>,<span class="keyword">sizeof</span> Y);</span><br><span class="line">	X[<span class="number">1</span>]=<span class="number">1</span>,<span class="built_in">FWT</span>(n,X,Y,<span class="number">1</span>,mk);</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">0</span>,n) Y[i]=<span class="built_in">qpow</span>(Y[i],k);</span><br><span class="line">	<span class="built_in">memset</span>(X,<span class="number">0</span>,<span class="keyword">sizeof</span> X);</span><br><span class="line">	<span class="built_in">FWT</span>(n,Y,X,<span class="number">2</span>,mk);</span><br><span class="line">	ll base=<span class="built_in">qpow</span>(<span class="built_in">qpow</span>(<span class="number">2</span>,n),P<span class="number">-2</span>);</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">0</span>,n) A[i]=X[i]*base%P*C[n][i]%P;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">bool</span> Med;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="comment">//fprintf(stderr,&quot;%.2lf\n&quot;,(&amp;Med-&amp;Mbe)/1024.0/1024.0);</span></span><br><span class="line">	<span class="built_in">freopen</span>(<span class="string">&quot;clone.in&quot;</span>,<span class="string">&quot;r&quot;</span>,stdin),<span class="built_in">freopen</span>(<span class="string">&quot;clone.out&quot;</span>,<span class="string">&quot;w&quot;</span>,stdout);</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">0</span>,N<span class="number">-1</span>) <span class="built_in">rep</span>(j,C[i][<span class="number">0</span>]=<span class="number">1</span>,i) C[i][j]=(C[i<span class="number">-1</span>][j<span class="number">-1</span>]+C[i<span class="number">-1</span>][j])%P;</span><br><span class="line">	<span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">1</span>;i&lt;N;i&lt;&lt;=<span class="number">1</span>) &#123;</span><br><span class="line">		T[i]=<span class="built_in">qpow</span>(<span class="number">3</span>,(P<span class="number">-1</span>)/i/<span class="number">2</span>);</span><br><span class="line">		IT[i]=<span class="built_in">qpow</span>((P+<span class="number">1</span>)/<span class="number">3</span>,(P<span class="number">-1</span>)/i/<span class="number">2</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">scanf</span>(<span class="string">&quot;%d%d%lld%d&quot;</span>,&amp;n,&amp;m,&amp;k,&amp;Z);</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">0</span>,n) <span class="built_in">rep</span>(j,<span class="number">0</span>,m) &#123;</span><br><span class="line">		<span class="keyword">if</span>(i*(m-j)+j*(n-i)!=Z) <span class="keyword">continue</span>;</span><br><span class="line">		mk1[i]=<span class="number">1</span>,mk2[j]=<span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">Solve</span>(n,A,mk1),<span class="built_in">Solve</span>(m,B,mk2);</span><br><span class="line">	<span class="type">int</span> ans=<span class="number">0</span>;</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">0</span>,n) <span class="built_in">rep</span>(j,<span class="number">0</span>,m) &#123;</span><br><span class="line">		<span class="keyword">if</span>(i*(m-j)+j*(n-i)!=Z) <span class="keyword">continue</span>;</span><br><span class="line">		ans=(ans+<span class="number">1ll</span>*A[i]*B[j])%P;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>,ans);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// n^2</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">long</span> <span class="type">long</span> ll;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> Mod1(x) ((x&gt;=P)&amp;&amp;(x-=P))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> Mod2(x) ((x&lt;0)&amp;&amp;(x+=P))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> rep(i,a,b) for(int i=a,i##end=b;i&lt;=i##end;++i)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> drep(i,a,b) for(int i=a,i##end=b;i&gt;=i##end;--i)</span></span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> N=<span class="number">2050</span>,P=<span class="number">998244353</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> n,m,Z; ll k;</span><br><span class="line"><span class="type">int</span> A[N],B[N];</span><br><span class="line"><span class="function">ll <span class="title">qpow</span><span class="params">(ll x,ll k=P<span class="number">-2</span>)</span> </span>&#123;</span><br><span class="line">	ll res=<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">for</span>(;k;k&gt;&gt;=<span class="number">1</span>,x=x*x%P) <span class="keyword">if</span>(k&amp;<span class="number">1</span>) res=res*x%P;</span><br><span class="line">	<span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> C[N][N],W[N][N],mk1[N],mk2[N];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Solve</span><span class="params">(<span class="type">int</span> n,<span class="type">int</span> *A,<span class="type">int</span> *mk)</span> </span>&#123;</span><br><span class="line">	<span class="type">static</span> <span class="type">int</span> X[N],Y[N];</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">0</span>,n) W[<span class="number">0</span>][i]=C[n][i];</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">1</span>,n) &#123;</span><br><span class="line">		<span class="built_in">rep</span>(j,<span class="number">0</span>,n) W[i][j]=W[i<span class="number">-1</span>][j]-(j?W[i][j<span class="number">-1</span>]:<span class="number">0</span>),<span class="built_in">Mod2</span>(W[i][j]);</span><br><span class="line">		<span class="built_in">drep</span>(j,n,<span class="number">0</span>) W[i][j]=(j?-W[i][j<span class="number">-1</span>]:<span class="number">0</span>)+W[i][j],<span class="built_in">Mod2</span>(W[i][j]);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">memset</span>(Y,<span class="number">0</span>,<span class="keyword">sizeof</span> Y);</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">0</span>,n) X[i]=<span class="built_in">qpow</span>(W[i][<span class="number">1</span>],k);</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">0</span>,n) <span class="keyword">if</span>(mk[i]) <span class="built_in">rep</span>(j,<span class="number">0</span>,n) Y[i]=(Y[i]+<span class="number">1ll</span>*W[i][j]*X[j])%P;</span><br><span class="line">	ll base=<span class="built_in">qpow</span>(<span class="built_in">qpow</span>(<span class="number">2</span>,n),P<span class="number">-2</span>);</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">0</span>,n) A[i]=Y[i]*base%P*C[n][i]%P;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="built_in">freopen</span>(<span class="string">&quot;clone.in&quot;</span>,<span class="string">&quot;r&quot;</span>,stdin),<span class="built_in">freopen</span>(<span class="string">&quot;clone.out&quot;</span>,<span class="string">&quot;w&quot;</span>,stdout);</span><br><span class="line">	<span class="built_in">scanf</span>(<span class="string">&quot;%d%d%lld%d&quot;</span>,&amp;n,&amp;m,&amp;k,&amp;Z);</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">0</span>,<span class="built_in">max</span>(n,m)) <span class="built_in">rep</span>(j,C[i][<span class="number">0</span>]=<span class="number">1</span>,i) C[i][j]=C[i<span class="number">-1</span>][j<span class="number">-1</span>]+C[i<span class="number">-1</span>][j],<span class="built_in">Mod1</span>(C[i][j]);</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">0</span>,n) <span class="built_in">rep</span>(j,<span class="number">0</span>,m) &#123;</span><br><span class="line">		<span class="keyword">if</span>(i*(m-j)+j*(n-i)!=Z) <span class="keyword">continue</span>;</span><br><span class="line">		mk1[i]=mk2[j]=<span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">Solve</span>(n,A,mk1),<span class="built_in">Solve</span>(m,B,mk2);</span><br><span class="line">	<span class="type">int</span> ans=<span class="number">0</span>;</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">0</span>,n) <span class="built_in">rep</span>(j,<span class="number">0</span>,m) &#123;</span><br><span class="line">		<span class="keyword">if</span>(i*(m-j)+j*(n-i)!=Z) <span class="keyword">continue</span>;</span><br><span class="line">		ans=(ans+<span class="number">1ll</span>*A[i]*B[j])%P;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>,ans);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://compilationfail.github.io/oi-solutions/Topcoder/SweetFruits%20TopCoder%20-%2012141/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="orangejuice">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="orangejuice's blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | orangejuice's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/oi-solutions/Topcoder/SweetFruits%20TopCoder%20-%2012141/" class="post-title-link" itemprop="url">[SweetFruits TopCoder - 12141](https://vjudge.net/problem/TopCoder-12141)(Matrix-Tree)</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2023-08-12 00:11:59 / Modified: 14:44:14" itemprop="dateCreated datePublished" datetime="2023-08-12T00:11:59+08:00">2023-08-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/CP-%E9%A2%98%E8%A7%A3/" itemprop="url" rel="index"><span itemprop="name">CP 题解</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="sweetfruits-topcoder---12141matrix-tree"><a
target="_blank" rel="noopener" href="https://vjudge.net/problem/TopCoder-12141">SweetFruits TopCoder -
12141</a>(Matrix-Tree)</h1>
<p>问题看起来很复杂，不可写，所以先考虑分解一下</p>
<p>假设最后生效的点集为 <span class="math inline">\(V\)</span>
，那么答案只和 <span class="math inline">\(\sum sweetness[V_i]\)</span>
和 <span class="math inline">\(|V|\)</span> 有关</p>
<p>所以可以考虑对于每一种 <span class="math inline">\(|V|\)</span>
，先预处理出方案数</p>
<p>得知每一种 <span class="math inline">\(|V|\)</span>
的方案数之后，可以用 <span class="math inline">\(\text{meet in the
middle}\)</span> 法枚举得到 <span class="math inline">\(\sum
sweetness[V_i]\leq maxsweetness\)</span> 的方案数</p>
<p>方案数是有限制的生成树个数，所以考虑用 <span
class="math inline">\(\text{Matrix-Tree}\)</span> 求</p>
<p>限定有 <span class="math inline">\(a\)</span> 个点生效， <span
class="math inline">\(b\)</span> 个点不生效， <span
class="math inline">\(c\)</span> 个点是 <span
class="math inline">\(-1\)</span></p>
<p>那么可能出现的边是 <span class="math inline">\(a-a,a-c,b-c\)</span>
三种</p>
<p>但是我们无法保证 <span class="math inline">\(a\)</span>
中的点一定生效，所以可以用容斥/二项式反演得到</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> Mod1(x) ((x&gt;=P)&amp;&amp;(x-=P))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> Mod2(x) ((x&lt;0)&amp;&amp;(x+=P))</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> reg register</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">long</span> <span class="type">long</span> ll;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> rep(i,a,b) for(reg int i=a,i##end=b;i&lt;=i##end;++i)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> drep(i,a,b) for(reg int i=a,i##end=b;i&gt;=i##end;--i)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> pb push_back</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt; <span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">cmin</span><span class="params">(T &amp;a,T b)</span></span>&#123; ((a&gt;b)&amp;&amp;(a=b)); &#125;</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt; <span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">cmax</span><span class="params">(T &amp;a,T b)</span></span>&#123; ((a&lt;b)&amp;&amp;(a=b)); &#125;</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> IO;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">rd</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="type">int</span> s=<span class="number">0</span>;</span><br><span class="line">	<span class="type">int</span> f=<span class="number">0</span>;</span><br><span class="line">	<span class="keyword">while</span>(!<span class="built_in">isdigit</span>(IO=<span class="built_in">getchar</span>())) <span class="keyword">if</span>(IO==<span class="string">&#x27;-&#x27;</span>) f=<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">do</span> s=(s&lt;&lt;<span class="number">1</span>)+(s&lt;&lt;<span class="number">3</span>)+(IO^<span class="string">&#x27;0&#x27;</span>);</span><br><span class="line">	<span class="keyword">while</span>(<span class="built_in">isdigit</span>(IO=<span class="built_in">getchar</span>()));</span><br><span class="line">	<span class="keyword">return</span> f?-s:s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> N=<span class="number">50</span>,P=<span class="number">1e9</span>+<span class="number">7</span>;</span><br><span class="line"></span><br><span class="line"><span class="function">ll <span class="title">qpow</span><span class="params">(ll x,ll k=P<span class="number">-2</span>)</span> </span>&#123;</span><br><span class="line">	ll res=<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">for</span>(;k;k&gt;&gt;=<span class="number">1</span>,x=x*x%P) <span class="keyword">if</span>(k&amp;<span class="number">1</span>) res=res*x%P;</span><br><span class="line">	<span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> n,m;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Mat</span>&#123;</span><br><span class="line">	<span class="type">int</span> a[N][N];</span><br><span class="line">	<span class="built_in">Mat</span>()&#123; <span class="built_in">memset</span>(a,<span class="number">0</span>,<span class="keyword">sizeof</span> a); &#125;</span><br><span class="line">	<span class="function"><span class="type">int</span> <span class="title">Det</span><span class="params">(<span class="type">int</span> n)</span></span>&#123;  <span class="comment">// 用于Matrix-Tree的</span></span><br><span class="line">		<span class="type">static</span> <span class="type">int</span> G[N][N];</span><br><span class="line">		<span class="built_in">rep</span>(i,<span class="number">1</span>,n) <span class="built_in">rep</span>(j,<span class="number">1</span>,n) G[i][j]=a[i][j];</span><br><span class="line">		<span class="type">int</span> res=<span class="number">1</span>;</span><br><span class="line">		<span class="built_in">rep</span>(i,<span class="number">1</span>,n) &#123;</span><br><span class="line">			<span class="keyword">if</span>(!G[i][i]) <span class="built_in">rep</span>(j,i+<span class="number">1</span>,n) <span class="keyword">if</span>(G[j][i])&#123; res=P-res; <span class="built_in">swap</span>(G[i],G[j]); <span class="keyword">break</span>; &#125;</span><br><span class="line">			<span class="keyword">if</span>(!G[i][i]) <span class="keyword">continue</span>;</span><br><span class="line">			ll Inv=<span class="built_in">qpow</span>(a[i][i]);</span><br><span class="line">			<span class="built_in">rep</span>(j,i+<span class="number">1</span>,n) &#123;</span><br><span class="line">				ll t=a[j][i]*Inv%P;</span><br><span class="line">				<span class="built_in">rep</span>(k,i,n) a[j][k]=(a[j][k]<span class="number">-1ll</span>*a[i][k]*t%P+P)%P;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">rep</span>(i,<span class="number">1</span>,n) res=<span class="number">1ll</span>*res*a[i][i]%P;</span><br><span class="line">		<span class="keyword">return</span> res;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> w[N],G[N][N],C[N][N];</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Init</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">0</span>,N<span class="number">-1</span>) <span class="built_in">rep</span>(j,C[i][<span class="number">0</span>]=<span class="number">1</span>,i) C[i][j]=(C[i<span class="number">-1</span>][j<span class="number">-1</span>]+C[i<span class="number">-1</span>][j])%P;</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">0</span>,n) &#123;</span><br><span class="line">		Mat T;</span><br><span class="line">		<span class="built_in">rep</span>(j,<span class="number">1</span>,m) &#123; <span class="comment">// -1</span></span><br><span class="line">			<span class="built_in">rep</span>(k,<span class="number">1</span>,n+m) T.a[j][k]=<span class="number">-1</span>;</span><br><span class="line">			T.a[j][j]=n+m<span class="number">-1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">rep</span>(j,m+<span class="number">1</span>,m+i) &#123; <span class="comment">// 生效</span></span><br><span class="line">			<span class="built_in">rep</span>(k,<span class="number">1</span>,m+i) <span class="keyword">if</span>(j!=k) T.a[j][k]=<span class="number">-1</span>;</span><br><span class="line">			T.a[j][j]=m+i<span class="number">-1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">rep</span>(j,m+i+<span class="number">1</span>,m+n) &#123; <span class="comment">// 不生效</span></span><br><span class="line">			<span class="built_in">rep</span>(k,<span class="number">1</span>,m) T.a[j][k]=<span class="number">-1</span>;</span><br><span class="line">			T.a[j][j]=m;</span><br><span class="line">		&#125;</span><br><span class="line">		w[i]=T.<span class="built_in">Det</span>(n+m<span class="number">-1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">0</span>,n) <span class="built_in">rep</span>(j,<span class="number">0</span>,i<span class="number">-1</span>) w[i]=(w[i]<span class="number">-1ll</span>*C[i][j]*w[j]%P+P)%P; <span class="comment">// 容斥/二项式反演</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> val[N];</span><br><span class="line">vector &lt;<span class="type">int</span>&gt; st[N/<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Meet_In_The_Middle</span><span class="params">(<span class="type">int</span> Max)</span></span>&#123;</span><br><span class="line">	<span class="type">int</span> ans=<span class="number">0</span>,mid=n/<span class="number">2</span>;</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">0</span>,mid) st[i].<span class="built_in">clear</span>();</span><br><span class="line">	<span class="built_in">rep</span>(S,<span class="number">0</span>,(<span class="number">1</span>&lt;&lt;mid)<span class="number">-1</span>) &#123;</span><br><span class="line">		<span class="type">int</span> c=<span class="number">0</span>,s=<span class="number">0</span>;</span><br><span class="line">		<span class="built_in">rep</span>(i,<span class="number">0</span>,mid<span class="number">-1</span>) <span class="keyword">if</span>(S&amp;(<span class="number">1</span>&lt;&lt;i)) s+=val[i],c++;</span><br><span class="line">		<span class="keyword">if</span>(s&lt;=Max) st[c].<span class="built_in">pb</span>(s);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">0</span>,mid) <span class="built_in">sort</span>(st[i].<span class="built_in">begin</span>(),st[i].<span class="built_in">end</span>());</span><br><span class="line">	<span class="built_in">rep</span>(S,<span class="number">0</span>,(<span class="number">1</span>&lt;&lt;(n-mid))<span class="number">-1</span>) &#123;</span><br><span class="line">		<span class="type">int</span> c=<span class="number">0</span>,s=<span class="number">0</span>;</span><br><span class="line">		<span class="built_in">rep</span>(i,<span class="number">0</span>,n-mid<span class="number">-1</span>) <span class="keyword">if</span>(S&amp;(<span class="number">1</span>&lt;&lt;i)) s+=val[i+mid],c++;</span><br><span class="line">		<span class="keyword">if</span>(s&gt;Max) <span class="keyword">continue</span>;</span><br><span class="line">		<span class="built_in">rep</span>(j,<span class="number">0</span>,mid) &#123;</span><br><span class="line">			<span class="type">int</span> x=<span class="built_in">upper_bound</span>(st[j].<span class="built_in">begin</span>(),st[j].<span class="built_in">end</span>(),Max-s)-st[j].<span class="built_in">begin</span>();</span><br><span class="line">			<span class="keyword">if</span>(x) ans=(ans+<span class="number">1ll</span>*x*w[c+j])%P;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> ans;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SweetFruits</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function"><span class="type">int</span> <span class="title">countTrees</span><span class="params">(vector &lt;<span class="type">int</span>&gt; Val, <span class="type">int</span> Max)</span> </span>&#123;</span><br><span class="line">		<span class="built_in">sort</span>(Val.<span class="built_in">begin</span>(),Val.<span class="built_in">end</span>(),greater &lt;<span class="type">int</span>&gt; ());</span><br><span class="line">		m=<span class="number">0</span>; <span class="keyword">while</span>(Val.<span class="built_in">size</span>() &amp;&amp; *Val.<span class="built_in">rbegin</span>()==<span class="number">-1</span>) m++,Val.<span class="built_in">pop_back</span>();</span><br><span class="line">		n=Val.<span class="built_in">size</span>();</span><br><span class="line">		<span class="built_in">rep</span>(i,<span class="number">0</span>,n<span class="number">-1</span>) val[i]=Val[i];</span><br><span class="line">		<span class="built_in">Init</span>();</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">Meet_In_The_Middle</span>(Max);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://compilationfail.github.io/oi-solutions/Topcoder/Orienteering%20TopCoder%20-%2012305/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="orangejuice">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="orangejuice's blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | orangejuice's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/oi-solutions/Topcoder/Orienteering%20TopCoder%20-%2012305/" class="post-title-link" itemprop="url">TopCoder SRM 561 Orienteering 树形dp</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2023-08-12 00:11:59 / Modified: 14:44:14" itemprop="dateCreated datePublished" datetime="2023-08-12T00:11:59+08:00">2023-08-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/CP-%E9%A2%98%E8%A7%A3/" itemprop="url" rel="index"><span itemprop="name">CP 题解</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="topcoder-srm-561-orienteering-树形dp">TopCoder SRM 561
Orienteering 树形dp</h1>
<p>题意: 给定了一棵树，以及树上一些节点为关键点，求出随机选出 <span
class="math inline">\(k\)</span> 个关键点后遍历它们的最短路径的期望</p>
<p>遍历关键点相当于要遍历一棵树，考虑遍历一棵树的最优决策</p>
<p>假设我们确定了一个根 <span class="math inline">\(u\)</span>
，递归考虑每棵子树的问题</p>
<p>发现除了最后留在的那个点对应的路径 <span
class="math inline">\((u,v)\)</span> 以外，所有的边都要被遍历两次</p>
<p>即答案 <span class="math inline">\(\sum _{e\in E} 2\cdot
w(e)-dis(u,v)\)</span></p>
<p>所以改变根就会发现，答案就是总长*2-直径长度</p>
<p>设总点数为 <span class="math inline">\(n\)</span>
，包含的总关键点数为 <span class="math inline">\(m\)</span> ，要选出
<span class="math inline">\(k\)</span> 个点</p>
<h2 id="part1-总长计算">Part1 总长计算</h2>
<p>考虑对于每一条边计算产生的树跨过它的概率</p>
<p>设这条边两边的关键点的个数分别为 <span
class="math inline">\(a,b(a+b=m)\)</span></p>
<p>显然，这条边被跨过的概率就是</p>
<p><span class="math inline">\(\begin{aligned}
1-\frac{C(a,k)}{C(m,k)}-\frac{C(b,k)}{C(m,k)}\end{aligned}\)</span>
(即减去所有选出的关键点都在两边的概率)</p>
<p>设 <span class="math inline">\(\begin{aligned}
f(i)=\frac{C(i,k)}{C(m,k)}=\frac{i!(m-k)!}{m!(i-k)!}\end{aligned}\)</span></p>
<p>因为这个题目要计算double，所以求阶乘的精度会比较有问题</p>
<p>考虑递推求出 <span class="math inline">\(f(i)\)</span> ，则有</p>
<p><span class="math inline">\(f(i)=\left\{\begin{aligned}1 &amp;&amp;
i=m \\ \frac{f(i+1)(i+1-k)}{i+1} &amp;&amp;
i&lt;m\end{aligned}\right.\)</span></p>
<p>这样递推就能比好得保证精度，然后直接对于每条边计算即可，复杂度为
<span class="math inline">\(O(n)\)</span></p>
<p><span class="math display">\[ \ \]</span></p>
<h2 id="part2-直径长度计算">Part2 直径长度计算</h2>
<p>直径似乎是一个很难在树形 <span
class="math inline">\(\mathrm{dp}\)</span>
中确定的东西，因此考虑直接先枚举直径的两个端点</p>
<p>定义一棵树的直径两端点为最小的二元组 <span
class="math inline">\((A,B)\)</span> 满足</p>
<p><span class="math inline">\(\begin{aligned}
A&lt;B，dis(A,B)=\max_{u,v\in V} \{dis(u,v)\}\end{aligned}\)</span></p>
<p>因为 <span class="math inline">\(k&gt;1\)</span>
，所以两端点一定不同，不妨设两个端点分别为 <span
class="math inline">\(A,B(A&lt;B)\)</span></p>
<p>则一个点 <span class="math inline">\(C\)</span>
可以出现在树上的充要条件是</p>
<p><span class="math inline">\((dis(A,C)&gt;dis(A,B) \or
dis(A,C)=dis(A,B)\and C \ge B)\)</span></p>
<p><span class="math inline">\(\and (dis(B,C)&gt;dis(A,B) \or
dis(B,C)=dis(A,B)\and C \ge A)\)</span></p>
<p>数出所有可以出现在树上的点个数 <span class="math inline">\(i\)</span>
，则 <span class="math inline">\((A,B)\)</span> 为直径的概率应为 <span
class="math inline">\(\frac{C(i-2,k-2)}{C(m,k)}\)</span></p>
<p>即强制选取了 <span class="math inline">\((A,B)\)</span> 两个点</p>
<p>依然考虑递推求出</p>
<p><span class="math inline">\(\begin{aligned}
f(i)=\frac{C(i-2,k-2)}{C(m,k)}=\frac{(i-2)!k(k-1)(m-k)!}{m!(i-k)!}\end{aligned}\)</span></p>
<p>类似地，得到其递推式为</p>
<p><span
class="math inline">\(f(i)=\left\{\begin{aligned}\frac{k(k-1)}{m(m-1)}
&amp;&amp; i=m \\ \frac{f(i+1)(i+1-k)}{i-1} &amp;&amp;
i&lt;m\end{aligned}\right.\)</span></p>
<p>这一部分复杂度为 <span class="math inline">\(O(m^3)\)</span></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> pair &lt;<span class="type">int</span>,<span class="type">int</span>&gt; Pii;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">long</span> <span class="type">long</span> ll;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">double</span> db;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> mp make_pair</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> pb push_back</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> reg register</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> Mod1(x) ((x&gt;=P)&amp;&amp;(x-=P))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> Mod2(x) ((x&lt;0)&amp;&amp;(x+=P))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> rep(i,a,b) for(reg int i=a,i##end=b;i&lt;=i##end;++i)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> drep(i,a,b) for(reg int i=a,i##end=b;i&gt;=i##end;--i)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt; <span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">cmin</span><span class="params">(T &amp;a,T b)</span></span>&#123; ((a&gt;b)&amp;&amp;(a=b)); &#125;</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt; <span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">cmax</span><span class="params">(T &amp;a,T b)</span></span>&#123; ((a&lt;b)&amp;&amp;(a=b)); &#125;</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> IO;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">rd</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="type">int</span> s=<span class="number">0</span>;</span><br><span class="line">	<span class="type">int</span> f=<span class="number">0</span>;</span><br><span class="line">	<span class="keyword">while</span>(!<span class="built_in">isdigit</span>(IO=<span class="built_in">getchar</span>())) <span class="keyword">if</span>(IO==<span class="string">&#x27;-&#x27;</span>) f=<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">do</span> s=(s&lt;&lt;<span class="number">1</span>)+(s&lt;&lt;<span class="number">3</span>)+(IO^<span class="string">&#x27;0&#x27;</span>);</span><br><span class="line">	<span class="keyword">while</span>(<span class="built_in">isdigit</span>(IO=<span class="built_in">getchar</span>()));</span><br><span class="line">	<span class="keyword">return</span> f?-s:s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> N=<span class="number">51</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> n,m,k;</span><br><span class="line"><span class="type">int</span> id[N][N],mk[<span class="number">2510</span>],sz[<span class="number">2510</span>],p[<span class="number">310</span>];</span><br><span class="line">vector &lt;<span class="type">int</span>&gt; G[<span class="number">2520</span>];</span><br><span class="line">db dp[<span class="number">2510</span>],ans;</span><br><span class="line"><span class="type">int</span> dis[<span class="number">2500</span>][<span class="number">2500</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Dfs</span><span class="params">(<span class="type">int</span> u,<span class="type">int</span> f)</span> </span>&#123;</span><br><span class="line">	sz[u]=mk[u]&gt;<span class="number">0</span>;</span><br><span class="line">	<span class="keyword">for</span>(<span class="type">int</span> v:G[u]) <span class="keyword">if</span>(v!=f) &#123;</span><br><span class="line">		<span class="built_in">Dfs</span>(v,u),sz[u]+=sz[v];</span><br><span class="line">		ans+=<span class="number">1</span>-dp[sz[v]]-dp[m-sz[v]];</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Dfs_Getdis</span><span class="params">(<span class="type">int</span> rt,<span class="type">int</span> u,<span class="type">int</span> f)</span></span>&#123;</span><br><span class="line">	<span class="keyword">for</span>(<span class="type">int</span> v:G[u]) <span class="keyword">if</span>(v!=f) </span><br><span class="line">		dis[rt][v]=dis[rt][u]+<span class="number">1</span>,<span class="built_in">Dfs_Getdis</span>(rt,v,u);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> A,B;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Check</span><span class="params">(<span class="type">int</span> u)</span></span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(dis[A][u]&gt;dis[A][B]) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span>(dis[A][u]==dis[A][B] &amp;&amp; u&lt;B) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span>(dis[B][u]&gt;dis[A][B]) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span>(dis[B][u]==dis[A][B] &amp;&amp; u&lt;A) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Orienteering</span> &#123;</span><br><span class="line">	<span class="keyword">public</span>:</span><br><span class="line">		<span class="function"><span class="type">double</span> <span class="title">expectedLength</span><span class="params">(vector &lt;string&gt; field, <span class="type">int</span> K)</span> </span>&#123;</span><br><span class="line">			<span class="built_in">rep</span>(i,<span class="number">1</span>,n) G[i].<span class="built_in">clear</span>(); <span class="built_in">memset</span>(id,<span class="number">0</span>,<span class="keyword">sizeof</span> id),<span class="built_in">memset</span>(mk,<span class="number">0</span>,<span class="keyword">sizeof</span> mk);</span><br><span class="line">			n=m=<span class="number">0</span>,k=K;</span><br><span class="line">			<span class="built_in">rep</span>(i,<span class="number">0</span>,field.<span class="built_in">size</span>()<span class="number">-1</span>) <span class="built_in">rep</span>(j,<span class="number">0</span>,field[i].<span class="built_in">size</span>()<span class="number">-1</span>) <span class="keyword">if</span>(field[i][j]!=<span class="string">&#x27;#&#x27;</span>) &#123;</span><br><span class="line">				id[i][j]=++n;</span><br><span class="line">				<span class="keyword">if</span>(field[i][j]==<span class="string">&#x27;*&#x27;</span>) p[mk[n]=++m]=n;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="built_in">rep</span>(i,<span class="number">0</span>,field.<span class="built_in">size</span>()<span class="number">-1</span>) <span class="built_in">rep</span>(j,<span class="number">0</span>,field[i].<span class="built_in">size</span>()<span class="number">-1</span>) <span class="keyword">if</span>(id[i][j]) &#123;</span><br><span class="line">				<span class="keyword">if</span>(i&lt;iend &amp;&amp; id[i+<span class="number">1</span>][j]) G[id[i][j]].<span class="built_in">pb</span>(id[i+<span class="number">1</span>][j]),G[id[i+<span class="number">1</span>][j]].<span class="built_in">pb</span>(id[i][j]);</span><br><span class="line">				<span class="keyword">if</span>(j&lt;jend &amp;&amp; id[i][j+<span class="number">1</span>]) G[id[i][j]].<span class="built_in">pb</span>(id[i][j+<span class="number">1</span>]),G[id[i][j+<span class="number">1</span>]].<span class="built_in">pb</span>(id[i][j]);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="built_in">rep</span>(i,<span class="number">0</span>,m) dp[i]=<span class="number">0</span>;</span><br><span class="line">			dp[m]=<span class="number">1</span>;</span><br><span class="line">			<span class="built_in">drep</span>(i,m<span class="number">-1</span>,k) dp[i]=dp[i+<span class="number">1</span>]/(i+<span class="number">1</span>)*(i+<span class="number">1</span>-k);</span><br><span class="line">			ans=<span class="number">0</span>,<span class="built_in">Dfs</span>(<span class="number">1</span>,<span class="number">0</span>),ans*=<span class="number">2</span>; <span class="comment">// 期望总长</span></span><br><span class="line">			<span class="comment">// 下面求期望直径长度</span></span><br><span class="line">			<span class="built_in">rep</span>(i,<span class="number">1</span>,n) <span class="keyword">if</span>(mk[i]) <span class="built_in">Dfs_Getdis</span>(i,i,dis[i][i]=<span class="number">0</span>);</span><br><span class="line">			</span><br><span class="line">			dp[m]=<span class="number">1.0</span>*k*(k<span class="number">-1</span>)/m/(m<span class="number">-1</span>);</span><br><span class="line">			<span class="built_in">drep</span>(i,m<span class="number">-1</span>,k) dp[i]=dp[i+<span class="number">1</span>]/(i<span class="number">-1</span>)*(i+<span class="number">1</span>-k);</span><br><span class="line">			<span class="built_in">rep</span>(i,<span class="number">1</span>,m) <span class="built_in">rep</span>(j,i+<span class="number">1</span>,m) &#123;</span><br><span class="line">				<span class="type">int</span> c=<span class="number">0</span>; A=p[i],B=p[j];</span><br><span class="line">				<span class="built_in">rep</span>(k,<span class="number">1</span>,m) c+=<span class="built_in">Check</span>(p[k]);</span><br><span class="line">				<span class="keyword">if</span>(c&gt;=k) ans-=dis[A][B]*dp[c];</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> ans;</span><br><span class="line">		&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><span class="math inline">\(\begin{aligned} \frac{\begin{aligned}
\sum_{i=0}^{min(k,sz[u]) } C(sz[u],i)\cdot C(m-sz[u],k-i)\end{aligned}
}{C(m,k)}\end{aligned}\)</span></p>
<p><span class="math inline">\(\begin{aligned} \frac{\begin{aligned}
\sum_{i=0}^{min(k,sz[u]) } sz[u]!(m-sz[u])!k!(m-k)!\cdot \end{aligned}
}{m!i!(sz[u]-i)!(k-i)!(m-sz[u]-k+i)!}\end{aligned}\)</span></p>
<p><span class="math inline">\(\begin{aligned}
1-\frac{C(sz[u],k)}{C(m,k)}-\frac{C(m-sz[u],k)}{C(m,k)}\end{aligned}\)</span></p>
<p><span
class="math inline">\(\frac{C(i,k)}{C(m,k)}=\frac{i!(m-k)!}{m!(i-k)!}\)</span></p>
<p>i从m for 到 k</p>
<p>f(i)=f(i+1)/i(k-i+1)</p>
<p><span
class="math inline">\(\frac{C(i-2,k-2)}{C(m,k)}=\frac{(i-2)!k(k-1)(m-k)!}{m!(i-k)!}\)</span></p>
<p>i=m时， <span
class="math inline">\(f(m)=\frac{k(k-1)}{m(m-1)}\)</span></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://compilationfail.github.io/oi-solutions/Topcoder/RockPaperScissors/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="orangejuice">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="orangejuice's blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | orangejuice's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/oi-solutions/Topcoder/RockPaperScissors/" class="post-title-link" itemprop="url">TopCoder - 12349 SRM579 Round1 Div1 RockPaperScissors (概率dp)</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2023-08-12 00:11:59 / Modified: 14:44:14" itemprop="dateCreated datePublished" datetime="2023-08-12T00:11:59+08:00">2023-08-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/CP-%E9%A2%98%E8%A7%A3/" itemprop="url" rel="index"><span itemprop="name">CP 题解</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1
id="topcoder---12349-srm579-round1-div1-rockpaperscissors-概率dp">TopCoder
- 12349 SRM579 Round1 Div1 RockPaperScissors (概率dp)</h1>
<h3 id="题目大意">题目大意：</h3>
<p>有 <span class="math inline">\(n\)</span>
个骰子，每个骰子有300个面，其中有 <span
class="math inline">\(a_i,b_i,c_i\)</span> 分别为石头/布/剪刀</p>
<p>每轮你选择出石头/剪刀/布，然后会从剩下的骰子中随机取一个再随机结果，但是你不知道取的是什么骰子</p>
<p>赢一局的权值为3，平局为1</p>
<p>求最优情况下最大的权值期望</p>
<p><span class="math display">\[ \ \]</span></p>
<h3 id="题目分析">题目分析：</h3>
<p>显然当前的局面只和已经抽出的石头/布/剪刀的数量有关（因为这是你唯一的决策依据，也是唯一影响局面的）</p>
<p>乍一看非常抽象的决策过程，实在无法通过分析得到每一种局面下应该作出的决策</p>
<p>于是考虑能否直接把每一种局面出现的概率求出，决策后将期望线性相加</p>
<p>不妨把随机取出的骰子放在一个序列上，一个局面是由已经出现的骰子和当前第
<span class="math inline">\(i\)</span> 次决策的骰子组成的</p>
<p>令 <span class="math inline">\(dp_{i,j,k,typ}\)</span>
表示已经出现的骰子中出现 <span class="math inline">\(i,j,k\)</span>
个石头/布/剪刀，当前决策时骰子结果为 <span
class="math inline">\(typ\)</span> 的概率</p>
<p>实际在 <span class="math inline">\(dp\)</span> 时， <span
class="math inline">\(typ\)</span>
一维需要额外加入一个值表示未确定下一个是什么</p>
<p>考虑对于每个骰子，枚举它是已经出现/正在决策/在第 <span
class="math inline">\(i\)</span> 次决策之后出现，将其概率累和</p>
<p><span class="math inline">\(dp\)</span> 状态为 <span
class="math inline">\(O(n^3)\)</span> ，转移次数为 <span
class="math inline">\(O(n)\)</span> ,复杂度为 <span
class="math inline">\(O(n^4)\)</span></p>
<p>最后对于每种局面计算最优的决策即可</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> rep(i,a,b) for(int i=a,i##end=b;i&lt;=i##end;++i)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> drep(i,a,b) for(int i=a,i##end=b;i&gt;=i##end;--i)</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt; <span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">cmin</span><span class="params">(T &amp;a,T b)</span></span>&#123; ((a&gt;b)&amp;&amp;(a=b)); &#125;</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt; <span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">cmax</span><span class="params">(T &amp;a,T b)</span></span>&#123; ((a&lt;b)&amp;&amp;(a=b)); &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RockPaperScissors</span> &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="type">static</span> <span class="type">const</span> <span class="type">int</span> N=<span class="number">53</span>;</span><br><span class="line">	<span class="type">static</span> <span class="type">const</span> <span class="type">int</span> eps=<span class="number">1e-9</span>;</span><br><span class="line">	<span class="type">double</span> F[N][N][N][<span class="number">4</span>],G[N][N][N][<span class="number">4</span>],w[<span class="number">3</span>];</span><br><span class="line">	<span class="type">double</span> C[N][N];</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="type">double</span> <span class="title">bestScore</span><span class="params">(vector &lt;<span class="type">int</span>&gt; w1, vector &lt;<span class="type">int</span>&gt; w2, vector &lt;<span class="type">int</span>&gt; w3)</span> </span>&#123;</span><br><span class="line">		<span class="type">int</span> n=w1.<span class="built_in">size</span>();</span><br><span class="line">		<span class="built_in">rep</span>(i,<span class="number">0</span>,n) <span class="built_in">rep</span>(j,C[i][<span class="number">0</span>]=<span class="number">1</span>,i) C[i][j]=C[i<span class="number">-1</span>][j<span class="number">-1</span>]+C[i<span class="number">-1</span>][j];</span><br><span class="line">		<span class="built_in">memset</span>(F,<span class="number">0</span>,<span class="keyword">sizeof</span> F),F[<span class="number">0</span>][<span class="number">0</span>][<span class="number">0</span>][<span class="number">3</span>]=<span class="number">1</span>;</span><br><span class="line">		<span class="built_in">rep</span>(i,<span class="number">1</span>,n) &#123;</span><br><span class="line">			w[<span class="number">0</span>]=w1[i<span class="number">-1</span>]/<span class="number">300.0</span>; w[<span class="number">1</span>]=w2[i<span class="number">-1</span>]/<span class="number">300.0</span>; w[<span class="number">2</span>]=w3[i<span class="number">-1</span>]/<span class="number">300.0</span>;</span><br><span class="line">			<span class="built_in">rep</span>(a,<span class="number">0</span>,i) <span class="built_in">rep</span>(b,<span class="number">0</span>,i-a) <span class="built_in">rep</span>(c,<span class="number">0</span>,i-a-b) <span class="built_in">rep</span>(d,<span class="number">0</span>,<span class="number">3</span>) G[a][b][c][d]=F[a][b][c][d];</span><br><span class="line">			<span class="built_in">rep</span>(a,<span class="number">0</span>,i) <span class="built_in">rep</span>(b,<span class="number">0</span>,i-a) <span class="built_in">rep</span>(c,<span class="number">0</span>,i-a-b) <span class="built_in">rep</span>(d,<span class="number">0</span>,<span class="number">3</span>) <span class="keyword">if</span>(G[a][b][c][d]&gt;eps) &#123;</span><br><span class="line">				<span class="comment">// 枚举这个骰子在之前出现过了</span></span><br><span class="line">				F[a+<span class="number">1</span>][b][c][d]+=G[a][b][c][d]*w[<span class="number">0</span>];</span><br><span class="line">				F[a][b+<span class="number">1</span>][c][d]+=G[a][b][c][d]*w[<span class="number">1</span>];</span><br><span class="line">				F[a][b][c+<span class="number">1</span>][d]+=G[a][b][c][d]*w[<span class="number">2</span>];</span><br><span class="line">				<span class="comment">// 枚举这个骰子为下一个出现的</span></span><br><span class="line">				<span class="keyword">if</span>(d==<span class="number">3</span>) <span class="built_in">rep</span>(e,<span class="number">0</span>,<span class="number">2</span>) F[a][b][c][e]+=G[a][b][c][d]*w[e];</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="type">double</span> ans=<span class="number">0</span>;</span><br><span class="line">		<span class="built_in">rep</span>(a,<span class="number">0</span>,n<span class="number">-1</span>) <span class="built_in">rep</span>(b,<span class="number">0</span>,n<span class="number">-1</span>-a) <span class="built_in">rep</span>(c,<span class="number">0</span>,n<span class="number">-1</span>-a-b) &#123;</span><br><span class="line">			<span class="comment">// 决策这一轮出什么</span></span><br><span class="line">			<span class="type">double</span> ma=<span class="number">0</span>;</span><br><span class="line">			<span class="built_in">rep</span>(d,<span class="number">0</span>,<span class="number">2</span>) <span class="built_in">cmax</span>(ma,F[a][b][c][d]+F[a][b][c][(d+<span class="number">2</span>)%<span class="number">3</span>]*<span class="number">3</span>);</span><br><span class="line">			ans+=ma/C[n][a+b+c]/(n-a-b-c);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> ans;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://compilationfail.github.io/oi-solutions/CodeChef/CodeChef%20Winning%20Ways/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="orangejuice">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="orangejuice's blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | orangejuice's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/oi-solutions/CodeChef/CodeChef%20Winning%20Ways/" class="post-title-link" itemprop="url">CodeChef November Challenge2019  Winning Ways (3-FWT)</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2023-08-12 00:11:59 / Modified: 14:44:14" itemprop="dateCreated datePublished" datetime="2023-08-12T00:11:59+08:00">2023-08-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/CP-%E9%A2%98%E8%A7%A3/" itemprop="url" rel="index"><span itemprop="name">CP 题解</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="codechef-november-challenge2019-winning-ways-3-fwt">CodeChef
November Challenge2019 Winning Ways (3-FWT)</h1>
<p>显然每个把每个数换成其因子个数-1，就能转为一个扩展的 <span
class="math inline">\(\text{Nim}\)</span> 游戏</p>
<p>每次操作 <span class="math inline">\(1,2,\cdots,k\)</span> 堆的 <span
class="math inline">\(\text{Nim}\)</span> 游戏，其判定方法是：</p>
<p>将每个数二进制分解，对于每个二进制位上分别计算1的个数 <span
class="math inline">\(\mod (k+1)\)</span> ，如果均为0则先手必败</p>
<p>对于这道题 <span class="math inline">\(k=3\)</span>
，我们考虑将其转为二进制之后的形式累成3进制，然后就能进行3进制按位不进位加法，即类异或</p>
<p>然后问题实际上有非常多的部分需要考虑</p>
<h2 id="part1-如何求因子个数">Part1 如何求因子个数</h2>
<p>一个简单的方法是枚举 <span class="math inline">\([1,\sqrt n]\)</span>
判断是否整除，复杂度过高</p>
<p>对于 <span class="math inline">\(n=\prod p_i^{c_i}\)</span> ( <span
class="math inline">\(p_i\)</span> 为质数)，其因子个数为 <span
class="math inline">\(\prod (c_i+1)\)</span></p>
<p>由这个式子对于 <span class="math inline">\(n\)</span>
进行质因数分解，枚举 <span class="math inline">\([1,\sqrt n]\)</span>
中的质数，复杂度为 <span class="math inline">\(O(\pi(\sqrt
n))=O(\frac{\sqrt n}{\log n})\)</span> ，这个应该够了？</p>
<p>然后是一个常规套路型的分解方法：</p>
<p>先对于 <span class="math inline">\([1,n^{\frac{1}{3}}]\)</span>
的质数筛 <span class="math inline">\(n\)</span>
，剩余的部分只有3种情况</p>
<ol type="1">
<li><p><span class="math inline">\(n\)</span> 被筛成1了</p></li>
<li><p><span class="math inline">\(n\)</span> 被筛到只剩一个质数，可以用
<span class="math inline">\(\text{Miller_Rabin}\)</span>
算法快速判断，<a
target="_blank" rel="noopener" href="https://www.cnblogs.com/chasedeath/p/13492548.html"><strong>可以参考</strong></a></p></li>
<li><p><span class="math inline">\(n\)</span>
仍然是若干质数的乘积，此时质因子必然 <span
class="math inline">\(&gt;n^{\frac{1}{3}}\)</span>
，因此最多只有两个</p></li>
</ol>
<p>那么只需要判断 <span class="math inline">\(n\)</span>
是否是完全平方数即可</p>
<p>总复杂度为 <span class="math inline">\(O(w\cdot \log
n+\frac{n^{\frac{1}{3}}}{\log n})\)</span> ，其中 <span
class="math inline">\(w\)</span> 为 <span
class="math inline">\(\text{Miller_Rabin}\)</span> 筛选次数</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> <span class="type">int</span> N=<span class="number">2e5</span>+<span class="number">10</span>;</span><br><span class="line"><span class="type">int</span> notpri[N],pri[N],pc;</span><br><span class="line"></span><br><span class="line"><span class="function">ll <span class="title">qpow</span><span class="params">(ll x,ll k=P<span class="number">-2</span>,<span class="type">int</span> P=::P)</span> </span>&#123;</span><br><span class="line">    ll res=<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span>(;k;k&gt;&gt;=<span class="number">1</span>,x=x*x%P) <span class="keyword">if</span>(k&amp;<span class="number">1</span>) res=res*x%P;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Trans</span><span class="params">(<span class="type">int</span> x)</span></span>&#123; </span><br><span class="line">    <span class="type">static</span> <span class="type">int</span> buf[<span class="number">20</span>],l=<span class="number">0</span>;</span><br><span class="line">    l=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(x) buf[++l]=x%<span class="number">2</span>,x/=<span class="number">2</span>;</span><br><span class="line">    <span class="type">int</span> s=<span class="number">0</span>;</span><br><span class="line">    <span class="built_in">drep</span>(i,l,<span class="number">1</span>) s=s*<span class="number">3</span>+buf[i];</span><br><span class="line">    <span class="built_in">cmax</span>(ma,s);</span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Miller_Rabin</span><span class="params">(<span class="type">int</span> x)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(x&lt;N) <span class="keyword">return</span> !notpri[x];</span><br><span class="line">    <span class="keyword">if</span>(x==<span class="number">2</span>) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span>(x&lt;=<span class="number">1</span> || ~x&amp;<span class="number">1</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    ll s=<span class="number">0</span>,t=x<span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">while</span>(~t&amp;<span class="number">1</span>) s++,t&gt;&gt;=<span class="number">1</span>;</span><br><span class="line">    <span class="built_in">rep</span>(i,<span class="number">1</span>,<span class="number">4</span>) &#123;</span><br><span class="line">        ll a=pri[<span class="built_in">rand</span>()%pc+<span class="number">1</span>],b=<span class="built_in">qpow</span>(a,t,x),c;</span><br><span class="line">        <span class="built_in">rep</span>(j,<span class="number">1</span>,s) &#123;</span><br><span class="line">            c=<span class="number">1ll</span>*b*b%x;</span><br><span class="line">            <span class="keyword">if</span>(c==<span class="number">1</span> &amp;&amp; b!=<span class="number">1</span> &amp;&amp; b!=x<span class="number">-1</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            b=c;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(b!=<span class="number">1</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">CheckSqr</span><span class="params">(<span class="type">int</span> n)</span></span>&#123;</span><br><span class="line">    <span class="type">int</span> y=<span class="built_in">round</span>(<span class="built_in">sqrt</span>(n));</span><br><span class="line">    <span class="keyword">return</span> y*y==n;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Count</span><span class="params">(<span class="type">int</span> n)</span></span>&#123;</span><br><span class="line">    <span class="type">int</span> res=<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">1</span>;i&lt;=pc &amp;&amp; pri[i]*pri[i]*pri[i]&lt;=n;++i) <span class="keyword">if</span>(n%pri[i]==<span class="number">0</span>) &#123;</span><br><span class="line">        <span class="type">int</span> c=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>(n%pri[i]==<span class="number">0</span>) n/=pri[i],c++;</span><br><span class="line">        res*=c+<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(n==<span class="number">1</span>) <span class="keyword">return</span> res;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">CheckSqr</span>(n)) <span class="keyword">return</span> res*<span class="number">3</span>;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">Miller_Rabin</span>(n)) <span class="keyword">return</span> res*<span class="number">2</span>;</span><br><span class="line">    <span class="keyword">return</span> res*<span class="number">4</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Init</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">rep</span>(i,<span class="number">2</span>,N<span class="number">-1</span>) <span class="keyword">if</span>(!notpri[i]) &#123;</span><br><span class="line">        pri[++pc]=i;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> j=i+i;j&lt;N;j+=i) notpri[j]=<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="part2-快速计算答案">Part2 快速计算答案</h2>
<p><span class="math inline">\(10^9\)</span> 以内的数，最大因子个数为
<span class="math inline">\(1334\)</span> ，这个数为 <span
class="math inline">\(931170240\)</span></p>
<p>转成二进制之后最多包含 <span class="math inline">\(11\)</span>
位，三进制下最大为 <span class="math inline">\(3^{11}-1=177146\)</span>
，令这个上界为 <span class="math inline">\(M\)</span></p>
<p>一种非常暴力的方法就是直接枚举， <span
class="math inline">\(NM\)</span> 计算每次选择一个数，复杂度为 <span
class="math inline">\(O(NMK)\)</span> ，应该可以通过 <span
class="math inline">\(N\leq 12\)</span> 的数据</p>
<p>一个比较浅显的优化可以用快速幂维护乘法，复杂度为 <span
class="math inline">\(O(M^2\log K)\)</span></p>
<p>由于是3进制类异或，接下来考虑用 <span
class="math inline">\(\text{3-FWT}\)</span> 优化乘法，<a
target="_blank" rel="noopener" href="https://www.cnblogs.com/chasedeath/p/12785842.html"><strong>可以参考</strong></a></p>
<p>模数为 <span class="math inline">\(P=10^9+7\)</span> ，不存在整数
<span class="math inline">\(3\)</span> 阶单位根，因此要用类似拆系数
<span class="math inline">\(\text{FFT}\)</span> 方法做</p>
<p>复杂度为 <span class="math inline">\(O(M\log M\log K)\)</span>
，似乎已经比较小了，但是常数非常大，应该难以通过</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> R;<span class="comment">// R为上界</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Cp</span>&#123;</span><br><span class="line">    db x,y;</span><br><span class="line">    <span class="built_in">Cp</span>()&#123;&#125;</span><br><span class="line">    <span class="built_in">Cp</span>(db x,db y):<span class="built_in">x</span>(x),<span class="built_in">y</span>(y) &#123;&#125;</span><br><span class="line">    Cp <span class="keyword">operator</span> + (<span class="type">const</span> Cp t)&#123; <span class="keyword">return</span> <span class="built_in">Cp</span>(x+t.x,y+t.y); &#125;</span><br><span class="line">    Cp <span class="keyword">operator</span> - (<span class="type">const</span> Cp t)&#123; <span class="keyword">return</span> <span class="built_in">Cp</span>(x-t.x,y-t.y); &#125;</span><br><span class="line">    Cp <span class="keyword">operator</span> * (<span class="type">const</span> Cp t)&#123; <span class="keyword">return</span> <span class="built_in">Cp</span>(x*t.x-y*t.y,x*t.y+y*t.x); &#125;</span><br><span class="line">&#125; A[N],B[N],C[N],D[N];</span><br><span class="line">Cp w[<span class="number">30</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Add</span><span class="params">(<span class="type">int</span> x,<span class="type">int</span> y)</span> </span>&#123;</span><br><span class="line">    <span class="type">static</span> <span class="type">int</span> A[<span class="number">20</span>],B[<span class="number">20</span>];</span><br><span class="line">    <span class="built_in">rep</span>(i,<span class="number">0</span>,<span class="number">19</span>) A[i]=x%<span class="number">3</span>,x/=<span class="number">3</span>;</span><br><span class="line">    <span class="built_in">rep</span>(i,<span class="number">0</span>,<span class="number">19</span>) B[i]=y%<span class="number">3</span>,y/=<span class="number">3</span>;</span><br><span class="line">    <span class="type">int</span> ans=<span class="number">0</span>;</span><br><span class="line">    <span class="built_in">drep</span>(i,<span class="number">19</span>,<span class="number">0</span>) ans=ans*<span class="number">3</span>+((A[i]+B[i])%<span class="number">3</span>);</span><br><span class="line">    <span class="keyword">return</span> ans;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">FWT</span><span class="params">(Cp *a,<span class="type">int</span> f)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">1</span>;i&lt;R;i*=<span class="number">3</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> l=<span class="number">0</span>;l&lt;R;l+=i*<span class="number">3</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> j=l;j&lt;l+i;++j) &#123;</span><br><span class="line">                <span class="type">static</span> Cp t[<span class="number">3</span>];</span><br><span class="line">                <span class="keyword">if</span>(f==<span class="number">1</span>) &#123;</span><br><span class="line">                    t[<span class="number">0</span>]=a[j]+a[j+i]+a[j+i*<span class="number">2</span>];</span><br><span class="line">                    t[<span class="number">1</span>]=a[j]+w[<span class="number">1</span>]*a[j+i]+w[<span class="number">2</span>]*a[j+i*<span class="number">2</span>];</span><br><span class="line">                    t[<span class="number">2</span>]=a[j]+w[<span class="number">2</span>]*a[j+i]+w[<span class="number">1</span>]*a[j+i*<span class="number">2</span>];</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    t[<span class="number">0</span>]=a[j]+a[j+i]+a[j+i*<span class="number">2</span>];</span><br><span class="line">                    t[<span class="number">1</span>]=a[j]+w[<span class="number">2</span>]*a[j+i]+w[<span class="number">1</span>]*a[j+i*<span class="number">2</span>];</span><br><span class="line">                    t[<span class="number">2</span>]=a[j]+w[<span class="number">1</span>]*a[j+i]+w[<span class="number">2</span>]*a[j+i*<span class="number">2</span>];</span><br><span class="line">                &#125;</span><br><span class="line">                a[j]=t[<span class="number">0</span>],a[j+i]=t[<span class="number">1</span>],a[j+i*<span class="number">2</span>]=t[<span class="number">2</span>];</span><br><span class="line">                <span class="keyword">if</span>(f==<span class="number">-1</span>) &#123;</span><br><span class="line">                    <span class="built_in">rep</span>(d,<span class="number">0</span>,<span class="number">2</span>) &#123;</span><br><span class="line">                        a[j+i*d].x/=<span class="number">3</span>,a[j+i*d].y/=<span class="number">3</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> S=(<span class="number">1</span>&lt;&lt;<span class="number">15</span>)<span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FWTs</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Poly</span>&#123; </span><br><span class="line">    <span class="type">int</span> a[N];</span><br><span class="line">    Poly <span class="keyword">operator</span> * (<span class="type">const</span> Poly __) <span class="type">const</span> &#123;</span><br><span class="line">        Poly res;</span><br><span class="line">        <span class="comment">// 拆系数，任意模数3-FWT</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> FWTs</span></span><br><span class="line">        <span class="built_in">rep</span>(i,<span class="number">0</span>,R<span class="number">-1</span>) A[i]=<span class="built_in">Cp</span>((a[i]&amp;S),(a[i]&gt;&gt;<span class="number">15</span>)),B[i]=<span class="built_in">Cp</span>((a[i]&amp;S),<span class="number">0</span>);</span><br><span class="line">        <span class="built_in">rep</span>(i,<span class="number">0</span>,R<span class="number">-1</span>) C[i]=<span class="built_in">Cp</span>((__.a[i]&amp;S),(__.a[i]&gt;&gt;<span class="number">15</span>));</span><br><span class="line">        <span class="built_in">FWT</span>(A,<span class="number">1</span>),<span class="built_in">FWT</span>(B,<span class="number">1</span>),<span class="built_in">FWT</span>(C,<span class="number">1</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> E(x) ((ll)(x+0.5))%P</span></span><br><span class="line">        <span class="built_in">rep</span>(i,<span class="number">0</span>,R<span class="number">-1</span>) A[i]=A[i]*C[i];</span><br><span class="line">        <span class="built_in">rep</span>(i,<span class="number">0</span>,R<span class="number">-1</span>) B[i]=B[i]*C[i];</span><br><span class="line">        <span class="built_in">FWT</span>(A,<span class="number">-1</span>),<span class="built_in">FWT</span>(B,<span class="number">-1</span>);</span><br><span class="line">        <span class="built_in">rep</span>(i,<span class="number">0</span>,R<span class="number">-1</span>) &#123;</span><br><span class="line">            ll a=<span class="built_in">E</span>(B[i].x),b=<span class="built_in">E</span>(A[i].y),c=<span class="built_in">E</span>(B[i].x-A[i].x);</span><br><span class="line">            res.a[i]=(a+<span class="number">1ll</span>*b*(S+<span class="number">1</span>)+<span class="number">1ll</span>*c*(S+<span class="number">1</span>)*(S+<span class="number">1</span>))%P;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">        <span class="built_in">rep</span>(i,<span class="number">0</span>,R<span class="number">-1</span>) res.a[i]=<span class="number">0</span>;</span><br><span class="line">        <span class="built_in">rep</span>(i,<span class="number">0</span>,R<span class="number">-1</span>) <span class="keyword">if</span>(a[i]) <span class="built_in">rep</span>(j,<span class="number">0</span>,R<span class="number">-1</span>) <span class="keyword">if</span>(__.a[j]) &#123;</span><br><span class="line">            <span class="type">int</span> k=<span class="built_in">Add</span>(i,j);</span><br><span class="line">            res.a[k]=(res.a[k]+<span class="number">1ll</span>*a[i]*__.a[j])%P;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; x,res;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">ll <span class="title">qpow</span><span class="params">(ll x,ll k=P<span class="number">-2</span>)</span> </span>&#123;</span><br><span class="line">    ll res=<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span>(;k;k&gt;&gt;=<span class="number">1</span>,x=x*x%P) <span class="keyword">if</span>(k&amp;<span class="number">1</span>) res=res*x%P;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">rep</span>(i,<span class="number">2</span>,N<span class="number">-1</span>) <span class="keyword">if</span>(!notpri[i]) &#123;</span><br><span class="line">        pri[++pc]=i;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> j=i+i;j&lt;N;j+=i) notpri[j]=<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    w[<span class="number">0</span>]=<span class="built_in">Cp</span>(<span class="number">1</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="built_in">rep</span>(i,<span class="number">1</span>,<span class="number">29</span>) w[i]=w[i<span class="number">-1</span>]*<span class="built_in">Cp</span>(<span class="built_in">cos</span>(<span class="number">2</span>*Pi/<span class="number">3</span>),<span class="built_in">sin</span>(<span class="number">2</span>*Pi/<span class="number">3</span>));</span><br><span class="line">    <span class="comment">// 复平面3阶单位根</span></span><br><span class="line"></span><br><span class="line">    n=<span class="built_in">rd</span>(),m=<span class="built_in">rd</span>();</span><br><span class="line">    <span class="built_in">rep</span>(i,<span class="number">1</span>,n) x.a[<span class="built_in">Count</span>(<span class="built_in">rd</span>())]++;</span><br><span class="line">    <span class="keyword">for</span>(R=<span class="number">1</span>;R&lt;=ma;R*=<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">    res.a[<span class="number">0</span>]++;</span><br><span class="line">    <span class="keyword">for</span>(;m;m&gt;&gt;=<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>(m&amp;<span class="number">1</span>) res=res*x;</span><br><span class="line">        x=x*x;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> ans=<span class="number">0</span>;</span><br><span class="line">    <span class="built_in">rep</span>(i,<span class="number">1</span>,R<span class="number">-1</span>) ans+=res.a[i],<span class="built_in">Mod1</span>(ans);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>,ans);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="further">Further</h3>
<p>对于形式幂级数多项式，我们知道 <span class="math inline">\(K\)</span>
次幂的循环卷积可以直接 <span class="math inline">\(\text{DFT}\)</span>
一次，每一位快速幂，然后 <span
class="math inline">\(\text{IDFT}\)</span></p>
<p>同理的，如果你学习了 <span
class="math inline">\(\text{K-FWT}\)</span> 就知道这就是一个按 <span
class="math inline">\(K\)</span>
进制位，每一位分别进行循环卷积，因此也可以用类似的方法做</p>
<p>但是遇到一个非常大的问题就是无法找到模意义下的 <span
class="math inline">\(3\)</span> 阶单位根(指 <span
class="math inline">\(3\not |(P-1)\)</span> )</p>
<p>如果用复平面单位根 <span
class="math inline">\(\omega_n=cos(\frac{2\pi}{n})+sin(\frac{2\pi}{n})\cdot
i\)</span> ( <span class="math inline">\(i=\sqrt {-1})\)</span>
，无法在计算时保证值域精度</p>
<p>这里由于 <span class="math inline">\(n=3\)</span> 比较特殊，发现
<span
class="math inline">\(\omega_3=cos(\frac{2\pi}{3})+sin(\frac{2\pi}{3})\cdot
i=-\frac{1}{2}+\frac{\sqrt 3}{2}\cdot i\)</span></p>
<p>而 <span class="math inline">\(3\)</span> 在 <span
class="math inline">\(\mod 10^9+7\)</span>
下存在二次剩余，因此可以用一个模意义下的复数描述复平面单位根</p>
<p>应该是有通行的单位根求法，会根据 <span
class="math inline">\(n\)</span>
不同要用更复杂的高维复数描述，但是我并不会.jpg</p>
<p>总复杂度为 <span class="math inline">\(O(M(\log M+\log K))\)</span>
，分别为进行 <span class="math inline">\(\text{3-FWT}\)</span>
以及快速幂的复杂度</p>
<p>Code总览:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">long</span> <span class="type">long</span> ll;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> ull;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">long</span> <span class="type">double</span> db;</span><br><span class="line"><span class="keyword">typedef</span> pair &lt;<span class="type">int</span>,<span class="type">int</span>&gt; Pii;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> reg register</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> pb push_back</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> mp make_pair</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> Mod1(x) ((x&gt;=P)&amp;&amp;(x-=P))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> Mod2(x) ((x&lt;0)&amp;&amp;(x+=P))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> rep(i,a,b) for(int i=a,i##end=b;i&lt;=i##end;++i)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> drep(i,a,b) for(int i=a,i##end=b;i&gt;=i##end;--i)</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt; <span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">cmin</span><span class="params">(T &amp;a,T b)</span></span>&#123; ((a&gt;b)&amp;&amp;(a=b)); &#125;</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt; <span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">cmax</span><span class="params">(T &amp;a,T b)</span></span>&#123; ((a&lt;b)&amp;&amp;(a=b)); &#125;</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> IO;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">rd</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="type">int</span> s=<span class="number">0</span>,f=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(!<span class="built_in">isdigit</span>(IO=<span class="built_in">getchar</span>())) <span class="keyword">if</span>(IO==<span class="string">&#x27;-&#x27;</span>) f=<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">do</span> s=(s&lt;&lt;<span class="number">1</span>)+(s&lt;&lt;<span class="number">3</span>)+(IO^<span class="string">&#x27;0&#x27;</span>);</span><br><span class="line">    <span class="keyword">while</span>(<span class="built_in">isdigit</span>(IO=<span class="built_in">getchar</span>()));</span><br><span class="line">    <span class="keyword">return</span> f?-s:s;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">bool</span> Mbe;</span><br><span class="line"><span class="type">const</span> <span class="type">int</span> N=<span class="number">2e5</span>,P=<span class="number">1e9</span>+<span class="number">7</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">int</span> Quad3=<span class="number">82062379</span>; <span class="comment">// 3在Mod P意义下的二次剩余</span></span><br><span class="line"><span class="type">const</span> db Pi=<span class="built_in">acos</span>((db)<span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> MaxX=<span class="number">931170240</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> n,m,ma,R;</span><br><span class="line"><span class="type">int</span> notpri[N],pri[N],pc;</span><br><span class="line"></span><br><span class="line"><span class="function">ll <span class="title">qpow</span><span class="params">(ll x,ll k=P<span class="number">-2</span>,<span class="type">int</span> P=::P)</span> </span>&#123;</span><br><span class="line">    ll res=<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span>(;k;k&gt;&gt;=<span class="number">1</span>,x=x*x%P) <span class="keyword">if</span>(k&amp;<span class="number">1</span>) res=res*x%P;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Trans</span><span class="params">(<span class="type">int</span> x)</span></span>&#123; </span><br><span class="line">    <span class="type">static</span> <span class="type">int</span> buf[<span class="number">20</span>],l=<span class="number">0</span>;</span><br><span class="line">    l=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(x) buf[++l]=x%<span class="number">2</span>,x/=<span class="number">2</span>;</span><br><span class="line">    <span class="type">int</span> s=<span class="number">0</span>;</span><br><span class="line">    <span class="built_in">drep</span>(i,l,<span class="number">1</span>) s=s*<span class="number">3</span>+buf[i];</span><br><span class="line">    <span class="built_in">cmax</span>(ma,s);</span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Miller_Rabin</span><span class="params">(<span class="type">int</span> x)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(x&lt;N) <span class="keyword">return</span> !notpri[x];</span><br><span class="line">    <span class="keyword">if</span>(x==<span class="number">2</span>) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span>(x&lt;=<span class="number">1</span> || ~x&amp;<span class="number">1</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    ll s=<span class="number">0</span>,t=x<span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">while</span>(~t&amp;<span class="number">1</span>) s++,t&gt;&gt;=<span class="number">1</span>;</span><br><span class="line">    <span class="built_in">rep</span>(i,<span class="number">1</span>,<span class="number">4</span>) &#123;</span><br><span class="line">        ll a=pri[<span class="built_in">rand</span>()%pc+<span class="number">1</span>],b=<span class="built_in">qpow</span>(a,t,x),c;</span><br><span class="line">        <span class="built_in">rep</span>(j,<span class="number">1</span>,s) &#123;</span><br><span class="line">            c=<span class="number">1ll</span>*b*b%x;</span><br><span class="line">            <span class="keyword">if</span>(c==<span class="number">1</span> &amp;&amp; b!=<span class="number">1</span> &amp;&amp; b!=x<span class="number">-1</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            b=c;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(b!=<span class="number">1</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">CheckSqr</span><span class="params">(<span class="type">int</span> n)</span></span>&#123;</span><br><span class="line">    <span class="type">int</span> y=<span class="built_in">round</span>(<span class="built_in">sqrt</span>(n));</span><br><span class="line">    <span class="keyword">return</span> y*y==n;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Count</span><span class="params">(<span class="type">int</span> n)</span></span>&#123;</span><br><span class="line">    <span class="type">int</span> res=<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">1</span>;i&lt;=pc &amp;&amp; pri[i]*pri[i]*pri[i]&lt;=n;++i) <span class="keyword">if</span>(n%pri[i]==<span class="number">0</span>) &#123;</span><br><span class="line">        <span class="type">int</span> c=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>(n%pri[i]==<span class="number">0</span>) n/=pri[i],c++;</span><br><span class="line">        res*=c+<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(n==<span class="number">1</span>) <span class="keyword">return</span> res;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">CheckSqr</span>(n)) <span class="keyword">return</span> res*<span class="number">3</span>;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">Miller_Rabin</span>(n)) <span class="keyword">return</span> res*<span class="number">2</span>;</span><br><span class="line">    <span class="keyword">return</span> res*<span class="number">4</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Cp</span>&#123;</span><br><span class="line">    <span class="type">int</span> x,y;</span><br><span class="line">    <span class="built_in">Cp</span>()&#123;&#125;</span><br><span class="line">    <span class="built_in">Cp</span>(<span class="type">int</span> x,<span class="type">int</span> y):<span class="built_in">x</span>(x),<span class="built_in">y</span>(y) &#123;&#125;</span><br><span class="line">    Cp <span class="keyword">operator</span> + (<span class="type">const</span> Cp t)&#123; </span><br><span class="line">        <span class="function">Cp <span class="title">res</span><span class="params">(x+t.x,y+t.y)</span></span>;</span><br><span class="line">        <span class="built_in">Mod1</span>(res.x),<span class="built_in">Mod1</span>(res.y);</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">    Cp <span class="keyword">operator</span> * (<span class="type">const</span> Cp t)&#123; <span class="keyword">return</span> <span class="built_in">Cp</span>((<span class="number">1ll</span>*x*t.x+<span class="number">1ll</span>*(P-y)*t.y)%P,(<span class="number">1ll</span>*x*t.y+<span class="number">1ll</span>*y*t.x)%P); &#125;</span><br><span class="line">&#125; A[N]; <span class="comment">// 模意义下 模拟复平面单位根</span></span><br><span class="line">Cp w1,w2; <span class="comment">// 3阶单位根及其平方</span></span><br><span class="line"></span><br><span class="line"><span class="function">Cp <span class="title">qpow</span><span class="params">(Cp x,ll k=P<span class="number">-2</span>)</span> </span>&#123;</span><br><span class="line">    <span class="function">Cp <span class="title">res</span><span class="params">(<span class="number">1</span>,<span class="number">0</span>)</span></span>;</span><br><span class="line">    <span class="keyword">for</span>(;k;k&gt;&gt;=<span class="number">1</span>,x=x*x) <span class="keyword">if</span>(k&amp;<span class="number">1</span>) res=res*x;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 下面是展开的FWT式子</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">FWT</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">1</span>;i&lt;R;i*=<span class="number">3</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> l=<span class="number">0</span>;l&lt;R;l+=i*<span class="number">3</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> j=l;j&lt;l+i;++j) &#123;</span><br><span class="line">                Cp a=A[j]+A[j+i]+A[j+i*<span class="number">2</span>];</span><br><span class="line">                Cp b=A[j]+w1*A[j+i]+w2*A[j+i*<span class="number">2</span>];</span><br><span class="line">                Cp c=A[j]+w2*A[j+i]+w1*A[j+i*<span class="number">2</span>];</span><br><span class="line">                A[j]=a,A[j+i]=b,A[j+i*<span class="number">2</span>]=c;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">IFWT</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">1</span>;i&lt;R;i*=<span class="number">3</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> l=<span class="number">0</span>;l&lt;R;l+=i*<span class="number">3</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> j=l;j&lt;l+i;++j) &#123;</span><br><span class="line">                Cp a=A[j]+A[j+i]+A[j+i*<span class="number">2</span>];</span><br><span class="line">                Cp b=A[j]+w2*A[j+i]+w1*A[j+i*<span class="number">2</span>];</span><br><span class="line">                Cp c=A[j]+w1*A[j+i]+w2*A[j+i*<span class="number">2</span>];</span><br><span class="line">                A[j]=a,A[j+i]=b,A[j+i*<span class="number">2</span>]=c;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ll base=<span class="built_in">qpow</span>(R);</span><br><span class="line">    <span class="built_in">rep</span>(i,<span class="number">0</span>,R<span class="number">-1</span>) A[i].x=A[i].x*base%P;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">rep</span>(i,<span class="number">2</span>,N<span class="number">-1</span>) <span class="keyword">if</span>(!notpri[i]) &#123;</span><br><span class="line">        pri[++pc]=i;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> j=i+i;j&lt;N;j+=i) notpri[j]=<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    w1=<span class="built_in">Cp</span>(P-(P+<span class="number">1</span>)/<span class="number">2</span>,<span class="number">1ll</span>*Quad3*(P+<span class="number">1</span>)/<span class="number">2</span>%P);</span><br><span class="line">    w2=w1*w1;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">rep</span>(kase,<span class="number">1</span>,<span class="built_in">rd</span>()) &#123;</span><br><span class="line">        n=<span class="built_in">rd</span>(),m=<span class="built_in">rd</span>();</span><br><span class="line">        <span class="built_in">rep</span>(i,<span class="number">1</span>,n) A[<span class="built_in">Trans</span>(<span class="built_in">Count</span>(<span class="built_in">rd</span>())<span class="number">-1</span>)].x++;</span><br><span class="line">        <span class="keyword">for</span>(R=<span class="number">1</span>;R&lt;=ma;R*=<span class="number">3</span>);</span><br><span class="line">        <span class="built_in">FWT</span>();</span><br><span class="line">        <span class="built_in">rep</span>(i,<span class="number">0</span>,R<span class="number">-1</span>) A[i]=<span class="built_in">qpow</span>(A[i],m);</span><br><span class="line">        <span class="built_in">IFWT</span>();</span><br><span class="line">        <span class="type">int</span> ans=<span class="number">0</span>;</span><br><span class="line">        <span class="built_in">rep</span>(i,<span class="number">1</span>,R<span class="number">-1</span>) ans+=A[i].x,<span class="built_in">Mod1</span>(ans);</span><br><span class="line">        <span class="built_in">rep</span>(i,<span class="number">0</span>,R<span class="number">-1</span>) A[i].x=A[i].y=<span class="number">0</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>,ans);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://compilationfail.github.io/oi-solutions/CodeChef/CodeChefNOV19%20PrettyBox/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="orangejuice">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="orangejuice's blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | orangejuice's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/oi-solutions/CodeChef/CodeChefNOV19%20PrettyBox/" class="post-title-link" itemprop="url">Codechef November Chanllenge 2019 Div1 PrettyBox (贪心，线段树)</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2023-08-12 00:11:59 / Modified: 14:44:14" itemprop="dateCreated datePublished" datetime="2023-08-12T00:11:59+08:00">2023-08-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/CP-%E9%A2%98%E8%A7%A3/" itemprop="url" rel="index"><span itemprop="name">CP 题解</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1
id="codechef-november-chanllenge-2019-div1-prettybox-贪心线段树">Codechef
November Chanllenge 2019 Div1 PrettyBox (贪心，线段树)</h1>
<p><a
target="_blank" rel="noopener" href="https://www.codechef.com/NOV19A/problems/PBOXES">原题链接</a></p>
<p>前言：这篇文章主要讲如何用线段树优化贪心，关于贪心的证明建议看<a
target="_blank" rel="noopener" href="https://discuss.codechef.com/t/pboxes-editorial/44102">官方题解</a></p>
<p>贪心思路：</p>
<p>首先肯定要按照 <span class="math inline">\((S_i,P_i)\)</span>
递增的顺序排序</p>
<p>每次选取两个点，一个标记为左括号，权值为 <span
class="math inline">\(-P_i\)</span> ，一个标记为右括号，权值为 <span
class="math inline">\(P_i\)</span>
，显然只要是一个合法的括号序列即可</p>
<p>题解证明了在不断增加括号时，不会出现一个位置的括号情况改变</p>
<p>现在我们的贪心问题就在于怎样找到一对最优的括号，注意每次选出的
<strong>两个括号之间并不一定匹配</strong></p>
<p>为了便于描述，把左括号看做1，右括号看做-1，一个合法括号序列满足任何一个前缀和
<span class="math inline">\(\ge 0\)</span></p>
<p>考虑什么样的情况可以放置左右括号，设分别放在 <span
class="math inline">\(x,y\)</span></p>
<ol type="1">
<li><p><span class="math inline">\(x&lt;y\)</span> 显然合法</p></li>
<li><p><span class="math inline">\(x&gt;y\)</span>
时，如果存在一个括号对，将 <span class="math inline">\((x,y)\)</span>
包含在一起，即 <span class="math inline">\((y,x)\)</span>
这一段区间不跨过一个前缀和为 <span class="math inline">\(0\)</span>
的位置</p></li>
</ol>
<p>如果把序列 看做 由一段段 <strong>前缀和为0的位置</strong> 分割开来的
一个个<strong>联通块</strong>，似乎比较好理解</p>
<p>也就是块内随意选，之间只能由小到大匹配</p>
<p>接下来考虑用线段树维护这样的块的信息，下面只讨论 <span
class="math inline">\(x&gt;y\)</span> 的情况</p>
<p>由于线段树每个结点统计区间 <span class="math inline">\([l,r]\)</span>
的信息，所以实际上块之间的间隔并不为0</p>
<p>设 <span class="math inline">\([l,r]\)</span> 中最小的前缀和为 <span
class="math inline">\(Min\)</span> (是指从 <span
class="math inline">\(l\)</span> 开始的前缀和)</p>
<p>不妨统计 <span class="math inline">\([l,r]\)</span>
中不跨过一个前缀和为 <span class="math inline">\(Min\)</span>
的位置的答案 <span class="math inline">\(Ans\)</span> ，以及跨过的答案
<span class="math inline">\(Ans2\)</span></p>
<p>合并两个区间时，需要找到</p>
<p>左区间中 右边连续的一段不跨过最小值 的最大权值 <span
class="math inline">\(R\)</span></p>
<p>右区间中 左边连续的一段不跨过最小值 的最小权值 <span
class="math inline">\(L\)</span></p>
<p>以及任意的最小值最大值 <span class="math inline">\(mi,ma\)</span></p>
<p>然后按照 <span class="math inline">\(Min\)</span> 的权值大小关系
，判断这4种权值的合并应该被分配到 <span
class="math inline">\(Ans\)</span> 还是 <span
class="math inline">\(Ans2\)</span></p>
<p>合并 <span class="math inline">\(L,R\)</span> 时注意 <span
class="math inline">\(L\)</span> 优先看左儿子， <span
class="math inline">\(R\)</span> 优先看右儿子，具体实现看代码中的 <span
class="math inline">\(Up\)</span> 函数</p>
<p>每次存下答案找到最优配对后，在序列上对应放置-1,1单点修改即可，复杂度为
<span class="math inline">\(O(n\log n)\)</span></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">long</span> <span class="type">long</span> ll;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> ull;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">double</span> db;</span><br><span class="line"><span class="keyword">typedef</span> pair &lt;<span class="type">int</span>,<span class="type">int</span>&gt; Pii;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> reg register</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> pb push_back</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> mp make_pair</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> Mod1(x) ((x&gt;=P)&amp;&amp;(x-=P))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> Mod2(x) ((x&lt;0)&amp;&amp;(x+=P))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> rep(i,a,b) for(int i=a,i##end=b;i&lt;=i##end;++i)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> drep(i,a,b) for(int i=a,i##end=b;i&gt;=i##end;--i)</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt; <span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">cmin</span><span class="params">(T &amp;a,T b)</span></span>&#123; a=<span class="built_in">min</span>(a,b); &#125;</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt; <span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">cmax</span><span class="params">(T &amp;a,T b)</span></span>&#123; a=<span class="built_in">max</span>(a,b); &#125;</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> IO;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">rd</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="type">int</span> s=<span class="number">0</span>,f=<span class="number">0</span>;</span><br><span class="line">	<span class="keyword">while</span>(!<span class="built_in">isdigit</span>(IO=<span class="built_in">getchar</span>())) <span class="keyword">if</span>(IO==<span class="string">&#x27;-&#x27;</span>) f=<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">do</span> s=(s&lt;&lt;<span class="number">1</span>)+(s&lt;&lt;<span class="number">3</span>)+(IO^<span class="string">&#x27;0&#x27;</span>);</span><br><span class="line">	<span class="keyword">while</span>(<span class="built_in">isdigit</span>(IO=<span class="built_in">getchar</span>()));</span><br><span class="line">	<span class="keyword">return</span> f?-s:s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> N=<span class="number">2e5</span>+<span class="number">10</span>,M=N&lt;&lt;<span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> n;</span><br><span class="line">Pii T[N];</span><br><span class="line"><span class="type">int</span> A[N];</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> S[M]; <span class="comment">// 区间和</span></span><br><span class="line"><span class="type">int</span> Min[M]; <span class="comment">// 前缀最小值</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Node</span>&#123;</span><br><span class="line">	<span class="type">int</span> x;</span><br><span class="line">	<span class="built_in">Node</span>()&#123;&#125;</span><br><span class="line">	<span class="built_in">Node</span>(<span class="type">int</span> x):<span class="built_in">x</span>(x)&#123;&#125;</span><br><span class="line">	<span class="type">int</span> <span class="keyword">operator</span> &lt; (<span class="type">const</span> Node __) <span class="type">const</span> &#123; <span class="keyword">return</span> A[x]&lt;A[__.x]; &#125;</span><br><span class="line">&#125; L[M],R[M]; <span class="comment">// 左最小，右最大  , 记录的是不跨过最小值的权值</span></span><br><span class="line">Node mi[M],ma[M]; <span class="comment">// 区间最大最小，没有限制</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Pair</span>&#123;</span><br><span class="line">	<span class="type">int</span> x,y;</span><br><span class="line">	<span class="built_in">Pair</span>()&#123;&#125;</span><br><span class="line">	<span class="built_in">Pair</span>(<span class="type">int</span> x,<span class="type">int</span> y):<span class="built_in">x</span>(x),<span class="built_in">y</span>(y)&#123;&#125;</span><br><span class="line">	<span class="built_in">Pair</span>(Node x,Node y):<span class="built_in">x</span>(x.x),<span class="built_in">y</span>(y.x)&#123;&#125;</span><br><span class="line">	<span class="function"><span class="type">int</span> <span class="title">Val</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> A[y]-A[x]; &#125;</span><br><span class="line">	<span class="type">int</span> <span class="keyword">operator</span> &lt; (<span class="type">const</span> Pair __) <span class="type">const</span> &#123; <span class="keyword">return</span> <span class="built_in">Val</span>()&lt;__.<span class="built_in">Val</span>(); &#125;</span><br><span class="line">&#125; Ans[M],Ans2[M]; <span class="comment">// 不跨过最小值的答案以及x&lt;y的答案，包含最小值的答案</span></span><br><span class="line"><span class="comment">// 区间答案</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Up</span><span class="params">(<span class="type">int</span> p)</span></span>&#123;</span><br><span class="line">	S[p]=S[p&lt;&lt;<span class="number">1</span>]+S[p&lt;&lt;<span class="number">1</span>|<span class="number">1</span>];</span><br><span class="line">	Min[p]=<span class="built_in">min</span>(Min[p&lt;&lt;<span class="number">1</span>],S[p&lt;&lt;<span class="number">1</span>]+Min[p&lt;&lt;<span class="number">1</span>|<span class="number">1</span>]);</span><br><span class="line">	mi[p]=<span class="built_in">min</span>(mi[p&lt;&lt;<span class="number">1</span>],mi[p&lt;&lt;<span class="number">1</span>|<span class="number">1</span>]),ma[p]=<span class="built_in">max</span>(ma[p&lt;&lt;<span class="number">1</span>],ma[p&lt;&lt;<span class="number">1</span>|<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">	Ans[p]=<span class="built_in">max</span>(Ans[p&lt;&lt;<span class="number">1</span>],Ans[p&lt;&lt;<span class="number">1</span>|<span class="number">1</span>]);</span><br><span class="line">	Ans2[p]=<span class="built_in">Pair</span>(mi[p&lt;&lt;<span class="number">1</span>|<span class="number">1</span>],ma[p&lt;&lt;<span class="number">1</span>]);</span><br><span class="line">	<span class="built_in">cmax</span>(Ans2[p],Ans2[p&lt;&lt;<span class="number">1</span>]);</span><br><span class="line">	<span class="built_in">cmax</span>(Ans2[p],Ans2[p&lt;&lt;<span class="number">1</span>|<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">cmax</span>(Ans[p],<span class="built_in">Pair</span>(mi[p&lt;&lt;<span class="number">1</span>],ma[p&lt;&lt;<span class="number">1</span>|<span class="number">1</span>]));</span><br><span class="line">	Ans[p]=<span class="built_in">max</span>(Ans[p],<span class="built_in">Pair</span>(L[p&lt;&lt;<span class="number">1</span>|<span class="number">1</span>],R[p&lt;&lt;<span class="number">1</span>]));</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(Min[p&lt;&lt;<span class="number">1</span>]!=Min[p]) &#123;</span><br><span class="line">		<span class="built_in">cmax</span>(Ans[p],Ans2[p&lt;&lt;<span class="number">1</span>]);</span><br><span class="line">		<span class="built_in">cmax</span>(Ans[p],<span class="built_in">Pair</span>(L[p&lt;&lt;<span class="number">1</span>|<span class="number">1</span>],ma[p&lt;&lt;<span class="number">1</span>]));</span><br><span class="line">		L[p]=<span class="built_in">min</span>(mi[p&lt;&lt;<span class="number">1</span>],L[p&lt;&lt;<span class="number">1</span>|<span class="number">1</span>]);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		L[p]=L[p&lt;&lt;<span class="number">1</span>];</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(S[p&lt;&lt;<span class="number">1</span>]+Min[p&lt;&lt;<span class="number">1</span>|<span class="number">1</span>]!=Min[p]) &#123;</span><br><span class="line">		<span class="built_in">cmax</span>(Ans[p],Ans2[p&lt;&lt;<span class="number">1</span>|<span class="number">1</span>]);</span><br><span class="line">		<span class="built_in">cmax</span>(Ans[p],<span class="built_in">Pair</span>(mi[p&lt;&lt;<span class="number">1</span>|<span class="number">1</span>],R[p&lt;&lt;<span class="number">1</span>]));</span><br><span class="line">		R[p]=<span class="built_in">max</span>(R[p&lt;&lt;<span class="number">1</span>],ma[p&lt;&lt;<span class="number">1</span>|<span class="number">1</span>]);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		R[p]=R[p&lt;&lt;<span class="number">1</span>|<span class="number">1</span>];</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Build</span><span class="params">(<span class="type">int</span> p,<span class="type">int</span> l,<span class="type">int</span> r)</span></span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(l==r) &#123;</span><br><span class="line">		S[p]=Min[p]=<span class="number">0</span>;</span><br><span class="line">		L[p]=n+<span class="number">1</span>,R[p]=n+<span class="number">2</span>;</span><br><span class="line">		mi[p]=ma[p]=l;</span><br><span class="line">		Ans[p]=Ans2[p]=<span class="built_in">Pair</span>(n+<span class="number">1</span>,n+<span class="number">2</span>);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="type">int</span> mid=(l+r)&gt;&gt;<span class="number">1</span>;</span><br><span class="line">	<span class="built_in">Build</span>(p&lt;&lt;<span class="number">1</span>,l,mid),<span class="built_in">Build</span>(p&lt;&lt;<span class="number">1</span>|<span class="number">1</span>,mid+<span class="number">1</span>,r);</span><br><span class="line">	<span class="built_in">Up</span>(p);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Upd</span><span class="params">(<span class="type">int</span> p,<span class="type">int</span> l,<span class="type">int</span> r,<span class="type">int</span> x,<span class="type">int</span> k)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(l==r) &#123;</span><br><span class="line">		S[p]=Min[p]=k;</span><br><span class="line">		L[p]=n+<span class="number">1</span>,R[p]=n+<span class="number">2</span>;</span><br><span class="line">		mi[p]=n+<span class="number">1</span>,ma[p]=n+<span class="number">2</span>;</span><br><span class="line">		Ans[p]=Ans2[p]=<span class="built_in">Pair</span>(n+<span class="number">1</span>,n+<span class="number">2</span>);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="type">int</span> mid=(l+r)&gt;&gt;<span class="number">1</span>;</span><br><span class="line">	x&lt;=mid?<span class="built_in">Upd</span>(p&lt;&lt;<span class="number">1</span>,l,mid,x,k):<span class="built_in">Upd</span>(p&lt;&lt;<span class="number">1</span>|<span class="number">1</span>,mid+<span class="number">1</span>,r,x,k);</span><br><span class="line">	<span class="built_in">Up</span>(p);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">1</span>,n=<span class="built_in">rd</span>()) T[i].first=<span class="built_in">rd</span>(),T[i].second=<span class="built_in">rd</span>();</span><br><span class="line">	<span class="built_in">sort</span>(T+<span class="number">1</span>,T+n+<span class="number">1</span>);</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">1</span>,n) A[i]=T[i].second;</span><br><span class="line">	A[n+<span class="number">1</span>]=<span class="number">1e9</span>+<span class="number">10</span>,A[n+<span class="number">2</span>]=<span class="number">-1e9</span><span class="number">-10</span>;</span><br><span class="line">	ll ans=<span class="number">0</span>;</span><br><span class="line">	<span class="type">int</span> i=<span class="number">1</span>;</span><br><span class="line">	<span class="built_in">Build</span>(<span class="number">1</span>,<span class="number">1</span>,n);</span><br><span class="line">	<span class="keyword">while</span>(i&lt;=n/<span class="number">2</span>) &#123;</span><br><span class="line">		Pair res=Ans[<span class="number">1</span>];</span><br><span class="line">		<span class="keyword">if</span>(res.<span class="built_in">Val</span>()&lt;=<span class="number">0</span>) <span class="keyword">break</span>;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;%lld\n&quot;</span>,ans+=res.<span class="built_in">Val</span>());</span><br><span class="line">		<span class="built_in">Upd</span>(<span class="number">1</span>,<span class="number">1</span>,n,res.x,<span class="number">1</span>),<span class="built_in">Upd</span>(<span class="number">1</span>,<span class="number">1</span>,n,res.y,<span class="number">-1</span>);</span><br><span class="line">		i++;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">while</span>(i&lt;=n/<span class="number">2</span>) <span class="built_in">printf</span>(<span class="string">&quot;%lld\n&quot;</span>,ans),i++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://compilationfail.github.io/oi-solutions/CodeChef/Codechef%20March%20Challenge%202021%20Div2%20Consecutive%20Adding/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="orangejuice">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="orangejuice's blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | orangejuice's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/oi-solutions/CodeChef/Codechef%20March%20Challenge%202021%20Div2%20Consecutive%20Adding/" class="post-title-link" itemprop="url">Codechef March Challenge 2021 Div2 Consecutive Adding(CONSADD)</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2023-08-12 00:11:59 / Modified: 14:44:14" itemprop="dateCreated datePublished" datetime="2023-08-12T00:11:59+08:00">2023-08-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/CP-%E9%A2%98%E8%A7%A3/" itemprop="url" rel="index"><span itemprop="name">CP 题解</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1
id="codechef-march-challenge-2021-div2-consecutive-addingconsadd">Codechef
March Challenge 2021 Div2 Consecutive Adding(CONSADD)</h1>
<p>题目大意：</p>
<p>给定两个 <span class="math inline">\(n\times m\)</span> 矩阵 <span
class="math inline">\(A\)</span> ， <span
class="math inline">\(B\)</span> 和一个常数 <span
class="math inline">\(x\)</span></p>
<p>现在对于 <span class="math inline">\(A\)</span>
操作，每次可以选择一行或者一列连续的 <span
class="math inline">\(x\)</span> 个，一起改变同一个数值 <span
class="math inline">\(v\in \Z\)</span></p>
<p>判断是否可以由 <span class="math inline">\(A\)</span> 变成 <span
class="math inline">\(B\)</span></p>
<p><br></p>
<p>显然可以先将 <span class="math inline">\(A,B\)</span>
作差，转化为操作成0矩阵</p>
<p>进一步，我们将 <span class="math inline">\(A\)</span>
矩阵行内差分，使得每次行操作变为一个单点 <span
class="math inline">\(A_{i,j}+v\)</span> ，一个单点 <span
class="math inline">\(A_{i,j+x}-v\)</span></p>
<p>在此基础上，继续差分即可将行列操作都转化为单点操作</p>
<p>此时容易发现， <span class="math inline">\(A_{i,j}\)</span>
的数值有关联的部分都是 <span
class="math inline">\(A_{i,j},A_{i+x,j},A_{i,j+x}\cdots
A_{i+ax,j+bx}\)</span></p>
<p>也就是相差 <span class="math inline">\(x\)</span>
的，考虑可以将这一部分子矩形提取出来，这样问题变成了</p>
<p>每次操作一个数 <span class="math inline">\(A_{i,j}+v\)</span>
，可以选择相邻一个数 <span class="math inline">\(A_{i,j+1}\)</span> 或
<span class="math inline">\(A_{i+1,j}\)</span> 去 <span
class="math inline">\(-v\)</span></p>
<p>对于每个这样的子问题，容易发现有解的充要条件：子矩阵元素和为0</p>
<p>（可以依次考虑每个元素贪心构造方案）</p>
<p>如此可以 <span class="math inline">\(O(nm)\)</span> 判定</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> N=<span class="number">1010</span>,INF=<span class="number">1e9</span>+<span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> n,m,k;</span><br><span class="line">ll A[N][N],B[N][N];</span><br><span class="line"><span class="type">int</span> V[N][N];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="built_in">rep</span>(kase,<span class="number">1</span>,<span class="built_in">rd</span>()) &#123;</span><br><span class="line">		n=<span class="built_in">rd</span>(),m=<span class="built_in">rd</span>(),k=<span class="built_in">rd</span>();</span><br><span class="line">		<span class="built_in">rep</span>(i,<span class="number">1</span>,n+<span class="number">1</span>) <span class="built_in">rep</span>(j,<span class="number">1</span>,m+<span class="number">1</span>) A[i][j]=V[i][j]=<span class="number">0</span>;</span><br><span class="line">		<span class="built_in">rep</span>(i,<span class="number">1</span>,n) <span class="built_in">rep</span>(j,<span class="number">1</span>,m) A[i][j]=<span class="built_in">rd</span>();</span><br><span class="line">		<span class="built_in">rep</span>(i,<span class="number">1</span>,n) <span class="built_in">rep</span>(j,<span class="number">1</span>,m) A[i][j]-=<span class="built_in">rd</span>();</span><br><span class="line">		<span class="built_in">rep</span>(i,<span class="number">1</span>,n+<span class="number">1</span>) <span class="built_in">drep</span>(j,m+<span class="number">1</span>,<span class="number">1</span>) A[i][j]-=A[i][j<span class="number">-1</span>];</span><br><span class="line">		<span class="built_in">drep</span>(i,n+<span class="number">1</span>,<span class="number">1</span>) <span class="built_in">rep</span>(j,<span class="number">1</span>,m+<span class="number">1</span>) A[i][j]-=A[i<span class="number">-1</span>][j];</span><br><span class="line">        <span class="comment">// 3 次作差</span></span><br><span class="line">		<span class="type">int</span> f=<span class="number">1</span>;</span><br><span class="line">		<span class="built_in">rep</span>(i,<span class="number">1</span>,n+<span class="number">1</span>) <span class="built_in">rep</span>(j,<span class="number">1</span>,m+<span class="number">1</span>) <span class="keyword">if</span>(!V[i][j]) &#123;</span><br><span class="line">			ll s=<span class="number">0</span>;</span><br><span class="line">            <span class="comment">// 子问题判定</span></span><br><span class="line">			<span class="keyword">for</span>(<span class="type">int</span> a=i;a&lt;=n+<span class="number">1</span>;a+=k) <span class="keyword">for</span>(<span class="type">int</span> b=j;b&lt;=m+<span class="number">1</span>;b+=k) &#123;</span><br><span class="line">				V[a][b]=<span class="number">1</span>;</span><br><span class="line">				s+=A[a][b];</span><br><span class="line">			&#125;</span><br><span class="line">			f&amp;=s==<span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">puts</span>(f?<span class="string">&quot;Yes&quot;</span>:<span class="string">&quot;No&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://compilationfail.github.io/oi-solutions/CodeChef/Codechef%20March%20Challenge%202021%20Random%20Walk%20Queries/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="orangejuice">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="orangejuice's blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | orangejuice's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/oi-solutions/CodeChef/Codechef%20March%20Challenge%202021%20Random%20Walk%20Queries/" class="post-title-link" itemprop="url">[Codechef March Challenge 2021 Random Walk Queries(RWALKS) (动态点分治) ](https://www.codechef.com/MARCH21B/problems/RWALKS)</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2023-08-12 00:11:59 / Modified: 14:44:14" itemprop="dateCreated datePublished" datetime="2023-08-12T00:11:59+08:00">2023-08-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/CP-%E9%A2%98%E8%A7%A3/" itemprop="url" rel="index"><span itemprop="name">CP 题解</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1
id="codechef-march-challenge-2021-random-walk-queriesrwalks-动态点分治"><a
target="_blank" rel="noopener" href="https://www.codechef.com/MARCH21B/problems/RWALKS">Codechef March
Challenge 2021 Random Walk Queries(RWALKS) (动态点分治)</a></h1>
<p>题目大意：</p>
<p>对于给定的无根树 <span class="math inline">\(T\)</span>
，要求强制在线维护两种操作</p>
<p>1.游走 <span class="math inline">\((u,d)\)</span> ，以 <span
class="math inline">\(u\)</span> 为根在树上游走，从 <span
class="math inline">\(u\)</span> 开始，最多走 <span
class="math inline">\(d\)</span> 步，每次随机从儿子中选择一个点</p>
<p>2.查询 <span class="math inline">\(u\)</span> ，当前 <span
class="math inline">\(u\)</span> 被遍历的期望次数</p>
<p><span class="math display">\[ \ \]</span></p>
<p><del>灵光一闪想到这么个憨批树上结构</del></p>
<p>对于更新 <span class="math inline">\((u,d)\)</span> ，考虑 <span
class="math inline">\(u\)</span> <strong>跨过当前点分根</strong>
到达其他点分子树里的贡献</p>
<p>一个点由当前点分根到达的概率是一个定值，可以预处理出来，并在查询时计算</p>
<p>因此更新贡献时，可以描述为 <span class="math inline">\(dep\leq
d\)</span> 的点接受到 以 <span class="math inline">\(x\)</span>
的概率访问当前点分根</p>
<p>可以简单用树状数组维护</p>
<p>为了剔除对于自己所在子树的非法贡献，需要额外开一些树状数组来维护</p>
<p>一个节点有 <span class="math inline">\(\log n\)</span>
个点分父节点，每次需要两次树状数组查询</p>
<p>因此查询部分复杂度为 <span class="math inline">\(O(m\log
^2n)\)</span> ，预处理以及空间复杂度为 <span
class="math inline">\(O(n\log n)\)</span></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> <span class="type">int</span> N=<span class="number">2e5</span>+<span class="number">10</span>,K=<span class="number">19</span>,P=<span class="number">1e9</span>+<span class="number">7</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> n,m,I[N];</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Edge</span>&#123;</span><br><span class="line">	<span class="type">int</span> to,nxt;</span><br><span class="line">&#125;e[N&lt;&lt;<span class="number">1</span>];</span><br><span class="line"><span class="type">int</span> head[N],ecnt,deg[N];</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">AddEdge</span><span class="params">(<span class="type">int</span> u,<span class="type">int</span> v)</span></span>&#123;</span><br><span class="line">	e[++ecnt]=(Edge)&#123;v,head[u]&#125;;</span><br><span class="line">	head[u]=ecnt,deg[v]++;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> erep(u) for(int i=head[u],v=e[i].to;i;i=e[i].nxt,v=e[i].to)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">BIT</span>&#123;</span><br><span class="line">	<span class="type">int</span> n;</span><br><span class="line">	vector &lt;<span class="type">int</span>&gt; s;</span><br><span class="line">	<span class="built_in">BIT</span>()&#123;&#125;;</span><br><span class="line">	<span class="built_in">BIT</span>(<span class="type">int</span> n):<span class="built_in">n</span>(n)&#123; s.<span class="built_in">resize</span>(n+<span class="number">1</span>); &#125;</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">Add</span><span class="params">(<span class="type">int</span> p,<span class="type">int</span> x)</span></span>&#123; </span><br><span class="line">		<span class="keyword">for</span>(<span class="built_in">cmin</span>(p,n);p;p-=p&amp;-p) s[p]+=x,<span class="built_in">Mod1</span>(s[p]);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="type">int</span> <span class="title">Que</span><span class="params">(<span class="type">int</span> p)</span></span>&#123;</span><br><span class="line">		<span class="type">int</span> res=<span class="number">0</span>;</span><br><span class="line">		<span class="keyword">while</span>(p&lt;=n) res+=s[p],<span class="built_in">Mod1</span>(res),p+=p&amp;-p;</span><br><span class="line">		<span class="keyword">return</span> res;</span><br><span class="line">	&#125;</span><br><span class="line">&#125; T[N];</span><br><span class="line">vector &lt;BIT&gt; G[N];</span><br><span class="line"><span class="comment">//  Dep:点分树上的dep，id:节点在每层的编号， dep:节点在每层的dep，s:节点在每层由根到达的系数</span></span><br><span class="line"><span class="type">int</span> Dep[N],id[K][N],dep[K][N],s[K][N],vis[N],sz[N],fa[N],Root;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> mi,rt;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">FindRt</span><span class="params">(<span class="type">int</span> n,<span class="type">int</span> u,<span class="type">int</span> f)</span></span>&#123;</span><br><span class="line">	<span class="type">int</span> ma=<span class="number">0</span>; sz[u]=<span class="number">1</span>;</span><br><span class="line">	<span class="built_in">erep</span>(u) <span class="keyword">if</span>(v!=f &amp;&amp; !vis[v]) &#123;</span><br><span class="line">		<span class="built_in">FindRt</span>(n,v,u);</span><br><span class="line">		sz[u]+=sz[v],<span class="built_in">cmax</span>(ma,sz[v]);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">cmax</span>(ma,n-sz[u]);</span><br><span class="line">	<span class="keyword">if</span>(mi&gt;ma) mi=ma,rt=u;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> D,maxd;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">dfs</span><span class="params">(<span class="type">int</span> u,<span class="type">int</span> f,<span class="type">int</span> id)</span></span>&#123;</span><br><span class="line">	<span class="built_in">cmax</span>(maxd,dep[D][u]=dep[D][f]+<span class="number">1</span>),::id[D][u]=id;</span><br><span class="line">	<span class="built_in">erep</span>(u) <span class="keyword">if</span>(v!=f &amp;&amp; !vis[v]) &#123;</span><br><span class="line">		s[D][v]=<span class="number">1ll</span>*s[D][u]*I[deg[u]<span class="number">-1</span>]%P;</span><br><span class="line">		<span class="built_in">dfs</span>(v,u,id);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 预处理点分治，开树状数组</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Divide</span><span class="params">(<span class="type">int</span> n,<span class="type">int</span> u)</span></span>&#123;</span><br><span class="line">	mi=<span class="number">1e9</span>,<span class="built_in">FindRt</span>(n,u,<span class="number">0</span>),u=rt;</span><br><span class="line">	<span class="type">int</span> sonc=<span class="number">0</span>;</span><br><span class="line">	vis[u]=s[Dep[u]=D][u]=<span class="number">1</span>,id[D][u]=<span class="number">-1</span>;</span><br><span class="line">	<span class="type">int</span> t=<span class="number">0</span>;</span><br><span class="line">	<span class="built_in">erep</span>(u) <span class="keyword">if</span>(!vis[v]) &#123;</span><br><span class="line">		maxd=<span class="number">0</span>;</span><br><span class="line">		s[D][v]=<span class="number">1</span>,<span class="built_in">dfs</span>(v,u,sonc);</span><br><span class="line">		G[u].<span class="built_in">pb</span>(<span class="built_in">BIT</span>(maxd));</span><br><span class="line">		sonc++;</span><br><span class="line">		<span class="built_in">cmax</span>(t,maxd);</span><br><span class="line">	&#125;</span><br><span class="line">	T[u]=<span class="built_in">BIT</span>(t);</span><br><span class="line">	<span class="built_in">erep</span>(u) <span class="keyword">if</span>(!vis[v]) &#123;</span><br><span class="line">		<span class="keyword">if</span>(sz[v]&gt;sz[u]) sz[v]=n-sz[u];</span><br><span class="line">		D++,fa[<span class="built_in">Divide</span>(sz[v],v)]=u,D--;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> u;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> sum[N];</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Que</span><span class="params">(<span class="type">int</span> u)</span></span>&#123;</span><br><span class="line">	ll ans=sum[u];</span><br><span class="line">	<span class="keyword">for</span>(<span class="type">int</span> v=u,d=Dep[v];(d--,v=fa[v]);) </span><br><span class="line">		ans=(ans+ <span class="number">1ll</span>* (T[v].<span class="built_in">Que</span>(dep[d][u])+G[v][id[d][u]].<span class="built_in">Que</span>(dep[d][u])) *s[d][u])%P;</span><br><span class="line">	<span class="keyword">return</span> (ans%P+P)%P;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Upd</span><span class="params">(<span class="type">int</span> u,<span class="type">int</span> d)</span></span>&#123;</span><br><span class="line">	sum[u]++,<span class="built_in">Mod1</span>(sum[u]),T[u].<span class="built_in">Add</span>(d,I[deg[u]]);</span><br><span class="line">	<span class="keyword">for</span>(<span class="type">int</span> v=fa[u],D=Dep[u]<span class="number">-1</span>;v;v=fa[v],D--) &#123;</span><br><span class="line">		<span class="keyword">if</span>(d&lt;dep[D][u]) <span class="keyword">continue</span>;</span><br><span class="line">		<span class="type">int</span> x=<span class="number">1ll</span>*I[deg[u]]*s[D][u]%P;</span><br><span class="line">		sum[v]+=x,<span class="built_in">Mod1</span>(sum[v]);</span><br><span class="line">		x=<span class="number">1ll</span>*x*I[deg[v]<span class="number">-1</span>]%P;</span><br><span class="line">		T[v].<span class="built_in">Add</span>(d-dep[D][u],x),G[v][id[D][u]].<span class="built_in">Add</span>(d-dep[D][u],P-x);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> lst;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Get</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> (<span class="built_in">rd</span>()+lst)%n+<span class="number">1</span>; &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	I[<span class="number">0</span>]=I[<span class="number">1</span>]=<span class="number">1</span>;</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">2</span>,N<span class="number">-1</span>) I[i]=<span class="number">1ll</span>*(P-P/i)*I[P%i]%P;</span><br><span class="line">	n=<span class="built_in">rd</span>(),m=<span class="built_in">rd</span>();</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">2</span>,n)&#123;</span><br><span class="line">		<span class="type">int</span> u=<span class="built_in">rd</span>(),v=<span class="built_in">rd</span>();</span><br><span class="line">		<span class="built_in">AddEdge</span>(u,v),<span class="built_in">AddEdge</span>(v,u);</span><br><span class="line">	&#125;</span><br><span class="line">	Root=<span class="built_in">Divide</span>(n,<span class="number">1</span>);</span><br><span class="line">	<span class="keyword">while</span>(m--) &#123;</span><br><span class="line">		<span class="type">int</span> opt=<span class="built_in">rd</span>();</span><br><span class="line">		<span class="keyword">if</span>(opt==<span class="number">1</span>) &#123;</span><br><span class="line">			<span class="type">int</span> u=<span class="built_in">Get</span>(),d=<span class="built_in">Get</span>();</span><br><span class="line">			<span class="built_in">Upd</span>(u,d);</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>,lst=<span class="built_in">Que</span>(<span class="built_in">Get</span>()));</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://compilationfail.github.io/oi-solutions/CodeChef/Codechef%20Red-Black%20Boolean%20Expression/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="orangejuice">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="orangejuice's blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | orangejuice's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/oi-solutions/CodeChef/Codechef%20Red-Black%20Boolean%20Expression/" class="post-title-link" itemprop="url">CodeChef 2020 November Challenge - Red-Black Boolean Expression</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2023-08-12 00:11:59 / Modified: 14:44:14" itemprop="dateCreated datePublished" datetime="2023-08-12T00:11:59+08:00">2023-08-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/CP-%E9%A2%98%E8%A7%A3/" itemprop="url" rel="index"><span itemprop="name">CP 题解</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1
id="codechef-2020-november-challenge---red-black-boolean-expression">CodeChef
2020 November Challenge - Red-Black Boolean Expression</h1>
<p>吐槽：这题很蠢，很套路</p>
<p>题目大意：</p>
<p>给定 <span class="math inline">\(n\)</span> 个布尔变量 <span
class="math inline">\(x_i\)</span> ，每个变量有其反变量 <span
class="math inline">\(\overline {x_i}\)</span></p>
<p>有 <span class="math inline">\(n\)</span> 组关系 <span
class="math inline">\(a_i,b_i\)</span> ，要求 <span
class="math inline">\(a_i\lor b_i\)</span> 为真</p>
<p>并且保证所有 <span class="math inline">\(a_i,b_i\)</span>
关系构成一张二分图，其中 <span class="math inline">\(x_i\)</span> 与
<span class="math inline">\(\overline{x_i}\)</span> 有一条边相连</p>
<p>给定每个变量的初始值 <span class="math inline">\(s_i\)</span>
，以及翻转其所需的代价 <span class="math inline">\(C_i\)</span>
，求最小满足条件的代价</p>
<p><span class="math display">\[  \ \]</span></p>
<p><span class="math inline">\(a_i\lor b_i\)</span> 为真即不存在 <span
class="math inline">\(a_i,b_i\)</span> 均为假的情况</p>
<p>如果是2-sat上的理解，即可以由 <span
class="math inline">\(a_i\)</span> 假推 <span
class="math inline">\(b_i\)</span> 真， <span
class="math inline">\(b_i\)</span> 假推 <span
class="math inline">\(a_i\)</span> 真，但是 <span
class="math inline">\(2-sat\)</span> 没法带权</p>
<p>由于题目保证了关系的二分图性质，不妨把所有变量分成两个集合 <span
class="math inline">\(A,B\)</span></p>
<p>这个问题令人联想到网络流最小割模型，我们用一条边 <span
class="math inline">\((u,v)\)</span> 限制 <span
class="math inline">\((u,v)\)</span> 不同时为假的情况</p>
<p>对于 <span class="math inline">\(A\)</span> 中的点，我们令源点 <span
class="math inline">\(S\)</span> 向 <span
class="math inline">\(u\)</span> 连的边 <span
class="math inline">\((S,u,w)\)</span> 表示 <span
class="math inline">\(u\)</span> 变成 <span
class="math inline">\(0\)</span> 所需代价，令 <span
class="math inline">\((u,T,w)\)</span> 表示 <span
class="math inline">\(u\)</span> 变成1的代价</p>
<p>对于 <span class="math inline">\(B\)</span>
中的点，采取相反的连接方式</p>
<p>任意一个关系的两点不在同一集合，不妨对于 <span
class="math inline">\(u\in A\)</span>
的情况考虑，实际上可以分为两类考虑</p>
<ol type="1">
<li><p><span class="math inline">\((u,v)\)</span>
不同时为0，那么连接一条边 <span
class="math inline">\((v,u,\infty)\)</span> ，表示如果合法必然有一条让
<span class="math inline">\(u\)</span> 或 <span
class="math inline">\(v\)</span> 变成1的边被割掉</p></li>
<li><p><span class="math inline">\((u,v)\)</span> 不同时为1，连接一条边
<span class="math inline">\((v,u,\infty)\)</span> ，原理类似</p></li>
</ol>
<p>然后就可以跑网络流最小割了</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">long</span> <span class="type">long</span> ll;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">double</span> db;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> ull;</span><br><span class="line"><span class="keyword">typedef</span> pair &lt;<span class="type">int</span>,<span class="type">int</span>&gt; Pii;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> reg register</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> pb push_back</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> mp make_pair</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> Mod1(x) ((x&gt;=P)&amp;&amp;(x-=P))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> Mod2(x) ((x&lt;0)&amp;&amp;(x+=P))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> rep(i,a,b) for(int i=a,i##end=b;i&lt;=i##end;++i)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> drep(i,a,b) for(int i=a,i##end=b;i&gt;=i##end;--i)</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt; <span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">cmin</span><span class="params">(T &amp;a,T b)</span></span>&#123; ((a&gt;b)&amp;&amp;(a=b)); &#125;</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt; <span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">cmax</span><span class="params">(T &amp;a,T b)</span></span>&#123; ((a&lt;b)&amp;&amp;(a=b)); &#125;</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> IO;</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">T</span>=<span class="type">int</span>&gt; T <span class="built_in">rd</span>()&#123;</span><br><span class="line">	T s=<span class="number">0</span>; <span class="type">int</span> f=<span class="number">0</span>;</span><br><span class="line">	<span class="keyword">while</span>(!<span class="built_in">isdigit</span>(IO=<span class="built_in">getchar</span>())) <span class="keyword">if</span>(IO==<span class="string">&#x27;-&#x27;</span>) f=<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">do</span> s=(s&lt;&lt;<span class="number">1</span>)+(s&lt;&lt;<span class="number">3</span>)+(IO^<span class="string">&#x27;0&#x27;</span>);</span><br><span class="line">	<span class="keyword">while</span>(<span class="built_in">isdigit</span>(IO=<span class="built_in">getchar</span>()));</span><br><span class="line">	<span class="keyword">return</span> f?-s:s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> N=<span class="number">1e5</span>+<span class="number">10</span>,INF=<span class="number">1e9</span>+<span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> n,m,S,T;</span><br><span class="line"><span class="type">char</span> s[N];</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Edge</span>&#123;</span><br><span class="line">	<span class="type">int</span> to,nxt,w;</span><br><span class="line">&#125;e[N&lt;&lt;<span class="number">1</span>];</span><br><span class="line"><span class="type">int</span> head[N],ecnt=<span class="number">1</span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">AddEdge</span><span class="params">(<span class="type">int</span> u,<span class="type">int</span> v,<span class="type">int</span> w)</span> </span>&#123;</span><br><span class="line">	e[++ecnt]=(Edge)&#123;v,head[u],w&#125;;</span><br><span class="line">	head[u]=ecnt;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Link</span><span class="params">(<span class="type">int</span> u,<span class="type">int</span> v,<span class="type">int</span> w)</span></span>&#123; </span><br><span class="line">	<span class="built_in">AddEdge</span>(u,v,w),<span class="built_in">AddEdge</span>(v,u,<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> F[N],X[N],Y[N],col[N],A[N];</span><br><span class="line"><span class="comment">// 这里我用带权并查集实现了二分图</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Find</span><span class="params">(<span class="type">int</span> x)</span></span>&#123; </span><br><span class="line">	<span class="keyword">if</span>(F[x]==x) <span class="keyword">return</span> x;</span><br><span class="line">	<span class="type">int</span> f=F[x]; F[x]=<span class="built_in">Find</span>(F[x]);</span><br><span class="line">	col[x]^=col[f];</span><br><span class="line">	<span class="keyword">return</span> F[x];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> dis[N];</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Bfs</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">1</span>,T) dis[i]=INF;</span><br><span class="line">	<span class="type">static</span> queue &lt;<span class="type">int</span>&gt; que;</span><br><span class="line">	dis[S]=<span class="number">0</span>; que.<span class="built_in">push</span>(S);</span><br><span class="line">	<span class="keyword">while</span>(!que.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">		<span class="type">int</span> u=que.<span class="built_in">front</span>(); que.<span class="built_in">pop</span>();</span><br><span class="line">		<span class="keyword">for</span>(<span class="type">int</span> i=head[u];i;i=e[i].nxt) &#123;</span><br><span class="line">			<span class="type">int</span> v=e[i].to,w=e[i].w;</span><br><span class="line">			<span class="keyword">if</span>(!w || dis[v]&lt;=dis[u]+<span class="number">1</span>) <span class="keyword">continue</span>;</span><br><span class="line">			dis[v]=dis[u]+<span class="number">1</span>,que.<span class="built_in">push</span>(v);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> dis[T]&lt;INF;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Dfs</span><span class="params">(<span class="type">int</span> u,<span class="type">int</span> in)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(u==T) <span class="keyword">return</span> in;</span><br><span class="line">	<span class="type">int</span> out=<span class="number">0</span>;</span><br><span class="line">	<span class="keyword">for</span>(<span class="type">int</span> i=head[u];i;i=e[i].nxt) &#123;</span><br><span class="line">		<span class="type">int</span> v=e[i].to,w=e[i].w;</span><br><span class="line">		<span class="keyword">if</span>(!w || dis[v]!=dis[u]+<span class="number">1</span>) <span class="keyword">continue</span>;</span><br><span class="line">		<span class="type">int</span> t=<span class="built_in">Dfs</span>(v,<span class="built_in">min</span>(in-out,w));</span><br><span class="line">		e[i].w-=t,e[i^<span class="number">1</span>].w+=t,out+=t;</span><br><span class="line">		<span class="keyword">if</span>(in==out) <span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(!out) dis[u]=<span class="number">0</span>;</span><br><span class="line">	<span class="keyword">return</span> out;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Dinic</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="type">int</span> ans=<span class="number">0</span>; </span><br><span class="line">	<span class="keyword">while</span>(<span class="built_in">Bfs</span>()) ans+=<span class="built_in">Dfs</span>(S,INF);</span><br><span class="line">	<span class="keyword">return</span> ans;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="built_in">rep</span>(kase,<span class="number">1</span>,<span class="built_in">rd</span>()) &#123;</span><br><span class="line">		n=<span class="built_in">rd</span>(),m=<span class="built_in">rd</span>();</span><br><span class="line">		<span class="built_in">rep</span>(i,<span class="number">1</span>,n) F[i]=i,col[i]=<span class="number">0</span>;</span><br><span class="line">		<span class="built_in">scanf</span>(<span class="string">&quot;%s&quot;</span>,s+<span class="number">1</span>);</span><br><span class="line">		S=n+<span class="number">1</span>,T=n+<span class="number">2</span>;</span><br><span class="line">		<span class="built_in">rep</span>(i,<span class="number">1</span>,n) A[i]=<span class="built_in">rd</span>();</span><br><span class="line">		<span class="built_in">rep</span>(i,<span class="number">1</span>,m) &#123;</span><br><span class="line">			X[i]=<span class="built_in">rd</span>(),Y[i]=<span class="built_in">rd</span>();</span><br><span class="line">			<span class="type">int</span> x=<span class="built_in">abs</span>(X[i]),y=<span class="built_in">abs</span>(Y[i]);</span><br><span class="line">			<span class="type">int</span> u=<span class="built_in">Find</span>(x),v=<span class="built_in">Find</span>(y);</span><br><span class="line">			<span class="keyword">if</span>(u==v) <span class="keyword">continue</span>;</span><br><span class="line">			F[u]=v,col[u]=col[x]^col[y]^(X[i]&lt;<span class="number">0</span>)^(Y[i]&lt;<span class="number">0</span>)^<span class="number">1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">rep</span>(i,<span class="number">1</span>,n) <span class="built_in">Find</span>(i);</span><br><span class="line">		<span class="built_in">rep</span>(i,<span class="number">1</span>,n) &#123;</span><br><span class="line">			<span class="keyword">if</span>(col[i]^s[i]^<span class="string">&#x27;0&#x27;</span>) <span class="built_in">Link</span>(S,i,A[i]);</span><br><span class="line">			<span class="keyword">else</span> <span class="built_in">Link</span>(i,T,A[i]);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">rep</span>(i,<span class="number">1</span>,m) &#123;</span><br><span class="line">			<span class="type">int</span> t=col[<span class="built_in">abs</span>(X[i])]^(X[i]&lt;<span class="number">0</span>);</span><br><span class="line">			<span class="built_in">assert</span>(col[<span class="built_in">abs</span>(X[i])]^col[<span class="built_in">abs</span>(Y[i])]^(X[i]&lt;<span class="number">0</span>)^(Y[i]&lt;<span class="number">0</span>));</span><br><span class="line">			<span class="keyword">if</span>(t) <span class="built_in">Link</span>(<span class="built_in">abs</span>(X[i]),<span class="built_in">abs</span>(Y[i]),INF);</span><br><span class="line">			<span class="keyword">else</span> <span class="built_in">Link</span>(<span class="built_in">abs</span>(Y[i]),<span class="built_in">abs</span>(X[i]),INF);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>,<span class="built_in">Dinic</span>());</span><br><span class="line">		<span class="built_in">rep</span>(i,<span class="number">1</span>,T) head[i]=<span class="number">0</span>; ecnt=<span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://compilationfail.github.io/oi-solutions/CodeChef/CodeChef%202020%20NOV%20Scalar%20Product%20Tree/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="orangejuice">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="orangejuice's blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | orangejuice's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/oi-solutions/CodeChef/CodeChef%202020%20NOV%20Scalar%20Product%20Tree/" class="post-title-link" itemprop="url">CodeChef 2020 November Challenge - Scalar Product Tree (莫队)</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2023-08-12 00:11:59 / Modified: 14:44:14" itemprop="dateCreated datePublished" datetime="2023-08-12T00:11:59+08:00">2023-08-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/CP-%E9%A2%98%E8%A7%A3/" itemprop="url" rel="index"><span itemprop="name">CP 题解</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1
id="codechef-2020-november-challenge---scalar-product-tree-莫队">CodeChef
2020 November Challenge - Scalar Product Tree (莫队)</h1>
<p>题目大意：给定一棵根为1的树，每个点有权值 <span
class="math inline">\(A_i\)</span>
，每个点按照其从根开始的路径记录下来一串数 <span
class="math inline">\((A_1,\cdots,A_u)\)</span> 构成一个向量 <span
class="math inline">\(v_u\)</span></p>
<p>每次查询两个点 <span class="math inline">\((x,y)\)</span> ，查询
<span class="math inline">\(v_x\cdot v_y\)</span></p>
<p><span class="math display">\[ \ \]</span></p>
<p>由于向量点积是对位相乘的，不好用数据结构维护</p>
<p>考虑用一个序列描述 <span class="math inline">\(\text{dfs}\)</span>
遍历树时每个点入栈出栈的过程，扫描一段前缀即可得到遍历到每个点时 <span
class="math inline">\(\text{dfs}\)</span>
栈的情况，也就得到了题目指定的向量</p>
<p>每次查询两个点 <span class="math inline">\(x,y\)</span>
，那么就是查询了两段前缀，用莫队维护两个前缀指针的移动，同时维护每个深度上两个前缀对应的值以及这些值的乘积即可</p>
<p>复杂度为 <span class="math inline">\(O(n\sqrt n)\)</span></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">typedef</span> pair &lt;<span class="type">int</span>,<span class="type">int</span>&gt; Pii;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> rep(i,a,b) for(int i=a,i##end=b;i&lt;=i##end;++i)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> drep(i,a,b) for(int i=a,i##end=b;i&gt;=i##end;--i)</span></span><br><span class="line"></span><br><span class="line"><span class="type">char</span> IO;</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">T</span>=<span class="type">int</span>&gt; T <span class="built_in">rd</span>()&#123;</span><br><span class="line">	T s=<span class="number">0</span>; <span class="type">int</span> f=<span class="number">0</span>;</span><br><span class="line">	<span class="keyword">while</span>(!<span class="built_in">isdigit</span>(IO=<span class="built_in">getchar</span>())) f|=IO==<span class="string">&#x27;-&#x27;</span>;</span><br><span class="line">	<span class="keyword">do</span> s=(s&lt;&lt;<span class="number">1</span>)+(s&lt;&lt;<span class="number">3</span>)+(IO^<span class="string">&#x27;0&#x27;</span>);</span><br><span class="line">	<span class="keyword">while</span>(<span class="built_in">isdigit</span>(IO=<span class="built_in">getchar</span>()));</span><br><span class="line">	<span class="keyword">return</span> f?-s:s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> N=<span class="number">6e5</span>+<span class="number">10</span>,P=<span class="number">1e9</span>+<span class="number">7</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> n,m;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Edge</span>&#123;</span><br><span class="line">	<span class="type">int</span> to,nxt;</span><br><span class="line">&#125;e[N];</span><br><span class="line"><span class="type">int</span> head[N],ecnt;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">AddEdge</span><span class="params">(<span class="type">int</span> u,<span class="type">int</span> v)</span> </span>&#123;</span><br><span class="line">	e[++ecnt]=(Edge)&#123;v,head[u]&#125;;</span><br><span class="line">	head[u]=ecnt;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> id[N],dfn;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> U;</span><br><span class="line">U A[N];</span><br><span class="line"><span class="type">int</span> L[N],K[N]; <span class="comment">// L,K维护括号序列，L为编号,K为左括号还是右括号</span></span><br><span class="line">U Sum,Ans[N];</span><br><span class="line"><span class="type">int</span> dep[N];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">dfs</span><span class="params">(<span class="type">int</span> u,<span class="type">int</span> f)</span> </span>&#123;</span><br><span class="line">	L[id[u]=++dfn]=u,K[dfn]=<span class="number">1</span>;</span><br><span class="line">	dep[u]=dep[f]+<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">for</span>(<span class="type">int</span> i=head[u];i;i=e[i].nxt) &#123;</span><br><span class="line">		<span class="type">int</span> v=e[i].to;</span><br><span class="line">		<span class="keyword">if</span>(v==f) <span class="keyword">continue</span>;</span><br><span class="line">		<span class="built_in">dfs</span>(v,u);</span><br><span class="line">	&#125;</span><br><span class="line">	L[++dfn]=u,K[dfn]=<span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> len;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Que</span>&#123;</span><br><span class="line">	<span class="type">int</span> l,r,id;</span><br><span class="line">	<span class="type">bool</span> <span class="keyword">operator</span> &lt; (<span class="type">const</span> Que __) <span class="type">const</span> &#123;</span><br><span class="line">		<span class="keyword">if</span>(l/len!=__.l/len) <span class="keyword">return</span> l/len&lt;__.l/len;</span><br><span class="line">		<span class="keyword">return</span> ((l/len)&amp;<span class="number">1</span>)?r&lt;__.r:r&gt;__.r;</span><br><span class="line">	&#125;</span><br><span class="line">&#125; Q[N];</span><br><span class="line"></span><br><span class="line">U S[<span class="number">2</span>][N];</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Add</span><span class="params">(<span class="type">int</span> d,<span class="type">int</span> x,<span class="type">int</span> k)</span> </span>&#123;</span><br><span class="line">	<span class="type">int</span> p=dep[x];</span><br><span class="line">	Sum-=S[d][p]*S[!d][p];</span><br><span class="line">	S[d][p]=k==<span class="number">1</span>?A[x]:<span class="number">0</span>;</span><br><span class="line">	Sum+=S[d][p]*S[!d][p];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	n=<span class="built_in">rd</span>(),m=<span class="built_in">rd</span>();</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">1</span>,n) A[i]=<span class="built_in">rd</span>();</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">2</span>,n) &#123;</span><br><span class="line">		<span class="type">int</span> u=<span class="built_in">rd</span>(),v=<span class="built_in">rd</span>();</span><br><span class="line">		<span class="built_in">AddEdge</span>(u,v),<span class="built_in">AddEdge</span>(v,u);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">dfs</span>(<span class="number">1</span>,<span class="number">0</span>),len=<span class="built_in">sqrt</span>(dfn);</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">1</span>,m) &#123;</span><br><span class="line">		<span class="type">int</span> l=<span class="built_in">rd</span>(),r=<span class="built_in">rd</span>();</span><br><span class="line">		l=id[l],r=id[r];</span><br><span class="line">		<span class="keyword">if</span>(l&gt;r) <span class="built_in">swap</span>(l,r);</span><br><span class="line">		Q[i]=(Que)&#123;l,r,i&#125;;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">sort</span>(Q+<span class="number">1</span>,Q+m+<span class="number">1</span>);</span><br><span class="line">	<span class="type">int</span> l=<span class="number">1</span>,r=<span class="number">1</span>;</span><br><span class="line">	<span class="built_in">Add</span>(<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>),<span class="built_in">Add</span>(<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>);</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">1</span>,m) &#123;</span><br><span class="line">		<span class="keyword">while</span>(l&lt;Q[i].l) ++l,<span class="built_in">Add</span>(<span class="number">0</span>,L[l],K[l]);</span><br><span class="line">		<span class="keyword">while</span>(l&gt;Q[i].l) <span class="built_in">Add</span>(<span class="number">0</span>,L[l],-K[l]),l--;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">while</span>(r&lt;Q[i].r) ++r,<span class="built_in">Add</span>(<span class="number">1</span>,L[r],K[r]);</span><br><span class="line">		<span class="keyword">while</span>(r&gt;Q[i].r) <span class="built_in">Add</span>(<span class="number">1</span>,L[r],-K[r]),r--;</span><br><span class="line">		Ans[Q[i].id]=Sum;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">rep</span>(i,<span class="number">1</span>,m) <span class="built_in">printf</span>(<span class="string">&quot;%u\n&quot;</span>,Ans[i]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="Previous page" aria-label="Previous page" href="/page/17/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/17/">17</a><span class="page-number current">18</span><a class="page-number" href="/page/19/">19</a><span class="space">&hellip;</span><a class="page-number" href="/page/27/">27</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/page/19/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2023</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">orangejuice</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>







  




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>



</body>
</html>
